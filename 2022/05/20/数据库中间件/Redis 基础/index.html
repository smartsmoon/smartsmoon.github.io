<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Redis 基本使用 | 月の子豚小屋</title><meta name="keywords" content="Redis"><meta name="author" content="moon"><meta name="copyright" content="moon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NoSQL 概述NoSQL 来源阶段一：基本的网站访问量不大，同时基本都是使用静态 Html 网页 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 单个数据库完全足够，服务器压力不大。那么这种情况下网站的瓶颈是什么呢？ ​	1）数据量过大，一个机器放不下。 ​	2）数据的索引（B+ Tree），一个机器内存放不下。 ​	3）访问量过大，同时">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 基本使用">
<meta property="og:url" content="http://localhost:4000/2022/05/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis%20%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="月の子豚小屋">
<meta property="og:description" content="NoSQL 概述NoSQL 来源阶段一：基本的网站访问量不大，同时基本都是使用静态 Html 网页 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 单个数据库完全足够，服务器压力不大。那么这种情况下网站的瓶颈是什么呢？ ​	1）数据量过大，一个机器放不下。 ​	2）数据的索引（B+ Tree），一个机器内存放不下。 ​	3）访问量过大，同时">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/we/wallhaven-weoe9q.jpg">
<meta property="article:published_time" content="2022-05-19T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-30T13:25:39.414Z">
<meta property="article:author" content="moon">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="缓存">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/we/wallhaven-weoe9q.jpg"><link rel="shortcut icon" href="https://w.wallhaven.cc/full/8o/wallhaven-8o2v82.jpg"><link rel="canonical" href="http://localhost:4000/2022/05/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis%20%E5%9F%BA%E7%A1%80/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Redis 基本使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-30 21:25:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic1.imgdb.cn/item/6337ca6e16f2c2beb17d8731.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://w.wallhaven.cc/full/we/wallhaven-weoe9q.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">月の子豚小屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis 基本使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-19T16:00:00.000Z" title="发表于 2022-05-20 00:00:00">2022-05-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-09-30T13:25:39.414Z" title="更新于 2022-09-30 21:25:39">2022-09-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/">数据库中间件</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">21.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>86分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis 基本使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="NoSQL-概述"><a href="#NoSQL-概述" class="headerlink" title="NoSQL 概述"></a>NoSQL 概述</h1><h2 id="NoSQL-来源"><a href="#NoSQL-来源" class="headerlink" title="NoSQL 来源"></a>NoSQL 来源</h2><p><code>阶段一</code>：基本的网站访问量不大，同时基本都是使用静态 Html 网页 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 单个数据库完全足够，服务器压力不大。那么这种情况下网站的瓶颈是什么呢？</p>
<p>​	1）数据量过大，一个机器放不下。</p>
<p>​	2）数据的索引（B+ Tree），一个机器内存放不下。</p>
<p>​	3）访问量过大，同时数据库读写混合使用，一个服务器承受不住压力。</p>
<p><code>阶段二</code>：使用缓存 Memcache + MySQL + 垂直拆分(读写分离)</p>
<p>​	但是发现相同的 SQL 时也会重复读 MySQL 数据库，因此使用<code>缓存</code> Memcache。</p>
<p><code>阶段三</code>：分库分表 + MySQL 水平拆分 + MySQL 集群 + 缓存</p>
<p><img src="https://img-blog.csdnimg.cn/20200820103739584.png" alt="在这里插入图片描述"></p>
<p><code>当今企业架构</code>：各种各样的数据类型出现，大数据的背景下关系型数据库（RDBMS）无法满足大量数据要求 &#x3D;&#x3D;&#x3D;&#x3D;&gt; Nosql 数据库就能轻松解决这些问题。</p>
<p><img src="https://img-blog.csdnimg.cn/20200820103804572.png" alt="在这里插入图片描述"></p>
<p>​		因此，为什么用 NoSQL 呢？</p>
<p>​		社交网络、地理位置、用户数据等，用户日志等等爆发式增长，这时候我们就需要使用 NoSQL 数据库的。</p>
<h2 id="NoSQL-简述"><a href="#NoSQL-简述" class="headerlink" title="NoSQL 简述"></a>NoSQL 简述</h2><p>​		<code>NoSQL</code>：<code>Not Only SQL</code>，泛指非关系型数据库。其中 Redis 是最流行的 NoSQL。</p>
<p>1）有些数据存储没有固定的格式，例如个人信息等，数据之间没有关系，容易扩展。</p>
<p>2）大数据量高性能（NoSQL 的缓存记录级，是一种细粒度的缓存，性能会比较高）。</p>
<p>3）数据类型多样性（不需要事先设计数据库）。</p>
<p>4）传统的 RDBMS 和 NoSQL 区别。</p>
<p>大数据时代问题(<code>3V</code>)：海量、多样、实时。大数据程序要求(<code>3高</code>)：高并发、高可扩、高性能。</p>
<p>企业实践：NoSQL + RDBMS 一起使用。</p>
<h2 id="NoSQL-分类"><a href="#NoSQL-分类" class="headerlink" title="NoSQL 分类"></a>NoSQL 分类</h2><p>1、<code>KV键值对</code>：<code>redis</code></p>
<p>2、文档型数据库( Bson 格式)：<code>MongoDB</code>（基于分布式文件存储，NoSQL中最像关系型数据库的数据库）、ConthDB</p>
<p>3、列存储数据库：<code>HBase</code>(大数据)、分布式文件系统</p>
<p>4、图关系数据库：Neo4j、InfoGrid。存放的是关系，用于推荐系统、社交网络。</p>
<h1 id="Redis-基础"><a href="#Redis-基础" class="headerlink" title="Redis 基础"></a>Redis 基础</h1><h2 id="Redis-简述"><a href="#Redis-简述" class="headerlink" title="Redis 简述"></a>Redis 简述</h2><p><code>Redis</code>：Remote Dictionary Server ，远程字典服务，是一种 KV 键值对类型的 NoSQL 数据库。</p>
<p>1）数据缓存在内存，但是会 redis 会周期性进行持久化，并可实现 master-slave 主从同步。</p>
<p>2）免费开源。</p>
<p>3）内存存储 ，并支持持久化 （<code>RDB、AOF</code>）</p>
<p>4）效率高，可以用于高速缓存。</p>
<p>5）功能：发布订阅系统、地图信息分析、计时器、计数器(浏览量) . . . . . .</p>
<p>特点：多样数据类型、支持持久化、支持集群、支持事务. . . . . .</p>
<h2 id="Redis-性能测试"><a href="#Redis-性能测试" class="headerlink" title="Redis 性能测试"></a>Redis 性能测试</h2><p>​		在 Redis 的安装目录：<code>/usr/local/bin</code> 下，有一个 Redis 官方的压测工具 <code>redis-benchmark</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试 100 个并发连接，每个并发 100000 万个请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-h 主机</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-p 端口</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-c 并发线程数</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-n 每个线程的请求数</span></span><br><span class="line">redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分析测试结果：以 <span class="built_in">set</span> 为例</span></span><br><span class="line">====== SET ======                                                   </span><br><span class="line">  100000 requests completed in 1.40 seconds		# 10万个请求进行写入测试，花费 1.40 s</span><br><span class="line">  100 parallel clients		# 100个并发客户端</span><br><span class="line">  3 bytes payload			# 每次写入三个字节</span><br><span class="line">  keep alive: 1				# 只有一台 redis 服务处理请求，单机性能</span><br><span class="line">  host configuration &quot;save&quot;: 3600 1 300 100 60 10000</span><br><span class="line">  host configuration &quot;appendonly&quot;: no</span><br><span class="line">  multi-thread: no</span><br><span class="line">  Latency by percentile distribution:</span><br><span class="line">0.000% &lt;= 0.239 milliseconds (cumulative count 1)</span><br><span class="line">50.000% &lt;= 0.687 milliseconds (cumulative count 51042)</span><br><span class="line">...............................</span><br><span class="line">100.000% &lt;= 3.983 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Cumulative distribution of latencies:</span><br><span class="line">0.000% &lt;= 0.103 milliseconds (cumulative count 0)</span><br><span class="line">0.005% &lt;= 0.303 milliseconds (cumulative count 5)</span><br><span class="line">................................</span><br><span class="line">100.000% &lt;= 4.103 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  throughput summary: 71275.84 requests per second			# 表示每秒处理 71275.84 个请求</span><br><span class="line">  latency summary (msec):			# 综合性能</span><br><span class="line">          avg       min       p50       p95       p99       max</span><br><span class="line">        0.777     0.232     0.687     1.255     1.655     3.983</span><br></pre></td></tr></table></figure>

<h2 id="Redis-基础命令"><a href="#Redis-基础命令" class="headerlink" title="Redis 基础命令"></a>Redis 基础命令</h2><p>根据 Redis 的配置文件，Redis 默认有 16 个数据库，<code>默认使用第 0 个数据库</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">a different one on a per-connection basis using SELECT &lt;dbid&gt; <span class="built_in">where</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dbid is a number between 0 and <span class="string">&#x27;databases&#x27;</span>-1</span></span><br><span class="line">databases 16</span><br></pre></td></tr></table></figure>

<p>1、数据库操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换数据库</span></span><br><span class="line">127.0.0.1:6379&gt; select 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前数据库容量</span></span><br><span class="line">127.0.0.1:6379[3]&gt; dbsize</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379[3]&gt; set name gaozheng</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[3]&gt; dbsize</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清除当前数据库</span></span><br><span class="line">flushdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清除所有的数据库</span></span><br><span class="line">flushall</span><br></pre></td></tr></table></figure>

<blockquote>
<pre><code>     Redis 是 key-value 类型的 NoSQL 数据库，无论什么数据类型，在数据库中都是`以 key-value 形式保存`，通过进行对 key 的操作，来完成对数据库中数据的操作。
</code></pre>
</blockquote>
<p>2、键 key 的相关操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前数据库所有的 key</span></span><br><span class="line">keys *</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断某个 key 是否存在</span></span><br><span class="line">exists key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除某个 key-value</span></span><br><span class="line">del key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将键值对移动到指定数据库 db，例如 move key 1</span></span><br><span class="line">move key db</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 key 的过期时间 second，单位是 秒</span></span><br><span class="line">expire key second</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看某个 key 存放 value 的数据类型</span></span><br><span class="line">type key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量设置值</span></span><br><span class="line">mset k1 v1 k2 v2 k3 v3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量获取值</span></span><br><span class="line">mget k1 k2 k3</span><br></pre></td></tr></table></figure>

<p>3、查看过期时间：-2 代表过期。-1 代表永不过期，其余情况返回当前剩余过期时间。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ttl key</span><br></pre></td></tr></table></figure>

<h2 id="Redis-分析"><a href="#Redis-分析" class="headerlink" title="Redis 分析"></a>Redis 分析</h2><p>​		<code>Redis 是单线程的</code>：Redis 是基于内存操作，其性能瓶颈不是 CPU限制，而是<code>机器内存和网络带宽</code>，既然可以使用单线程实现，就直接使用单线程实现了。</p>
<p>那么为什么 Redis 是单线程但是如此之快呢？ &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>10 万+ 的 QPS</code>，不比 MemeCache 差。</p>
<blockquote>
<p><code>误区</code>：</p>
<p>1）误区1：高性能的服务器一定是多线程的。<code>（×）</code></p>
<p>2）误区2：多线程（CPU上下文会切换 &#x3D;&#x3D;&#x3D;&gt; 耗时）一定比单线程效率高。<code>（×）</code></p>
</blockquote>
<p>​		核心原因：Redis 是将所有的数据放在<code>内存</code>中的，所以说使用单线程去操作效率就是最高的，多线程会产生 CPU 上下文会切换，是一个耗时的操作。对于内存系统来说，如果<code>没有上下文切换效率就是最高的</code>，多次读写都是在一个 CPU 上的，<code>在内存存储数据情况下，单线程就是最佳的方案</code>。</p>
<h1 id="Redis-数据类型"><a href="#Redis-数据类型" class="headerlink" title="Redis 数据类型"></a>Redis 数据类型</h1><p>​		官方说明：Redis 是一个开源（BSD许可），内存存储的数据结构服务器，可用作<code>数据库</code>，<code>高速缓存</code>和<code>消息队列</code>代理。它支持<code>字符串</code>、<code>哈希表</code>、<code>列表</code>、<code>集合</code>、<code>有序集合</code>，<code>位图</code>，<code>hyperloglogs</code> 等数据类型。Redis 内置复制、Lua 脚本、LRU 收回、事务以及不同级别磁盘持久化功能，同时通过 Redis Sentinel 提供高可用，通过 Redis Cluster 提供自动分区（集群搭建）。</p>
<h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><p>​		除了一些基本的命令外，String 还有一些常用的命令：</p>
<p>1、<code>append</code>  追加 key 对应的 value，如果 key 不存在，则新建一个 key。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; append key1 hello</span><br><span class="line">(integer) 11		# 返回当前该 key 的 value 的长度</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;key1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line">&quot;value1hello&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当 key 不存在时，新建</span></span><br><span class="line">127.0.0.1:6379&gt; append name zhangsan</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;zhangsan&quot;</span><br></pre></td></tr></table></figure>

<p>2、<code>strlen</code>  获取某个 key 对应 value 字符串长度。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; strlen key1</span><br><span class="line">(integer) 19</span><br></pre></td></tr></table></figure>

<p>3、自加 1 和 自减 1 操作，支持设置步长 step 指定增量。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自加 1 操作：incr</span></span><br><span class="line">127.0.0.1:6379&gt; set view 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; incr view</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; incr view</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自减 1 操作：decr</span></span><br><span class="line">127.0.0.1:6379&gt; decr view</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; decr view</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自加 step 操作：incrby</span></span><br><span class="line">127.0.0.1:6379&gt; incrby view 10</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; incrby view 10</span><br><span class="line">(integer) 20</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">自减 step 操作：decrby</span></span><br><span class="line">127.0.0.1:6379&gt; decrby view 2</span><br><span class="line">(integer) 18</span><br><span class="line">127.0.0.1:6379&gt; decrby view 2</span><br><span class="line">(integer) 16</span><br><span class="line">127.0.0.1:6379&gt; decrby view 2</span><br><span class="line">(integer) 14</span><br></pre></td></tr></table></figure>

<p>4、字符串范围操作，例如截取字符串。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">截取字符串，闭区间 [] 截取</span></span><br><span class="line">127.0.0.1:6379&gt; set name &quot;hello,gaozheng&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; getrange name 0 4</span><br><span class="line">&quot;hello&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-1 代表截取所有，和 java 一样</span></span><br><span class="line">127.0.0.1:6379&gt; getrange name 0 -1</span><br><span class="line">&quot;hello,gaozheng&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">替换字符串，从指定位置开始的字符串，替换 n 个字符串</span></span><br><span class="line">127.0.0.1:6379&gt; setrange name 6 xxxx</span><br><span class="line">(integer) 14</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;hello,xxxxheng&quot;</span><br></pre></td></tr></table></figure>

<p>5、<code>setex</code> 插值时设置过期时间。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setex dbname 30 &quot;redis&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">key 为 dbname，过期时间为 30 s， value 为 redis</span></span><br></pre></td></tr></table></figure>

<p>6、<code>setnx</code> 当值不存在时设置值，分布式锁中经常使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set dbname &quot;redis&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; setnx dbname &quot;mongoDb&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; get dbname</span><br><span class="line">&quot;redis&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现该键存在因此插入失败，返回 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量按条件设置</span></span><br><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k3&quot;</span><br><span class="line">3) &quot;k1&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果不存在，则设置 =====&gt; mset 保证原子性</span></span><br><span class="line">127.0.0.1:6379&gt; msetnx k1 v1 k4 v4</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k3&quot;</span><br><span class="line">3) &quot;k1&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现虽然 k4 不存在，但是并没有操作成功 =====&gt; 原子性操作：同时失败</span></span><br></pre></td></tr></table></figure>

<p>7、对象 json 字符串类型的 value 操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式一：直接存储对象</span></span><br><span class="line">127.0.0.1:6379&gt; set user:1 &#123;name:zhangsan,age:3&#125;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k3&quot;</span><br><span class="line">3) &quot;user:1&quot;</span><br><span class="line">4) &quot;k1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get user:1</span><br><span class="line">&quot;&#123;name:zhangsan,age:3&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式二：通过 ： 来确定属性 ，使用 mset 进行插入，这是 redis 的一个巧妙设计之处 user:&#123;<span class="built_in">id</span>&#125;:&#123;field&#125;</span></span><br><span class="line">127.0.0.1:6379&gt; mset  user:1:name lisi user:1:age 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;user:1:name&quot;</span><br><span class="line">2) &quot;user:1:age&quot;</span><br><span class="line">127.0.0.1:6379&gt; mget user:1:name user:1:age</span><br><span class="line">1) &quot;lisi&quot;</span><br><span class="line">2) &quot;100&quot;</span><br></pre></td></tr></table></figure>

<p>8、<code>getset</code> 先 get 再 set。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当没有这个 key 时，getset 会先返回当前的存放 null，再插入数据</span></span><br><span class="line">127.0.0.1:6379&gt; getset db redis</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line">&quot;redis&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当有这个 key 时，getset 会先返回当前的存放的 value，再插入新的 value</span></span><br><span class="line">127.0.0.1:6379&gt; getset db mongodb</span><br><span class="line">&quot;redis&quot;</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line">&quot;mongodb&quot;</span><br></pre></td></tr></table></figure>

<h2 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h2><p>​		在 Redis 中，可以经过规则定义将 List 当成 栈、队列、阻塞队列 使用，里面存放的都是字符串。（<code>所有的List 命令都是以 l 开头</code>）</p>
<p>List 实际上是一个<code>链表</code>，before Node after , left, right 都可以插入值，在两边插入或者改动值，效率最高，修改中间元素，效率相对较低。</p>
<p>1、插入的相关操作：<code>lpush</code>、<code>rpush</code></p>
<p>​		（1）<code>lpush</code> 从列表头部插入（从左边插入），类似于：wangwu lisi zhangsan。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush name zhangsan</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush name lisi</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush name wangwu</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;wangwu&quot;</span><br><span class="line">2) &quot;lisi&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br></pre></td></tr></table></figure>

<p>​		（2）<code>rpush</code> 从列表的尾部插入（从右边插入），类似于：wangwu lisi zhangsan lalala。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush name lalala</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;wangwu&quot;</span><br><span class="line">2) &quot;lisi&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br><span class="line">4) &quot;lalala&quot;</span><br></pre></td></tr></table></figure>

<p>​		因此整个列表就相当于是一个 ”<code>双端队列</code>“。</p>
<p>​		（3）批量插入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush name hello hello1 hello2 hello3 hello4 hello5</span><br><span class="line">(integer) 6</span><br></pre></td></tr></table></figure>

<p>2、查询的相关操作：<code>lrange</code>、<code>lindex</code>、<code>len</code>。</p>
<p>​		（1）查找列表具体区间的值（从左边开始计数）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange name 0 1</span><br><span class="line">1) &quot;wangwu&quot;</span><br><span class="line">2) &quot;lisi&quot;</span><br></pre></td></tr></table></figure>

<p>​		（2）通过下标获取值（从左边开始计数）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lindex name 0</span><br><span class="line">&quot;wangwu&quot;</span><br></pre></td></tr></table></figure>

<p>​		（3）获取列表长度。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; llen name</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>

<p>3、移除的相关操作：<code>lpop</code>、<code>rpop</code>、<code>lrem</code>、<code>ltrim</code>。</p>
<p>​		（1）<code>lpop</code> 从列表的头部移除（从左边移除），返回移除的元素.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpop name 1</span><br><span class="line">1) &quot;wangwu&quot;</span><br></pre></td></tr></table></figure>

<p>​		（2）<code>rpop</code> 从列表的尾部移除（从右边移除），返回移除的元素.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpop name 1</span><br><span class="line">1) &quot;lalala&quot;</span><br></pre></td></tr></table></figure>

<p>​		（3）移除指定的值，这个 1 代表移除的个数(表示 <code>list 内部可以有重复值</code>)，返回移除的个数 &lt;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; <code>精确匹配</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrem name 1 lisi</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>​		（4）截断操作，保留截取的部分（从左到右计数）.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush name hello hello1 hello2 hello3 hello4 hello5</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;hello5&quot;</span><br><span class="line">2) &quot;hello4&quot;</span><br><span class="line">3) &quot;hello3&quot;</span><br><span class="line">4) &quot;hello2&quot;</span><br><span class="line">5) &quot;hello1&quot;</span><br><span class="line">6) &quot;hello&quot;</span><br><span class="line">127.0.0.1:6379&gt; ltrim name 1 4</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;hello4&quot;</span><br><span class="line">2) &quot;hello3&quot;</span><br><span class="line">3) &quot;hello2&quot;</span><br><span class="line">4) &quot;hello1&quot;</span><br></pre></td></tr></table></figure>

<p>​		（5）移除列表<code>最后一个元素（尾部元素）</code>并添加到新列表（数据的转移），返回移除的元素。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpoplpush name newName</span><br><span class="line">&quot;hello1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;hello4&quot;</span><br><span class="line">2) &quot;hello3&quot;</span><br><span class="line">3) &quot;hello2&quot;</span><br><span class="line">127.0.0.1:6379&gt; lrange newName 0 -1</span><br><span class="line">1) &quot;hello1&quot;</span><br></pre></td></tr></table></figure>

<p>4、其他相关操作：<code>exists</code>、<code>lset</code>、<code>linsert</code>。</p>
<p>​		（1）判断某个 list 存在与否：exists.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; exists name</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>​		（2）根据索引插入数据（类似于更新操作），当索引不存在时，会报错。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lset name 0 zhangsan	# lset 需要保证列表存在</span><br><span class="line">(error) ERR no such key</span><br><span class="line">127.0.0.1:6379&gt; lpush name zhangsan		# 插入数据保证 list 存在</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; lset name 0 lisi		# lset 插入</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;lisi&quot;</span><br></pre></td></tr></table></figure>

<p>​		（3）在某位置插入新的数据：linsert 命令，可选 before（前）、after（后）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">语法：linsert key before/after pivot element</span></span><br><span class="line">127.0.0.1:6379&gt; lpush name zhangsan</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush name wangwu</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; linsert name before zhangsan lisi</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange name 0 -1</span><br><span class="line">1) &quot;wangwu&quot;</span><br><span class="line">2) &quot;lisi&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br></pre></td></tr></table></figure>

<p>列表的应用举例：消息排队、消息队列（Lpush Rpop）、栈（Lpush Lpop）。</p>
<h2 id="Set-集合"><a href="#Set-集合" class="headerlink" title="Set 集合"></a>Set 集合</h2><p>​		Redis 的 Set 是 String 类型的<code>无序集合</code>，集合成员唯一，意味着集合中<code>不能出现重复的数据</code>。Redis 中 集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。</p>
<p>1、基本的操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量插入数据到 <span class="built_in">set</span></span></span><br><span class="line">127.0.0.1:6379&gt; sadd myset zhangsan lisi wangwu</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加重复元素发现失败：</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myset wangwu</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询 <span class="built_in">set</span> 里面的所有数据</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) &quot;lisi&quot;</span><br><span class="line">2) &quot;wangwu&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断 <span class="built_in">set</span> 中是否包含某个成员，1 表示是，0 表示不是</span></span><br><span class="line">127.0.0.1:6379&gt; sismember myset wangwu</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取 <span class="built_in">set</span> 集合中的个数</span></span><br><span class="line">127.0.0.1:6379&gt; scard myset</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除 <span class="built_in">set</span> 集合某个元素，移除成功返回 1，移除不存在的或者失败的返回 0</span></span><br><span class="line">127.0.0.1:6379&gt; srem myset zhangsan</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>2、特殊操作：由于 set 中数据无序且不重复 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 可以随机的得到或删除值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机获取 <span class="built_in">set</span> 中的一个值</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line">&quot;lisi&quot;</span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line">&quot;wangwu&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机获取 <span class="built_in">set</span> 中的指定个数的值</span></span><br><span class="line">srandmember myset number</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">随机移除元素</span></span><br><span class="line">spop myset</span><br><span class="line">spop myset number</span><br></pre></td></tr></table></figure>

<p>3、<code>smove</code> 值的移动：将一个 set 的一个成员移动到另一个 set。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset1 zhangsan lisi wangwu</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 666</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smove myset1 myset2 lisi</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset1</span><br><span class="line">1) &quot;wangwu&quot;</span><br><span class="line">2) &quot;zhangsan&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers myset2</span><br><span class="line">1) &quot;lisi&quot;</span><br><span class="line">2) &quot;666&quot;</span><br></pre></td></tr></table></figure>

<p>4、两个 set 的数字集合类：交集、并集、差集。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset1 a b c d</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; sadd myset2 c d e f</span><br><span class="line">(integer) 4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">求 myset1 和 myset2 的差集，以前面的 <span class="built_in">set</span> 为标准，此例为 myset1</span></span><br><span class="line">127.0.0.1:6379&gt; sdiff myset1 myset2</span><br><span class="line">1) &quot;b&quot;</span><br><span class="line">2) &quot;a&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">求 myset1 和 myset2 的交集</span></span><br><span class="line">127.0.0.1:6379&gt; sinter myset1 myset2</span><br><span class="line">1) &quot;d&quot;</span><br><span class="line">2) &quot;c&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">求 myset1 和 myset2 的并集</span></span><br><span class="line">127.0.0.1:6379&gt; sunion myset1 myset2</span><br><span class="line">1) &quot;d&quot;</span><br><span class="line">2) &quot;c&quot;</span><br><span class="line">3) &quot;a&quot;</span><br><span class="line">4) &quot;b&quot;</span><br><span class="line">5) &quot;e&quot;</span><br><span class="line">6) &quot;f&quot;</span><br></pre></td></tr></table></figure>

<p> set 的应用：微博、b站关注的人放在 set，其粉丝也放于 set &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>共同关注</code>、共同爱好、推荐好友。</p>
<h2 id="Hash-集合"><a href="#Hash-集合" class="headerlink" title="Hash 集合"></a>Hash 集合</h2><p>​		Hash 集合类型： <code>key-Map</code> 类型，value 是 Map 类型。</p>
<p>1、设置和获取值的操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将哈希表 key 中的字段 field 的值设为 value ，重复设置同一个 field 会`覆盖`</span></span><br><span class="line">127.0.0.1:6379&gt; hset myhash name zhangsan</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取 <span class="built_in">hash</span> 某个 key 的值</span></span><br><span class="line">127.0.0.1:6379&gt; hget myhash name</span><br><span class="line">&quot;zhangsan&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量设置值和获取值</span></span><br><span class="line">127.0.0.1:6379&gt; hmset hash1 name zhangsan age 18 sex men</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget hash1 name age sex</span><br><span class="line">1) &quot;zhangsan&quot;</span><br><span class="line">2) &quot;18&quot;</span><br><span class="line">3) &quot;men&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取哈希表中所有的 key 和 value</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall hash1</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">2) &quot;zhangsan&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;18&quot;</span><br><span class="line">5) &quot;sex&quot;</span><br><span class="line">6) &quot;men&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取 哈希表中所有的 key（字段）</span></span><br><span class="line">127.0.0.1:6379&gt; hkeys hash1</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">2) &quot;age&quot;</span><br><span class="line">3) &quot;sex&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取哈希表中 key 字段的个数</span></span><br><span class="line">127.0.0.1:6379&gt; hlen hash1</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取哈希表中所有的值</span></span><br><span class="line">127.0.0.1:6379&gt; hvals hash1</span><br><span class="line">1) &quot;zhangsan&quot;</span><br><span class="line">2) &quot;18&quot;</span><br><span class="line">3) &quot;men&quot;</span><br></pre></td></tr></table></figure>

<p>2、移除字段的操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量删除字段</span></span><br><span class="line">127.0.0.1:6379&gt; hdel hash1 name age</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; hkeys hash1</span><br><span class="line">1) &quot;sex&quot;</span><br></pre></td></tr></table></figure>

<p>3、条件插入和判断：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">判断指定字段是否存在，存在返回 1</span></span><br><span class="line">127.0.0.1:6379&gt; hexists hash1 name</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">只有在该字段不存在时，才设置哈希表字段的值。</span></span><br><span class="line">127.0.0.1:6379&gt; hsetnx hash1 name lisi		# 已经存在该字段，设置失败返回 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; hsetnx hash1 hobby games	# 不存在该字段，设置成功返回 1</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>4、增量操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为哈希表 key 中的指定字段的`整数值`加上增量n，并返回增量后结果，只适用于整数型字段</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">语法：hincrby key field number</span></span><br><span class="line">127.0.0.1:6379&gt; hget hash1 age</span><br><span class="line">&quot;18&quot;</span><br><span class="line">127.0.0.1:6379&gt; hincrby hash1 age 1</span><br><span class="line">(integer) 19</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为哈希表 key 中的指定字段的`浮点数值`加上增量 n。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">语法：hincrbyfloat key field number</span></span><br></pre></td></tr></table></figure>

<p>Hash 适合存储变更的数据 user name age，尤其是用户信息之类的，经常变动的信息。&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>Hash 更适合于对象的存储，Sring 更加适合字符串存储！</code>。</p>
<h2 id="Zset-有序集合"><a href="#Zset-有序集合" class="headerlink" title="Zset 有序集合"></a>Zset 有序集合</h2><p>​		在一般的 set 基础上，增加了一个 double 类型的分数（<code>score</code>），用此来进行排序，当 score 相同时，用字典序排序。</p>
<p>1、添加操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">语法：zadd key score value</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一个值</span></span><br><span class="line">127.0.0.1:6379&gt; zadd zset01 1 one</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量添加</span></span><br><span class="line">127.0.0.1:6379&gt; zadd zset01 2 two 3 three</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure>

<p>2、查询操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据范围查询 value</span></span><br><span class="line">127.0.0.1:6379&gt; zrange zset01 0 -1</span><br><span class="line">1) &quot;one&quot;</span><br><span class="line">2) &quot;two&quot;</span><br><span class="line">3) &quot;three&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询成员数量</span></span><br><span class="line">127.0.0.1:6379&gt; zcard zset01</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<p>3、排序操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">zrange 查询默认是按照从小到大排序</span></span><br><span class="line">127.0.0.1:6379&gt; zadd salary 2500 xiaohong</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 2000 zhangsan</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 3000 lisi</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd salary 500 laji</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange salary 0 -1</span><br><span class="line">1) &quot;laji&quot;</span><br><span class="line">2) &quot;zhangsan&quot;</span><br><span class="line">3) &quot;xiaohong&quot;</span><br><span class="line">4) &quot;lisi&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从大到小降序排列</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange salary 0 -1 withscores</span><br><span class="line">1) &quot;lisi&quot;</span><br><span class="line">2) &quot;3000&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br><span class="line">4) &quot;2000&quot;</span><br><span class="line">5) &quot;laji&quot;</span><br><span class="line">6) &quot;500&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">带上分数排序：根据分数排序 zrangebyscore</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf +inf withscores</span><br><span class="line">1) &quot;laji&quot;</span><br><span class="line">2) &quot;500&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br><span class="line">4) &quot;2000&quot;</span><br><span class="line">5) &quot;xiaohong&quot;</span><br><span class="line">6) &quot;2500&quot;</span><br><span class="line">7) &quot;lisi&quot;</span><br><span class="line">8) &quot;3000&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示工资小于 2500 的员工升序</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore salary -inf 2500 withscores</span><br><span class="line">1) &quot;laji&quot;</span><br><span class="line">2) &quot;500&quot;</span><br><span class="line">3) &quot;zhangsan&quot;</span><br><span class="line">4) &quot;2000&quot;</span><br><span class="line">5) &quot;xiaohong&quot;</span><br><span class="line">6) &quot;2500&quot;</span><br></pre></td></tr></table></figure>

<p>4、移除操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">移除某一个具体的成员</span></span><br><span class="line">127.0.0.1:6379&gt; zrem salary xiaohong</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>5、统计操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd zset1 1 hello 2 world 3 caixukun</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取区间内的成员数量</span></span><br><span class="line">127.0.0.1:6379&gt; zcount zset1 1 3</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<p>应用案例：班级表排序、工资表排序、消息分级（普通消息1、重要消息 2）、<code>排行榜 Top N</code>。</p>
<h2 id="Geospatial-地理位置"><a href="#Geospatial-地理位置" class="headerlink" title="Geospatial 地理位置"></a>Geospatial 地理位置</h2><p>​		经纬度查询网站：<code>https://jingweidu.bmcx.com/</code>。</p>
<p>作用： 可以实现推算地理位置信息，两地举例等，完成 <code>附近的人</code> 功能。</p>
<p>1、<code>getadd</code> 添加位置：（注意<code>两极</code>是无法添加的）。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">批量添加位置语法：geoadd key longitud(经度) latitude(纬度) member [..]</span></span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.40 39.90 beijing</span><br><span class="line">(integer) 1</span><br><span class="line">...........</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 120.16 30.24 hangzhou 108.96 34.26 xian</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>有效的经度从 -180度到180度，有效的纬度从 -85.05112878 度到 85.05112878 度。</p>
</blockquote>
<p>2、<code>geopos</code> 获取指定位置的经纬度位置(之前设置进去的)。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询 beijing 的地理位置</span></span><br><span class="line">127.0.0.1:6379&gt; geopos china:city beijing</span><br><span class="line">1) 1) &quot;116.39999896287918091&quot;</span><br><span class="line">   2) &quot;39.90000009167092543&quot;</span><br></pre></td></tr></table></figure>

<p>3、<code>geodist</code> 可用于获取两个经纬度位置的直线距离。&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>两人之间的距离的实现</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认单位是 米</span></span><br><span class="line">127.0.0.1:6379&gt; geodist china:city shenzhen shanghai</span><br><span class="line">&quot;1215922.3698&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可设置单位为 km，mi(英里)，ft(英尺)</span></span><br><span class="line">127.0.0.1:6379&gt; geodist china:city shenzhen shanghai km</span><br><span class="line">&quot;1215.9224&quot;</span><br></pre></td></tr></table></figure>

<p>4、<code>georadius</code> 用于以给定的经纬度为中心，找出某一半径内的其他元素。</p>
<p>​		附近的人如何实现呢？通过<code>半径</code>来搜索，前提是地理位置存在于这个 key 内。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km</span><br><span class="line">1) &quot;chongqing&quot;</span><br><span class="line">2) &quot;xian&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km withcoord</span><br><span class="line">1) 1) &quot;chongqing&quot;</span><br><span class="line">   2) 1) &quot;106.49999767541885376&quot;</span><br><span class="line">      2) &quot;29.52999957900659211&quot;</span><br><span class="line">2) 1) &quot;xian&quot;</span><br><span class="line">   2) 1) &quot;108.96000176668167114&quot;</span><br><span class="line">      2) &quot;34.25999964418929977&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">withcoord 显示目标经纬度</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">withdist 显示到中心的直线距离</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">count number 指定数量</span></span><br></pre></td></tr></table></figure>

<p>5、<code>georadiusbymember</code> 根据给定的地理位置为中心，找出某一半径内的其他元素。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city beijing 1000 km</span><br><span class="line">1) &quot;beijing&quot;</span><br><span class="line">2) &quot;xian&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：包括了自身</span></span><br></pre></td></tr></table></figure>

<p>6、<code>geohash</code> 返回 11 个字符的经纬度转化为  geohash 字符串。（<code>没用</code>）</p>
<p>实际上，这个数据类型就是 zset，可以直接使用 zset 的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) &quot;chongqing&quot;</span><br><span class="line">2) &quot;xian&quot;</span><br><span class="line">3) &quot;shenzhen&quot;</span><br><span class="line">4) &quot;hangzhou&quot;</span><br><span class="line">5) &quot;shanghai&quot;</span><br><span class="line">6) &quot;beijing&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他命令也可以使用</span></span><br></pre></td></tr></table></figure>

<h2 id="Hyperloglog-基数统计"><a href="#Hyperloglog-基数统计" class="headerlink" title="Hyperloglog 基数统计"></a>Hyperloglog 基数统计</h2><p>​		什么是<code>基数</code>：数据集中<code>不重复的元素</code>的个数。</p>
<p>​		<code>Redis HyperLogLog</code> 是用来做<code>基数统计的算法</code>，计算基数所需的空间总是固定很小的。花费 12 KB 内存，就可以计算接近 2^64 个不同元素的基数。</p>
<p>因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<p>其底层使用string数据类型</p>
<p>应用场景：网页的 UV（访问量统计：一个人访问同一个网站多次，也只能算作一个）</p>
<p>1）传统方式：使用 Set 保存用户的 id，以 id 个数作为标准判断。 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 占用内存大。</p>
<p>2）新方法：使用 HyperLogLog 算法，利用 <code>pfadd</code>、<code>pfcount</code>、<code>pfmerge</code> 命令可以实现只占用最大 12k 的内存就能完成基数统计。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd mykey a b c d e f		# 创建第一组元素</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount mykey		# 统计基数数量</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; pfadd mykey2 e f g h i j</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount mykey2</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; pfmerge mykey3 mykey mykey2		# 合并两组成为 mykey3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount mykey3</span><br><span class="line">(integer) 10</span><br></pre></td></tr></table></figure>

<p>如果允许容错，那么可以使用 Hyperloglog ，不允许容错，就使用 set 或者自己的数据类型即可 。</p>
<h2 id="Bitmaps-位图"><a href="#Bitmaps-位图" class="headerlink" title="Bitmaps 位图"></a>Bitmaps 位图</h2><p>​		信息状态就只有两个状态的：1 和 0，那么就可以使用 Bitmaps，操作二进制位来记录，只有 1 和 0 两个状态。</p>
<p>应用场景：统计用户信息：活跃 和 不活跃？ 登录 和 未登录？打卡 和 未打卡？例如 365 天打卡，只需要 365 bit &#x3D; 46 字节。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">举例：以一周打卡为例，1 代表签到 0 代表未签到</span></span><br><span class="line">127.0.0.1:6379&gt; setbit sign 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 2 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 3 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 4 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 5 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 6 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 7 1</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这样的话组成的就像是：1 1 0 0 1 1 1 一共 7bit，存储空间占用少</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">那么如何查看某一天是否打卡呢？ getbit 方法</span></span><br><span class="line">127.0.0.1:6379&gt; getbit sign 4</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">那么怎么统计打卡的参数呢？bitcount 方法</span></span><br><span class="line">127.0.0.1:6379&gt; bitcount sign</span><br><span class="line">(integer) 5</span><br></pre></td></tr></table></figure>

<h1 id="Redis-事务"><a href="#Redis-事务" class="headerlink" title="Redis 事务"></a>Redis 事务</h1><blockquote>
<p>Redis 事务的本质：一组命令的集合，<code>类似于一个队列</code>。</p>
<p>​			类同于：set 语句 	set 语句	 set 语句 (执行)</p>
<p>事务中每条命令都会被序列化，执行过程中按顺序执行，不允许其他命令进行干扰。</p>
<p>对应着：			<code>一次性</code>							<code>顺序性</code>								<code>排他性</code></p>
<p><code>注意</code>：（必须知道）</p>
<p>1）Redis 事务没有隔离级别的概念，所有的命令在事务中并没有被执行，只有发起执行命令时才会统一执行 <code>Exec</code>。</p>
<p>2）Redis 的<code>单条命令是保证原子性的</code>，但是 <code>Redis 事务不能保证原子性</code>。</p>
</blockquote>
<p>Redis 的事务三步骤：1）开启事务(<code>multi</code>)；2）命令入队(<code>正常命令</code>)；3）执行事务(<code>exec</code>)</p>
<h2 id="正常执行事务"><a href="#正常执行事务" class="headerlink" title="正常执行事务"></a>正常执行事务</h2><blockquote>
<p>正常情况下，会按照顺序，一次性且不会相互影响的执行事务。当<code>这个事务执行完毕后就释放了</code>，再需要用就需要重新开启。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启事务，开启后数据库会标记为 TX，代表事务</span></span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令入队</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令入队</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令入队</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; get k2</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令入队</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; set k3 v3</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行事务</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) &quot;v2&quot;</span><br><span class="line">4) OK</span><br></pre></td></tr></table></figure>

<h2 id="放弃事务"><a href="#放弃事务" class="headerlink" title="放弃事务"></a>放弃事务</h2><blockquote>
<p>放弃事务：放弃事务后<code>这个事务队列的所有命令都不会执行</code>了。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k4 v4 </span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; discard		# 取消事务</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k4</span><br><span class="line">(nil)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">证明放弃事务后，<span class="built_in">set</span> k4 v4 并没有得到执行</span></span><br></pre></td></tr></table></figure>

<h2 id="事务错误"><a href="#事务错误" class="headerlink" title="事务错误"></a>事务错误</h2><p>1、编译时异常：代码语法错误，导致所有的命令都不会执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; error k1</span><br><span class="line">(error) ERR unknown command &#x27;error&#x27;, with args beginning with: &#x27;k1&#x27; </span><br><span class="line">127.0.0.1:6379(TX)&gt; get k2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; get k1		# 发现这个事务队列的命令全部没有执行</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<p>2、运行时异常：代码逻辑错误，其他命令可以正常执行。 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>此处就说明了 Redis 事务并不能保证原子性</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; incr k1		# 字符串不能自增 1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; discard</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k1 &quot;v1&quot;</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incr k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; set k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; get k3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) (error) ERR value is not an integer or out of range		# 由于字符串自增 1 报错</span><br><span class="line">3) OK</span><br><span class="line">4) OK</span><br><span class="line">5) &quot;v3&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">发现其中有命令报错，但是其他命令正常执行 =====&gt; 没有原子性</span></span><br></pre></td></tr></table></figure>

<h2 id="Redis-乐观锁"><a href="#Redis-乐观锁" class="headerlink" title="Redis 乐观锁"></a>Redis 乐观锁</h2><blockquote>
<p><code>悲观锁</code>直接上锁再处理数据，很影响性能，而<code>乐观锁</code>只会在更新数据的时候去判断在此期间是否有人修改过这个数据(<code>version 字段</code>)</p>
</blockquote>
<p>​		Redis 使用 <code>watch key</code> 监控指定数据，相当于使用<code>乐观锁</code>加锁。</p>
<p>1、单客户端情况下，事务过程中正常执行，期间数据没有发生变动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">1) (integer) 80</span><br><span class="line">2) (integer) 20</span><br></pre></td></tr></table></figure>

<p>2、多个客户端同时操作情况下，</p>
<p>客户端 1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这一步等到 客户端 2 修改后再执行提交事务（原本的数据发生了变化）</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; exec</span><br><span class="line">(nil)		# 返回 nil 就代表事务提交失败，命令未执行成功</span><br></pre></td></tr></table></figure>

<p>客户端 2 ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get money</span><br><span class="line">&quot;100&quot;</span><br><span class="line">127.0.0.1:6379&gt; set money 1000</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>需要注意的是，<code>用完了 watch 监视，需要解锁</code>：（相当于放弃之前的 version 版本，获取最新的 version)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unwatch</span><br></pre></td></tr></table></figure>

<h1 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h1><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>​		Jedis 是 Redis 官方推荐使用的 Java 连接 Redis 的客户端。</p>
<p>1、创建一个 maven 项目，导入 jedis 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--导入jedis的包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--fastjson--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.70<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、建立测试程序，连接远程的 Redis-Server 服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPing</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//准备远程连接</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;8.142.92.222&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//设置权限密码</span></span><br><span class="line">        jedis.auth(<span class="string">&quot;gaozheng1998&quot;</span>);</span><br><span class="line">        <span class="comment">//进行连通性检查</span></span><br><span class="line">        System.out.println(<span class="string">&quot;jedis.ping() = &quot;</span> + jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果为 pong，证明连同。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jedis.ping() = PONG</span><br></pre></td></tr></table></figure>

<p>3、使用 jedis 进行 redis 的基本操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestKeyExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//准备远程连接</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;8.142.92.222&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//设置权限密码</span></span><br><span class="line">        jedis.auth(<span class="string">&quot;gaozheng1998&quot;</span>);</span><br><span class="line">        <span class="comment">//进行连通性检查</span></span><br><span class="line">        System.out.println(<span class="string">&quot;jedis.ping() = &quot;</span> + jedis.ping());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;清空数据库 —— &quot;</span> + jedis.flushAll());</span><br><span class="line">        System.out.println(<span class="string">&quot;判断某个键是否存在 —— &quot;</span>+jedis.exists(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;新增&lt;name:gaozheng&gt; ——&quot;</span>+jedis.set(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;gaozheng&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;新增&lt;password:gaozheng1998&gt; ——&quot;</span>+jedis.set(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;gaozheng1998&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;系统中所有的键 ——&quot;</span> +jedis.keys(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;删除 password 的键值对 ——&quot;</span>+jedis.del(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;查看键 username 所存储值的类型 --&quot;</span> + jedis.type(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;随即返回 key 中的一个 --&quot;</span> + jedis.randomKey());</span><br><span class="line">        System.out.println(<span class="string">&quot;重命名 key --&quot;</span> + jedis.rename(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;username&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;取出改后的 name --&quot;</span> + jedis.get(<span class="string">&quot;username&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;按索引查询 --&quot;</span> + jedis.select(<span class="number">0</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;删除当前数据库的所有 key --&quot;</span> + jedis.flushDB());</span><br><span class="line">        System.out.println(<span class="string">&quot;当前数据库的 key 的数目--&quot;</span> + jedis.dbSize());</span><br><span class="line">        System.out.println(<span class="string">&quot;清空数据库 —— &quot;</span> + jedis.flushAll());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>总结：实际上使用 Jedis 就和之前使用命令行客户端没有区别，没有很大变化，<code>基本一模一样</code>。</p>
</blockquote>
<h2 id="事务操作"><a href="#事务操作" class="headerlink" title="事务操作"></a>事务操作</h2><p>​		事务操作命令和之前控制台操作并没有区别，使用 <code>multi 开启事务</code>，<code>exec 执行事务</code>，<code>discard 取消事务</code>。</p>
<p>1、正常情况下，没有任何异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTX</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//连接远程 redis</span></span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;8.142.92.222&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;gaozheng1998&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//开启事务,获取事务对象</span></span><br><span class="line">        <span class="type">Transaction</span> <span class="variable">multi</span> <span class="operator">=</span> jedis.multi();</span><br><span class="line">        <span class="comment">//具体业务</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;Hello,World&quot;</span>);</span><br><span class="line">        jsonObject.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;gaozheng&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> jsonObject.toJSONString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            multi.set(<span class="string">&quot;user1&quot;</span>, result);</span><br><span class="line">            multi.set(<span class="string">&quot;user2&quot;</span>, result);</span><br><span class="line">            <span class="comment">//执行操作</span></span><br><span class="line">            multi.exec();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">//执行失败则事务放弃</span></span><br><span class="line">            multi.discard();</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//关闭连接</span></span><br><span class="line">            System.out.println(<span class="string">&quot;user1&quot;</span> + jedis.get(<span class="string">&quot;user1&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;user2&quot;</span> + jedis.get(<span class="string">&quot;user2&quot;</span>));</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user1&#123;&quot;name&quot;:&quot;gaozheng&quot;,&quot;message&quot;:&quot;Hello,World&quot;&#125;</span><br><span class="line">user2&#123;&quot;name&quot;:&quot;gaozheng&quot;,&quot;message&quot;:&quot;Hello,World&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>正常情况下，事务正常提交，数据正常存储。</p>
<p>2、当在代码中模拟一个 <code>1/0 异常</code>，则就会抛出异常，事务执行失败，会走取消事务 discard 代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">multi.set(<span class="string">&quot;user1&quot;</span>, result);</span><br><span class="line">multi.set(<span class="string">&quot;user2&quot;</span>, result);</span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;		<span class="comment">// 设置异常情况</span></span><br><span class="line"><span class="comment">//执行操作</span></span><br><span class="line">multi.exec();</span><br></pre></td></tr></table></figure>

<p>结果则会是存储失败，同时还会抛出异常：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">java.lang.ArithmeticException: / <span class="title">by</span> <span class="title">zero</span> <span class="title">at</span> <span class="title">com.example.TestTX.main</span>(<span class="title">TestTX.java</span>:25)</span></span><br><span class="line"><span class="function"><span class="title">user1null</span></span></span><br><span class="line"><span class="function"><span class="title">user2null</span></span></span><br></pre></td></tr></table></figure>

<h1 id="SpringBoot-整合-Redis"><a href="#SpringBoot-整合-Redis" class="headerlink" title="SpringBoot 整合 Redis"></a>SpringBoot 整合 Redis</h1><p>Springboot 操作数据都是<code>使用 Spring Data</code>：可以整合众多的 SQL 和 NoSQL 数据库（其中包括 Redis）。</p>
<h2 id="Redis-整合"><a href="#Redis-整合" class="headerlink" title="Redis 整合"></a>Redis 整合</h2><p>需要的 Redis 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但实际上，这个依赖包括三个依赖部分：boot-starter、redis、<code>lettuce</code>(替换原来的 jedis)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：在 <code>SpringBoot 2.X</code> 之后，原来的<code>Jedis 被替换为了 lettuce</code>，因此默认导入的是 lettuce。</p>
<p><code>Jedis 和 lettuce 区别</code></p>
<p>Jedis ：采用的是<code>直连</code>的服务，如果有多个线程操作的话是不安全的，就需要使用 Jedis Pool 连接池取解决，问题就会比较多。 <code>BIO 模式</code></p>
<p>lettuce ：底层采用 <code>Netty</code> ，实例可以在多个线程中共享，不存在线程不安全的情况，可以减少线程数据了，性能更高。<code>NIO 模式</code></p>
</blockquote>
<p>​		根据之前的 SpringBoot 源码分析可以猜想，自动配置类是 <code>RedisAutoConfiguration</code>，属性配置文件是 <code>RedisProperties</code>，发现前缀是：“spring.redis”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RedisOperations.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RedisProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisAutoConfiguration</span> &#123;</span><br><span class="line">   <span class="comment">// 默认的 RedisTemplate 没有过多的设置，redis 对象都需要序列化</span></span><br><span class="line">   <span class="comment">//两个泛型都是 Object 类型，我们使用需要强转</span></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(name = &quot;redisTemplate&quot;)</span>	<span class="comment">//这个注解告诉我们可以自己定义一个 redisTemplate 来覆盖原有的默认 redisTemplate</span></span><br><span class="line">   <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">   <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<span class="comment">// 注意需要使用 redisTemplate 命名</span></span><br><span class="line">      RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">      template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">      <span class="keyword">return</span> template;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span>  <span class="comment">//由于 string 最常使用，因此单独提出了一个 bean：stringRedisTemplate</span></span><br><span class="line">   <span class="meta">@ConditionalOnSingleCandidate(RedisConnectionFactory.class)</span></span><br><span class="line">   <span class="keyword">public</span> StringRedisTemplate <span class="title function_">stringRedisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(redisConnectionFactory);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置 redis 服务的设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 配置 redis</span><br><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: <span class="number">8.142</span><span class="number">.92</span><span class="number">.222</span></span><br><span class="line">    port: <span class="number">6379</span></span><br><span class="line">    password: gaozheng1998</span><br></pre></td></tr></table></figure>

<p>redis 操作测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这就是之前 RedisAutoConfiguration 源码中的 Bean</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="comment">/** redisTemplate 操作不同的数据类型，API 和 Redis-cli 客户端中的是一样操作</span></span><br><span class="line"><span class="comment">	 * opsForValue 类似于 Redis 中的 String</span></span><br><span class="line"><span class="comment">	 * opsForList 类似于 Redis 中的 List</span></span><br><span class="line"><span class="comment">	 * opsForSet 类似于 Redis 中的 Set</span></span><br><span class="line"><span class="comment">	 * opsForHash 类似于 Redis 中的 Hash</span></span><br><span class="line"><span class="comment">	 * opsForZSet 类似于 Redis 中的 ZSet</span></span><br><span class="line"><span class="comment">	 * opsForGeo 类似于 Redis 中的 Geospatial 地图</span></span><br><span class="line"><span class="comment">	 * opsForHyperLogLog 类似于 Redis 中的 HyperLogLog</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 除了基本的操作，常用的命令都可以直接通过 redisTemplate 操作，比如事务、基本的 crud 等。</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 和数据库相关的操作都需要通过连接操作！</span></span><br><span class="line">	<span class="comment">//RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();</span></span><br><span class="line">	<span class="comment">//connection.flushDb();</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试</span></span><br><span class="line">	redisTemplate.opsForValue().set(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;呵呵&quot;</span>);</span><br><span class="line">	System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;key&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="序列化问题"><a href="#序列化问题" class="headerlink" title="序列化问题"></a>序列化问题</h2><p>​		使用默认的 序列化方式来测试存储 <code>对象</code> ，结果会怎样呢？</p>
<p>User：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootRedisApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;图图&quot;</span>,<span class="number">20</span>);</span><br><span class="line">        <span class="comment">// 真实开发一般是先转成 json 再存储</span></span><br><span class="line">        <span class="comment">// String jsonUser = new ObjectMapper().writeValueAsString(user);</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;user&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处未使用 json 序列化，则会直接报错：<code>SerializationException</code>。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">org.springframework.data.redis.serializer.SerializationException: <span class="title">Cannot</span> <span class="title">serialize</span>; <span class="title">nested</span> <span class="title">exception</span> <span class="title">is</span> <span class="title">org.springframework.core.serializer.support.SerializationFailedException</span>: <span class="title">Failed</span> <span class="title">to</span> <span class="title">serialize</span> <span class="title">object</span> <span class="title">using</span> <span class="title">DefaultSerializer</span>; <span class="title">nested</span> <span class="title">exception</span> <span class="title">is</span> <span class="title">java.lang.IllegalArgumentException</span>: <span class="title">DefaultSerializer</span> <span class="title">requires</span> <span class="title">a</span> <span class="title">Serializable</span> <span class="title">payload</span> <span class="title">but</span> <span class="title">received</span> <span class="title">an</span> <span class="title">object</span> <span class="title">of</span> <span class="title">type</span> [<span class="title">com.example.pojo.User</span>]</span></span><br></pre></td></tr></table></figure>

<p>所以一般的实体类都需要序列化。</p>
<h2 id="自定义-Redis-序列化"><a href="#自定义-Redis-序列化" class="headerlink" title="自定义 Redis 序列化"></a>自定义 Redis 序列化</h2><p>向数据库中插入了一个中文字符串，虽然在 Java 端可以看到返回了中文，但是在 Redis 中查看，发现 key 是乱码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\xac\xed\x00\x05t\x00\x03key&quot;</span><br></pre></td></tr></table></figure>

<p>原因：“<code>未序列化的结果</code>”，那么 redis 内部如何实现的序列化呢？</p>
<p>1、在 RedisAutoConfiguration 类的 redisTemplate 方法中用到了一个 RedisTemplate 的对象：</p>
<p><img src="https://www.freesion.com/images/54/95f7e455c15ad7200e961f94b7645d06.png" alt="在这里插入图片描述"></p>
<p>2、点进 redisTemplate ：</p>
<p><img src="https://www.freesion.com/images/23/bd12798c921f2f282149e5ac490738df.png" alt="在这里插入图片描述"></p>
<p>3、查看源码如何序列化的：使用 jdk 默认的序列化</p>
<p><img src="https://www.freesion.com/images/704/884a3d0aeb7e2da5d591fd76d2f88b10.png" alt="在这里插入图片描述"></p>
<p>而当使用默认的序列化方式时，即：implements Serializable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是发现结果仍然是乱码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get &quot;\xac\xed\x00\x05t\x00\x04user&quot;</span><br><span class="line">&quot;\xac\xed\x00\x05sr\x00\x15com.example.pojo.User\x95\xb3m\xea\xed\x80&lt;E\x02\x00\x02I\x00\x03ageL\x00\x04namet\x00\x12Ljava/lang/String;xp\x00\x00\x00\x14t\x00\x06\xe5\x9b\xbe\xe5\x9b\xbe&quot;</span><br></pre></td></tr></table></figure>

<p>因此需要自定义序列化方式，那么<code>如何自定义序列化方式</code>呢？</p>
<p>默认的序列化可能会使 JDK 转义，因此我们需要：JSON 序列化，所以就需要<code>自定义一个配置类 RedisConfig</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//编写自己的 redisTemplate：使用原来的作为基本模板进行修改</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> <span class="keyword">throws</span> UnknownHostException &#123;</span><br><span class="line">        <span class="comment">// 为了开发方便，直接使用 &lt;String, Object&gt; 类型</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Json 配置序列化</span></span><br><span class="line">        <span class="comment">// 使用 jackson 解析任意的对象</span></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(Object.class);</span><br><span class="line">        <span class="comment">// 使用 objectMapper 进行转义</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// String 的序列化</span></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分别设置各种对象的序列化方式</span></span><br><span class="line">        <span class="comment">// key 采用 String 的序列化方式</span></span><br><span class="line">        template.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// Hash 的 key 采用 String 的序列化方式</span></span><br><span class="line">        template.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// value 采用 jackson 的序列化方式</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// Hash 的 value 采用 jackson 的序列化方式</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// 把所有的配置 set 进 template</span></span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果发现：序列化乱码问题解决：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get user</span><br><span class="line">&quot;[\&quot;com.example.pojo.User\&quot;,&#123;\&quot;name\&quot;:\&quot;\xe5\x9b\xbe\xe5\x9b\xbe\&quot;,\&quot;age\&quot;:20&#125;]&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Redis-工具类"><a href="#Redis-工具类" class="headerlink" title="Redis 工具类"></a>Redis 工具类</h2><p>在企业中，基本都不会使用上面的原生的方式编写代码，而是会写一个 <code>RedisUtils</code> 工具类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================= common ============================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定缓存过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间 s</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">expire</span><span class="params">(String key, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(time &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                redisTemplate.expire(key,time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取缓存过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键，不能为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间(秒) 返回 0 代表永不过期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getExpire</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断某个 key 是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 代表存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasKey</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键，可能包含多个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delCache</span><span class="params">(String... key)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="literal">null</span> &amp;&amp; key.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (key.length == <span class="number">1</span>)&#123;</span><br><span class="line">                redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.delete((Collection&lt;String&gt;) CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================ String =============================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取普通缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(String key)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key == <span class="literal">null</span> ? <span class="literal">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置普通缓存数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 插入结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置普通缓存数据，并设置过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 过期时间，设置小于等于 0 ，则代表设置无限期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 设置结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">set</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递增</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要增加几（大于 0）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">increment</span><span class="params">(String key, <span class="type">long</span> delta)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;递增因子必须大于 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递减</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要减少几（大于 0）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">decrement</span><span class="params">(String key, <span class="type">long</span> delta)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;递减因子必须大于 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, -delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================ Map =================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashGet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">hget</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取hashKey对应的所有键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对应的多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title function_">hmget</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map 对应多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet 并设置时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map  对应多个键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hset</span><span class="params">(String key, String item, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hset</span><span class="params">(String key, String item, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除hash表中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 可以使多个 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hdel</span><span class="params">(String key, Object... item)</span> &#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断hash表中是否有该项的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hHasKey</span><span class="params">(String key, String item)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递增 如果不存在,就会创建一个 并把新增后的值返回</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要增加几(大于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hincr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递减</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要减少记(小于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">hdecr</span><span class="params">(String key, String item, <span class="type">double</span> by)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================ set =============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key获取Set中的所有值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;Object&gt; <span class="title function_">sGet</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据value从一个set中查询,是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sHasKey</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将数据放入set缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sSet</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将set数据放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time   时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sSetAndTime</span><span class="params">(String key, <span class="type">long</span> time, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取set缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sGetSetSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除值为value的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">setRemove</span><span class="params">(String key, Object... values)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============================list=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start 开始</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end   结束 0 到 -1代表所有值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Object&gt; <span class="title function_">lGet</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().range(key, start, end);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lGetListSize</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过索引 获取list中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引 index&gt;=0时， 0 表头，1 第二个元素，依次类推；index&lt;0时，-1，表尾，-2倒数第二个元素，依次类推</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">lGetIndex</span><span class="params">(String key, <span class="type">long</span> index)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().index(key, index);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, Object value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, List&lt;Object&gt; value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lSet</span><span class="params">(String key, List&lt;Object&gt; value, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据索引修改list中的某条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lUpdateIndex</span><span class="params">(String key, <span class="type">long</span> index, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除N个值为value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 移除多少个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">lRemove</span><span class="params">(String key, <span class="type">long</span> count, Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Long</span> <span class="variable">remove</span> <span class="operator">=</span> redisTemplate.opsForList().remove(key, count, value);</span><br><span class="line">            <span class="keyword">return</span> remove;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span>&#123;</span><br><span class="line">    redisUtils.set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;蔡徐坤&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) redisUtils.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Redis-conf-配置文件"><a href="#Redis-conf-配置文件" class="headerlink" title="Redis.conf 配置文件"></a>Redis.conf 配置文件</h1><p>详细说明整个配置文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis 配置文件</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动时必须指定配置文件位置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">./redis-server /path/to/redis.conf</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">说明 Redis 对大小写不敏感</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">units are <span class="keyword">case</span> insensitive so 1GB 1Gb 1gB are all the same.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# INCLUDES ###################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此块配置表示配置文件可以使用多个，利用 includ 包含其他文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">include /path/to/local.conf</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">include /path/to/fragments/*.conf</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# MODULES #####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载 so 等启动文件（不重要）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loadmodule /path/to/my_module.so</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loadmodule /path/to/other_module.so</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# NETWORK #####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此块为网络配置模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此项配置为绑定访问 IP</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认为只允许本地访问</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">bind</span> 127.0.0.1 -::1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当需要使用 java 远程连接时，就需要修改 <span class="built_in">bind</span>，0.0.0.0 代表所有 IP 都可以访问</span></span><br><span class="line">  bind 0.0.0.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保护模式是否开启，默认开启，远程访问时需要取消保护模式</span></span><br><span class="line">protected-mode no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis 服务启动的默认端口 6379</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TCP 监听设置</span></span><br><span class="line">tcp-backlog 511</span><br><span class="line">timeout 0</span><br><span class="line">tcp-keepalive 300</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################ GENERAL #####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此块为通用设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否为守护进行，即后台运行方式启动，默认为 no</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">守护进程方式管理，默认是 auto(no)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">supervised auto</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果以后台方式运行，就要求指定一个 pid 的运行配置文件</span></span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志级别：debug(测试和开发)、verbose、notice(生产环境)、warning(只记录关键日志)</span></span><br><span class="line">loglevel notice</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志文件位置名</span></span><br><span class="line">logfile &quot;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认数据库数量</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">logo 显示，旧版本默认开启</span></span><br><span class="line">always-show-logo no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改进程标题以显示一些运行时信息</span></span><br><span class="line">set-proc-title yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当更改进程标题时，Redis 使用以下模板来构造修改后的标题。</span></span><br><span class="line">proc-title-template &quot;&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################### SNAPSHOTTING  ################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">快照模块：持久化的设置，持久化的触发条件以及保存等设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化的规则，3600s 内至少一个 key 修改就持久化操作，300s 内 100 个key修改则持久化，60s内修改10000个key就持久化</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">save 3600 1 300 100 60 10000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化出错后还是否继续工作，默认 <span class="built_in">yes</span>，表示失败后，后续写操作均会失败</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否用 LZF 算法进行压缩 rdb 文件（把整个内存数据映射到硬盘中），需要消耗 CPU 资源</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保存 rdb 持久化文件时是否使用CRC64算法进行错误检查校验，会增加性能的消耗</span></span><br><span class="line">rdbchecksum yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rdb 文件名设置</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rdb 文件是否删除同步锁</span></span><br><span class="line">rdb-del-sync-files no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rdb 持久化文件保存目录，默认当前文件目录</span></span><br><span class="line">dir ./</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################ REPLICATION #################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此块是复制设置，后面主从复制集群时再说明。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################# SECURITY ###################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安全配置模块</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置 ACL 日志最大长度，默认128个记录。这个日志是存在内存里的。</span></span><br><span class="line">acllog-max-len 128</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">外部ACL文件配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aclfile /etc/redis/users.acl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置全局权限密码，默认没有密码</span></span><br><span class="line">requirepass gaozheng1998</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################## CLIENTS ####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端限制设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置最大客户端连接数，达到限制值后的连接会被拒绝并会返回错误信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxclients 10000</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################# MEMORY MANAGEMENT ################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis 内存设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定Redis最大内存限制。达到内存限制时，Redis将尝试删除已到期或即将到期的Key。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxmemory &lt;bytes&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置达到最大内存限制后的处理策略，Redis 进行何种操作。默认 noeviction 处理策略（具体看配置文件）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxmemory-policy noeviction</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用LRU/LFU/TTL算法时采样率：Redis使用的是近似的LRU/LFU/minimal TTL算法。主要是为了节约内存以及提升性能。Redis配置文件有maxmemory-samples选项，可以配置每次取样的数量。Redis每次会选择配置数量的key，然后根据算法从中淘汰最差的key。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxmemory-samples 5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂未了解</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">maxmemory-eviction-tenacity 10</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置Redis主从复制时，从库超过maxmemory也不淘汰数据。这个配置主要是为了保证主从库的一致性，因为Redis的淘汰策略是随机的，如果允许从库自己淘汰key，那么会导致主从不一致的现象出现（master节点删除key的命令会同步给slave节点）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">replica-ignore-maxmemory <span class="built_in">yes</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置过期keys仍然驻留在内存中的比重，默认是为1，表示最多只能有10%的过期key驻留在内存中，该值设置的越小，那么在一个淘汰周期内，消耗的CPU资源也更多，因为需要实时删除更多的过期key。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">active-expire-effort 1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################ LAZY FREEING ####################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">惰性删除设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内存达到上面设置的 maxmemory 时，是否使用惰性删除</span></span><br><span class="line">lazyfree-lazy-eviction no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过期keys是否惰性删除</span></span><br><span class="line">lazyfree-lazy-expire no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内部删除选项，此情况是否删除：由于在已经存在的key上存储对象的命令的副作用。例如，RENAME命令可能会删除旧的key的内容，当该key的内容被其它内容代替时。类似的，SUNIONSTORE或者带STORE选项的SORT命令可能会删除已经存在的keys。SET命令会删除指定键的任何旧内容，以便使用指定字符串替换。</span></span><br><span class="line">lazyfree-lazy-server-del no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">slave接收完RDB文件后清空数据是否是惰性的：在复制过程中，当副库与主库执行完全重新同步时，整个数据库的内容将被删除，以便加载刚刚传输的RDB文件。</span></span><br><span class="line">replica-lazy-flush no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否将DEL调用替换为UNLINK，注释里写的从user code里替换DEL调用为UNLINK调用可能并不是一件容易的事，因此可以使用以下选项，将DEL的行为替换为UNLINK</span></span><br><span class="line">lazyfree-lazy-user-del no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂未了解</span></span><br><span class="line">lazyfree-lazy-user-flush no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">############################# APPEND ONLY MODE ###############################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF（另一种持久化的方式）的设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认不开启 AOF 持久化，默认使用 RDB 持久化</span></span><br><span class="line">appendonly no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化文件名</span></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">持久化文件目录</span></span><br><span class="line">appenddirname &quot;appendonlydir&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">每秒都执行一次同步，但是可能会丢失这一秒的数据</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync always	<span class="comment"># 每次修改都会写入，消耗性能</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync no		<span class="comment"># 不执行同步，操作系统自己同步数据，速度最快</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当有后台保存任务时，关闭appendfsync，防止在进行BGSAVE或者BGREWRITEAOF时在主进程中调用fsync()。</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在AOF文件大小增长到了指定的百分比（相对于上次AOF文件大小的增长量）或者最小体积时，自动调用BGREWRITEAOF命令重写AOF文件。</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件末尾被截断</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启混合持久化：当重写AOF文件时，Redis能够在AOF文件中使用RDB前导，以更快地重写和恢复。</span></span><br><span class="line">aof-use-rdb-preamble yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂未了解</span></span><br><span class="line">aof-timestamp-enabled no</span><br></pre></td></tr></table></figure>

<h1 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h1><p>​		Redis 是内存数据库，如果不将内存中的数据状态保存到磁盘进行<code>持久化</code>，那么一旦服务进行退出，Redis 数据库中的数据也会消失。 </p>
<h2 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h2><p>​		RDB ：Redis DataBase 持久化方式。在指定的时间间隔将内存数据快照写入磁盘，这也就是 <code>Snapshot快照</code>(备份文件)，恢复时只需要将快照文件直接读取到内存即可。<code>Redis 默认的持久化方式就是 RDB 持久化</code></p>
<p>​		默认情况下， Redis 将数据库快照保存在名字为 <code>dump.rdb</code> 的二进制文件中。</p>
<p>1、工作原理：在进行 <strong><code>RDB</code></strong> 的时候，**<code>redis</code>** 的主线程是不会做 <strong><code>io</code></strong> 操作的，主线程会 <strong><code>fork</code></strong> 一个子线程来完成该操作。</p>
<p>1）Redis 调用 forks。同时拥有父进程和子进程。</p>
<p>2）子进程将数据集写入到一个临时 RDB 文件中。</p>
<p>3）当子进程完成对新 RDB 文件的写入时，Redis 用新 RDB 文件替换原来的 RDB 文件，并删除旧的 RDB 文件。</p>
<p>这种工作方式使得 Redis 可以从 <code>写时复制（copy-on-write）</code> 机制中获益（因为是使用子进程进行写操作，而父进程依然可以接收来自客户端的请求）</p>
<p><img src="https://img-blog.csdnimg.cn/20200513215141519.jpg" alt="在这里插入图片描述"></p>
<p>2、RDB 持久化触发规则：</p>
<p>1）save 的规则满足的情况下，会自动触发 RDB 持久化。&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>save 规则在 配置文件的 SNAPSHOTTING 快照模块进行设置</code></p>
<p>2）执行 flushall 命令，也会触发我们的 RDB 持久化。</p>
<p>3）退出 Redis 时，也会自动产生 rdb 文件。</p>
<p>4）使用 <code>save</code> 命令，会立刻对当前内存中的数据进行持久化 ,但是会<code>阻塞</code>，阻塞当前所有客户端的请求。（save 命令使用主线程进行持久化）</p>
<p>5）使用 <code>bgsave</code> 命令，也是持久化命令，不过是<code>异步</code>的，意味着主线程<code>不会产生阻塞</code>，但是需要 fork 子进程（子进程阻塞），消耗内存，但是很小且快。</p>
<p>3、恢复 RDB 文件：只需要将 RDB 文件放在我们 Redis 的启动目录，则启动时就会自动检查 dump.rdb 文件，并恢复其中的数据。</p>
<blockquote>
<p>检查 rdb 自动扫描扫描文件位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/root&quot;		# 自动扫描位置</span><br></pre></td></tr></table></figure>
</blockquote>
<p>注意：默认配置基本就足够平时企业开发应用。</p>
<p>4、优点和缺点：</p>
<p>1）适合大规模的数据恢复，但是对数据的完整性要求不高时可以使用。</p>
<p>2）需要一定时间间隔的进程操作，如果期间 Redis 宕机，最后一次修改数据就会消失。</p>
<p>3）fork 进程会单独开启一条线程，有一定的内存空间消耗。</p>
<h2 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h2><p>​		<code>AOF</code> ：Append Only File(追加文件)。实质就是将所有的命令记录下来，类似于一个 <code>history 文件</code>，恢复时再全部执行一遍。（类似于 sql 文件备份）</p>
<p>​		默认情况下， Redis 并没有开启 aof 持久化，开启后将数据库日志文件保存在名字为 <code>appendonly.aof</code> 的二进制文件中。</p>
<p>1、工作原理：也是<code>使用 fork 子进程</code>，以日志的形式来记录每个<code>写的操作</code>，将 Redis 执行过的所有指令记录下来（读操作不记录），<code>只追加</code>文件但<code>不改写</code>文件，redis 启动之初会读取该文件<code>重新构建数据</code>，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。</p>
<p>2、触发规则：<code>每秒</code>自动执行子进程将写操作记录进入日志文件（可配置）。</p>
<blockquote>
<p>但是，这个文件是可以<code>手动破坏</code>的，那么破坏后会怎么样呢？如何使其恢复正常呢？</p>
<p>1）当该 aof 文件被破坏出现问题时，redis-server 服务可以正常启动，但是已经不能进入客户端 redis-cli 了，会直接<code>连接拒绝</code>。</p>
<p>2）redis 官方提供了 aof 的修复工具：<code>redis-check-aof --fix</code>，此工具可以直接对 aof 文件进行修复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-check-aof --fix appendonly.aof</span><br></pre></td></tr></table></figure>

<p>此时就可以正常启动客户端（可能会丢失 1s 数据）。</p>
</blockquote>
<p>3、优缺点：</p>
<p>1）每次修改都会同步，文件完整性很好。（三种同步模式）</p>
<p>2）相对于数据文件来说，aof 文件远远大于 rdb 文件，同时由于是 IO 操作，修复速度比 rdb 慢。</p>
<p>3）aof 运行效率比 rdb 慢，因此 Redis 默认的持久化方式就是 RDB。</p>
<p>4、拓展点：<code>aof 重写原则</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<p>根据配置文件，aof 文件如果大于 64M（这个 64 来源于上一次生成的文件大小，会自动变化），就会fork 新的子进程来将文件进行重写。</p>
<h1 id="Redis-发布订阅"><a href="#Redis-发布订阅" class="headerlink" title="Redis 发布订阅"></a>Redis 发布订阅</h1><h2 id="原理简述"><a href="#原理简述" class="headerlink" title="原理简述"></a>原理简述</h2><p>​		Redis 发布订阅(pub&#x2F;sub)是一种<code>消息通信</code>模式：发送者(pub)发送消息，订阅者(sub)接收消息。&#x3D;&#x3D;&#x3D;&#x3D;&gt; 微信微博等关注系统。</p>
<p>​		Redis 客户端可以订阅任意数量的频道，其订阅&#x2F;发布消息图为：</p>
<p><img src="https://img1.baidu.com/it/u=92971651,3684802502&fm=253&fmt=auto&app=138&f=PNG?w=804&h=315" alt="img"></p>
<p>公众号更新人（发布者） ————-&gt; Redis server ————&gt; 张三、李四、王五订阅就可以收到（消息订阅者）。</p>
<p>​		当有新消息通过 PUBLISH 命令发送给频道 channel 时， 这个消息就会被发送给订阅它的三个客户端：</p>
<p><img src="https://img-blog.csdnimg.cn/2020051321553483.png" alt="在这里插入图片描述"></p>
<p>主要命令：围绕<code>消息发送者、频道、消息订阅者</code>而言。</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>PSUBSCRIBE pattern [pattern..]</code></td>
<td align="center"><code>订阅</code>一个或多个符合给定模式的频道。</td>
</tr>
<tr>
<td align="center">PUNSUBSCRIBE pattern [pattern..]</td>
<td align="center">退订一个或多个符合给定模式的频道。</td>
</tr>
<tr>
<td align="center">PUBSUB subcommand [argument[argument]]</td>
<td align="center">查看订阅与发布系统状态。</td>
</tr>
<tr>
<td align="center"><code>PUBLISH channel message</code></td>
<td align="center">向指定频道<code>发布</code>消息</td>
</tr>
<tr>
<td align="center"><code>SUBSCRIBE channel [channel..]</code></td>
<td align="center"><code>订阅</code>给定的一个或多个频道。</td>
</tr>
<tr>
<td align="center">SUBSCRIBE channel [channel..]</td>
<td align="center">退订一个或多个频道</td>
</tr>
</tbody></table>
<p>​		每个 Redis 服务器进程都维持着一个表示服务器状态的 redis.h&#x2F;redisServer 结构， 结构的 pubsub_channels 属性是一个<code>字典</code>， 这个字典就用于保存订阅频道的信息，其中，<code>字典的键为正在被订阅的频道</code>， 而字典的值则是一个链表（<code>订阅者链表</code>）， 链表中保存了所有订阅这个频道的客户端。客户端订阅，就被链接到对应频道的链表的尾部，退订则就是将客户端节点从链表中移除。</p>
<p><img src="https://img-blog.csdnimg.cn/2020051321554964.png" alt="在这里插入图片描述"></p>
<p>缺点：</p>
<p>1）如果一个客户端订阅了频道，但自己读取消息的速度却不够快的话，那么不断积压的消息会使redis输出缓冲区的体积变得越来越大，这可能使得redis本身的速度变慢，甚至直接崩溃。</p>
<p>2）这和数据传输可靠性有关，如果在订阅方断线，那么他将会丢失所有在短线期间发布者发布的消息。</p>
<p>应用场景：</p>
<p>1）消息订阅：公众号订阅，微博关注等等（企业基本使用消息队列来进行实现）。 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>消息中间件 MQ</code></p>
<p>2）多人在线聊天室。</p>
<p>3）订阅、关注系统。</p>
<h2 id="Redis-cli-实现"><a href="#Redis-cli-实现" class="headerlink" title="Redis-cli 实现"></a>Redis-cli 实现</h2><p>1）消息订阅者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">订阅者订阅消息</span></span><br><span class="line">127.0.0.1:6379&gt; subscribe gaozheng</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;gaozheng&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处等待消息发布</span></span><br></pre></td></tr></table></figure>

<p>2）消息发布者</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; publish gaozheng &quot;hello,gaozheng&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; publish gaozheng &quot;hello,nihaoya&quot;</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<p>3）当发布消息的同时，再检查订阅者等待模式下的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; subscribe gaozheng</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) &quot;subscribe&quot;</span><br><span class="line">2) &quot;gaozheng&quot;</span><br><span class="line">3) (integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">消息1</span></span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;gaozheng&quot;	# 表示频道</span><br><span class="line">3) &quot;hello,gaozheng&quot;	# 表示消息内容</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">消息 2</span></span><br><span class="line">1) &quot;message&quot;</span><br><span class="line">2) &quot;gaozheng&quot;	# 表示频道</span><br><span class="line">3) &quot;hello,nihaoya&quot;	# 表示消息内容</span><br></pre></td></tr></table></figure>

<h2 id="Jedis-实现"><a href="#Jedis-实现" class="headerlink" title="Jedis 实现"></a>Jedis 实现</h2><p>​		Jedis 实现则需要两个角色：<code>消息发布者</code> 和 <code>消息订阅者</code>。</p>
<p>1）消息发布者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消息发布者:控制台发送消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Publisher</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;8.142.92.222&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;gaozheng1998&quot;</span>);</span><br><span class="line">        <span class="comment">//通过控制台发布消息，未来从前端读取</span></span><br><span class="line">        jedis.publish(<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;欢迎订阅!&quot;</span>);</span><br><span class="line">        <span class="type">InputStreamReader</span> <span class="variable">inputStreamReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in);</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(inputStreamReader);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> reader.readLine();</span><br><span class="line">            jedis.publish(<span class="string">&quot;channel1&quot;</span>, <span class="string">&quot;Bilibili 官方：&quot;</span> + line);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;quit&quot;</span>.equals(line)) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）消息订阅者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消息订阅者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Subcriber</span> <span class="keyword">extends</span> <span class="title class_">JedisPubSub</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Subcriber</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//收到消息时会调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String channel, String message)</span> &#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">&quot;订阅消息来自于 %s, 消息内容 %s&quot;</span>, channel, message));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//订阅了频道会调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(String channel, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">&quot;用户 %s 成功订阅频道 %s, subscribedChannels = %d&quot;</span>, <span class="built_in">this</span>.name, channel, subscribedChannels));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取消订阅会调用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUnsubscribe</span><span class="params">(String channel, <span class="type">int</span> subscribedChannels)</span> &#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">&quot;已取消订阅来自于频道 %s 的消息, subscribedChannels %d&quot;</span>, channel, subscribedChannels));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）测试代码，测试消息的接收和发送：使用两个消息订阅者（代码基本相同，name 属性分别为 张三 和 李四）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestSubscriber01</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;8.142.92.222&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;gaozheng1998&quot;</span>);</span><br><span class="line">        jedis.subscribe(<span class="keyword">new</span> <span class="title class_">Subcriber</span>(<span class="string">&quot;张三&quot;</span>), <span class="string">&quot;channel1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）测试结果：</p>
<p>当消息发布者控制台发送：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">亲，你好呀，欢迎您的订阅！</span><br></pre></td></tr></table></figure>

<p>两个订阅者接收消息结果为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">张三</span></span><br><span class="line">用户 张三 成功订阅频道 channel1, subscribedChannels = 1</span><br><span class="line">订阅消息来自于 channel1, 消息内容 hello,world!</span><br><span class="line">订阅消息来自于 channel1, 消息内容 Bilibili 官方：亲，你好呀，欢迎您的订阅！</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">李四</span></span><br><span class="line">用户 李四 成功订阅频道 channel1, subscribedChannels = 1</span><br><span class="line">订阅消息来自于 channel1, 消息内容 hello,world!</span><br><span class="line">订阅消息来自于 channel1, 消息内容 Bilibili 官方：亲，你好呀，欢迎您的订阅！</span><br></pre></td></tr></table></figure>

<h1 id="Redis-主从复制"><a href="#Redis-主从复制" class="headerlink" title="Redis 主从复制"></a>Redis 主从复制</h1><p>​		<code>主从复制</code>，是指将一台Redis服务器的数据（<code>主机 master</code>），复制到其他的Redis服务器（<code>从机 slave</code>）。<code> 数据的复制是单向的</code>，只能由主节点复制到从节点。默认情况下，每台 Redis 单机服务器都是主节点，一个主节点可以有0个或者多个从节点，但每个从节点只能由一个主节点管理。</p>
<p>​		主节点主要负责写请求，多台从机负责读请求。 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>读写分离</code>，减缓服务器压力。</p>
<p><code>问题</code>：当请求过多时，单台服务器压力过大，容量有限制(单台 Redis 最大使用内存不应该超过 20G)，同时如果发生单点故障，可能会导致整个系统崩坏。</p>
<p>1、主从复制的主要作用：</p>
<p>1）数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余的方式。</p>
<p>2）故障恢复：当主节点故障时，从节点可以暂时替代主节点提供服务，是一种服务冗余的方式。</p>
<p>3）负载均衡：在主从复制的基础上，配合读写分离，分担服务器的负载；尤其是在多读少写的场景下，通过多个从节点分担负载，<code>提高并发量</code>。</p>
<p>4）高可用基础：主从复制还是<code>哨兵</code>和集群能够实施的基础。</p>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><p>​		环境配置：只需要从节点的配置，不需要修改主节点的配置。（<code>每台单机 Redis 默认就是主节点</code>）</p>
<blockquote>
<p>查看当前库的集群副本配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master		# 角色</span><br><span class="line">connected_slaves:0		# 从机个数</span><br><span class="line">master_replid:ebc2bc894176afd756dd7708dcea6841ac03b22a</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>
</blockquote>
<p>1、复制配置文件 redis79.conf、redis80.conf、redis81.conf 三个配置文件（搭建<code>一主两从</code>集群）</p>
<p>​		修改配置内容：<code>端口号、pid文件名、日志文件名、rdb文件名</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以 6380 端口 redis 服务为例，其他端口服务类似配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动端口</span></span><br><span class="line">port 6380</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后台运行 pid 文件</span></span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日志</span></span><br><span class="line">logfile &quot;redis80.log&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rdb 文件</span></span><br><span class="line">dbfilename dump80.rdb</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要<code>注意</code>：当要连接的主机设置密码后，从机配置文件需要增加<code>主机密码设置</code>的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处主机79密码为 gaozheng1998</span></span><br><span class="line">masterauth gaozheng1998</span><br></pre></td></tr></table></figure>
</blockquote>
<p>2、启动这三个 redis 服务。</p>
<p>1）查看 redis 进程：发现三个 redis 服务成功启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ redis-conf]# redis-server ./redis79.conf </span><br><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ redis-conf]# redis-server ./redis80.conf </span><br><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ redis-conf]# redis-server ./redis81.conf </span><br><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ redis-conf]# ps auxw|grep redis</span><br><span class="line">root     3847940  0.0  0.1  53436  8684 ?        Ssl  20:11   0:00 redis-server 0.0.0.0:6379</span><br><span class="line">root     3847945  0.0  0.0  53436  7892 ?        Ssl  20:11   0:00 redis-server 0.0.0.0:6380</span><br><span class="line">root     3847957  0.0  0.0  53436  5824 ?        Ssl  20:11   0:00 redis-server 0.0.0.0:6381</span><br><span class="line">root     3847962  0.0  0.0  12108  1060 pts/0    S+   20:11   0:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<p>2）以 6379 端口为主机，将 6380 端口和 6381 端口配置成从机（<code>只需要修改从机</code>）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置成某台 redis-server 的从机的语法：</span></span><br><span class="line">slaveof host port</span><br></pre></td></tr></table></figure>

<p>将 80 端口配置为从机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ redis-conf]# redis-cli -p 6380		# 进入指定端口的 redis-cli</span><br><span class="line">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前库副本配置信息</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:slave		# 角色变为 slave 从机</span><br><span class="line">master_host:127.0.0.1	 # 主机 ip</span><br><span class="line">master_port:6379		# 主机端口变为 6379</span><br><span class="line">master_link_status:up	# 表示正常连接到主机</span><br><span class="line">..........</span><br></pre></td></tr></table></figure>

<p>将 81 端口配置为从机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 81 端口配置为从机</span></span><br><span class="line">[root@iZ8vb0l7sqdpurpvy5e77xZ ~]# redis-cli -p 6381</span><br><span class="line">127.0.0.1:6381&gt; slaveof 127.0.0.1 6379</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看当前库副本配置信息</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:slave		# 角色变为 slave 从机</span><br><span class="line">master_host:127.0.0.1	 # 主机 ip</span><br><span class="line">master_port:6379		# 主机端口变为 6379</span><br><span class="line">master_link_status:up	 # 表示正常连接到主机</span><br><span class="line">...........</span><br></pre></td></tr></table></figure>

<p>3、通过主机查看集群信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=98,lag=1		# 从机 80 的信息</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=98,lag=1		# 从机 81 的信息</span><br><span class="line">master_replid:e1f1a36bb62353d5a3d02b3ce6e91439dbcbeef1</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:98</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:98</span><br></pre></td></tr></table></figure>

<blockquote>
<p>真实主从复制是在配置文件直接修改，此处通过命令设置只是暂时的<code>主从设置</code>。</p>
<p>配置文件配置是永久的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################ REPLICATION #################################</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处就是设置主机的 ip 和 端口</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">replicaof &lt;masterip&gt; &lt;masterport&gt;</span></span><br><span class="line">...........</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置主机的密码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">masterauth &lt;master-password&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>4、测试集群的使用。</p>
<p>​		1）主机可以写，但从机只能读。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">80 端口测试写数据：报错</span></span><br><span class="line">127.0.0.1:6380&gt; set k1 v1</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主机能读能写，但是一般只用来写数据操作</span></span><br><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试从机读取数据：正常</span></span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br></pre></td></tr></table></figure>

<p>​		测试发现：主机能读能写，但从机只能读，且<code>主机数据会自动同步到从机</code>。		</p>
<p>2）主机断开，从机依旧是连接到主机的，<code>依旧能够读取主机之前写入的数据</code>，但是已经没有新的数据写入集群，等待主机恢复，整个集群直接恢复正常。</p>
<blockquote>
<p>此处就会有一个问题：如果主机很久才恢复，那么将一直不能写入新数据，能不能在从机之间选择一个成为主机呢？</p>
<p>1）手动将某一台从机独立：<code>slaveof no one</code> ，自身就会变成主机，其他节点重新设置主机为此节点。（<code>需要手动</code>）如果此时原来的主节点恢复正常了，那么也只能重新再配置了，并不会自动变成其他节点的主节点。</p>
<p>2）使用<code>哨兵模式</code>，利用选举模式自动选一个主机。</p>
</blockquote>
<p>3）从机 81 断开，这时主机写入数据，81 再连接回来，发现此时已经变成了主机（<code>未配置到配置文件则断开就会取消跟随主机</code>）</p>
<p>​			注意：如果是配置文件配置的（或者<code>再次配置进入集群</code>），就会发现主机在其断开期间写入的数据，仍然可以读取到。&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>自动同步</code></p>
<h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><p>​		Slave 启动成功连接到 master 后会发送一个 sync 同步命令，Master 接收到命令后，启动后台的存盘进程，同时手机所有接收到的修改数据库的命令，在后台进程执行完毕后，<code>Master 将传送整个数据文件到 Slave</code>，完成一次完全同步。</p>
<p>​		<code>全量复制</code>：Slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中。</p>
<p>​		<code>增量复制</code>：Master 继续将<code>新收集到的修改命令</code>一次传给 Slave，完成同步。</p>
<p>​		只要是重新连接到 Master，一次完全同步（全量复制）将自动执行。</p>
<h2 id="层层链路结构"><a href="#层层链路结构" class="headerlink" title="层层链路结构"></a>层层链路结构</h2><p>​		上面提到，当主机宕机后，主机可能短时间无法连接上，那么如何解决？</p>
<p>​		那么，能不能将集群设计成：<code>79（Master）&lt;---------- 80（Slave和 Master） &lt;----------- 81（从机）</code> 层层链路的结构呢，这样的结构能不能保证当主机宕机后，<code>原本的从机 80 直接上升到主机</code>呢？</p>
<p>1、修改 81 的主机选择，将 81 主机切换成 80 Redis。</p>
<p>​		此时检查 80 发现：<code>本身角色是从机</code>（依旧无法写入数据），但是下面有一个从机 6381。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:7</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:3916</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=3916,lag=1</span><br></pre></td></tr></table></figure>

<p>​		再检查 81 发现其主机变为 80，检查 79 发现其只有一个从机 80。</p>
<p>​		此时上述的结构就搭建完成。</p>
<p>2、检查正常插入和删除数据：</p>
<p>1）79 正常插入数据 k9 v9 。</p>
<p>2）80 正常能够读取数据 k9 的 value 值。</p>
<p>3）81 同样能够读取到数据 k9 的 value 值。</p>
<p>因此：此种层层链路结构依旧能实现<code>主从复制</code>。</p>
<p>3、此时如果关掉原来的主机79，80会变成主机吗？<code>并不会</code></p>
<p>当原来的主机宕机后，80 Redis <code>依旧是从机角色</code>，依旧不能写入数据。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; set k0 v0</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica.</span><br></pre></td></tr></table></figure>

<p>此时如何解决呢？ &#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>将 80 独立设置成为主机</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; slaveof no one</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>此时设置后，80从机变为主机，同时原来其 81 从机仍然是其从机。（<code>比原本的方式容易操作一点</code>，但同样复杂）</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><p>​		Redis 从 2.8 开始正式推出 <code>Sentinel 哨兵</code>架构来解决上面的手动选举的过程。</p>
<p>​		哨兵模式：后台自动监控主机是否故障，如果故障则会<code>根据投票数自动将某个从机转换为主机</code>。（选举模式）</p>
<p>​		哨兵作用：通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器。当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通过<code>发布订阅模式</code>通知其他的从服务器，修改配置文件，让它们切换主机。</p>
<p>单哨兵模式原理图：</p>
<p><img src="http://c.biancheng.net/uploads/allimg/210913/1K00M955-0.gif" alt="哨兵模式"></p>
<p>​		在实际生产情况中，<code>Redis Sentinel</code> 是集群的高可用的保障，为避免 Sentinel 发生意外，它一般是由 3～5 个哨兵节点组成，<code>哨兵之间也互相监控</code>，这样就算挂了个别哨兵节点，仍然能够正常监控，该集群仍然可以正常运转。（<code>起码六个服务</code>）</p>
<p>多哨兵模式原理图：</p>
<p><img src="http://c.biancheng.net/uploads/allimg/210913/1K00HQ5-1.gif" alt="Redis哨兵模式"></p>
<p>​		假设主机宕机，哨兵1先检测到此结果，系统并不会立即进行(failover) 过程，仅仅是哨兵1主观认为主机不可用，这个现象称为“<code>主观下线</code>”，当后面的哨兵也检测到主机不可用，并且达到一定数目时，那么<code>哨兵之间就会进行一次选举投票</code>，投票结果由一个哨兵发起，进行 <code>failover[故障转移]</code> 操作，切换成功后，就会通过<code>发布订阅模式</code>，让各个哨兵把自己监控的从机实现切换主机，这就是“<code>客观下线</code>”。</p>
<p>那么如何搭建出哨兵模式的主从复制集群呢？（目前是一主二从的模式）</p>
<p>1、配置哨兵模式的最简配置文件：<code>sentinel.conf</code> 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件内容</span></span><br><span class="line">port 26379		# 启动端口 26379</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">语法：sentinel monitor 被监控的主机名称 主机ip 主机端口 1</span></span><br><span class="line">sentinel monitor myredis 127.0.0.1 6379 1</span><br><span class="line">sentinel auth-pass myredis gaozheng1998		# 注意，当主机设置密码后，监视需要添加密码验证</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个 1 代表主机宕机后，从机投票的票数</span></span><br></pre></td></tr></table></figure>

<p>2、启动哨兵：利用文件项目 redis-sentinel 进行启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel ./redis-conf/sentinel.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">出现redis 的欢迎页面即为启动成功，同时还有一些信息：</span></span><br><span class="line">3871668:X 11 Jun 2022 09:43:39.522 # Sentinel ID is 5e970e1b78aa1a89c12ad33b8dcbc62e7221539c</span><br><span class="line">3871668:X 11 Jun 2022 09:43:39.522 # +monitor master myredis 127.0.0.1 6379 quorum 1</span><br><span class="line">3871668:X 11 Jun 2022 09:43:39.523 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379		# 从机配置</span><br><span class="line">3871668:X 11 Jun 2022 09:43:39.524 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379		# 从机配置</span><br></pre></td></tr></table></figure>

<p>3、测试主机79 宕机，会不会有从机自动变为主机呢？</p>
<p>1）主机宕机关机。</p>
<p>等待一会，等待哨兵监控状态。</p>
<p>2）从机80状态：（<code>变成了主机</code>）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=88688,lag=1</span><br><span class="line">master_replid:8d4989b2914953af8a544344b497da2d05c2c65a</span><br><span class="line">master_replid2:8008adc3915ae1cd175409bf0eb54cfe92178e24</span><br><span class="line">master_repl_offset:88820</span><br><span class="line">second_repl_offset:81384</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:88820</span><br></pre></td></tr></table></figure>

<p>3）从机81状态：（<code>仍然是从机</code>，但是跟随的是 80新主机）</p>
<p>4、测试主机恢复后：当主机恢复后，再次查看状态，发现<code>恢复的主机已经被归并为当前的主机81 的从机</code>。（注意配置文件：需要配置集群的主机密码）</p>
<p>哨兵模式的优缺点：</p>
<p>1）哨兵集群，基于主从复制模式，所有的主从配置的优势均有。</p>
<p>2）主从可以切换，故障能够转移，系统可用性优良。</p>
<p>3）哨兵模式就是主从模式的升级，手动变为自动配置，更加健壮。</p>
<p>4）<code>缺点</code>：Redis 不易在线扩容，集群容量一旦达到上限，扩容就十分麻烦，同时实现哨兵模式配置非常复杂。</p>
<p>完整的哨兵模式的配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Example sentinel.conf</span></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">哨兵sentinel实例运行的端口 默认26379</span></span><br><span class="line">port 26379</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">哨兵sentinel的工作目录</span></span><br><span class="line">dir /tmp</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">哨兵sentinel监控的redis主节点的 ip port</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master-name  可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符<span class="string">&quot;.-_&quot;</span>组成。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当在Redis实例中开启了requirepass foobared 授权密码 这样所有连接Redis实例的客户端都要提供密码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span></span><br><span class="line">sentinel auth-pass mymaster MySUPER--secret-0123passw0rd</span><br><span class="line"> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个数字越小，完成failover所需的时间就越长，</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">故障转移的超时时间 failover-timeout 可以用在以下这些方面：</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. 同一个sentinel对同一个master两次failover之间的间隔时间。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.当想要取消一个正在进行的failover所需要的时间。</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认三分钟</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SCRIPTS EXECUTION</span></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">对于脚本的运行结果有以下规则：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</span></span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">一个是事件的类型，</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">一个是事件的描述。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通知脚本</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">  sentinel notification-script mymaster /var/redis/notify.sh</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端重新配置主节点参数脚本</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下参数将会在调用脚本时传给脚本:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目前&lt;state&gt;总是“failover”,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;role&gt;是“leader”或者“observer”中的一个。</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个脚本应该是通用的，能被多次调用，不是针对性的。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel client-reconfig-script mymaster /var/redis/reconfig.sh</span><br></pre></td></tr></table></figure>

<h1 id="Redis-缓存穿透和雪崩"><a href="#Redis-缓存穿透和雪崩" class="headerlink" title="Redis 缓存穿透和雪崩"></a>Redis 缓存穿透和雪崩</h1><h2 id="11-1-缓存穿透"><a href="#11-1-缓存穿透" class="headerlink" title="11.1 缓存穿透"></a>11.1 缓存穿透</h2><p>​		在默认情况下，用户请求数据时，会<code>先在缓存(Redis)</code>中查找，若没找到即缓存未命中，再在数据库中进行查找，<code>数据库也没有</code>，数量少可能问题不大，可是一旦大量的请求数据（例如秒杀场景）缓存都没有命中的话，就会全部转移到数据库上，造成数据库极大的压力，就有可能导致数据库崩溃。&#x3D;&#x3D;&#x3D;&gt; <code>缓存穿透</code></p>
<p>​		网络安全中也有人恶意使用这种手段进行攻击被称为<code>洪水攻击</code>。</p>
<p>​		那么如何解决呢？</p>
<p>1）在 缓存 之前增加过滤器（布隆过滤器）</p>
<p>2）第一次查询不到就在缓存中缓存一个 空对象，后续就不会持续请求数据库。</p>
<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><p>​		对所有可能查询的参数以 <code>Hash</code> 的形式存储，以便快速确定是否存在这个值，在控制层先进行拦截校验，<code>校验不通过直接丢弃</code>，减轻了存储系统的压力。</p>
<p><img src="https://img-blog.csdnimg.cn/20200513215824722.jpg" alt="在这里插入图片描述"></p>
<h3 id="缓存空对象"><a href="#缓存空对象" class="headerlink" title="缓存空对象"></a>缓存空对象</h3><p>​		第一次请求若在缓存和数据库中都没找到，就在缓存中存放一个空对象用于处理后续这个请求。</p>
<p><img src="https://img-blog.csdnimg.cn/20200513215836317.jpg" alt="在这里插入图片描述"></p>
<p>但是此办法会存在问题：</p>
<p>1）存储空对象也需要空间，大量的空对象会耗费一定的空间，存储效率并不高。</p>
<p>2）解决缺陷1的方式就是设置较短过期时间，会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对于需要保持一致性的业务会有影响。</p>
<h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p>​		相较于缓存穿透，缓存击穿的目的性更强，一个<code>存在的key</code>，在缓存过期的一刻，同时有大量的请求，这些请求都会击穿到DB，造成瞬时DB请求量大、压力骤增，这就是<code>缓存击穿</code>，只是针对其中某个key的缓存不可用而导致击穿，但是其他的key依然可以使用缓存响应。（<code>缓存过期瞬间某个 key 请求量过大</code>）</p>
<p>​		例如：微博热搜，一个热点新闻被同时大量访问就可能导致缓存击穿。</p>
<p>​		那么如何解决呢？</p>
<p>1）设置热点数据 key 永不过期：这样就不会出现热点数据过期的情况，但是当 Redis 内存空间满的时候也会清理部分数据，而且此种方案会占用空间，一旦热点数据多了起来，就会占用部分空间。</p>
<p>2）使用分布式锁：在访问 key 之前，采用 SETNX（set if not exists）来设置另一个短期 key 来锁住当前 key 的访问，访问结束再删除该短期 key。保证同时刻只有一个线程访问，但是这样对锁的要求就十分高。（保证同一时刻只有一个线程进行访问）</p>
<h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p>​		大量的 key 设置了相同的过期时间，导致<code>缓存在同一时刻全部失效</code>，造成瞬时DB请求量大、压力骤增，引起雪崩。</p>
<p><img src="https://img-blog.csdnimg.cn/20200513215850428.jpeg" alt="在这里插入图片描述"></p>
<p>​		那么如何解决呢？</p>
<p>1）Redis 高可用方案：增设 Redis，这样一台挂掉之后其他的还可以继续工作，其实就是搭建的集群。（<code>异地多活</code>）</p>
<p>2）限流降级：在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待。</p>
<p>3）数据预热：在正式部署之前，我先把可能的数据先预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的 key，<code>设置不同的过期时间</code>，让缓存失效的时间点尽量均匀。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://localhost:4000">moon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://localhost:4000/2022/05/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis%20%E5%9F%BA%E7%A1%80/">http://localhost:4000/2022/05/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis%20%E5%9F%BA%E7%A1%80/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://localhost:4000" target="_blank">月の子豚小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><a class="post-meta__tags" href="/tags/Redis/">Redis</a><a class="post-meta__tags" href="/tags/%E7%BC%93%E5%AD%98/">缓存</a><a class="post-meta__tags" href="/tags/NoSQL/">NoSQL</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/we/wallhaven-weoe9q.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/20/%E8%BF%90%E7%BB%B4%E6%8A%80%E6%9C%AF/Docker%20%E5%9F%BA%E7%A1%80/"><img class="prev-cover" src="https://w.wallhaven.cc/full/e7/wallhaven-e7dy9w.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Docker 的基本使用</div></div></a></div><div class="next-post pull-right"><a href="/2022/05/20/%E5%88%86%E5%B8%83%E5%BC%8F%E7%AE%97%E6%B3%95/Nginx%20%E5%9F%BA%E7%A1%80/"><img class="next-cover" src="https://w.wallhaven.cc/full/1k/wallhaven-1k7ox3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nginx 使用初探</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/03/02/Java%20%E6%A1%86%E6%9E%B6/MybatisPlus%20%E5%9F%BA%E7%A1%80/" title="Mybatis-Plus 简单使用"><img class="cover" src="https://w.wallhaven.cc/full/wq/wallhaven-wqplxr.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-02</div><div class="title">Mybatis-Plus 简单使用</div></div></a></div><div><a href="/2021/02/21/Java%20%E6%A1%86%E6%9E%B6/Mybatis%20%E5%9F%BA%E7%A1%80/" title="Mybatis 使用初探"><img class="cover" src="https://w.wallhaven.cc/full/8o/wallhaven-8o2d8k.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-21</div><div class="title">Mybatis 使用初探</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic1.imgdb.cn/item/6337ca6e16f2c2beb17d8731.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">moon</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn"><i class="fab fa-github"></i><span>月の子豚小屋</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/xxx" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/1963885633@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/1963885633" target="_blank" title="QQ"><i class="fa-sharp fa-solid fa-ghost"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">月の子豚小屋</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NoSQL-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">NoSQL 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL-%E6%9D%A5%E6%BA%90"><span class="toc-number">1.1.</span> <span class="toc-text">NoSQL 来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL-%E7%AE%80%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">NoSQL 简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NoSQL-%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.</span> <span class="toc-text">NoSQL 分类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">Redis 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E7%AE%80%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Redis 简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.</span> <span class="toc-text">Redis 性能测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.</span> <span class="toc-text">Redis 基础命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E5%88%86%E6%9E%90"><span class="toc-number">2.4.</span> <span class="toc-text">Redis 分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">Redis 数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#String-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">3.1.</span> <span class="toc-text">String 字符串</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#List-%E5%88%97%E8%A1%A8"><span class="toc-number">3.2.</span> <span class="toc-text">List 列表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set-%E9%9B%86%E5%90%88"><span class="toc-number">3.3.</span> <span class="toc-text">Set 集合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash-%E9%9B%86%E5%90%88"><span class="toc-number">3.4.</span> <span class="toc-text">Hash 集合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zset-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88"><span class="toc-number">3.5.</span> <span class="toc-text">Zset 有序集合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Geospatial-%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE"><span class="toc-number">3.6.</span> <span class="toc-text">Geospatial 地理位置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hyperloglog-%E5%9F%BA%E6%95%B0%E7%BB%9F%E8%AE%A1"><span class="toc-number">3.7.</span> <span class="toc-text">Hyperloglog 基数统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bitmaps-%E4%BD%8D%E5%9B%BE"><span class="toc-number">3.8.</span> <span class="toc-text">Bitmaps 位图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">Redis 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">正常执行事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BE%E5%BC%83%E4%BA%8B%E5%8A%A1"><span class="toc-number">4.2.</span> <span class="toc-text">放弃事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%94%99%E8%AF%AF"><span class="toc-number">4.3.</span> <span class="toc-text">事务错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">4.4.</span> <span class="toc-text">Redis 乐观锁</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Jedis"><span class="toc-number">5.</span> <span class="toc-text">Jedis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">5.1.</span> <span class="toc-text">基本操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%93%8D%E4%BD%9C"><span class="toc-number">5.2.</span> <span class="toc-text">事务操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringBoot-%E6%95%B4%E5%90%88-Redis"><span class="toc-number">6.</span> <span class="toc-text">SpringBoot 整合 Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E6%95%B4%E5%90%88"><span class="toc-number">6.1.</span> <span class="toc-text">Redis 整合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E9%97%AE%E9%A2%98"><span class="toc-number">6.2.</span> <span class="toc-text">序列化问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Redis-%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">6.3.</span> <span class="toc-text">自定义 Redis 序列化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">6.4.</span> <span class="toc-text">Redis 工具类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-conf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">Redis.conf 配置文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">Redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RDB-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.1.</span> <span class="toc-text">RDB 持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AOF-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.2.</span> <span class="toc-text">AOF 持久化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="toc-number">9.</span> <span class="toc-text">Redis 发布订阅</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0"><span class="toc-number">9.1.</span> <span class="toc-text">原理简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis-cli-%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.2.</span> <span class="toc-text">Redis-cli 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jedis-%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.3.</span> <span class="toc-text">Jedis 实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">Redis 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">10.1.</span> <span class="toc-text">集群搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">10.2.</span> <span class="toc-text">复制原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%82%E5%B1%82%E9%93%BE%E8%B7%AF%E7%BB%93%E6%9E%84"><span class="toc-number">10.3.</span> <span class="toc-text">层层链路结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">10.4.</span> <span class="toc-text">哨兵模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9"><span class="toc-number">11.</span> <span class="toc-text">Redis 缓存穿透和雪崩</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-1-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">11.1.</span> <span class="toc-text">11.1 缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">11.1.1.</span> <span class="toc-text">布隆过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BA%E5%AF%B9%E8%B1%A1"><span class="toc-number">11.1.2.</span> <span class="toc-text">缓存空对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="toc-number">11.2.</span> <span class="toc-text">缓存击穿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">11.3.</span> <span class="toc-text">缓存雪崩</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-订单服务实现"/></a><div class="content"><a class="title" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现">谷粒商城-订单服务实现</a><time datetime="2022-11-06T14:42:44.735Z" title="发表于 2022-11-06 22:42:44">2022-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-购物车逻辑实现"/></a><div class="content"><a class="title" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现">谷粒商城-购物车逻辑实现</a><time datetime="2022-11-03T07:19:16.711Z" title="发表于 2022-11-03 15:19:16">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户认证处理"/></a><div class="content"><a class="title" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理">谷粒商城-用户认证处理</a><time datetime="2022-10-30T02:15:21.954Z" title="发表于 2022-10-30 10:15:21">2022-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/28/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E5%A4%84%E7%90%86/" title="谷粒商城-用户商品详情处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户商品详情处理"/></a><div class="content"><a class="title" href="/2022/10/28/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E5%A4%84%E7%90%86/" title="谷粒商城-用户商品详情处理">谷粒商城-用户商品详情处理</a><time datetime="2022-10-28T08:39:51.722Z" title="发表于 2022-10-28 16:39:51">2022-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/24/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E6%90%9C%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86/" title="谷粒商城-用户搜索业务处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户搜索业务处理"/></a><div class="content"><a class="title" href="/2022/10/24/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E6%90%9C%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86/" title="谷粒商城-用户搜索业务处理">谷粒商城-用户搜索业务处理</a><time datetime="2022-10-24T14:24:27.926Z" title="发表于 2022-10-24 22:24:27">2022-10-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://w.wallhaven.cc/full/we/wallhaven-weoe9q.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By moon</div><div class="footer_custom_text">Hi, welcome to <a href="">月の子豚小屋</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'W7dceLXrUuiCITXy8cfM3sQ5-gzGzoHsz',
      appKey: 'Cu1minmiIoZRLGrJNxHnhZgn',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-mini="true" data-fixed="true" data-autoplay="true"> </div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>