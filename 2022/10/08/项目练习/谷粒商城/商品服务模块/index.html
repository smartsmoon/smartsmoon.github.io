<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>谷粒商城-商品服务模块 | 月の子豚小屋</title><meta name="keywords" content="SpringBoot"><meta name="author" content="moon"><meta name="copyright" content="moon"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="分类维护模块​	电商产品基本都是三级分类的形式，例如 图书—– 电子书刊——网络原创 这种层级。  关闭语法检查：build&#x2F;webpack.base.conf.js 文件下： 12345678910const createLintingRule &#x3D; () &#x3D;&gt; (&amp;#123;  &#x2F;&#x2F; test: &#x2F;\.(js|vue)$&#x2F;,  &#x2F;&#x2F; loader: &amp;#x27;eslint-loader&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="谷粒商城-商品服务模块">
<meta property="og:url" content="http://localhost:4000/2022/10/08/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="月の子豚小屋">
<meta property="og:description" content="分类维护模块​	电商产品基本都是三级分类的形式，例如 图书—– 电子书刊——网络原创 这种层级。  关闭语法检查：build&#x2F;webpack.base.conf.js 文件下： 12345678910const createLintingRule &#x3D; () &#x3D;&gt; (&amp;#123;  &#x2F;&#x2F; test: &#x2F;\.(js|vue)$&#x2F;,  &#x2F;&#x2F; loader: &amp;#x27;eslint-loader&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg">
<meta property="article:published_time" content="2022-10-08T06:39:42.531Z">
<meta property="article:modified_time" content="2022-10-25T07:49:03.935Z">
<meta property="article:author" content="moon">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg"><link rel="shortcut icon" href="https://w.wallhaven.cc/full/8o/wallhaven-8o2v82.jpg"><link rel="canonical" href="http://localhost:4000/2022/10/08/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '谷粒商城-商品服务模块',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-25 15:49:03'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic1.imgdb.cn/item/6337ca6e16f2c2beb17d8731.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">月の子豚小屋</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fas fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">谷粒商城-商品服务模块</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-08T06:39:42.531Z" title="发表于 2022-10-08 14:39:42">2022-10-08</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-10-25T07:49:03.935Z" title="更新于 2022-10-25 15:49:03">2022-10-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/">项目练习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E-%E5%B0%9A%E7%A1%85%E8%B0%B7/">谷粒商城-尚硅谷</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">24k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>108分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="谷粒商城-商品服务模块"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="分类维护模块"><a href="#分类维护模块" class="headerlink" title="分类维护模块"></a>分类维护模块</h2><p>​	电商产品基本都是三级分类的形式，例如 图书—– 电子书刊——网络原创 这种层级。</p>
<blockquote>
<p>关闭语法检查：<code>build/webpack.base.conf.js</code> 文件下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">createLintingRule</span> = (<span class="params"></span>) =&gt; (&#123;</span><br><span class="line">  <span class="comment">// test: /\.(js|vue)$/,</span></span><br><span class="line">  <span class="comment">// loader: &#x27;eslint-loader&#x27;,</span></span><br><span class="line">  <span class="comment">// enforce: &#x27;pre&#x27;,</span></span><br><span class="line">  <span class="comment">// include: [resolve(&#x27;src&#x27;), resolve(&#x27;test&#x27;)],</span></span><br><span class="line">  <span class="comment">// options: &#123;</span></span><br><span class="line">  <span class="comment">//   formatter: require(&#x27;eslint-friendly-formatter&#x27;),</span></span><br><span class="line">  <span class="comment">//   emitWarning: !config.dev.showEslintErrorsInOverlay</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="菜单显示"><a href="#菜单显示" class="headerlink" title="菜单显示"></a>菜单显示</h3><p>实现效果如下：</p>
<p><img src="https://pic1.imgdb.cn/item/634a58c416f2c2beb1105dbf.png"></p>
<p>1、导入分类数据，此处分类过多，暂不做 sql 语句的展示，可参考谷粒商城的电商项目 sql 语句。</p>
<blockquote>
<p>此时就可以在子项目 <code>shop-product</code> 中的 <code>CategoryController</code> 控制器根据需求修改原来的逆向工程生成的代码。</p>
</blockquote>
<p>2、修改 CategoryEntity 实体类，添加属性 Children，表示子分类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子分类:在数据表中不存在，标注为 false</span></span><br><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span>		<span class="comment">// 表示当结果为 null 时不设置</span></span><br><span class="line"><span class="keyword">private</span> List&lt;CategoryEntity&gt; children;</span><br></pre></td></tr></table></figure>

<p>3、由于我采用的高版本的 nacos，就必须配置 nacos 服务发现（目前不明白为什么，猜测<code>可能是版本的原因</code>），并且需要开启 nacos-server 单机版，如果不开启虽然能够正常查询数据，但是 Spring会提前停止。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring</span>: <span class="string"></span></span><br><span class="line">    <span class="attr">cloud</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">nacos</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">discovery</span>:<span class="string"></span></span><br><span class="line">            <span class="attr">server-addr</span>: <span class="string">127.0.0.1:8848</span></span><br><span class="line">    <span class="attr">application</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">shop-product</span></span><br></pre></td></tr></table></figure>

<p>4、CategoryController 添加请求用于查询所有分类并以树形结构组装起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查出所有分类以及子分类，以树形结构组装起来</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list/tree&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">listTree</span><span class="params">()</span>&#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; treeList = categoryService.listWithTree();</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, treeList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、CategoryService 添加方法 <code>listWithTree</code> 提供给 Controller 使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CategoryService 接口：</span></span><br><span class="line">List&lt;CategoryEntity&gt; <span class="title function_">listWithTree</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CategoryServiceImpl 实现：</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">listWithTree</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1 查出所有分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; categoryEntities = baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">//2 组装成树形结构</span></span><br><span class="line">    <span class="comment">//2.1 找到一级分类：pid = 0</span></span><br><span class="line">    List&lt;CategoryEntity&gt; levelMenus = categoryEntities.stream()</span><br><span class="line">        .filter((categoryEntity) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> categoryEntity.getParentCid() == <span class="number">0</span>;</span><br><span class="line">        &#125;).map((menu) -&gt; &#123;</span><br><span class="line">        menu.setChildren(getChildren(menu, categoryEntities));</span><br><span class="line">        <span class="keyword">return</span> menu;</span><br><span class="line">    &#125;).sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> (menu1.getSort() == <span class="literal">null</span> ? <span class="number">0</span> : menu1.getSort()) - (menu2.getSort() == <span class="literal">null</span> ? <span class="number">0</span> : menu2.getSort());</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> levelMenus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归查找所有菜单的子菜单</span></span><br><span class="line"><span class="keyword">private</span> List&lt;CategoryEntity&gt; <span class="title function_">getChildren</span><span class="params">(CategoryEntity root, List&lt;CategoryEntity&gt; menuList)</span>&#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; children =</span><br><span class="line">        menuList.stream().filter((categoryEntity) -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> categoryEntity.getParentCid().longValue() == root.getCatId().longValue();</span><br><span class="line">    &#125;).map((categoryEntity) -&gt; &#123;</span><br><span class="line">        <span class="comment">//递归遍历寻找子菜单，将每一个菜单的子菜单都进行递归寻找放入</span></span><br><span class="line">        categoryEntity.setChildren(getChildren(categoryEntity, menuList));</span><br><span class="line">        <span class="keyword">return</span> categoryEntity;</span><br><span class="line">    &#125;).sorted((menu1, menu2) -&gt; &#123;</span><br><span class="line">        <span class="comment">//菜单的排序</span></span><br><span class="line">        <span class="keyword">return</span> (menu1.getSort() == <span class="literal">null</span> ? <span class="number">0</span> : menu1.getSort()) - (menu2.getSort() == <span class="literal">null</span> ? <span class="number">0</span> : menu2.getSort());</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、启动后端项目 renren-fast，再启动前端项目 renren-fast-vue 项目，进入项目发现，实际上这个项目的路由和 vue 模板文件时对应的，所有的菜单页面都在 <code>views/modules</code> 目录下，sys 菜单配置都在 sys 目录下，因此我们在前端页面中添加菜单后，只需要创建新目录然后实现代码即可。</p>
<p>1）登录前端系统，选择系统管理下的菜单管理，添加菜单：<code>商品系统</code>，选择合适图标即可。</p>
<p><img src="https://pic1.imgdb.cn/item/63427daf16f2c2beb177d2ee.png"></p>
<p>2）继续添加菜单：<code>分类维护</code>，添加到商品系统下，菜单路由设置：<code>product/category</code> 。</p>
<p>3）在前端项目的 view&#x2F;modules 目录下新建目录 product，新建 <code>category.vue</code> 组件，实现分类的展示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot;&gt;&lt;/el-tree&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    data() &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            menus: [],</span><br><span class="line">            defaultProps: &#123;</span><br><span class="line">                children: &quot;children&quot;,	//子菜单选项</span><br><span class="line">                label: &quot;name&quot;	//name 属性是显示的菜单名称</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    mounted() &#123;</span><br><span class="line">        this.getMenus();</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    methods: &#123;</span><br><span class="line">        getMenus () &#123;</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&#x27;/product/category/list/tree&#x27;),</span><br><span class="line">                method: &#x27;get&#x27;</span><br><span class="line">            &#125;).then(data =&gt; &#123;</span><br><span class="line">                console.log(&quot;菜单数据：&quot;,data);</span><br><span class="line">            &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>4）此时测试前端页面，发现请求是给 8080 发送请求，而实际上应该给 10000 端口的商品服务发送请求，那么应该怎么办呢？</p>
<p>同时考虑到如果我们修改成 10000 端口，那么以后其他请求也是没办法实现转发的，因此肯定是需要给网关发送请求的，让网关 88 来统一管理转发所有的请求。</p>
<p>修改前端项目的默认 api 请求地址：<code>static/config/index.js</code> ，此处的 api 后缀用于后面网关的匹配断言。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">SITE_CONFIG</span>[<span class="string">&#x27;baseUrl&#x27;</span>] = <span class="string">&#x27;http://localhost:88/api&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>此时会发现前端网页会直接跳转登录页，同时验证码请求失败，这是因为验证码是在 renren-fast 项目服务中，那么此时就可以将renren-fast 也注册到注册中心，然后让网关将请求都转发到 renren-fast 服务中。</p>
<p>5）将 renren-fast 注入到注册中心中。</p>
<p>修改原来的 boot 版本，引入 common 工程，同时配置 cloud 的版本限制：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 修改 boot 版本同其他子项目对应 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 由于没有自动引用，需要手动添加 cloud 版本控制 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.SR3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 引入 common 工程 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 由于没有自动引用，需要手动添加 cloud 版本依赖控制 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 application.yml 配置文件修改注册到注册中心中：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">    <span class="attr">application:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">renren-fast</span></span><br><span class="line">      <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">nacos:</span></span><br><span class="line">          <span class="attr">discovery:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">172.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>

<p>添加 bootstrap.yml 配置文件配置中心信息，避免警告信息（如果 product 项目没有 <code>bootstrap.yml</code> 配置文件同样也需要添加）：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">renren-fast</span></span><br></pre></td></tr></table></figure>

<p>主启动类添加 <code>@EnableDiscoveryClient</code> 注解开启服务注册和发现。</p>
<blockquote>
<p>此时就发现需要引入 <code>shop-common</code> 模块，但是发现 cloud 版本和 boot 版本不匹配，项目无法成功启动，因此需要修改为 boot 版本和 cloud 版本。</p>
</blockquote>
<p>6）启动 gateway、renren-fast、product 项目，进入 nacos 客户端查看项目注册情况，发现都能成功注册到 nacos 注册中心。</p>
<p><img src="https://pic1.imgdb.cn/item/6343e29316f2c2beb10419c5.png"></p>
<p>7）网关配置路由规则，进行断言判断。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">admin_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://renren-fast</span>		<span class="comment"># lb 表示负载均衡</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment"># 规定前端项目的路由都带有 api 前缀</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/**</span></span><br></pre></td></tr></table></figure>

<p>8）再重新启动网关项目，但是此时 F12 再看验证码请求会发现，请求路径是：<code>http://localhost:88/api/captcha.jpg?uuid=xxx</code>，由于实际上 renren-fast 访问时还会有项目名：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span> </span><br><span class="line">    <span class="attr">servlet:</span></span><br><span class="line">        <span class="attr">context-path:</span> <span class="string">/renren-fast</span></span><br></pre></td></tr></table></figure>

<p>因此实际上我们应该让网关能将 URL 转化成 <code>http://localhost:8080/renren-fast/captcha.jpg?uuid=xxx</code> 才能实现正确访问，那么就需要网关的 filter 的路径重写功能，也就是在网关项目的 application.yml 中添加 <code>filters</code> 的路径重写配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;.*),/renren-fast/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>9）同时还应该想到登陆时前端项目是 8001 端口，访问的是 88 端口，也就会产生跨域问题 <code>Cors Policy</code>，那么就需要使用网关统一配置跨域。</p>
<blockquote>
<p><code>跨域</code>是指浏览器不能执行其他网站的脚本，是由浏览器的同源策略造成的，是<code>浏览器对 javascript 施加的安全限制</code>（例如发送 ajax 请求获取数据）。 </p>
<p><code>同源策略</code>是指协议，域名，端囗都要相同，其中有一个不同就会产生跨域。</p>
<p>解决办法：</p>
<p>1）使用 Nginx 部署为同域，统一使用 Nginx 服务。</p>
<p>2）配置当前请求允许跨域：<code>Access-Control-Allow-Origin/Methods/Credentials</code> 本地项目使用此种方式，且是在网关中统一配置。</p>
</blockquote>
<p>gateway 项目添加 config 包，编写 <code>CorsConfiguration</code> 跨域配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCorsConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CorsWebFilter <span class="title function_">corsWebFilter</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        <span class="comment">//配置跨域的设置</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);    <span class="comment">//允许哪些请求头</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);    <span class="comment">//允许哪些请求方式</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);    <span class="comment">//允许哪些请求来源</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="literal">true</span>);    <span class="comment">//是否允许携带 cookie 进行跨域</span></span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CorsWebFilter</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但此时还是有问题的，因为 renren-fast 内部自己也设置了跨域，此时就需要将 renren-fast 项目内部的 CrosConfig 跨域设置注释掉，避免重复配置为 mutli。</p>
<p>此时再重启 gateway 项目，进行登录测试，发现能够成功登录到系统。</p>
<p>10）网关配置新增路由，将 <code>/api/product</code> 请求都转发给 <code>shop-product</code> 服务。（<code>注意需要将精确的路由放在前面，否则会被模糊的路由提前拦截</code>）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://shop-product</span></span><br><span class="line">  <span class="attr">predicates:</span> <span class="comment"># 规定前端项目的路由都带有 /api/product/ 前缀</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>同时需要将 product 项目注册到 nacos 注册中心，同时也配置 nacos 配置中心相关信息。</p>
<p>此时前端控制台已经可以看到菜单信息，后面就需要在 getMenu 方法中将菜单数据装入到页面的元素中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getMenus () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">    	<span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&#x27;/product/category/list/tree&#x27;</span>),</span><br><span class="line">    	<span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    	<span class="comment">//将返回数据中的 data 解构出来</span></span><br><span class="line">    	<span class="variable language_">this</span>.<span class="property">menus</span> = data.<span class="property">data</span>;</span><br><span class="line">    	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;菜单数据：&quot;</span>,data);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="菜单删除"><a href="#菜单删除" class="headerlink" title="菜单删除"></a>菜单删除</h3><p>实现三级分类菜单删除功能需要注意 product 服务中实现 <code>逻辑删除</code>，因为在实际开发中并不会真实删除数据。</p>
<p>1、在 product 的 <code>application.yml</code> 配置文件中加入 mp 的全局逻辑删除规则的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span>   <span class="comment"># 1 表示已删除</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span>   <span class="comment"># 0 表示未删除</span></span><br></pre></td></tr></table></figure>

<p>2、在实体类上添加 <code>@TableLogic</code> 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableLogic(value = &quot;1&quot;, delval = &quot;0&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre></td></tr></table></figure>

<p>3、可以调整日志级别，查看删除操作时的 sql 语句：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.example.shop:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>4、后端 Controller 请求的实现逻辑：</p>
<p>1）CategoryController 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除菜单的选项（目前只完成一半）</span></span><br><span class="line"><span class="comment"> * RequestBody 注解用于获取请求体的内容（json）进行封装成对应的对象，但是也说明只能使用在 Post 请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catIds 待删除的菜单项 id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] catIds)</span>&#123;</span><br><span class="line">    categoryService.removeMenuByIds(Arrays.asList(catIds));</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）CategoryServiceImpl 层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeMenuByIds</span><span class="params">(List&lt;Long&gt; ids)</span> &#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span>检查当前删除的菜单是否被别的地方引用</span></span><br><span class="line">    baseMapper.deleteBatchIds(ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、前端项目使用 el-tree 的 <code>scoped slot</code> 函数功能添加删除按钮操作，同时添加多选框等实现逻辑，并且应该具有友好的提示框。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot; :expand-on-click-node=&quot;false&quot; :show-checkbox=&quot;true&quot; node-key=&quot;catId&quot; :default-expanded-keys=&quot;expendedKey&quot;&gt;</span><br><span class="line">    &lt;!-- expand-on-click-node = false 设置只有点击菜单箭头时才会展开，避免影响操作体验 --&gt;</span><br><span class="line">    &lt;!-- show-checkbox 用于多选, node-key 用于表示树节点的唯一 id,default-checked-keys用于设置删除菜单后默认展开的菜单，增加用户体验 --&gt;</span><br><span class="line">    &lt;span class=&quot;custom-tree-node&quot; slot-scope=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; node.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;!-- 设置只有当叶子菜单才显示 delete，其他菜单显示 append 按钮 --&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.childNodes.length == 0&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; remove(node, data)&quot; &gt; Delete &lt;/el-button&gt;</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-tree&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      menus: [],</span><br><span class="line">      defaultProps: &#123;</span><br><span class="line">        children: &quot;children&quot;,</span><br><span class="line">        label: &quot;name&quot;,</span><br><span class="line">      &#125;,</span><br><span class="line">      expendedKey:[]</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.getMenus();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    getMenus() &#123;</span><br><span class="line">      this.$http(&#123;</span><br><span class="line">        url: this.$http.adornUrl(&quot;/product/category/list/tree&quot;),</span><br><span class="line">        method: &quot;get&quot;,</span><br><span class="line">      &#125;).then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">        //将返回数据中的 data 解构出来</span><br><span class="line">        this.menus = data.data;</span><br><span class="line">        console.log(&quot;菜单数据：&quot;, data);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    //node 为当前节点的值（包括是否展开、层级属性等等），data 为节点代表的菜单项真正内容</span><br><span class="line">    remove(node, data)&#123;</span><br><span class="line">        //设置友好的弹窗，避免误操作</span><br><span class="line">        this.$confirm(`是否删除$&#123;data.name&#125;菜单项?`, &quot;提示&quot;, &#123;</span><br><span class="line">            confirmButtonText: &quot;确认&quot;,</span><br><span class="line">            cancelButtonText: &quot;取消&quot;,</span><br><span class="line">            type: &quot;warning&quot;</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">            var ids = [data.catId]</span><br><span class="line">            //实际发送请求删除菜单项</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&quot;/product/category/delete&quot;),</span><br><span class="line">                method: &quot;post&quot;,</span><br><span class="line">                data: this.$http.adornData(ids, false)</span><br><span class="line">            &#125;).then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">                this.$message(&#123;</span><br><span class="line">                    message: &quot;已成功删除菜单项&quot;,</span><br><span class="line">                    type: &#x27;success&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">                //刷新出新的菜单</span><br><span class="line">                this.getMenus();</span><br><span class="line">                //设置默认要展开的菜单，也就是刚删除菜单的父节点</span><br><span class="line">                this.expendedKey = [node.parent.data.catId];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;).catch(() =&gt; &#123;</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">                message: `已取消删除$&#123;data.name&#125;菜单项`,</span><br><span class="line">                type: &#x27;warning&#x27;</span><br><span class="line">            &#125;) </span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="菜单添加"><a href="#菜单添加" class="headerlink" title="菜单添加"></a>菜单添加</h3><p>菜单添加则希望能够点击 append 按钮，弹出一个对话框，在对话框中输入子分类的信息后发送请求添加到数据库中，实现菜单添加功能。</p>
<p>1、后端保存方法直接使用逆向工程的 save 代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> CategoryEntity category)</span>&#123;</span><br><span class="line">    categoryService.save(category);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前端需要使用对话框表单提交的方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot; :expand-on-click-node=&quot;false&quot; :show-checkbox=&quot;true&quot; node-key=&quot;catId&quot; :default-expanded-keys=&quot;expendedKey&quot;&gt;</span><br><span class="line">    &lt;!-- expand-on-click-node = false 设置只有点击菜单箭头时才会展开，避免影响操作体验 --&gt;</span><br><span class="line">    &lt;!-- show-checkbox 用于多选, node-key 用于表示树节点的唯一 id,default-checked-keys用于设置删除菜单后默认展开的菜单，增加用户体验 --&gt;</span><br><span class="line">    &lt;span class=&quot;custom-tree-node&quot; slot-scope=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; node.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;!-- 设置只有当叶子菜单才显示 delete，其他菜单显示 append 按钮 --&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.level &lt;= 2&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; append(data)&quot;&gt; Append &lt;/el-button&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.childNodes.length == 0&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; remove(node, data)&quot; &gt; Delete &lt;/el-button&gt;</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-tree&gt;</span><br><span class="line">  &lt;el-dialog title=&quot;&quot; :visible.sync=&quot;dialogVisible&quot; width=&quot;30%&quot; :before-close=&quot;canceSave&quot;&gt;</span><br><span class="line">    &lt;el-form :model=&quot;category&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;分类名称&quot;&gt;</span><br><span class="line">            &lt;el-input v-model=&quot;category.name&quot; auto-complete=&quot;off&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">    &lt;span slot=&quot;footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click=&quot;canceSave&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;addCategory&quot;&gt;确认&lt;/el-button&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-dialog&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      menus: [],</span><br><span class="line">      defaultProps: &#123;</span><br><span class="line">        children: &quot;children&quot;,</span><br><span class="line">        label: &quot;name&quot;,</span><br><span class="line">      &#125;,</span><br><span class="line">      expendedKey:[],</span><br><span class="line">      dialogVisible: false,</span><br><span class="line">      category: &#123;</span><br><span class="line">        name: &quot;&quot;,</span><br><span class="line">        parentCid: 0,</span><br><span class="line">        cateLevel: 0,</span><br><span class="line">        showStatus: 1,</span><br><span class="line">        sort: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.getMenus();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    getMenus() &#123;</span><br><span class="line">      // 见之前以实现的对应功能</span><br><span class="line">    &#125;,</span><br><span class="line">    append(data)&#123;</span><br><span class="line">        console.log(data);</span><br><span class="line">        this.dialogVisible = true;</span><br><span class="line">        this.category.parentCid = data.catId;</span><br><span class="line">        this.category.cateLevel = data.cateLevel + 1;</span><br><span class="line">    &#125;,</span><br><span class="line">    //添加三级分类数据</span><br><span class="line">    addCategory()&#123;</span><br><span class="line">        this.$confirm(`是否确认添加 【$&#123;this.category.name&#125;】 子菜单项?`, &quot;提示&quot;, &#123;</span><br><span class="line">            confirmButtonText: &quot;确认&quot;,</span><br><span class="line">            cancelButtonText: &quot;取消&quot;,</span><br><span class="line">            type: &quot;warning&quot;</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&#x27;/product/category/save&#x27;),</span><br><span class="line">                method: &#x27;post&#x27;,</span><br><span class="line">                data: this.$http.adornData(this.category, false)</span><br><span class="line">            &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">                this.$message(&#123;</span><br><span class="line">                    message: &quot;成功添加子菜单&quot;,</span><br><span class="line">                    type: &#x27;success&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">                this.dialogVisible = false;</span><br><span class="line">                this.category.name = &quot;&quot;;</span><br><span class="line">                this.getMenus();</span><br><span class="line">                this.expendedKey = [this.category.parentCid];</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;).catch(() =&gt; &#123;</span><br><span class="line">            this.dialogVisible = false;</span><br><span class="line">            this.category.name = &quot;&quot;;</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">                message: `已取消添加$&#123;this.category.name&#125;菜单项`,</span><br><span class="line">                type: &#x27;warning&#x27;</span><br><span class="line">            &#125;) </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //用于清空取消添加时的表单中的残留数据</span><br><span class="line">    canceSave()&#123;</span><br><span class="line">        this.dialogVisible = false;</span><br><span class="line">        this.category.name = &quot;&quot;;</span><br><span class="line">    &#125;,</span><br><span class="line">    remove(node, data)&#123;		// 见之前以实现的对应功能</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="菜单修改"><a href="#菜单修改" class="headerlink" title="菜单修改"></a>菜单修改</h3><p>菜单修改需要在原先的基础上再加一个 edit 按钮，点击按钮需要弹出对话框，需要完成数据的回显，并实现数据修改后的提交。</p>
<p>1、修改菜单的后端逻辑的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改分类的相关信息，实际上是利用 catId 来选择分类进行修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> category 修改后的分类信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 修改请求的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> CategoryEntity category)</span>&#123;</span><br><span class="line">    categoryService.updateById(category);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 id 查询分类信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catId 分类 id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 查询到的分类信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/info/&#123;catId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;catId&quot;)</span> Long catId)</span>&#123;</span><br><span class="line">    <span class="type">CategoryEntity</span> <span class="variable">category</span> <span class="operator">=</span> categoryService.getById(catId);</span><br><span class="line">    <span class="comment">//TODO：后续还要做冗余表中字段的更新</span></span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, category);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、修改菜单的前端逻辑实现，前端需要公用一个对话框，需要修改对话框内部原来的提交函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot; :expand-on-click-node=&quot;false&quot; :show-checkbox=&quot;true&quot; node-key=&quot;catId&quot; :default-expanded-keys=&quot;expendedKey&quot;&gt;</span><br><span class="line">    &lt;!-- expand-on-click-node = false 设置只有点击菜单箭头时才会展开，避免影响操作体验 --&gt;</span><br><span class="line">    &lt;!-- show-checkbox 用于多选, node-key 用于表示树节点的唯一 id,default-checked-keys用于设置删除菜单后默认展开的菜单，增加用户体验 --&gt;</span><br><span class="line">    &lt;span class=&quot;custom-tree-node&quot; slot-scope=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; node.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;!-- 设置只有当叶子菜单才显示 delete，其他菜单显示 append 按钮 --&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.level &lt;= 2&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; append(data)&quot;&gt; Append &lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; edit(data)&quot;&gt; edit &lt;/el-button&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.childNodes.length == 0&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; remove(node, data)&quot; &gt; Delete &lt;/el-button&gt;</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-tree&gt;</span><br><span class="line">  &lt;el-dialog :title=&quot;title&quot; :visible.sync=&quot;dialogVisible&quot; width=&quot;30%&quot; :before-close=&quot;canceSave&quot;&gt;</span><br><span class="line">    &lt;el-form :model=&quot;category&quot;&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;分类名称&quot;&gt;</span><br><span class="line">            &lt;el-input v-model=&quot;category.name&quot; auto-complete=&quot;off&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;图标&quot;&gt;</span><br><span class="line">            &lt;el-input v-model=&quot;category.icon&quot; auto-complete=&quot;off&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">        &lt;el-form-item label=&quot;计量单位&quot;&gt;</span><br><span class="line">            &lt;el-input v-model=&quot;category.productUnit&quot; auto-complete=&quot;off&quot;&gt;&lt;/el-input&gt;</span><br><span class="line">        &lt;/el-form-item&gt;</span><br><span class="line">    &lt;/el-form&gt;</span><br><span class="line">    &lt;span slot=&quot;footer&quot;&gt;</span><br><span class="line">        &lt;el-button @click=&quot;canceSave&quot;&gt;取消&lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;primary&quot; @click=&quot;submitData&quot;&gt;确认&lt;/el-button&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-dialog&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      menus: [],</span><br><span class="line">      defaultProps: &#123;</span><br><span class="line">        children: &quot;children&quot;,</span><br><span class="line">        label: &quot;name&quot;,</span><br><span class="line">      &#125;,</span><br><span class="line">      expendedKey:[],</span><br><span class="line">      dialogVisible: false,</span><br><span class="line">      dialogType: &quot;&quot;, //edit,add</span><br><span class="line">      title: &quot;&quot;,</span><br><span class="line">      category: &#123;</span><br><span class="line">        catId: null,</span><br><span class="line">        name: &quot;&quot;,</span><br><span class="line">        parentCid: 0,</span><br><span class="line">        cateLevel: 0,</span><br><span class="line">        showStatus: 1,</span><br><span class="line">        sort: 0,</span><br><span class="line">        productUnit: &quot;&quot;,</span><br><span class="line">        icon: &quot;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.getMenus();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    getMenus() &#123;</span><br><span class="line">      this.$http(&#123;</span><br><span class="line">        url: this.$http.adornUrl(&quot;/product/category/list/tree&quot;),</span><br><span class="line">        method: &quot;get&quot;,</span><br><span class="line">      &#125;).then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">        //将返回数据中的 data 解构出来</span><br><span class="line">        this.menus = data.data;</span><br><span class="line">        console.log(&quot;菜单数据：&quot;, data);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    //对话框提交数据</span><br><span class="line">    submitData()&#123;</span><br><span class="line">      if(this.dialogType == &quot;add&quot;)&#123;</span><br><span class="line">        this.addCategory();</span><br><span class="line">      &#125;</span><br><span class="line">      if(this.dialogType == &quot;edit&quot;)&#123;</span><br><span class="line">        this.editCategory();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    append(data)&#123;</span><br><span class="line">      this.dialogType = &quot;add&quot;;</span><br><span class="line">      this.title = &quot;添加分类&quot;;</span><br><span class="line">      console.log(data);</span><br><span class="line">      this.dialogVisible = true;</span><br><span class="line">      this.category.parentCid = data.catId;</span><br><span class="line">      this.category.cateLevel = data.cateLevel + 1;</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    //添加三级分类数据</span><br><span class="line">    addCategory()&#123;</span><br><span class="line">        this.$confirm(`是否确认添加 【$&#123;this.category.name&#125;】 子菜单项?`, &quot;提示&quot;, &#123;</span><br><span class="line">            confirmButtonText: &quot;确认&quot;,</span><br><span class="line">            cancelButtonText: &quot;取消&quot;,</span><br><span class="line">            type: &quot;warning&quot;</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&#x27;/product/category/save&#x27;),</span><br><span class="line">                method: &#x27;post&#x27;,</span><br><span class="line">                data: this.$http.adornData(this.category, false)</span><br><span class="line">            &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">                this.$message(&#123;</span><br><span class="line">                    message: &quot;成功添加子菜单&quot;,</span><br><span class="line">                    type: &#x27;success&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">                this.dialogVisible = false;</span><br><span class="line">                this.category.name = &quot;&quot;;</span><br><span class="line">                this.getMenus();</span><br><span class="line">                this.expendedKey = [this.category.parentCid];</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;).catch(() =&gt; &#123;</span><br><span class="line">            this.dialogVisible = false;</span><br><span class="line">            this.category.name = &quot;&quot;;</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">                message: `已取消添加$&#123;this.category.name&#125;菜单项`,</span><br><span class="line">                type: &#x27;warning&#x27;</span><br><span class="line">            &#125;) </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //用于清空取消添加时的表单中的残留数据</span><br><span class="line">    canceSave()&#123;</span><br><span class="line">        this.dialogVisible = false;</span><br><span class="line">        this.category.name = &quot;&quot;;</span><br><span class="line">    &#125;,</span><br><span class="line">    //弹出修改对话框</span><br><span class="line">    edit(data)&#123;</span><br><span class="line">        this.dialogType = &quot;edit&quot;;</span><br><span class="line">        this.title = &quot;修改分类&quot;;</span><br><span class="line">        this.dialogVisible = true;</span><br><span class="line">        //需要发起请求获取回显数据，而不应该是直接使用点击的数据，因为可能会多个操作人员进行操作</span><br><span class="line">        this.$http(&#123;</span><br><span class="line">          url: this.$http.adornUrl(`/product/category/info/$&#123;data.catId&#125;`),</span><br><span class="line">          method: &#x27;get&#x27;</span><br><span class="line">        &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">          //请求成功进行数据回显</span><br><span class="line">          this.category.name = data.data.name;</span><br><span class="line">          this.category.catId = data.data.catId;</span><br><span class="line">          this.category.icon = data.data.icon;</span><br><span class="line">          this.category.productUnit = data.data.productUnit;</span><br><span class="line">          this.category.parentCid = data.data.parentCid;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">    &#125;,</span><br><span class="line">    //修改菜单信息,只修改基本信息，sort、parentId 等信息不修改（后续会拖拽修改），因此需要抽取某些字段发送到后端，而不能将所有信息发送到后端导致覆盖</span><br><span class="line">    editCategory()&#123;</span><br><span class="line">      var &#123;catId, name, icon, productUnit&#125; = this.category;</span><br><span class="line">      this.$http(&#123;</span><br><span class="line">        url: this.$http.adornUrl(&#x27;/product/category/update&#x27;),</span><br><span class="line">        method: &#x27;post&#x27;,</span><br><span class="line">        data: this.$http.adornData(&#123;catId, name, icon, productUnit&#125;, false)</span><br><span class="line">      &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">        this.$message(&#123;</span><br><span class="line">            message: `菜单修改成功`,</span><br><span class="line">            type: &#x27;success&#x27;</span><br><span class="line">        &#125;);</span><br><span class="line">        this.dialogVisible = false;</span><br><span class="line">        this.getMenus();</span><br><span class="line">        this.expendedKey = [this.category.parentCid];</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //node 为当前节点的值（包括是否展开、层级属性等等），data 为节点代表的菜单项真正内容</span><br><span class="line">    remove(node, data)&#123;</span><br><span class="line">        //设置友好的弹窗，避免误操作</span><br><span class="line">        this.$confirm(`是否删除$&#123;data.name&#125;菜单项?`, &quot;提示&quot;, &#123;</span><br><span class="line">            confirmButtonText: &quot;确认&quot;,</span><br><span class="line">            cancelButtonText: &quot;取消&quot;,</span><br><span class="line">            type: &quot;warning&quot;</span><br><span class="line">        &#125;).then(() =&gt; &#123;</span><br><span class="line">            var ids = [data.catId]</span><br><span class="line">            //实际发送请求删除菜单项</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&quot;/product/category/delete&quot;),</span><br><span class="line">                method: &quot;post&quot;,</span><br><span class="line">                data: this.$http.adornData(ids, false)</span><br><span class="line">            &#125;).then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">                this.$message(&#123;</span><br><span class="line">                    message: &quot;已成功删除菜单项&quot;,</span><br><span class="line">                    type: &#x27;success&#x27;</span><br><span class="line">                &#125;)</span><br><span class="line">                //刷新出新的菜单</span><br><span class="line">                this.getMenus();</span><br><span class="line">                //设置默认要展开的菜单，也就是刚删除菜单的父节点</span><br><span class="line">                this.expendedKey = [node.parent.data.catId];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;).catch(() =&gt; &#123;</span><br><span class="line">            this.$message(&#123;</span><br><span class="line">                message: `已取消删除$&#123;data.name&#125;菜单项`,</span><br><span class="line">                type: &#x27;warning&#x27;</span><br><span class="line">            &#125;) </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="拖拽功能"><a href="#拖拽功能" class="headerlink" title="拖拽功能"></a>拖拽功能</h3><p>设置 el-tree 的 <code>draggable</code> 属性，表示可拖拽节点，<code>allow-drop</code> 属性则是指定一个函数，表示节点是否可以放在某个位置的判断。</p>
<p>1、后端提供批量更新的接口，更新拖拽菜单的集合信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据前端的拖拽信息修改数据库信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categories 要修改菜单的集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 更新请求结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update/sort&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">updateSort</span><span class="params">(<span class="meta">@RequestBody</span> CategoryEntity[] categories)</span>&#123;</span><br><span class="line">    categoryService.updateBatchById(Arrays.asList(categories));</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、前端实现页面（此部分页面可能会有问题，但是更专注于后端即可）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;el-switch v-model=&quot;draggable&quot; active-text=&quot;开启拖拽&quot; inactive-text=&quot;关闭拖拽&quot;&gt;&lt;/el-switch&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; v-if=&quot;draggable&quot; @click=&quot;batchSave&quot;&gt;批量保存&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;danger&quot; size=&quot;mini&quot; @click=&quot;batchDelete&quot;&gt;批量删除&lt;/el-button&gt;</span><br><span class="line">  &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot; :draggable=&quot;draggable&quot; :expand-on-click-node=&quot;false&quot; ref=&quot;menuTree&quot;</span><br><span class="line">    :show-checkbox=&quot;true&quot; node-key=&quot;catId&quot; :default-expanded-keys=&quot;expendedKey&quot; :allow-drop=&quot;allowDrop&quot; @node-drop=&quot;handleDrop&quot;&gt;</span><br><span class="line">    &lt;!-- expand-on-click-node = false 设置只有点击菜单箭头时才会展开，避免影响操作体验 --&gt;</span><br><span class="line">    &lt;!-- show-checkbox 用于多选, node-key 用于表示树节点的唯一 id,default-checked-keys用于设置删除菜单后默认展开的菜单，增加用户体验 --&gt;</span><br><span class="line">    &lt;!-- draggable 开启拖拽功能，allow-drop 用于指定拖拽可放位置的设定函数 --&gt;</span><br><span class="line">    &lt;!-- node-drop 监听事件，表示拖拽成功时触发的事件，四个参数：被拖拽节点Node、拖拽进入的节点、放置位置、事件 event --&gt;</span><br><span class="line">    &lt;!-- ref 相当于用于 js 的选择器，用于后续调用组件的方法 --&gt;</span><br><span class="line">    &lt;span class=&quot;custom-tree-node&quot; slot-scope=&quot;&#123; node, data &#125;&quot;&gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; node.label &#125;&#125;&lt;/span&gt;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;!-- 设置只有当叶子菜单才显示 delete，其他菜单显示 append 按钮 --&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.level &lt;= 2&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; append(data)&quot;&gt; Append &lt;/el-button&gt;</span><br><span class="line">        &lt;el-button type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; edit(data)&quot;&gt; edit &lt;/el-button&gt;</span><br><span class="line">        &lt;el-button v-if=&quot;node.childNodes.length == 0&quot; type=&quot;text&quot; size=&quot;mini&quot; @click=&quot;() =&gt; remove(node, data)&quot; &gt; Delete &lt;/el-button&gt;</span><br><span class="line">      &lt;/span&gt;</span><br><span class="line">    &lt;/span&gt;</span><br><span class="line">  &lt;/el-tree&gt;</span><br><span class="line">  &lt;!-- 之前代码不做赘述 --&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      //之前代码不做赘述</span><br><span class="line">      maxLevel: 0,</span><br><span class="line">      pCid: [],</span><br><span class="line">      updateNodes: []</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted() &#123;</span><br><span class="line">    this.getMenus();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    //之前代码不做赘述</span><br><span class="line">    batchSave()&#123;</span><br><span class="line">      //此时需要修改的节点整理完毕，点击按钮就需要发送请求到后端进行实际的修改</span><br><span class="line">      this.$http(&#123;</span><br><span class="line">        url: this.$http.adornUrl(&#x27;/product/category/update/sort&#x27;),</span><br><span class="line">        method: &#x27;post&#x27;,</span><br><span class="line">        data: this.$http.adornData(this.updateNodes, false)</span><br><span class="line">      &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">        this.$message(&#123;</span><br><span class="line">            message: &quot;菜单更新成功!&quot;,</span><br><span class="line">            type: &#x27;success&#x27;</span><br><span class="line">        &#125;)</span><br><span class="line">        this.getMenus();</span><br><span class="line">        this.expendedKey = this.pCid;</span><br><span class="line">        //清空状态，避免 updateNodes 内部数据重复更新</span><br><span class="line">        this.updateNodes = [];</span><br><span class="line">        this.maxLevel = 0;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    //拖拽实现的位置判断函数，draggingNode表示当前节点，dropNode 表示放到哪些节点的 type 位置（next、prev、inner三种 type）。</span><br><span class="line">    allowDrop(draggingNode, dropNode, type)&#123;</span><br><span class="line">      console.log(&quot;allowDrop:&quot;, draggingNode, dropNode, type);</span><br><span class="line">      //判断总层数不能大于 3</span><br><span class="line">      this.countNodeLevel(draggingNode.data);</span><br><span class="line">      //当前拖拽的节点+所在的父节点的层级不大于3就可以放置</span><br><span class="line">      let deep = Math.abs(this.maxLevel - draggingNode.level) + 1;</span><br><span class="line">      if(type == &quot;inner&quot;)&#123;</span><br><span class="line">        return (deep + dropNode.level) &lt;= 3;</span><br><span class="line">      &#125;else &#123;</span><br><span class="line">        return (deep + dropNode.parent.level) &lt;= 3;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //统计当前节点的最大深度</span><br><span class="line">    countNodeLevel(node)&#123;</span><br><span class="line">      if(node.childNodes != null &amp;&amp; node.childNodes.length &gt; 0)&#123;</span><br><span class="line">          for (let i = 0; i &lt; node.childNodes.length; i++)&#123;</span><br><span class="line">            if(node.childNodes[i].level &gt; this.maxLevel)&#123;</span><br><span class="line">              this.maxLevel = node.childNodes[i].catLevel;</span><br><span class="line">            &#125;</span><br><span class="line">            //递归查找</span><br><span class="line">            this.countNodeLevel(node.childNodes[i]);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //拖拽成功的回调函数</span><br><span class="line">    handleDrop(draggingNode, dropNode, dropType, event)&#123;</span><br><span class="line">      let pCid = 0;</span><br><span class="line">      let brotherNodes = null;</span><br><span class="line">      //1.当前节点的最新父节点的 id</span><br><span class="line">      if(dropType == &quot;before&quot; || dropType == &quot;after&quot;)&#123;</span><br><span class="line">        pCid = dropNode.parent.data.catId == undefined ? 0 : dropNode.parent.data.catId;</span><br><span class="line">        brotherNodes = dropNode.parent.childNodes;</span><br><span class="line">      &#125;else &#123;</span><br><span class="line">        pCid = dropNode.data.catId;</span><br><span class="line">        brotherNodes = dropNode.childNodes;</span><br><span class="line">      &#125;</span><br><span class="line">      this.pCid.push(pCid);</span><br><span class="line">      //2.当前拖拽节点的最新顺序</span><br><span class="line">      for(let i = 0; i &lt; brotherNodes.length; i++)&#123;</span><br><span class="line">        if(brotherNodes[i].data.catId == dropNode.data.catId)&#123;</span><br><span class="line">          //如果遍历到当前拖拽的节点，那么就需要添加新的父id</span><br><span class="line">          //3.判断当前拖拽节点的最新层级</span><br><span class="line">          let catLevel = draggingNode.level;</span><br><span class="line">          if(brotherNodes[i].level != draggingNode.level)&#123;</span><br><span class="line">            //当前节点的层级发生变化</span><br><span class="line">            catLevel = brotherNodes[i].level;</span><br><span class="line">            //修改子节点的层级</span><br><span class="line">            this.updateChildNodeLevel(brotherNodes[i])</span><br><span class="line">          &#125;</span><br><span class="line">          this.updateNodes.push(&#123;catId:brotherNodes[i].data.catId, sort: i, parentCId: pCid, catLevel: catLevel&#125;)</span><br><span class="line">          </span><br><span class="line">        &#125;else &#123;</span><br><span class="line">          //兄弟元素只更改顺序</span><br><span class="line">          this.updateNodes.push(&#123;catId:brotherNodes[i].data.catId, sort: i&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    //修改子节点的层级</span><br><span class="line">    updateChildNodeLevel(node)&#123;</span><br><span class="line">      if(node.childNodes.length &gt; 0)&#123;</span><br><span class="line">        for(let i = 0; i &lt; node.childNodes.length; i++)&#123;</span><br><span class="line">          var cNode = node.childNodes[i].data;</span><br><span class="line">          this.updateNodes.push(&#123;catId: cNode.catId, catLevel: node.childNodes[i].level&#125;)</span><br><span class="line">          this.updateChildNodeLevel(node.childNodes[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><p>批量删除实际上就是借用 el-tree 的方法来发送请求删除数据，delete 批量方法就使用原来的请求接口 <code>delete</code> 即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ref 相当于用于 js 的选择器，用于后续调用组件的方法 --&gt;</span><br><span class="line"><span class="number">1</span>、el-tree 添加 ref 属性</span><br><span class="line"><span class="number">2</span>、添加批量删除按钮</span><br><span class="line">&lt;el-button type=<span class="string">&quot;danger&quot;</span> size=<span class="string">&quot;mini&quot;</span> @click=<span class="string">&quot;batchDelete&quot;</span>&gt;批量删除&lt;/el-button&gt;</span><br><span class="line"><span class="number">3</span>、实现 batchDelete 功能</span><br><span class="line"><span class="title function_">batchDelete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> catIds = [];</span><br><span class="line">    <span class="keyword">let</span> checkedNodes = <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">menuTree</span>.<span class="title function_">getCheckedNodes</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; checkedNodes.<span class="property">length</span>; i++)&#123;</span><br><span class="line">    	catIds.<span class="title function_">push</span>(checkedNodes[i].<span class="property">catId</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.$confirm(<span class="string">`是否确认批量删除菜单项?`</span>, <span class="string">&quot;提示&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">confirmButtonText</span>: <span class="string">&quot;确认&quot;</span>,</span><br><span class="line">        <span class="attr">cancelButtonText</span>: <span class="string">&quot;取消&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    	<span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">    		<span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">&#x27;/product/category/delete&#x27;</span>),</span><br><span class="line">    		<span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">    		<span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(catIds, <span class="literal">false</span>)</span><br><span class="line">    	&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    		<span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">   				<span class="attr">message</span>: <span class="string">&quot;成功批量删除子菜单&quot;</span>,</span><br><span class="line">    			<span class="attr">type</span>: <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    		&#125;)</span><br><span class="line">    		<span class="variable language_">this</span>.<span class="title function_">getMenus</span>();</span><br><span class="line">    	&#125;)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    	<span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">    		<span class="attr">message</span>: <span class="string">`已取消删除菜单项`</span>,</span><br><span class="line">    		<span class="attr">type</span>: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    	&#125;) </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="品牌管理模块"><a href="#品牌管理模块" class="headerlink" title="品牌管理模块"></a>品牌管理模块</h2><p>和分类维护类似，在商品系统下创建一个子菜单：品牌管理，将之前逆向生成的代码中的 <code>brand.vue 和 brand-add-or-update.vue</code> 页面加入到 product 目录下。</p>
<p>但是能够发现前端页面中按钮是具有权限设置的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-button v-if=&quot;isAuth(&#x27;product:brand:save&#x27;)&quot; type=&quot;primary&quot; @click=&quot;addOrUpdateHandle()&quot;&gt;新增&lt;/el-button&gt;</span><br><span class="line">&lt;el-button v-if=&quot;isAuth(&#x27;product:brand:delete&#x27;)&quot; type=&quot;danger&quot; @click=&quot;deleteHandle()&quot; </span><br><span class="line">           :disabled=&quot;dataListSelections.length &lt;= 0&quot;&gt;批量删除&lt;/el-button&gt;</span><br></pre></td></tr></table></figure>

<p>注释掉权限判断的相关方法，也就是 <code>utils/index.js</code> 里面的权限判断：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 权限判断</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isAuth</span> (key) &#123;</span><br><span class="line">  <span class="comment">// return JSON.parse(sessionStorage.getItem(&#x27;permissions&#x27;) || &#x27;[]&#x27;).indexOf(key) !== -1 || false</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时新增和批量删除的按钮已经显示，同时功能都是完好的，我们在此基础上只需要进行效果的优化即可。</p>
<h3 id="配置分页插件"><a href="#配置分页插件" class="headerlink" title="配置分页插件"></a>配置分页插件</h3><p>根据官方提示，配置分页插件需要编写配置类，引入 <code>MybatisPlusInterceptor</code> 后即可使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.example.product.dao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="type">PaginationInnerInterceptor</span> <span class="variable">interceptor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.H2);</span><br><span class="line">        interceptor1.setMaxLimit(<span class="number">1000L</span>);	<span class="comment">//限制最大条数</span></span><br><span class="line">        interceptor1.setOverflow(<span class="literal">true</span>);		<span class="comment">//超出跳转到第一页</span></span><br><span class="line">        interceptor.addInnerInterceptor(interceptor1);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ConfigurationCustomizer <span class="title function_">configurationCustomizer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> configuration -&gt; configuration.setUseDeprecatedExecutor(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="显示状态优化"><a href="#显示状态优化" class="headerlink" title="显示状态优化"></a>显示状态优化</h3><p>原本的显示状态为 0&#x2F;1，需要将 0 和 1 显示优化成使用 <code>slot</code> 的开关显示效果，同时也需要修改新增对话框的 01 显示效果，前端页面样式变化，但是还是需要像后端发请求使数据真实修改，通过 <code>change</code> 事件来实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- brand.vue --&gt;</span><br><span class="line">&lt;el-table-column prop=&quot;showStatus&quot; header-align=&quot;center&quot; align=&quot;center&quot; label=&quot;显示状态&quot;&gt;</span><br><span class="line">    &lt;template slot-scope=&quot;scope&quot;&gt;</span><br><span class="line">		&lt;el-switch v-model=&quot;scope.row.showStatus&quot; active-color=&quot;#13ce66&quot; inactive-color=&quot;#ff4949&quot; </span><br><span class="line">                   @change=&quot;updateBrandStatus(scope.row)&quot; :active-value=&quot;1&quot; :inactive-value=&quot;0&quot;&gt;</span><br><span class="line">        &lt;/el-switch&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">&lt;/el-table-column&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- brand-add-or-update.vue --&gt;</span><br><span class="line">&lt;!-- 修改 label-width 宽度 --&gt;</span><br><span class="line">&lt;el-form :model=&quot;dataForm&quot; :rules=&quot;dataRule&quot; ref=&quot;dataForm&quot; @keyup.enter.native=&quot;dataFormSubmit()&quot; label-width=&quot;140px&quot;&gt;</span><br><span class="line">&lt;el-form-item label=&quot;显示状态&quot; prop=&quot;showStatus&quot;&gt;</span><br><span class="line">    &lt;el-switch v-model=&quot;dataForm.showStatus&quot; active-color=&quot;#13ce66&quot; inactive-color=&quot;#ff4949&quot; :active-value=&quot;1&quot; :inactive-value=&quot;0&quot;&gt;</span><br><span class="line">    &lt;/el-switch&gt;</span><br><span class="line">&lt;/el-form-item&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 实际的 updateBrandStatus 请求方法 --&gt;</span><br><span class="line">updateBrandStatus(data)&#123;</span><br><span class="line">    console.log(&quot;最新信息&quot;, data);</span><br><span class="line">    let &#123;brandId, showStatus&#125; = data;</span><br><span class="line">    this.$http(&#123;</span><br><span class="line">    	url: this.$http.adornUrl(&#x27;/product/brand/update&#x27;),</span><br><span class="line">    	method: &#x27;post&#x27;,</span><br><span class="line">    	data: this.$http.adornData(&#123;brandId, showStatus&#125;, false)</span><br><span class="line">    &#125;).then((&#123;data&#125;) =&gt; &#123;</span><br><span class="line">    	this.$message(&#123;</span><br><span class="line">    		type: &quot;success&quot;,</span><br><span class="line">    		message: &quot;状态更新成功&quot;</span><br><span class="line">    	&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>后端的逻辑位于 <code>BrandController</code> 中的 update 请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据 id 修改 Brand 品牌</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brand 想要修改后的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line">    brandService.updateById(brand);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span>需要更新关联表</span></span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询品牌列表"><a href="#查询品牌列表" class="headerlink" title="查询品牌列表"></a>查询品牌列表</h3><p>前端代码使用逆向工程生成的代码，但是并未做模糊匹配的搜索，因此需要修改原来的 service，添加查询条件的限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    QueryWrapper&lt;BrandEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (！StringUtils.isEmpty(searchKey))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, searchKey).or().like(<span class="string">&quot;name&quot;</span>, searchKey);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;BrandEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;BrandEntity&gt;().getPage(params),wrapper);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://pic1.imgdb.cn/item/634a586816f2c2beb10fca16.png"></p>
<h3 id="关联分类实现"><a href="#关联分类实现" class="headerlink" title="关联分类实现"></a>关联分类实现</h3><p>将谷粒商城提供的代码 common 和 product 里面的文件替换掉原来自己编写的 <code>view/modules</code> 下面的文件（前端代码不重点写），方便之后根据前端确定的接口文档编写后端 api 接口。</p>
<blockquote>
<p>注意：前端抽取组件和主页面的通信采用的是 Pubsub.js 实现，因此需要导入 Pubsub.js：</p>
<p>1）命令行执行：npm install –save pubsub-js –registry&#x3D;<a target="_blank" rel="noopener" href="https://registry.npm.taobao.org/">https://registry.npm.taobao.org</a> –force</p>
<p>2）src 目录下的 main 添加引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">PubSub</span> <span class="keyword">from</span> <span class="string">&#x27;pubsub-js&#x27;</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">PubSub</span> = <span class="title class_">PubSub</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="https://pic1.imgdb.cn/item/634a594216f2c2beb1113bec.png"></p>
<p><code>关联分类</code>是指一个品牌可以关联到多个分类，而一个分类也可以关联到多个品牌，因此品牌和分类是 <code>多对多</code> 的关系，因此数据库中也就会存在一个中间表，也就是 <code>pms_category_brand_relation</code> 表，用于维持二者的关系。</p>
<p>1、根据提供的代码会发现需要两个请求：</p>
<p>CategoryBrandRelationController 捕获请求逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取某个品牌关联的所有分类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brandId 品牌id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 关联分类信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/catelog/list&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam(&quot;brandId&quot;)</span> Long brandId)</span>&#123;</span><br><span class="line">    QueryWrapper&lt;CategoryBrandRelationEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, brandId);</span><br><span class="line">    List&lt;CategoryBrandRelationEntity&gt; data = categoryBrandRelationService.list(wrapper);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关系信息的保存，此处前端传递信息并不包括某些字段，需要完成字段的填充</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryBrandRelation 参数只包括 brandId 和 catelogId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 保存关联关系的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> CategoryBrandRelationEntity categoryBrandRelation)</span>&#123;</span><br><span class="line">    categoryBrandRelationService.saveDetail(categoryBrandRelation);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CategoryBrandRelationServiceImpl 逻辑实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDetail</span><span class="params">(CategoryBrandRelationEntity categoryBrandRelation)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> categoryBrandRelation.getBrandId();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">catelogId</span> <span class="operator">=</span> categoryBrandRelation.getCatelogId();</span><br><span class="line">    <span class="comment">//查询详细品牌和分类名称填充到该对应关系中</span></span><br><span class="line">    categoryBrandRelation.setBrandName(brandDao.selectById(brandId).getName());</span><br><span class="line">    categoryBrandRelation.setCatelogName(categoryDao.selectById(catelogId).getName());</span><br><span class="line">    <span class="comment">//保存数据信息到中间表</span></span><br><span class="line">    <span class="built_in">this</span>.save(categoryBrandRelation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、因此实际上更新品牌时需要更新冗余表信息（品牌分类关联表），使用 mybatis-plus 现有方法实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrandController </span></span><br><span class="line"><span class="comment"> * 根据 id 修改 Brand 品牌，但是需要注意的是还需要更新冗余字段（其他表中的数据）中的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brand 想要修改后的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line">    brandService.updateDetail(brand);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * BrandServiceImpl</span></span><br><span class="line"><span class="comment"> * 封装关联表对象用来更新关联表信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brand</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDetail</span><span class="params">(BrandEntity brand)</span> &#123;</span><br><span class="line">    <span class="comment">//需要保证其他表（品牌分类关联表）中的冗余字段的数据一致性</span></span><br><span class="line">    <span class="built_in">this</span>.updateById(brand);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(brand.getName()))&#123;</span><br><span class="line">        <span class="comment">//同步更新其他表(品牌分类关联表)中的数据，里面就两个冗余字段</span></span><br><span class="line">        categoryBrandRelationService.updateBrand(brand.getBrandId(), brand.getName());</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span>后续可能还需要更新其他表的关联信息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryBrandRelationServiceImpl</span></span><br><span class="line"><span class="comment"> * 更新冗余表（关联表）的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brandId 品牌id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brandName 品牌名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateBrand</span><span class="params">(Long brandId, String brandName)</span> &#123;</span><br><span class="line">    <span class="type">CategoryBrandRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CategoryBrandRelationEntity</span>();</span><br><span class="line">    relationEntity.setBrandId(brandId);</span><br><span class="line">    relationEntity.setBrandName(brandName);</span><br><span class="line">    UpdateWrapper&lt;CategoryBrandRelationEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, brandId);</span><br><span class="line">    <span class="built_in">this</span>.update(relationEntity, wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、同样的，当更新分类表时，也需要更新冗余表信息（品牌分类关联表），使用自定义的 sql 语句实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryController</span></span><br><span class="line"><span class="comment"> * 修改分类的相关信息，实际上是利用 catId 来选择分类进行修改，还需要修改荣誉表字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> category 修改后的分类信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 修改请求的结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> CategoryEntity category)</span>&#123;</span><br><span class="line">    categoryService.updateDetail(category);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryServiceImpl</span></span><br><span class="line"><span class="comment"> * 更新时更新冗余表中相同字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> category 更新数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDetail</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.updateById(category);</span><br><span class="line">    categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryBrandRelationServiceImpl</span></span><br><span class="line"><span class="comment"> * 更新冗余表（关联表）的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catName 分类名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCategory</span><span class="params">(Long catId, String catName)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.updateCategory(catId, catName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CategoryBrandRelationDao</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">updateCategory</span><span class="params">(Long catId, String catName)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CategoryBrandRelationDao.xml</span></span><br><span class="line">&lt;update id=<span class="string">&quot;updateCategory&quot;</span>&gt;</span><br><span class="line">    update pms_category_brand_relation <span class="type">set</span> <span class="variable">catalog_name</span> <span class="operator">=</span> #&#123;catName&#125; <span class="type">where</span> <span class="variable">catlog_id</span> <span class="operator">=</span> #&#123;catId&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure>

<h3 id="上传图片OSS"><a href="#上传图片OSS" class="headerlink" title="上传图片OSS"></a>上传图片OSS</h3><p><code>[问题]</code> 增加对话框的品牌 logo 地址应该是上传图片，那么文件上传应该怎么实现呢？</p>
<p>原来单体应用下，可以使用服务器本地存储，保存在项目的某个文件夹下，但是在分布式负载均衡条件下，每次路由都不同，那么就需要一个统一的文件存储系统，在本项目中使用<code>阿里云对象存储 OSS 服务</code> 这种海量存储的公共存储服务。</p>
<ul>
<li><p>普通上传方式：用户发送请求到自己的服务器 gateway，而后由后端用账号密码向 OSS 存储系统发送。</p>
</li>
<li><p>前端直接上传方式：前端在 JS 内部携带账号密码直接向 OSS 存储系统发送。</p>
</li>
<li><p><code>服务端签名后直传</code>方式：用户向应用服务器请求上传 Policy(由账号密码生成的防伪签名)，前端拿到 Policy 后直接上传数据到 OSS 存储系统。</p>
</li>
</ul>
<p><img src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/0747006361/p139016.png"></p>
<p>考虑到后续还有短信服务等等第三方服务，因此抽取出来单独创建一个负责第三方服务的项目 <code>shop-thirdservice</code>，添加 web 和 openFeign 的 starter，同时并引入 common 服务（但是<code>需要排除 mybatis-starter</code>），引入 cloud 依赖，并将对象存储的相关依赖放入 thirdservice 服务中。</p>
<p>1、在 thirdservice 服务中引入，本来应该导入 <code>aliyun-sdk-oss</code> ，但是可以直接使用 SpringCloud Alibaba OSS 解决方案（可以省去自己编写代码的步骤）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alicloud-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2、在阿里云中登录进入控制台，进入 OSS 对象存储，进入 AccessKey 管理，创建<code>子用户 AccessKey</code>，创建用户 shop，并对其授权 <code>AliyunOSSFullAcess</code> 权限。</p>
<p>同时还需要修改 bucket 支持 CORS 跨域：基础设置 —-&gt; 跨域访问 —–&gt; 创建规则：<code>来源设置 * ，head 设置 * ，请求方式选择 Post</code>。</p>
<p>3、创建 bootstrap.yml 配置文件，并配置相关信息，主要配置使用 nacos 进行管理：</p>
<p>1）nacos 创建 thirdservice 命名空间。</p>
<p>2）该命名空间下创建配置文件 oss.yml：配置对应的 OSS 信息，配置子用户的 access-key、secret-key 以及 oss.endpoint 信息。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">    <span class="attr">cloud:</span> </span><br><span class="line">        <span class="attr">alicloud:</span> </span><br><span class="line">            <span class="attr">access-key:</span> <span class="string">LTAI5tDmdjBFiyUo5L7we1SB</span></span><br><span class="line">            <span class="attr">secret-key:</span> <span class="string">A1lu08kqzQs0qkhY1OVr8uON7iOYpN</span></span><br><span class="line">            <span class="attr">oss:</span> </span><br><span class="line">                <span class="attr">endpoint:</span> <span class="string">oss-cn-nanjing.aliyuncs.com</span></span><br><span class="line">                <span class="attr">bucket:</span> <span class="string">cloud-shop-bucket</span>		<span class="comment"># 临时变量</span></span><br></pre></td></tr></table></figure>

<p>3）bootstrap 配置文件内容指明具体的配置中心和配置信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">thirdservice-id</span></span><br><span class="line">        <span class="string">ext-config[0]:</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">oss.yml</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">          <span class="attr">refresh:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>4、创建 application.yml 配置文件，配置注册中心，并在主启动类上添加注解 <code>@EnableDiscoveryClient</code> 开启服务注册和发现。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">shop-thirdservice</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">30000</span></span><br></pre></td></tr></table></figure>

<p>5、编写 OssController 实现 Oss 服务的签名回传到前端(可以从阿里云官方文档复制)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OSS ossClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.oss.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.oss.bucket&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.cloud.alicloud.access-key&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/oss/policy&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">policy</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实际的访问地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;https://&quot;</span> + bucket + <span class="string">&quot;.&quot;</span> + endPoint;</span><br><span class="line">        <span class="comment">//设置上传到OSS文件的前缀，此处按日期分配目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> date + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        Map&lt;String, String&gt; respMap = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expireEndTime</span> <span class="operator">=</span> System.currentTimeMillis() + expireTime * <span class="number">1000</span>;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expireEndTime);</span><br><span class="line">            <span class="type">PolicyConditions</span> <span class="variable">policyConds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PolicyConditions</span>();</span><br><span class="line">            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, <span class="number">0</span>, <span class="number">1048576000</span>);</span><br><span class="line">            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);</span><br><span class="line">            <span class="type">String</span> <span class="variable">postPolicy</span> <span class="operator">=</span> ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">            <span class="type">byte</span>[] binaryData = postPolicy.getBytes(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">encodedPolicy</span> <span class="operator">=</span> BinaryUtil.toBase64String(binaryData);</span><br><span class="line">            <span class="type">String</span> <span class="variable">postSignature</span> <span class="operator">=</span> ossClient.calculatePostSignature(postPolicy);</span><br><span class="line">            respMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">            respMap.put(<span class="string">&quot;accessId&quot;</span>, accessId);</span><br><span class="line">            respMap.put(<span class="string">&quot;policy&quot;</span>, encodedPolicy);</span><br><span class="line">            respMap.put(<span class="string">&quot;signature&quot;</span>, postSignature);</span><br><span class="line">            respMap.put(<span class="string">&quot;dir&quot;</span>, dir);</span><br><span class="line">            respMap.put(<span class="string">&quot;host&quot;</span>, host);</span><br><span class="line">            respMap.put(<span class="string">&quot;expire&quot;</span>, String.valueOf(expireEndTime / <span class="number">1000</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, respMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6、网关配置路由转发规则，放在 admin_route 路由前面：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">thirdservice_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://shop-thirdservice</span></span><br><span class="line">  <span class="attr">predicates:</span> <span class="comment"># 规定前端项目的路由都带有 /api/thirdservice/ 前缀</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/thirdservice/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/thirdservice/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>启动 gateway 和 thirdservice 服务，测试发送请求 <code>http://localhost:88/api/thirdservice/oss/policy</code> ：</p>
<p><img src="https://pic1.imgdb.cn/item/6346d00b16f2c2beb1217043.png"></p>
<p>7、将网上谷粒商城项目的 upload 文件夹(<code>代码地址 https://gitee.com/blizzard0409/gulimall</code>)放入 <code>/src/components</code> 目录下，修改每个文件上传组件的 action 地址，检查 policy.js 里面的请求地址是不是配置的网关转发地址即可。</p>
<p>8、修改 brand-add-or-update.vue 文件，修改品牌地址的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 3.更换组件 --&gt;</span><br><span class="line">&lt;el-form-item label=&quot;品牌logo地址&quot; prop=&quot;logo&quot;&gt;</span><br><span class="line">    &lt;SingleUpload v-model=&quot;dataForm.logo&quot;&gt;&lt;/SingleUpload&gt;</span><br><span class="line">&lt;/el-form-item&gt;</span><br><span class="line">&lt;!-- 1.导入组件 --&gt;</span><br><span class="line">import SingleUpload from &quot;@/components/upload/singleUpload&quot;</span><br><span class="line">&lt;!-- 2.添加组件到 vue --&gt;</span><br><span class="line">components:&#123;</span><br><span class="line">	SingleUpload: SingleUpload</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>9、测试发起请求：因此实际上是发送了两个请求，第一个请求是向自己服务器请求签名信息，第二个请求才是根据签名信息向阿里云 OSS 对象存储系统发送存储请求，并实现数据与页面的双向绑定。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f584c09f867a09be2b95191d2bc8748f.png"></p>
<blockquote>
<p>注：如果报错 accessKey 不存在可以检查一下前端的取数据部分的写法问题。</p>
</blockquote>
<h3 id="前端表单校验"><a href="#前端表单校验" class="headerlink" title="前端表单校验"></a>前端表单校验</h3><p>1、表格 logo 能够成功上传，但是此时显示的却是 logo 图片的地址，并不是直接显示图片，因此还需要定义 slot 将表格中的地址转化为图片。并且需要注意的是renren-fast-vue 并没有导入 el-image 组件，因此还需要在 <code>src/components/element-ui/index.js</code> 中导入 <code>Image</code> 组件（此处我的代码中无法使用 el-image 标签成功全图显示，因此还是使用的原生 image 标签），并 use 引入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-table-column prop=&quot;logo&quot; header-align=&quot;center&quot; align=&quot;center&quot; label=&quot;品牌logo地址&quot;&gt;</span><br><span class="line">    &lt;template slot-scope=&quot;scope&quot;&gt;</span><br><span class="line">		&lt;!-- &lt;el-image style=&quot;width: 100px; height: 80px&quot; :src=&quot;scope.row.logo&quot; fit=&quot;scale-down&quot;&gt;&lt;/el-image&gt; --&gt;</span><br><span class="line">		&lt;img :src=&quot;scope.row.logo&quot; style=&quot;width: 100px; height: 80px&quot;&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">&lt;/el-table-column&gt;</span><br></pre></td></tr></table></figure>

<p>2、表单验证使用 ElementUI 的原生方式，通过 rules 传入校验规则即可，主要是对 firstLetter 和 sort 做特殊校验。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">firstLetter</span>: [</span><br><span class="line">    &#123; <span class="attr">validator</span>: <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value === <span class="string">&quot;&quot;</span>) <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;检索首字母必须填写&#x27;</span>));</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="regexp">/^[a-zA-Z]$/</span>.<span class="title function_">test</span>(value))&#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;检索首字母必须必须是a-z或A-Z之间&#x27;</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">trigger</span>: <span class="string">&#x27;blur&#x27;</span> &#125;</span><br><span class="line">],</span><br><span class="line"><span class="attr">sort</span>: [</span><br><span class="line">    &#123; <span class="attr">validator</span>: <span class="function">(<span class="params">rule, value, callback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (value === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;排序字段必须填写&#x27;</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="title class_">Number</span>.<span class="title function_">isInteger</span>(value) || value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;排序字段必须是大于等于0的整数&#x27;</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="attr">trigger</span>: <span class="string">&#x27;blur&#x27;</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>3、后台也是需要进行校验，因为可能攻击者恶意通过直接发送请求的方式 (Postman) 方式来进行发送请求。后台采用 JSR303 来进行数据校验。</p>
<p>1）给 Bean 添加校验注解，并定义自己的校验提示，其他字段暂不说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NotBlank(message = &quot;brandName can‘t be null&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="meta">@URL(message = &quot;logo need to be a url&quot;)</span></span><br><span class="line"><span class="meta">@NotEmpty(message = &quot;logo can&#x27;t be null&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String logo;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Pattern(regexp = &quot;^[a-zA-Z]$&quot;, message = &quot;firstLetter must is a-z or A-Z&quot;)</span></span><br><span class="line"><span class="meta">@NotEmpty(message = &quot;firstLetter can&#x27;t be null&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String firstLetter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Min(value = 0, message = &quot;sort must &gt;= 0&quot;)</span></span><br><span class="line"><span class="meta">@NotNull(message = &quot;sort can&#x27;t be null&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer sort;</span><br></pre></td></tr></table></figure>

<p>2）给对应的请求 Controller 标上校验注解，并且使用 <code>BindingResult</code> 记录校验结果并返回：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增品牌信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> brand 需要新增的品牌信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> result  参数校验结果封装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求结果封装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> BrandEntity brand, BindingResult result)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (result.hasErrors()) &#123;</span><br><span class="line">        Map&lt;String, String&gt; resultMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.getFieldErrors().forEach(item -&gt; &#123;</span><br><span class="line">            <span class="comment">//错误提示消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> item.getDefaultMessage();</span><br><span class="line">            <span class="comment">//获取校验错误的属性名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> item.getField();</span><br><span class="line">            resultMap.put(field, errorMessage);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> R.error(<span class="number">400</span>, <span class="string">&quot;提交数据不合法&quot;</span>).put(<span class="string">&quot;data&quot;</span>, resultMap);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        brandService.save(brand);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="统一异常处理"><a href="#统一异常处理" class="headerlink" title="统一异常处理"></a>统一异常处理</h3><p>使用上面的 JSR303进行校验已经是比较良好了，但是每个提交的 controller 都需要写重复性的校验结果注入，过于麻烦，因此考虑使用 SpringMVC 提供的统一异常处理方案 <code>ControllerAdivce</code> 来实现。</p>
<blockquote>
<p>针对实际的开发，请求状态码可以作为判断问题的类型，用于快速排错，因此请求状态码十分重要，此处规定错误的请求状态码使用 5 位数字来表示：<code>10</code> 表示通用错误（<code>001 格式校验错误</code>），<code>11</code> 表示商品模块错误，<code>12</code> 表示订单模块错误，<code>13</code> 表示购物车模块错误，<code>14</code> 表示物流模块错误。</p>
</blockquote>
<p>1）公共模块 common 编写 exception 包，编写请求状态码枚举类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BizCode</span> &#123;</span><br><span class="line">    UNKNOWN_EXCEPTION(<span class="number">10000</span>, <span class="string">&quot;系统未知异常&quot;</span>),</span><br><span class="line">    VALID_EXCEPTION(<span class="number">10001</span>, <span class="string">&quot;参数格式校验失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    BizCode(<span class="type">int</span> code, String message)&#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）抽取异常处理类 <code>ShopExceptionControllerAdvice</code> ，用于全局异常管理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//集中处理异常，并使用日志记录</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice(basePackages = &quot;com.example.product.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopExceptionControllerAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定异常处理器，并同时指定处理哪些种类的异常,此处是处理数据校验异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = MethodArgumentNotValidException.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handlerValidException</span><span class="params">(MethodArgumentNotValidException e)</span>&#123;</span><br><span class="line">        log.error(<span class="string">&quot;数据校验出现，异常类型：&#123;&#125;，异常问题：&#123;&#125;&quot;</span>, e.getClass(), e.getMessage());</span><br><span class="line">        <span class="type">BindingResult</span> <span class="variable">result</span> <span class="operator">=</span> e.getBindingResult();</span><br><span class="line">        Map&lt;String, String&gt; errorMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.getFieldErrors().forEach(item -&gt; &#123;</span><br><span class="line">            <span class="comment">//错误提示消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> item.getDefaultMessage();</span><br><span class="line">            <span class="comment">//获取校验错误的属性名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> item.getField();</span><br><span class="line">            errorMap.put(field, errorMessage);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCode.VALID_EXCEPTION.getCode(), BizCode.VALID_EXCEPTION.getMessage()).put(<span class="string">&quot;data&quot;</span>, errorMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//整体异常处理逻辑</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(value = Throwable.class)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">handlerException</span><span class="params">(Throwable throwable)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> R.error(BizCode.UNKNOWN_EXCEPTION.getCode(), BizCode.UNKNOWN_EXCEPTION.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[拓展用法]</code>  分组校验（<code>多场景的复杂校验</code>）：新增和修改的情况下校验规则可能不同，例如修改时 brandId 不变（必须为 Null 表示不修改），但是新增时 hrandId 就必须填写（必须不为 Null ），那么就可以使用<code>分组校验</code> 。（需要注意的是分组校验的 group 属性需要传递接口类）		<code>[本系统不使用分组校验]</code></p>
<p>在 common 项目下新建 valid 包，创建 AddGroup 接口，创建 UpdateGroup 接口，里面不需要写什么具体内容，只是一个标识。而后就可以在注解中添加 <code>groups</code> 属性，指明什么情况下需要进行校验，而后使用 <code>@Validated</code> 注解取代原来的 <code>@Valid</code> 注解，就可以指明校验分组。</p>
<blockquote>
<p><code>注意</code>：使用校验分组后，如果没有标注分组，那么校验注解不起做用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId</span></span><br><span class="line"><span class="meta">@NotNull(message = &quot;修改时不能指定品牌 id&quot; ,groups = &#123;UpdateGroup.class&#125;)</span></span><br><span class="line"><span class="meta">@Null(message = &quot;新增时不能指定品牌 id&quot; ,groups = &#123;AddGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Long brandId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NotBlank(message = &quot;brandName can‘t be null&quot;, groups = &#123;UpdateGroup.class, AddGroup.class&#125;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@Validated(UpdateGroup.class)</span> <span class="meta">@RequestBody</span> BrandEntity brand)</span>&#123;</span><br><span class="line">    brandService.save(brand);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[拓展用法]</code>  自定义校验：有时候可能正则表达式都无法满足校验的需求，那么就可以使用自定义的校验方式（都位于 common 项目）。</p>
<p>导入对应的 validation 依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>编写自定义的校验注解，实际就是自定义特别的注解，并于下面的校验器进行关联：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义校验器注解</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint(validatedBy = &#123;EnumValueConstraintValidator.class&#125;)</span>     <span class="comment">//将校验器和校验注解进行关联，可以指定多个类型的校验器</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE, ElementType.CONSTRUCTOR, ElementType.PARAMETER, ElementType.TYPE_USE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnumValue &#123;</span><br><span class="line">    String <span class="title function_">message</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&#123;com.example.common.EnumValue.message&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Payload</span>&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span>[] values() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写对应的配置文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">com.example.common.EnumValue.message</span>=<span class="string">必须提交指定的值</span></span><br></pre></td></tr></table></figure>

<p>编写自定义的校验器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义校验器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EnumValueConstraintValidator</span> <span class="keyword">implements</span> <span class="title class_">ConstraintValidator</span>&lt;EnumValue, Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Integer&gt; valueSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(EnumValue constraintAnnotation)</span> &#123;</span><br><span class="line">        <span class="comment">//获取注解上标注的可能值，装入 Set 中</span></span><br><span class="line">        <span class="type">int</span>[] values = constraintAnnotation.values();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> value : values) &#123;</span><br><span class="line">            valueSet.add(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否校验成功</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> integer 需要校验的值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> constraintValidatorContext 校验器上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回校验结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isValid</span><span class="params">(Integer integer, ConstraintValidatorContext constraintValidatorContext)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> valueSet.contains(integer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体使用在 showStatus 上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnumValue(values = &#123;0, 1&#125;)</span></span><br><span class="line"><span class="keyword">private</span> Integer showStatus;</span><br></pre></td></tr></table></figure>

<h2 id="平台属性模块"><a href="#平台属性模块" class="headerlink" title="平台属性模块"></a>平台属性模块</h2><p>SPU：标准化产品单元，是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该集合描述了一个产品的特性。（类似于 类）</p>
<p>SKU：库存量单位，是指 SPU 的具体的某个商品。（类似于 对象）</p>
<blockquote>
<p>使用资料里面的 <code>sys_menus.sql</code> 文件在 shop-admin 数据库中运行生成所有的菜单目录，实际就是添加记录，sql 语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span>  <span class="keyword">into</span> `sys_menu`(`menu_id`,`parent_id`,`name`,`url`,`perms`,`type`,`icon`,`order_num`) <span class="keyword">values</span> (<span class="number">37</span>,<span class="number">31</span>,<span class="string">&#x27;平台属性&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;system&#x27;</span>,<span class="number">0</span>),(<span class="number">38</span>,<span class="number">37</span>,<span class="string">&#x27;属性分组&#x27;</span>,<span class="string">&#x27;product/attrgroup&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;tubiao&#x27;</span>,<span class="number">0</span>),(<span class="number">39</span>,<span class="number">37</span>,<span class="string">&#x27;规格参数&#x27;</span>,<span class="string">&#x27;product/baseattr&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;log&#x27;</span>,<span class="number">0</span>),(<span class="number">40</span>,<span class="number">37</span>,<span class="string">&#x27;销售属性&#x27;</span>,<span class="string">&#x27;product/saleattr&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;zonghe&#x27;</span>,<span class="number">0</span>),(<span class="number">41</span>,<span class="number">31</span>,<span class="string">&#x27;商品维护&#x27;</span>,<span class="string">&#x27;product/spu&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;zonghe&#x27;</span>,<span class="number">0</span>),(<span class="number">42</span>,<span class="number">0</span>,<span class="string">&#x27;优惠营销&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;mudedi&#x27;</span>,<span class="number">0</span>),(<span class="number">43</span>,<span class="number">0</span>,<span class="string">&#x27;库存系统&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;shouye&#x27;</span>,<span class="number">0</span>),(<span class="number">44</span>,<span class="number">0</span>,<span class="string">&#x27;订单系统&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;config&#x27;</span>,<span class="number">0</span>),(<span class="number">45</span>,<span class="number">0</span>,<span class="string">&#x27;用户系统&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="number">0</span>),(<span class="number">46</span>,<span class="number">0</span>,<span class="string">&#x27;内容管理&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;sousuo&#x27;</span>,<span class="number">0</span>),(<span class="number">47</span>,<span class="number">42</span>,<span class="string">&#x27;优惠券管理&#x27;</span>,<span class="string">&#x27;coupon/coupon&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;zhedie&#x27;</span>,<span class="number">0</span>),(<span class="number">48</span>,<span class="number">42</span>,<span class="string">&#x27;发放记录&#x27;</span>,<span class="string">&#x27;coupon/history&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;sql&#x27;</span>,<span class="number">0</span>),(<span class="number">49</span>,<span class="number">42</span>,<span class="string">&#x27;专题活动&#x27;</span>,<span class="string">&#x27;coupon/subject&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;tixing&#x27;</span>,<span class="number">0</span>),(<span class="number">50</span>,<span class="number">42</span>,<span class="string">&#x27;秒杀活动&#x27;</span>,<span class="string">&#x27;coupon/seckill&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;daohang&#x27;</span>,<span class="number">0</span>),(<span class="number">51</span>,<span class="number">42</span>,<span class="string">&#x27;积分维护&#x27;</span>,<span class="string">&#x27;coupon/bounds&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;geren&#x27;</span>,<span class="number">0</span>),(<span class="number">52</span>,<span class="number">42</span>,<span class="string">&#x27;满减折扣&#x27;</span>,<span class="string">&#x27;coupon/full&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;shoucang&#x27;</span>,<span class="number">0</span>),(<span class="number">53</span>,<span class="number">43</span>,<span class="string">&#x27;仓库维护&#x27;</span>,<span class="string">&#x27;ware/wareinfo&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;shouye&#x27;</span>,<span class="number">0</span>),(<span class="number">54</span>,<span class="number">43</span>,<span class="string">&#x27;库存工作单&#x27;</span>,<span class="string">&#x27;ware/task&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;log&#x27;</span>,<span class="number">0</span>),(<span class="number">55</span>,<span class="number">43</span>,<span class="string">&#x27;商品库存&#x27;</span>,<span class="string">&#x27;ware/sku&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;jiesuo&#x27;</span>,<span class="number">0</span>),(<span class="number">56</span>,<span class="number">44</span>,<span class="string">&#x27;订单查询&#x27;</span>,<span class="string">&#x27;order/order&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;zhedie&#x27;</span>,<span class="number">0</span>),(<span class="number">57</span>,<span class="number">44</span>,<span class="string">&#x27;退货单处理&#x27;</span>,<span class="string">&#x27;order/return&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;shanchu&#x27;</span>,<span class="number">0</span>),(<span class="number">58</span>,<span class="number">44</span>,<span class="string">&#x27;等级规则&#x27;</span>,<span class="string">&#x27;order/settings&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;system&#x27;</span>,<span class="number">0</span>),(<span class="number">59</span>,<span class="number">44</span>,<span class="string">&#x27;支付流水查询&#x27;</span>,<span class="string">&#x27;order/payment&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;job&#x27;</span>,<span class="number">0</span>),(<span class="number">60</span>,<span class="number">44</span>,<span class="string">&#x27;退款流水查询&#x27;</span>,<span class="string">&#x27;order/refund&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;mudedi&#x27;</span>,<span class="number">0</span>),(<span class="number">61</span>,<span class="number">45</span>,<span class="string">&#x27;会员列表&#x27;</span>,<span class="string">&#x27;member/member&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;geren&#x27;</span>,<span class="number">0</span>),(<span class="number">62</span>,<span class="number">45</span>,<span class="string">&#x27;会员等级&#x27;</span>,<span class="string">&#x27;member/level&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;tubiao&#x27;</span>,<span class="number">0</span>),(<span class="number">63</span>,<span class="number">45</span>,<span class="string">&#x27;积分变化&#x27;</span>,<span class="string">&#x27;member/growth&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;bianji&#x27;</span>,<span class="number">0</span>),(<span class="number">64</span>,<span class="number">45</span>,<span class="string">&#x27;统计信息&#x27;</span>,<span class="string">&#x27;member/statistics&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;sql&#x27;</span>,<span class="number">0</span>),(<span class="number">65</span>,<span class="number">46</span>,<span class="string">&#x27;首页推荐&#x27;</span>,<span class="string">&#x27;content/index&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;shouye&#x27;</span>,<span class="number">0</span>),(<span class="number">66</span>,<span class="number">46</span>,<span class="string">&#x27;分类热门&#x27;</span>,<span class="string">&#x27;content/category&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;zhedie&#x27;</span>,<span class="number">0</span>),(<span class="number">67</span>,<span class="number">46</span>,<span class="string">&#x27;评论管理&#x27;</span>,<span class="string">&#x27;content/comments&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;pinglun&#x27;</span>,<span class="number">0</span>),(<span class="number">68</span>,<span class="number">41</span>,<span class="string">&#x27;spu管理&#x27;</span>,<span class="string">&#x27;product/spu&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;config&#x27;</span>,<span class="number">0</span>),(<span class="number">69</span>,<span class="number">41</span>,<span class="string">&#x27;发布商品&#x27;</span>,<span class="string">&#x27;product/spuadd&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;bianji&#x27;</span>,<span class="number">0</span>),(<span class="number">70</span>,<span class="number">43</span>,<span class="string">&#x27;采购单维护&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;tubiao&#x27;</span>,<span class="number">0</span>),(<span class="number">71</span>,<span class="number">70</span>,<span class="string">&#x27;采购需求&#x27;</span>,<span class="string">&#x27;ware/purchaseitem&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;editor&#x27;</span>,<span class="number">0</span>),(<span class="number">72</span>,<span class="number">70</span>,<span class="string">&#x27;采购单&#x27;</span>,<span class="string">&#x27;ware/purchase&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;menu&#x27;</span>,<span class="number">0</span>),(<span class="number">73</span>,<span class="number">41</span>,<span class="string">&#x27;商品管理&#x27;</span>,<span class="string">&#x27;product/manager&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;zonghe&#x27;</span>,<span class="number">0</span>),(<span class="number">74</span>,<span class="number">42</span>,<span class="string">&#x27;会员价格&#x27;</span>,<span class="string">&#x27;coupon/memberprice&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="number">0</span>),(<span class="number">75</span>,<span class="number">42</span>,<span class="string">&#x27;每日秒杀&#x27;</span>,<span class="string">&#x27;coupon/seckillsession&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">1</span>,<span class="string">&#x27;job&#x27;</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="属性分组"><a href="#属性分组" class="headerlink" title="属性分组"></a>属性分组</h3><h4 id="属性分组查询"><a href="#属性分组查询" class="headerlink" title="属性分组查询"></a>属性分组查询</h4><p><img src="https://pic1.imgdb.cn/item/634a598516f2c2beb111bec9.png"></p>
<blockquote>
<p>从此开始，前端代码会缩减显示，基本使用谷粒学院项目资料的前端代码。</p>
</blockquote>
<p>product 目录下添加 attrgroup.vue 文件和 attrgroup-add-or-update.vue 组件，表示属性分组。</p>
<p>1、抽取公共部分放于 <code>modules/common/category.vue</code> ，里面存放公共使用的分类树形菜单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;el-tree :data=&quot;menus&quot; :props=&quot;defaultProps&quot; node-key=&quot;catId&quot; ref=&quot;menuTree&quot;&gt;&lt;/el-tree&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    name: &#x27;RenrenFastVueCategory&#x27;,</span><br><span class="line">    data() &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            menus:[],</span><br><span class="line">            defaultProps: &#123;</span><br><span class="line">                children: &quot;children&quot;,</span><br><span class="line">                label: &quot;name&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    created() &#123;</span><br><span class="line">        this.getMenus();</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        getMenus() &#123;</span><br><span class="line">            this.$http(&#123;</span><br><span class="line">                url: this.$http.adornUrl(&quot;/product/category/list/tree&quot;),</span><br><span class="line">                method: &quot;get&quot;,</span><br><span class="line">            &#125;).then((&#123; data &#125;) =&gt; &#123;</span><br><span class="line">                //将返回数据中的 data 解构出来</span><br><span class="line">                this.menus = data.data;</span><br><span class="line">                console.log(&quot;菜单数据：&quot;, data);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>[知识简要]</code> 父子组件传递数据问题。</p>
<p>目前需要点击抽取出的公共类中的树形结构，右边表格显示不同的数据（对应分类的属性列表），那么如何实现他们之间数据的传递呢？</p>
<p>子组件给父组件传递数据使用<code>事件机制</code> ：子组件给父组件发送一个事件并且携带上数据。（目前此种情况）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// el-tree 绑定 node-click 事件</span></span><br><span class="line">&lt;el-tree :data=<span class="string">&quot;menus&quot;</span> :props=<span class="string">&quot;defaultProps&quot;</span> node-key=<span class="string">&quot;catId&quot;</span> ref=<span class="string">&quot;menuTree&quot;</span> @node-click=<span class="string">&quot;nodeClick&quot;</span>&gt;&lt;/el-tree&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子组件编写点击函数，并且利用 $emit 向父组件发送事件，事件名 tree-node-click（可以随便取）</span></span><br><span class="line"><span class="title function_">nodeClick</span>(<span class="params">data, node, component</span>)&#123;</span><br><span class="line">    <span class="comment">//向父组件发送事件并携带数据</span></span><br><span class="line">    <span class="variable language_">this</span>.$emit(<span class="string">&quot;tree-node-click&quot;</span>, data, node, component);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//父组件绑定该事件，并且调用自己的函数进行处理</span></span><br><span class="line">&lt;categoryTree @tree-node-click=<span class="string">&quot;treenodeclick&quot;</span>&gt;&lt;/categoryTree&gt;</span><br><span class="line"><span class="title function_">treenodeclick</span>(<span class="params">data, node, component</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`attrgroup 感知到tree的 [<span class="subst">$&#123;data.name&#125;</span>] 分类被点击`</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>2、后端编写对应的根据分类获取属性分组的请求 handler。</p>
<p>1）AttrGroupController：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据查询参数查询数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params    查询参数（包括分页参数和查询关键字)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryId    三级分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  查询结果数据封装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list/&#123;categoryId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params, <span class="meta">@PathVariable(&quot;categoryId&quot;)</span> Long categoryId)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrGroupService.queryPage(params, categoryId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）AttrGroupServiceImpl：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPage</span><span class="params">(Map&lt;String, Object&gt; params, Long categoryId)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);  <span class="comment">//检索关键字用于模糊匹配</span></span><br><span class="line">    QueryWrapper&lt;AttrGroupEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    log.warn(<span class="string">&quot;else-categoryId:&#123;&#125;, searchKey:&#123;&#125;&quot;</span>, categoryId, searchKey);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(searchKey))&#123;</span><br><span class="line">        wrapper.and((obj) -&gt; &#123;</span><br><span class="line">            <span class="comment">// and (attr_group_id = searchKey or attr_group_name like &#x27;%searchKey%&#x27;)</span></span><br><span class="line">            obj.eq(<span class="string">&quot;attr_group_id&quot;</span>, searchKey).or().like(<span class="string">&quot;attr_group_name&quot;</span>, searchKey);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//非三级分类,就查询所有属性</span></span><br><span class="line">    <span class="keyword">if</span> (categoryId == <span class="number">0</span>) &#123;</span><br><span class="line">        IPage&lt;AttrGroupEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrGroupEntity&gt;().getPage(params),wrapper);<span class="comment">//封装查询参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page); <span class="comment">//根据返回结果封装成需要的返回值类型</span></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// catelog_id = categoryId</span></span><br><span class="line">        wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, categoryId);</span><br><span class="line">        <span class="comment">//封装查询参数，调用分页查询</span></span><br><span class="line">        IPage&lt;AttrGroupEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrGroupEntity&gt;().getPage(params), wrapper);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page); <span class="comment">//根据返回结果封装成需要的返回值类型</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、前端发送请求获取数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取数据列表</span></span><br><span class="line"><span class="title function_">getDataList</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataListLoading</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">`/product/attrgroup/list/<span class="subst">$&#123;<span class="variable language_">this</span>.catId&#125;</span>`</span>),</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="attr">params</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornParams</span>(&#123;</span><br><span class="line">            <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">pageIndex</span>,</span><br><span class="line">            <span class="attr">limit</span>: <span class="variable language_">this</span>.<span class="property">pageSize</span>,</span><br><span class="line">            <span class="attr">key</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">key</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dataList</span> = data.<span class="property">page</span>.<span class="property">list</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">totalPage</span> = data.<span class="property">page</span>.<span class="property">totalCount</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dataList</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">totalPage</span> = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataListLoading</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,</span><br><span class="line">    </span><br><span class="line"><span class="comment">//感知树节点被点击</span></span><br><span class="line"><span class="title function_">treenodeclick</span>(<span class="params">data, node, component</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`attrgroup感知到tree的 [<span class="subst">$&#123;data.catId&#125;</span>-<span class="subst">$&#123;data.name&#125;</span>] 分类被点击`</span>);</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">level</span> == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">catId</span> = data.<span class="property">catId</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">getDataList</span>(); <span class="comment">//重新查询</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h4 id="属性分组新增"><a href="#属性分组新增" class="headerlink" title="属性分组新增"></a>属性分组新增</h4><p>1、新增框的分类选择使用级联选择器的形式，但是需要补充 cascaderProps 属性，并记录 catelogPath，而实际存入的是 catelogId：</p>
<blockquote>
<p>注：需要注意将对话框在关闭时需要将表单数据清空，不然可能在下一次对话框打开时遗留历史的选择结果。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-form-item label=<span class="string">&quot;所属分类&quot;</span> prop=<span class="string">&quot;catelogId&quot;</span>&gt;</span><br><span class="line">    <span class="comment">// filterable 表示设置可搜索的</span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">el-cascader</span> <span class="attr">filterable</span> <span class="attr">placeholder</span>=<span class="string">&quot;尝试搜索一下&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;dataForm.catelogPath&quot;</span> <span class="attr">:options</span>=<span class="string">&quot;categories&quot;</span> <span class="attr">:props</span>=<span class="string">&quot;cascaderProps&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">el-cascader</span>&gt;</span></span></span><br><span class="line">&lt;/el-form-item&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//data 数据域新增需要的数据定义</span></span><br><span class="line"><span class="attr">cascaderProps</span>:&#123;</span><br><span class="line">    <span class="attr">value</span>: <span class="string">&quot;catId&quot;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;children&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">dataForm</span>: &#123;</span><br><span class="line">    <span class="attr">attrGroupId</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">attrGroupName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">sort</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">descript</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">icon</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">catelogPath</span>: [],   <span class="comment">//包含子分类的一个 id 集合</span></span><br><span class="line">    <span class="attr">catelogId</span>: <span class="number">0</span>,   <span class="comment">//真实提交的id数据</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">dataFormSubmit () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$refs</span>[<span class="string">&#x27;dataForm&#x27;</span>].<span class="title function_">validate</span>(<span class="function">(<span class="params">valid</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">           <span class="variable language_">this</span>.$http(&#123;</span><br><span class="line">              <span class="comment">//适用于新增的提交，也适用于修改的提交，修改的仅仅是请求路径的区别</span></span><br><span class="line">              <span class="attr">url</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornUrl</span>(<span class="string">`/product/attrgroup/<span class="subst">$&#123;!<span class="variable language_">this</span>.dataForm.attrGroupId ? <span class="string">&#x27;save&#x27;</span> : <span class="string">&#x27;update&#x27;</span>&#125;</span>`</span>),</span><br><span class="line">              <span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">              <span class="comment">//数据封装时并没有什么太大区别，修改时只需要将 attrGroupId 输入框隐藏即可实现固定</span></span><br><span class="line">              <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">adornData</span>(&#123;</span><br><span class="line">                <span class="string">&#x27;attrGroupId&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">attrGroupId</span> || <span class="literal">undefined</span>,</span><br><span class="line">                <span class="string">&#x27;attrGroupName&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">attrGroupName</span>,</span><br><span class="line">                <span class="string">&#x27;sort&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">sort</span>,</span><br><span class="line">                <span class="string">&#x27;descript&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">descript</span>,</span><br><span class="line">                <span class="string">&#x27;icon&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">icon</span>,</span><br><span class="line">                <span class="string">&#x27;catelogId&#x27;</span>: <span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">catelogPath</span>[<span class="variable language_">this</span>.<span class="property">dataForm</span>.<span class="property">catelogPath</span>.<span class="property">length</span> - <span class="number">1</span>],</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (data &amp;&amp; data.<span class="property">code</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">                  <span class="attr">message</span>: <span class="string">&#x27;操作成功&#x27;</span>,</span><br><span class="line">                  <span class="attr">type</span>: <span class="string">&#x27;success&#x27;</span>,</span><br><span class="line">                  <span class="attr">duration</span>: <span class="number">1500</span>,</span><br><span class="line">                  <span class="attr">onClose</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">visible</span> = <span class="literal">false</span></span><br><span class="line">                    <span class="variable language_">this</span>.$emit(<span class="string">&#x27;refreshDataList&#x27;</span>)</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">$message</span>.<span class="title function_">error</span>(data.<span class="property">msg</span>)</span><br><span class="line">              &#125;</span><br><span class="line">         &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>2、后端逻辑实现新增数据记录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于前端提交保存新属性分组的记录请求处理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrGroup 新的属性分组信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 请求结果封装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> AttrGroupEntity attrGroup)</span>&#123;</span><br><span class="line">    attrGroupService.save(attrGroup);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="属性分组修改"><a href="#属性分组修改" class="headerlink" title="属性分组修改"></a>属性分组修改</h4><p>1、数据回显问题：由于前端提交的是单个 id，但是表单是多级选择器，需要的是多级 id，也就是 id 的集合（包括其父 id），那么此时数据回显就会出现问题。</p>
<p>1）AttrGroupEntity 类新增属性 catelogPath 表示分类路径数组。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField(exist = false)</span></span><br><span class="line"><span class="keyword">private</span> Long[] catelogPath;</span><br></pre></td></tr></table></figure>

<p>2）修改后端的获取信息的逻辑，将 catelogPath 返回给前端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 找到某个 catId 的完整路径：父/子/孙</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catelogId 分类 id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 完整路径结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long[] findCatelogPath(Long catelogId) &#123;</span><br><span class="line">    List&lt;Long&gt; path = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;Long&gt; parentPath = findParentPath(catelogId, path);</span><br><span class="line">    Collections.reverse(parentPath);</span><br><span class="line">    <span class="keyword">return</span> parentPath.toArray(<span class="keyword">new</span> <span class="title class_">Long</span>[parentPath.size()]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//递归查找某个分类的父id</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Long&gt; <span class="title function_">findParentPath</span><span class="params">(Long catId, List&lt;Long&gt; path)</span>&#123;</span><br><span class="line">    path.add(catId);</span><br><span class="line">    <span class="type">CategoryEntity</span> <span class="variable">catById</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(catId);</span><br><span class="line">    <span class="keyword">if</span> (catById.getParentCid() != <span class="number">0</span>)&#123;</span><br><span class="line">        findParentPath(catById.getParentCid(), path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）前端回显表单时将 catelogPath 也进行赋值就能够在前端得到分类信息的回显。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">dateForm</span>.<span class="property">catelogPath</span> = data.<span class="property">attrGroup</span>.<span class="property">catelogPath</span>;</span><br></pre></td></tr></table></figure>

<h4 id="分组属性关联"><a href="#分组属性关联" class="headerlink" title="分组属性关联"></a>分组属性关联</h4><p>一个属性分组可以关联多个属性。</p>
<p>1、获取数据分组的关联的所有属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 获取当前分组关联的所有属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId 分组id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  属性集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/attr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">attrRelation</span><span class="params">(<span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span> Long attrgroupId)</span>&#123;</span><br><span class="line">    <span class="comment">//前端页面只需要展示属性名和可选值，那么久没必要单独封装 vo</span></span><br><span class="line">    List&lt;AttrEntity&gt; attrEntities = attrService.getRelationAttr(attrgroupId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, attrEntities);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据分组id查找关联的规格属性（销售属性没有和分组关联）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId 分组id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  规格属性集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AttrEntity&gt; <span class="title function_">getRelationAttr</span><span class="params">(Long attrgroupId)</span> &#123;</span><br><span class="line">    List&lt;AttrEntity&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    QueryWrapper&lt;AttrAttrgroupRelationEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;attr_group_id&quot;</span>, attrgroupId);</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; relationEntities = relationDao.selectList(wrapper);</span><br><span class="line">    <span class="keyword">if</span> (relationEntities.size() != <span class="number">0</span>)&#123;</span><br><span class="line">        List&lt;Long&gt; attrIds = relationEntities.stream().map((relation) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> relation.getAttrId();</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        result = <span class="built_in">this</span>.listByIds(attrIds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、删除属性和分组关联关系：</p>
<p>1）编写 vo 来封装前端传递过来的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrGroupRelationVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）实际逻辑的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 根据前端传递的关联关系数组批量删除多个关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> relationVos 封装的前端传递过来的关联关系集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 删除成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation/delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">deleteRelation</span><span class="params">(<span class="meta">@RequestBody</span> AttrGroupRelationVo[] relationVos)</span>&#123;</span><br><span class="line">    attrService.deleteRelation(relationVos);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 批量删除关联关系(一条语句实现)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> relationVos 关联关系集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteRelation</span><span class="params">(AttrGroupRelationVo[] relationVos)</span> &#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; deleteRelationList = Arrays.asList(relationVos).stream().map((relationVo) -&gt; &#123;</span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">        BeanUtils.copyProperties(relationVo, relationEntity);</span><br><span class="line">        <span class="keyword">return</span> relationEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    relationDao.deleteBatchRelation(deleteRelationList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AttrAttrgroupRelationDao</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteBatchRelation</span><span class="params">(<span class="meta">@Param(&quot;deleteRelationList&quot;)</span> List&lt;AttrAttrgroupRelationEntity&gt; deleteRelationList)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AttrAttrgroupRelationDao.xml</span></span><br><span class="line">&lt;delete id=<span class="string">&quot;deleteBatchRelation&quot;</span>&gt;</span><br><span class="line">    delete from pms_attr_attrgroup_relation where</span><br><span class="line">    &lt;foreach collection=<span class="string">&quot;deleteRelationList&quot;</span> item=<span class="string">&quot;relation&quot;</span> separator=<span class="string">&quot; OR &quot;</span>&gt;</span><br><span class="line">    	(attr_id=#&#123;relation.attrId&#125; and attr_group_id=#&#123;relation.attrGroupId&#125;)</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/delete&gt;</span><br></pre></td></tr></table></figure>

<p>3、新增属性关联：需要判断本分类下并且没有被其他分组关联的属性才能够关联。</p>
<p>1）查询属性分组没有关联的其他属性，并进行分页：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 查询当前分组没有关联的所有属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数封装</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId 分组id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 属性集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;attrgroupId&#125;/noattr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">attrNoRelation</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params,</span></span><br><span class="line"><span class="params">                        <span class="meta">@PathVariable(&quot;attrgroupId&quot;)</span> Long attrgroupId)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrService.getNoRelationAttr(params, attrgroupId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 获取某个分组没有关联到的所有属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrgroupId   分组id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 分页属性列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">getNoRelationAttr</span><span class="params">(Map&lt;String, Object&gt; params, Long attrgroupId)</span> &#123;</span><br><span class="line">    <span class="comment">//1.当前分组只能关联自己所属的分类里面的属性</span></span><br><span class="line">    <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrgroupId);</span><br><span class="line">    <span class="type">Long</span> <span class="variable">catelogId</span> <span class="operator">=</span> attrGroupEntity.getCatelogId();</span><br><span class="line">    <span class="comment">//2.当前分组只能关联别的分组没有引用的属性</span></span><br><span class="line">    <span class="comment">//2.1 查询当前分类下的所有分组</span></span><br><span class="line">    QueryWrapper&lt;AttrGroupEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId);</span><br><span class="line">    List&lt;AttrGroupEntity&gt; groups = attrGroupDao.selectList(wrapper);</span><br><span class="line">    <span class="comment">//2.2 查询这些分组关联的属性</span></span><br><span class="line">    List&lt;Long&gt; groupIds = groups.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrGroupId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    QueryWrapper&lt;AttrAttrgroupRelationEntity&gt; relationWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    relationWrapper.in(<span class="string">&quot;attr_group_id&quot;</span>, groupIds);</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; attrRelationList = relationDao.selectList(relationWrapper);</span><br><span class="line">    List&lt;Long&gt; attrRelationIds = attrRelationList.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//2.3 从所有属性表中剔除这些已经被关联的属性</span></span><br><span class="line">    QueryWrapper&lt;AttrEntity&gt; attrWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    attrWrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, catelogId);</span><br><span class="line">    attrWrapper.eq(<span class="string">&quot;attr_type&quot;</span>, ProductConstant.AttrEnum.ATTR_TYPE_BASE.getValue());    <span class="comment">//查询规则属性即可</span></span><br><span class="line">    <span class="keyword">if</span> (attrRelationIds != <span class="literal">null</span> &amp;&amp; attrRelationIds.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        attrWrapper.notIn(<span class="string">&quot;attr_id&quot;</span>, attrRelationIds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.用于迷糊查询搜索 key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(searchKey))&#123;</span><br><span class="line">        attrWrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;attr_id&quot;</span>, searchKey).or().like(<span class="string">&quot;attr_name&quot;</span>, searchKey);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;AttrEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrEntity&gt;().getPage(params), attrWrapper);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、添加属性和分组的关联关系：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 批量保存关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> relationVos 关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 保存结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/attr/relation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">addRelation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;AttrGroupRelationVo&gt; relationVos)</span>&#123;</span><br><span class="line">    relationService.saveBatchRelation(relationVos);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrAttrgroupRelationServiceImpl</span></span><br><span class="line"><span class="comment"> * 批量保存关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> relationVos 关联关系</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveBatchRelation</span><span class="params">(List&lt;AttrGroupRelationVo&gt; relationVos)</span> &#123;</span><br><span class="line">    List&lt;AttrAttrgroupRelationEntity&gt; relationEntities = relationVos.stream().map((item) -&gt; &#123;</span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">        BeanUtils.copyProperties(item, relationEntity);</span><br><span class="line">        <span class="keyword">return</span> relationEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="built_in">this</span>.saveBatch(relationEntities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5、需要注意的是，引入关联关系后，当<code>删除分组时需要将对应的关联关系进行删除</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 删除属性分组和对应的关联关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrGroupIds 属性分组id集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestBody</span> Long[] attrGroupIds)</span>&#123;</span><br><span class="line">    attrGroupService.remoGroupByIds(Arrays.asList(attrGroupIds));</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remoGroupByIds</span><span class="params">(List&lt;Long&gt; asList)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.removeByIds(asList);</span><br><span class="line">    relationDao.deleteBatchRelationByGroupIds(asList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;delete id=<span class="string">&quot;deleteBatchRelationByGroupIds&quot;</span>&gt;</span><br><span class="line">    delete from pms_attr_attrgroup_relation where</span><br><span class="line">    &lt;foreach collection=<span class="string">&quot;groupIds&quot;</span> item=<span class="string">&quot;groupId&quot;</span> separator=<span class="string">&quot; OR &quot;</span>&gt;</span><br><span class="line">    	(attr_group_id=#&#123;groupId&#125;)</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">&lt;/delete&gt;</span><br></pre></td></tr></table></figure>

<h3 id="规则参数"><a href="#规则参数" class="headerlink" title="规则参数"></a>规则参数</h3><h4 id="规则参数新增"><a href="#规则参数新增" class="headerlink" title="规则参数新增"></a>规则参数新增</h4><p>使用逆向生成的代码进行保存时会发现能够请求成功，但实际上并不会修改冗余关联表，并且分类属性也保存的并不完整（<code>需要保存整个分类链</code>），因此原先的代码并不行，同时添加新字段的方式不使用原先的 <code>@TableField</code> 修饰的方式进行添加 attrGroupId 字段，但实际上这并<code>不规范</code>。</p>
<blockquote>
<p>为了根据功能更清晰的划分实体类，将 JavaBean 划分为：</p>
<p>1）PO：持久对象，就是对应数据表中的记录，例如 BrandEntity。</p>
<p>2）DO：领域对象，就是从显示对象抽象出来的有形或无形的业务实体。</p>
<p>3）TO：数据传输对象，不同应用程序之间传输的对象，就是微服务之间传输的对象。</p>
<p>4）DTO：数据传输对象。</p>
<p>5）VO：值对象，也叫视图对象，用于<code>接受请求将请求的数据封装</code>，往往都不是数据库的完整记录信息，同时也是业务处理对象的封装。</p>
</blockquote>
<p>1、在 pojo 包下编写 <code>/vo/AttrVo</code> 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> String attrName;</span><br><span class="line">    <span class="keyword">private</span> Integer searchType;</span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="keyword">private</span> Integer valueType;</span><br><span class="line">    <span class="keyword">private</span> String valueSelect;</span><br><span class="line">    <span class="keyword">private</span> Integer attrType;</span><br><span class="line">    <span class="keyword">private</span> Long enable;</span><br><span class="line">    <span class="keyword">private</span> Long catelogId;</span><br><span class="line">    <span class="keyword">private</span> Integer showDesc;</span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、AttrController 编写添加方法，同时需要修改关联表数据信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 根据前端传递的数据包装成 AttrVo 进行数据库信息的新增</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attr 前端传递的属性数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 新增结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> AttrVo attr)</span>&#123;</span><br><span class="line">    attrService.saveAttr(attr);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 进行两个数据表的新增操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attr 前端传递的数据信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAttr</span><span class="params">(AttrVo attr)</span> &#123;</span><br><span class="line">        <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrEntity</span>();</span><br><span class="line">        <span class="comment">// BeanUtils.copyProperties(Object source, Object target)</span></span><br><span class="line">        BeanUtils.copyProperties(attr, attrEntity);</span><br><span class="line">        <span class="built_in">this</span>.save(attrEntity);  <span class="comment">//1.属性表新增基本数据</span></span><br><span class="line">    	<span class="comment">//有分组信息的属性才能保存到关联表中</span></span><br><span class="line">        <span class="keyword">if</span> (attr.getAttrType() == ProductConstant.AttrEnum.ATTR_TYPE_BASE.getValue() &amp;&amp; attr.getAttrGroupId() != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//规则属性才需要保存分组关系</span></span><br><span class="line">            <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">            relationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">            relationEntity.setAttrId(attrEntity.getAttrId());</span><br><span class="line">            log.debug(<span class="string">&quot;relationEntity:&#123;&#125;&quot;</span>, relationEntity);</span><br><span class="line">            relationDao.insert(relationEntity); <span class="comment">//2.关联表新增数据</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="规则参数查询"><a href="#规则参数查询" class="headerlink" title="规则参数查询"></a>规则参数查询</h4><p><img src="https://pic1.imgdb.cn/item/634a59ba16f2c2beb11222f9.png"></p>
<p>根据前端的表格属性以及接口文档，可以发现需要所属分类和所属分组属性，那么就需要再封装一个 AttrRespVo 对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrRespVo</span> <span class="keyword">extends</span> <span class="title class_">AttrVo</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String catelogName;     <span class="comment">//分类名称（实际是分类路径）</span></span><br><span class="line">    <span class="keyword">private</span> String groupName;       <span class="comment">//所属分组名称</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Long[] catelogPath;     <span class="comment">//分组完整路径（后面数据回显会用，当前用不到）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写查询方法，支持根据具体的分类 id 和关键字进行搜索查询。</p>
<blockquote>
<p>实际上也可以直接联表查询，但是如果数据过多，联表查询就会因为笛卡尔积的原因产生过多的中间数据，非常影响效率。（此处使用查三次的方式）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 查询基本属性列表，并支持根据具体分类id和关键字搜索</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数及关键字</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 分页数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/base/list/&#123;categoryId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">baseAttrList</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params,</span></span><br><span class="line"><span class="params">                      <span class="meta">@PathVariable(&quot;categoryId&quot;)</span> Long categoryId)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrService.queryBaseAttrPage(params, categoryId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数及关键字</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 分页信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryBaseAttrPage</span><span class="params">(Map&lt;String, Object&gt; params, Long categoryId)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (categoryId != <span class="number">0</span>)&#123;   <span class="comment">//传入了 categoryId</span></span><br><span class="line">        wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, categoryId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isEmpty(searchKey))&#123;</span><br><span class="line">        wrapper.and((obj) -&gt; &#123;</span><br><span class="line">            obj.eq(<span class="string">&quot;attr_id&quot;</span>, searchKey).or().like(<span class="string">&quot;attr_name&quot;</span>, searchKey);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;AttrEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;AttrEntity&gt;().getPage(params),wrapper);</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">pageUtils</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">    List&lt;AttrEntity&gt; records = page.getRecords();</span><br><span class="line">    List&lt;AttrRespVo&gt; attrRespVoList = records.stream().map((attrEntity -&gt; &#123;</span><br><span class="line">        <span class="type">AttrRespVo</span> <span class="variable">attrRespVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrRespVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(attrEntity, attrRespVo);</span><br><span class="line">        <span class="comment">//根据分类 id 获取分类信息</span></span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryDao.selectById(attrEntity.getCatelogId());</span><br><span class="line">        <span class="keyword">if</span> (categoryEntity != <span class="literal">null</span>) &#123;   <span class="comment">//没有指定分类时，分类信息可能并没有</span></span><br><span class="line">            attrRespVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据属性 id 获取分组id，进而再获取分组name</span></span><br><span class="line">        <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrRelation</span> <span class="operator">=</span></span><br><span class="line">            relationDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrEntity.getAttrId()));</span><br><span class="line">        <span class="keyword">if</span> (attrRelation != <span class="literal">null</span> &amp;&amp; attrRelation.getAttrGroupId() != <span class="literal">null</span>) &#123;  <span class="comment">//没有指定分组时，关联关系可能是空的</span></span><br><span class="line">            <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrRelation.getAttrGroupId());</span><br><span class="line">            attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> attrRespVo;</span><br><span class="line">    &#125;)).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//设置最新的结果集为 attrRespVoList</span></span><br><span class="line">    pageUtils.setList(attrRespVoList);</span><br><span class="line">    <span class="keyword">return</span> pageUtils;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="规格参数更新"><a href="#规格参数更新" class="headerlink" title="规格参数更新"></a>规格参数更新</h4><p>1、数据回显：直接使用逆向生成代码会发现所属分类的完整路径和所属分组并未回显，这也是由于数据封装漏了的原因，需要进行补充。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 用于数据回显的查询请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrId 属性id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回查询到的单条记录的属性信息（应该包括分类和分组信息）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/info/&#123;attrId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;attrId&quot;)</span> Long attrId)</span>&#123;</span><br><span class="line">    <span class="type">AttrRespVo</span> <span class="variable">attrRespVo</span> <span class="operator">=</span> attrService.getInfo(attrId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;attr&quot;</span>, attrRespVo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 查询前端需要的所有数据，包括分类路径和分组信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrId 属性id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> AttrRespVo 封装信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> AttrRespVo <span class="title function_">getInfo</span><span class="params">(Long attrId)</span> &#123;</span><br><span class="line">    <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(attrId);</span><br><span class="line">    <span class="type">AttrRespVo</span> <span class="variable">attrRespVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrRespVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(attrEntity, attrRespVo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置分组信息</span></span><br><span class="line">    <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrRelation</span> <span class="operator">=</span></span><br><span class="line">        relationDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrId));</span><br><span class="line">    <span class="keyword">if</span> (attrRelation != <span class="literal">null</span>) &#123;  <span class="comment">//没有指定分组时，关联关系可能是空的</span></span><br><span class="line">        attrRespVo.setAttrGroupId(attrRelation.getAttrGroupId());</span><br><span class="line">        <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrRelation.getAttrGroupId());</span><br><span class="line">        <span class="keyword">if</span> (attrGroupEntity != <span class="literal">null</span>) &#123;</span><br><span class="line">            attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置分类信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">catelogId</span> <span class="operator">=</span> attrEntity.getCatelogId();</span><br><span class="line">    <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryDao.selectById(catelogId);</span><br><span class="line">    Long[] catelogPath = categoryService.findCatelogPath(attrEntity.getCatelogId());</span><br><span class="line">    attrRespVo.setCatelogPath(catelogPath);</span><br><span class="line">    <span class="keyword">if</span> (categoryEntity != <span class="literal">null</span>) &#123;</span><br><span class="line">        attrRespVo.setCatelogName(categoryEntity.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attrRespVo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、数据更新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 修改属性的提交请求</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrVo 提交的 attrVo 信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 修改请求执行结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AttrVo attrVo)</span>&#123;</span><br><span class="line">    attrService.updateAttr(attrVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 进行属性的修改，需要修改中间表的信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrVo 接收到的页面的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateAttr</span><span class="params">(AttrVo attrVo)</span> &#123;</span><br><span class="line">    <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrEntity</span>();</span><br><span class="line">    BeanUtils.copyProperties(attrVo, attrEntity);</span><br><span class="line">    <span class="built_in">this</span>.updateById(attrEntity);    <span class="comment">//修改本表的基本数据</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.执行更新属性和属性分组中间表的操作</span></span><br><span class="line">    <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">    relationEntity.setAttrId(attrVo.getAttrId());</span><br><span class="line">    relationEntity.setAttrGroupId(attrVo.getAttrGroupId());</span><br><span class="line">    <span class="comment">//还需要判断当前关联表中有没有属性和分组关系</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">relationCount</span> <span class="operator">=</span> relationDao.selectCount(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrVo.getAttrId()));</span><br><span class="line">    <span class="keyword">if</span> (relationCount &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//如果有执行更新操作</span></span><br><span class="line">        UpdateWrapper&lt;AttrAttrgroupRelationEntity&gt; updateWrapper = <span class="keyword">new</span> <span class="title class_">UpdateWrapper</span>&lt;&gt;();</span><br><span class="line">        updateWrapper.eq(<span class="string">&quot;attr_id&quot;</span>, attrVo.getAttrId());</span><br><span class="line">        relationDao.update(relationEntity, updateWrapper);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果没有则需要执行增加操作</span></span><br><span class="line">        relationDao.insert(relationEntity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="销售属性"><a href="#销售属性" class="headerlink" title="销售属性"></a>销售属性</h3><p>规则参数实际就是和销售属性差不多，只不过是属性类型的区别，规则参数类型为 1，销售属性为 0，同时只有规则参数才有分组信息，销售属性应该是通用的，不用区分属于什么分组。</p>
<h4 id="销售属性查询"><a href="#销售属性查询" class="headerlink" title="销售属性查询"></a>销售属性查询</h4><p>根据接口文档，销售属性和规则参数的区别在于请求路径的细微区别，那么就可复用之前的请求，进行简单修改，添加路径参数 <code>attrType</code> 来进行区分。</p>
<p>修改原来的 AttrController 的查询方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/&#123;attrType&#125;/list/&#123;categoryId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">baseAttrList</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params,</span></span><br><span class="line"><span class="params">                      <span class="meta">@PathVariable(&quot;categoryId&quot;)</span> Long categoryId,</span></span><br><span class="line"><span class="params">                      <span class="meta">@PathVariable(&quot;attrType&quot;)</span> String attrType)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> attrService.queryBaseAttrPage(params, categoryId, attrType);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageUtils <span class="title function_">queryBaseAttrPage</span><span class="params">(Map&lt;String, Object&gt; params, Long categoryId, String type)</span> &#123;</span><br><span class="line">        QueryWrapper&lt;AttrEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        wrapper.eq(<span class="string">&quot;attr_type&quot;</span>, <span class="string">&quot;base&quot;</span>.equalsIgnoreCase(type) ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (categoryId != <span class="number">0</span>)&#123;   <span class="comment">//传入了 categoryId</span></span><br><span class="line">            wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, categoryId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//原先代码不变......</span></span><br><span class="line">        <span class="comment">//当为规则属性时需要设置属性分组信息，但是如果是销售属性那么就不能设置分组信息</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;base&quot;</span>.equalsIgnoreCase(type))&#123;</span><br><span class="line">            <span class="comment">//根据属性 id 获取分组id，进而再获取分组name</span></span><br><span class="line">            <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">attrRelation</span> <span class="operator">=</span></span><br><span class="line">                relationDao.selectOne(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;AttrAttrgroupRelationEntity&gt;().eq(<span class="string">&quot;attr_id&quot;</span>, attrEntity.getAttrId()));</span><br><span class="line">            <span class="keyword">if</span> (attrRelation != <span class="literal">null</span>) &#123;  <span class="comment">//没有指定分组时，关联关系可能是空的</span></span><br><span class="line">                <span class="type">AttrGroupEntity</span> <span class="variable">attrGroupEntity</span> <span class="operator">=</span> attrGroupDao.selectById(attrRelation.getAttrGroupId());</span><br><span class="line">                attrRespVo.setGroupName(attrGroupEntity.getAttrGroupName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//原先代码不变......</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="销售属性新增"><a href="#销售属性新增" class="headerlink" title="销售属性新增"></a>销售属性新增</h4><p>由于经常需要进行判断，可以抽取出常量类放到 common 项目中：<code>constant/ProductConstant</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductConstant</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//属性类型的枚举类</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">AttrEnum</span>&#123;</span><br><span class="line">        ATTR_TYPE_BASE(<span class="number">1</span>, <span class="string">&quot;规则属性&quot;</span>),ATTR_TYPE_SALE(<span class="number">0</span>, <span class="string">&quot;销售属性&quot;</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line">        <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">        AttrEnum(<span class="type">int</span> value, String message)&#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">            <span class="built_in">this</span>.message = message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改原先规则参数的新增方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (attr.getAttrType() == ProductConstant.AttrEnum.ATTR_TYPE_BASE.getValue())&#123;</span><br><span class="line">    <span class="comment">//规则属性才需要保存分组关系</span></span><br><span class="line">    <span class="type">AttrAttrgroupRelationEntity</span> <span class="variable">relationEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrAttrgroupRelationEntity</span>();</span><br><span class="line">    relationEntity.setAttrGroupId(attr.getAttrGroupId());</span><br><span class="line">    relationEntity.setAttrId(attrEntity.getAttrId());</span><br><span class="line">    log.debug(<span class="string">&quot;relationEntity:&#123;&#125;&quot;</span>, relationEntity);</span><br><span class="line">    relationDao.insert(relationEntity); <span class="comment">//2.关联表新增数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相同的，在查询回显数据以及更新属性时都是需要判断属性类型是不是规则属性类型的。</p>
<p>注：销售属性新增都是直接使用逆向生成代码即可。</p>
<h2 id="商品维护模块"><a href="#商品维护模块" class="headerlink" title="商品维护模块"></a>商品维护模块</h2><h3 id="发布商品模块"><a href="#发布商品模块" class="headerlink" title="发布商品模块"></a>发布商品模块</h3><h4 id="基本信息录入"><a href="#基本信息录入" class="headerlink" title="基本信息录入"></a>基本信息录入</h4><p>1、根据前端请求接口，需要编写会员等级相关接口：</p>
<p>1）查看前置注册中心相关配置是否完整。</p>
<p>2）网关系统配置路由信息：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">member_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://shop-member</span></span><br><span class="line">  <span class="attr">predicates:</span> <span class="comment"># 规定前端项目的路由都带有 /api/thirdservice/ 前缀</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/api/member/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RewritePath=/api/(?&lt;segment&gt;.*),/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>3）启动 member 项目（里面本身有逆向生成的代码），添加测试的会员等级（前端页面复用谷粒商城）：</p>
<p><img src="https://pic1.imgdb.cn/item/634baf9816f2c2beb10afe31.png"></p>
<p>此时说明会员接口就是成功能够使用的。</p>
<p>2、根据前端页面，需要获取分类关联的所有品牌：</p>
<p>1）由于前端只需要品牌id和品牌name，那么可以单独封装一个 BrandVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BrandVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> String brandName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）具体实现请求接口的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryBrandRelationController</span></span><br><span class="line"><span class="comment"> * 获取某个分类关联的所有品牌</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 品牌id和品牌名称的集合:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/brands/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">catRelationBrandList</span><span class="params">(<span class="meta">@RequestParam(&quot;catId&quot;)</span> Long catId)</span>&#123;</span><br><span class="line">    <span class="comment">//其他位置可能还需要用到这个请求的全量数据，因此还是选择查询到所有数据</span></span><br><span class="line">    List&lt;BrandEntity&gt; brandEntityList = categoryBrandRelationService.getBrandsByCatId(catId);</span><br><span class="line">    List&lt;BrandVo&gt; brandVoList = brandEntityList.stream().map(brandEntity -&gt; &#123;</span><br><span class="line">        <span class="type">BrandVo</span> <span class="variable">brandVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BrandVo</span>();</span><br><span class="line">        brandVo.setBrandId(brandEntity.getBrandId());</span><br><span class="line">        brandVo.setBrandName(brandEntity.getName());</span><br><span class="line">        <span class="keyword">return</span> brandVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, brandVoList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * CategoryBrandRelationServiceImpl</span></span><br><span class="line"><span class="comment"> * 从分类品牌关联表中根据分类查询品牌信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> catId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 品牌信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BrandEntity&gt; <span class="title function_">getBrandsByCatId</span><span class="params">(Long catId)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;CategoryBrandRelationEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, catId);</span><br><span class="line">    List&lt;CategoryBrandRelationEntity&gt; relationEntities = relationDao.selectList(wrapper);</span><br><span class="line">    <span class="comment">//为了方法重用，还是获取一下品牌的详细信息</span></span><br><span class="line">    List&lt;BrandEntity&gt; brandEntityList = relationEntities.stream().map(relation -&gt; &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">brandId</span> <span class="operator">=</span> relation.getBrandId();</span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(brandId);</span><br><span class="line">        <span class="keyword">return</span> brandEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> brandEntityList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）结果就是选择分类后就能够选择下面的品牌下拉框的选择：</p>
<p><img src="https://pic1.imgdb.cn/item/634bbbfb16f2c2beb1209439.png"></p>
<p>4）修改前端代码中的图片上传的 action 属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">action=<span class="string">&quot;https://cloud-shop-bucket.oss-cn-nanjing.aliyuncs.com&quot;</span></span><br><span class="line"><span class="comment">//还需要注意下面的data域的赋值操作应该使用 accessId，而非原来提供的 accessid</span></span><br><span class="line">_self.<span class="property">dataObj</span>.<span class="property">ossaccessKeyId</span> = response.<span class="property">data</span>.<span class="property">accessId</span>;</span><br></pre></td></tr></table></figure>

<h4 id="规则参数录入"><a href="#规则参数录入" class="headerlink" title="规则参数录入"></a>规则参数录入</h4><p>1、根据前端请求根据分类id查询对应的属性分组以及其属性集合进行显示。</p>
<p>1）由于前端需要将属性分组查询出来后，还需要每个分组下的对应属性，因此封装一个 AttrGroupWithAttrsVo：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttrGroupWithAttrsVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrGroupId;</span><br><span class="line">    <span class="keyword">private</span> String attrGroupName;</span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line">    <span class="keyword">private</span> String descript;</span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line">    <span class="keyword">private</span> Long catelogId;</span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrEntity&gt; attrs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）具体的查询逻辑，主要就是先查询分组，再查询分组对应的属性集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupController</span></span><br><span class="line"><span class="comment"> * 根据分类id查询对应的属性分组以及其属性集合。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  AttrGroupWithAttrsVo 集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;catelogId&#125;/withattr&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">getAttrGroupWithAttrs</span><span class="params">(<span class="meta">@PathVariable(&quot;catelogId&quot;)</span> Long categoryId)</span>&#123;</span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; data = attrGroupService.getAttrGroupWithAttrsByCatId(categoryId)</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrGroupServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据分类id查询AttrGroupWithAttrsVo集合信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryId 分类id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AttrGroupWithAttrsVo&gt; <span class="title function_">getAttrGroupWithAttrsByCatId</span><span class="params">(Long categoryId)</span> &#123;</span><br><span class="line">    <span class="comment">//1.查询分组信息</span></span><br><span class="line">    QueryWrapper&lt;AttrGroupEntity&gt; AttrGroupWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    AttrGroupWrapper.eq(<span class="string">&quot;catelog_id&quot;</span>, categoryId);</span><br><span class="line">    List&lt;AttrGroupEntity&gt; attrGroupEntityList = <span class="built_in">this</span>.list(AttrGroupWrapper);</span><br><span class="line">    <span class="comment">//2.对每个分组查询其所有属性并进行封装</span></span><br><span class="line">    List&lt;AttrGroupWithAttrsVo&gt; attrGroupWithAttrsVos = attrGroupEntityList.stream().map(attrGroup -&gt; &#123;</span><br><span class="line">        <span class="type">AttrGroupWithAttrsVo</span> <span class="variable">attrGroupWithAttrsVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AttrGroupWithAttrsVo</span>();</span><br><span class="line">        BeanUtils.copyProperties(attrGroup, attrGroupWithAttrsVo);</span><br><span class="line">        <span class="comment">//2.1 查询所有属性进行封装，用之前已经有的方法</span></span><br><span class="line">        List&lt;AttrEntity&gt; attrs = attrService.getRelationAttr(attrGroup.getAttrGroupId());</span><br><span class="line">        attrGroupWithAttrsVo.setAttrs(attrs);</span><br><span class="line">        <span class="keyword">return</span> attrGroupWithAttrsVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> attrGroupWithAttrsVos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前端我拷贝的页面是有问题的，需要修改对应赋值逻辑：<code>data.page</code> ，如果请求无问题但是不显示数据可以检查一下。</p>
<p>销售属性是使用直接展示的方式，后端逆向代码已经提供了请求方法。</p>
<h4 id="发布提交实现"><a href="#发布提交实现" class="headerlink" title="发布提交实现"></a>发布提交实现</h4><p>新增商品的实现，也就是新增商品后端的逻辑并没有实现，首先肯定是需要对前端整个大表单信息的封装 Vo。</p>
<p>1、前端表单所提交信息的 JavaBean 封装 Vo：</p>
<p>1）表单提交的整体信息的封装 ProductVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//商品保存的Vo</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String spuName;</span><br><span class="line">    <span class="keyword">private</span> String spuDescription;</span><br><span class="line">    <span class="keyword">private</span> Long catalogId;</span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal weight;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> publishStatus;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; decript;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; images;</span><br><span class="line">    <span class="keyword">private</span> BoundVo bounds;</span><br><span class="line">    <span class="keyword">private</span> List&lt;BaseAttrsVo&gt; baseAttrs;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ProductSkuVo&gt; skus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）积分信息的封装 BoundVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BoundVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal buyBounds;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal growBounds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）商品中所需基本属性信息的封装 BaseAttrsVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseAttrsVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> String attrValues;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> showDesc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）商品 sku 笛卡尔积组合信息的封装 ProductSkuVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductSkuVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ProductAttrVo&gt; attr;</span><br><span class="line">    <span class="keyword">private</span> String skuName;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> String skuTitle;</span><br><span class="line">    <span class="keyword">private</span> String skuSubtitle;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ProductImageVo&gt; images;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; descar;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> fullCount;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal discount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> countStatus;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal fullPrice;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal reducePrice;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> priceStatus;</span><br><span class="line">    <span class="keyword">private</span> List&lt;MemberPriceVo&gt; memberPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）商品属性信息的单独封装 ProductAttrVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductAttrVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long attrId;</span><br><span class="line">    <span class="keyword">private</span> String attrName;</span><br><span class="line">    <span class="keyword">private</span> String attrValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6）商品图片信息的封装 ProductImageVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductImageVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String imgUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> defaultImg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>7）商品会员价格及优惠信息的封装 MemberPriceVo 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MemberPriceVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;    <span class="comment">//会员等级id</span></span><br><span class="line">    <span class="keyword">private</span> String name;    <span class="comment">//会员等级名称</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;   <span class="comment">//会员价格</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、接受前端提交的数据，进行商品的新增。</p>
<p>1）SpuInfoController 实现业务逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoController</span></span><br><span class="line"><span class="comment"> * 新增商品数据，牵扯到多张表的操作修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> productVo 需要新增的商品信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> ProductVo productVo)</span>&#123;</span><br><span class="line">    spuInfoService.saveProduct(productVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）由于涉及到调用远程服务 coupon 服务进行一些优惠数据的增加，首先肯定需要确保 coupon 的配置（服务注册和发现的配置）。</p>
<p>3）涉及到远程调用，那么又出现了远程调用传递数据的问题，那么此时就需要在 common 模块新建 SpuBoundTo 和 SkuReductionTo 这两个网络传输的 Bean 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//会员积分信息To</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpuBoundTo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal buyBounds;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal growBounds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//优惠信息To</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuReductionTo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> fullCount;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal discount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> countStatus;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal fullPrice;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal reducePrice;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> priceStatus;</span><br><span class="line">    <span class="comment">//需要在common也导入MemberPriceVo这个 Bean</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MemberPriceVo&gt; memberPrice;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）product 新建 feign 包，编写本地的存根 SpuFeignService 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;shop-coupon&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CouponFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存spu的积分信息：需要使用商品服务远程调用member服务修改shop_sms库的sms_spu_bounds表</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/coupon/spubounds/saveBounds&quot;)</span></span><br><span class="line">    R <span class="title function_">saveSpuBounds</span><span class="params">(<span class="meta">@RequestBody</span> SpuBoundTo spuBoundTo)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置sku的优惠、满减等信息：远程调用coupon服务修改shop_sms库的sms_sku_ladder、sms_sku_full_reduction以及sms_member_price表信息</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/coupon/skufullreduction/saveReductionInfo&quot;)</span></span><br><span class="line">    R <span class="title function_">saveSkuReduction</span><span class="params">(<span class="meta">@RequestBody</span> SkuReductionTo skuReductionTo)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）远端 coupon 服务对调用进行具体的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * coupon-SpuBoundsController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuBounds 接收到的远端传递的积分信息</span></span><br><span class="line"><span class="comment"> * 此处不使用相同 To 进行接收是因为本身 SpuBoundTo 信息在 SpuBoundsEntity 都存在，因此可以用 SpuBoundsEntity直接接收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/saveBounds&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">saveSpuBounds</span><span class="params">(<span class="meta">@RequestBody</span> SpuBoundsEntity spuBounds)</span>&#123;</span><br><span class="line">    spuBoundsService.save(spuBounds);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * coupon-SkuFullReductionController</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuReductionTo 接收到的远端的优惠信息数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/saveReductionInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">saveSkuReduction</span><span class="params">(<span class="meta">@RequestBody</span> SkuReductionTo skuReductionTo)</span>&#123;</span><br><span class="line">    skuFullReductionService.saveSkuReduction(skuReductionTo);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * coupon-SkuFullReductionServiceImpl</span></span><br><span class="line"><span class="comment"> * 实现优惠信息的保存，涉及到多个数据表操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuReductionTo 优惠信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveSkuReduction</span><span class="params">(SkuReductionTo skuReductionTo)</span> &#123;</span><br><span class="line">    <span class="comment">//1.保存满减打折和会员价等信息：sms_sku_ladder</span></span><br><span class="line">    <span class="type">SkuLadderEntity</span> <span class="variable">skuLadderEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuLadderEntity</span>();</span><br><span class="line">    skuLadderEntity.setSkuId(skuReductionTo.getSkuId());</span><br><span class="line">    skuLadderEntity.setFullCount(skuReductionTo.getFullCount());</span><br><span class="line">    skuLadderEntity.setDiscount(skuReductionTo.getDiscount());</span><br><span class="line">    skuLadderEntity.setAddOther(skuReductionTo.getCountStatus());</span><br><span class="line">    <span class="keyword">if</span> (skuReductionTo.getFullCount() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        skuLadderService.save(skuLadderEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.保存满减信息：sms_sku_full_reduction</span></span><br><span class="line">    <span class="type">SkuFullReductionEntity</span> <span class="variable">skuFullReductionEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuFullReductionEntity</span>();</span><br><span class="line">    skuFullReductionEntity.setSkuId(skuReductionTo.getSkuId());</span><br><span class="line">    skuFullReductionEntity.setFullPrice(skuReductionTo.getFullPrice());</span><br><span class="line">    skuFullReductionEntity.setReducePrice(skuReductionTo.getReducePrice());</span><br><span class="line">    skuFullReductionEntity.setAddOther(skuReductionTo.getPriceStatus());</span><br><span class="line">    <span class="keyword">if</span> (skuFullReductionEntity.getFullPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">this</span>.save(skuFullReductionEntity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.保存会员价格：sms_member_price</span></span><br><span class="line">    List&lt;MemberPriceVo&gt; memberPrices = skuReductionTo.getMemberPrice();</span><br><span class="line">    List&lt;MemberPriceEntity&gt; memberPriceEntityList = memberPrices.stream().map(memberPrice -&gt; &#123;</span><br><span class="line">        <span class="type">MemberPriceEntity</span> <span class="variable">memberPriceEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemberPriceEntity</span>();</span><br><span class="line">        memberPriceEntity.setSkuId(skuReductionTo.getSkuId());</span><br><span class="line">        memberPriceEntity.setMemberLevelId(memberPrice.getId());</span><br><span class="line">        memberPriceEntity.setMemberPrice(memberPrice.getPrice());</span><br><span class="line">        memberPriceEntity.setMemberLevelName(memberPrice.getName());</span><br><span class="line">        memberPriceEntity.setAddOther(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> memberPriceEntity;</span><br><span class="line">    &#125;).filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getMemberPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    memberPriceService.saveBatch(memberPriceEntityList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）product 服务本地 saveProduct 方法实现的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoServiceImpl</span></span><br><span class="line"><span class="comment"> * 对多张表的数据进行新增记录，包括远程调用服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> productVo 前端传递过来的商品信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProduct</span><span class="params">(ProductVo productVo)</span> &#123;</span><br><span class="line">    <span class="comment">//1.保存spu的基本信息：pms_spu_info</span></span><br><span class="line">    <span class="type">SpuInfoEntity</span> <span class="variable">spuInfoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuInfoEntity</span>();</span><br><span class="line">    BeanUtils.copyProperties(productVo, spuInfoEntity);</span><br><span class="line">    <span class="comment">//TODO：时间推荐使用 mp 的 fill = FieldFill.INSERT 方式来设置时间</span></span><br><span class="line">    spuInfoEntity.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    spuInfoEntity.setUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="built_in">this</span>.save(spuInfoEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.保存spu的描述图片：pms_spu_info_desc</span></span><br><span class="line">    List&lt;String&gt; descriptions = productVo.getDecript();</span><br><span class="line">    <span class="type">SpuInfoDescEntity</span> <span class="variable">spuInfoDescEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuInfoDescEntity</span>();</span><br><span class="line">    spuInfoDescEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">    spuInfoDescEntity.setDecript(String.join(<span class="string">&quot;,&quot;</span>, descriptions));   <span class="comment">//以逗号拼接描述</span></span><br><span class="line">    spuInfoDescService.save(spuInfoDescEntity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.保存spu的图片集：pms_spu_images</span></span><br><span class="line">    List&lt;String&gt; images = productVo.getImages();</span><br><span class="line">    <span class="keyword">if</span> (images != <span class="literal">null</span> &amp;&amp; images.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        List&lt;SpuImagesEntity&gt; spuImagesEntityList = images.stream().map(image -&gt; &#123;</span><br><span class="line">            <span class="type">SpuImagesEntity</span> <span class="variable">spuImagesEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuImagesEntity</span>();</span><br><span class="line">            spuImagesEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">            spuImagesEntity.setImgUrl(image);</span><br><span class="line">            <span class="keyword">return</span> spuImagesEntity;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        spuImagesService.saveBatch(spuImagesEntityList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.保存spu的规格参数(基本属性):pms_product_attr_value</span></span><br><span class="line">    List&lt;BaseAttrsVo&gt; baseAttrs = productVo.getBaseAttrs();</span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; attrValueEntityList = baseAttrs.stream().map(baseAttr -&gt; &#123;</span><br><span class="line">        <span class="type">ProductAttrValueEntity</span> <span class="variable">attrValueEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductAttrValueEntity</span>();</span><br><span class="line">        attrValueEntity.setAttrId(baseAttr.getAttrId());</span><br><span class="line">        <span class="comment">//4.1 通过 attrId 获取整个 attr 信息用于下面的封装</span></span><br><span class="line">        <span class="type">AttrEntity</span> <span class="variable">attrEntity</span> <span class="operator">=</span> attrService.getById(baseAttr.getAttrId());</span><br><span class="line">        attrValueEntity.setAttrName(attrEntity.getAttrName());</span><br><span class="line">        attrValueEntity.setAttrValue(baseAttr.getAttrValues());</span><br><span class="line">        attrValueEntity.setQuickShow(baseAttr.getShowDesc());   <span class="comment">//实际就是对应 quickShow 字段</span></span><br><span class="line">        attrValueEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">        <span class="keyword">return</span> attrValueEntity;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    attrValueService.saveBatch(attrValueEntityList);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.保存spu的积分信息：需要使用商品服务远程调用member服务修改shop_sms库的sms_spu_bounds表</span></span><br><span class="line">    <span class="type">BoundVo</span> <span class="variable">bounds</span> <span class="operator">=</span> productVo.getBounds();</span><br><span class="line">    <span class="type">SpuBoundTo</span> <span class="variable">spuBoundTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpuBoundTo</span>();</span><br><span class="line">    BeanUtils.copyProperties(bounds, spuBoundTo);</span><br><span class="line">    spuBoundTo.setSpuId(spuInfoEntity.getId());</span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> couponFeignService.saveSpuBounds(spuBoundTo);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;远程调用 coupon 服务保存 spu 积分信息失败!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.保存spu对应的所有sku信息</span></span><br><span class="line">    List&lt;ProductSkuVo&gt; skus = productVo.getSkus();</span><br><span class="line">    <span class="keyword">if</span> (skus != <span class="literal">null</span> &amp;&amp; skus.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        skus.forEach(sku -&gt; &#123;</span><br><span class="line">            <span class="comment">//6.0 寻找默认图片</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">defaultImage</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (ProductImageVo image : sku.getImages())&#123;</span><br><span class="line">                <span class="keyword">if</span> (image.getDefaultImg() == <span class="number">1</span>) &#123;</span><br><span class="line">                    defaultImage = image.getImgUrl();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//6.1 设置基本信息进行保存:pms_sku_info</span></span><br><span class="line">            <span class="type">SkuInfoEntity</span> <span class="variable">skuInfoEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuInfoEntity</span>();</span><br><span class="line">            BeanUtils.copyProperties(sku, skuInfoEntity);</span><br><span class="line">            skuInfoEntity.setBrandId(spuInfoEntity.getBrandId());</span><br><span class="line">            skuInfoEntity.setCatalogId(spuInfoEntity.getCatalogId());</span><br><span class="line">            skuInfoEntity.setSaleCount(<span class="number">0L</span>);</span><br><span class="line">            skuInfoEntity.setSpuId(spuInfoEntity.getId());</span><br><span class="line">            skuInfoEntity.setSkuDefaultImg(defaultImage);</span><br><span class="line">            skuInfoService.save(skuInfoEntity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//6.2 设置sku的图片信息：pms_sku_images</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">skuId</span> <span class="operator">=</span> skuInfoEntity.getSkuId();</span><br><span class="line">            List&lt;ProductImageVo&gt; skuProductImages = sku.getImages();</span><br><span class="line">            List&lt;SkuImagesEntity&gt; skuImages = skuProductImages.stream().map(image -&gt; &#123;</span><br><span class="line">                <span class="type">SkuImagesEntity</span> <span class="variable">skuImagesEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuImagesEntity</span>();</span><br><span class="line">                skuImagesEntity.setSkuId(skuId);</span><br><span class="line">                skuImagesEntity.setImgUrl(image.getImgUrl());</span><br><span class="line">                skuImagesEntity.setDefaultImg(image.getDefaultImg());</span><br><span class="line">                <span class="keyword">return</span> skuImagesEntity;</span><br><span class="line">            &#125;).filter(skuImage -&gt; &#123;</span><br><span class="line">                <span class="comment">//前端传递值还存在空值的可能性（未选中就是null也会传递到后台），返回true是需要，返回false是过滤掉</span></span><br><span class="line">                <span class="keyword">return</span> !StringUtils.isNullOrEmpty(skuImage.getImgUrl());</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            skuImagesService.saveBatch(skuImages);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//6.3 设置sku的销售属性信息：pms_sku_sale_attr_value</span></span><br><span class="line">            List&lt;ProductAttrVo&gt; attrs = sku.getAttr();</span><br><span class="line">            List&lt;SkuSaleAttrValueEntity&gt; skuSaleAttrValueEntities = attrs.stream().map(attr -&gt; &#123;</span><br><span class="line">                <span class="type">SkuSaleAttrValueEntity</span> <span class="variable">skuSaleAttrValueEntity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuSaleAttrValueEntity</span>();</span><br><span class="line">                skuSaleAttrValueEntity.setSkuId(skuId);</span><br><span class="line">                BeanUtils.copyProperties(attr, skuSaleAttrValueEntity);</span><br><span class="line">                <span class="keyword">return</span> skuSaleAttrValueEntity;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            skuSaleAttrValueService.saveBatch(skuSaleAttrValueEntities);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//6.4 设置sku的优惠、满减等信息：远程调用coupon服务修改shop_sms库的sms_sku_ladder、sms_sku_full_reduction以及sms_member_price表信息</span></span><br><span class="line">            <span class="type">SkuReductionTo</span> <span class="variable">skuReductionTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuReductionTo</span>();</span><br><span class="line">            BeanUtils.copyProperties(sku, skuReductionTo);</span><br><span class="line">            skuReductionTo.setSkuId(skuId);</span><br><span class="line">            <span class="keyword">if</span> (skuReductionTo.getFullCount() &gt; <span class="number">0</span> || skuReductionTo.getFullPrice().compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="type">R</span> <span class="variable">r1</span> <span class="operator">=</span> couponFeignService.saveSkuReduction(skuReductionTo);</span><br><span class="line">                <span class="keyword">if</span> (r1.getCode() != <span class="number">0</span>) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;远程调用 coupon 服务设置sku的优惠和满减等信息失败!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时需要开启的服务已经达到比较多的程度，同时需要设置批量重启方便。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.设置最大占用内存</span></span><br><span class="line">VM OPTIONS：-Xmx100m</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.新增 Coumpound ，将所需服务加入到这个里面</span></span><br></pre></td></tr></table></figure>

<p>启动所有需要的服务，进行示例商品的添加，为后面的实现做准备案例。</p>
<h3 id="SPU-管理模块"><a href="#SPU-管理模块" class="headerlink" title="SPU 管理模块"></a>SPU 管理模块</h3><h4 id="SPU-复杂检索"><a href="#SPU-复杂检索" class="headerlink" title="SPU 复杂检索"></a>SPU 复杂检索</h4><p><img src="https://pic1.imgdb.cn/item/634cfc7f16f2c2beb1cf0b24.png"></p>
<p>根据前端接口提供后端的逻辑实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoController</span></span><br><span class="line"><span class="comment"> * 根据条件检索 spu 列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 参数（包括需要的条件：品牌、分类等）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> spu列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> spuInfoService.queryPageByConditions(params);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据条件查询对应的 spu 列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 条件和分页信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPageByConditions</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;SpuInfoEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//进行条件的封装</span></span><br><span class="line">    <span class="comment">//1.是否选择分类id的判断</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catelogId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;catelogId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(catelogId) &amp;&amp; !(<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(catelogId)))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catalog_id&quot;</span>, catelogId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.是否选择品牌id的判断</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">brandId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(brandId) &amp;&amp; !(<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(brandId)))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, brandId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.是否选择状态的判断：新建、上架、下架</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;status&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(status))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;publish_status&quot;</span>, status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.关键字填写的判断</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(searchKey))&#123;</span><br><span class="line">        wrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;id&quot;</span>, searchKey).or().like(<span class="string">&quot;spu_name&quot;</span>, searchKey);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    IPage&lt;SpuInfoEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;SpuInfoEntity&gt;().getPage(params),wrapper);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现表格中显示的时间格式出现问题，那么可以添加 Spring 配置对全局时间进行格式化：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br></pre></td></tr></table></figure>

<h4 id="SPU-规格维护"><a href="#SPU-规格维护" class="headerlink" title="SPU 规格维护"></a>SPU 规格维护</h4><p>SPU 规格维护实际就是对 <code>规则参数</code> 进行修改。</p>
<blockquote>
<p>首先解决原来代码里面 “规格” 点击 400 问题：在路由的 <code>index.js</code> 的40行补充路由信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;/product-attrupdate&#x27;</span>, <span class="attr">component</span>: <span class="title function_">_import</span>(<span class="string">&#x27;modules/product/attrupdate&#x27;</span>), <span class="attr">name</span>: <span class="string">&#x27;attr-update&#x27;</span>, <span class="attr">meta</span>: &#123; <span class="attr">title</span>: <span class="string">&#x27;规格维护&#x27;</span>, <span class="attr">isTab</span>: <span class="literal">true</span> &#125; &#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>1、根据 spuId 查询对应的商品规格信息进行回显：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 某个spu基本属性（规则参数）数据的回显</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/base/listforspu/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">baseAttrListForSpu</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span>&#123;</span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; entities = productAttrValueService.baseAttrListForSpu(spuId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;data&quot;</span>, entities);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProductAttrValueServiceImpl</span></span><br><span class="line"><span class="comment"> * 数据信息的回显查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;ProductAttrValueEntity&gt; <span class="title function_">baseAttrListForSpu</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;ProductAttrValueEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;spu_id&quot;</span>, spuId);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.baseMapper.selectList(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、需要注意的是前端页面数据的对应关系，多处出现 <code>data.data</code> 取数据，实际上应该使用 <code>data.page</code> 来取出数据，前端数据不回显可能需要检查一下。</p>
<p>3、数据完成回显后，就可以开始实现数据的提交确认修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AttrController</span></span><br><span class="line"><span class="comment"> * 提交某个spu基本属性（规则参数）数据的的修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/update/&#123;spuId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">update</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId,</span></span><br><span class="line"><span class="params">                <span class="meta">@RequestBody</span> List&lt;ProductAttrValueEntity&gt; entities)</span>&#123;</span><br><span class="line">    productAttrValueService.updateSpuAttr(spuId, entities);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProductAttrValueServiceImpl</span></span><br><span class="line"><span class="comment"> * 提交数据的修改</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entities 提交后的spu规则参数的数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateSpuAttr</span><span class="params">(Long spuId, List&lt;ProductAttrValueEntity&gt; entities)</span> &#123;</span><br><span class="line">    <span class="comment">//1.删除这个 spuId 对应的所有属性</span></span><br><span class="line">    QueryWrapper&lt;ProductAttrValueEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;spu_id&quot;</span>, spuId);</span><br><span class="line">    <span class="built_in">this</span>.baseMapper.delete(queryWrapper);</span><br><span class="line">    <span class="comment">//2.采用新增的方式来重新增加记录</span></span><br><span class="line">    <span class="keyword">for</span> (ProductAttrValueEntity entity : entities) &#123;</span><br><span class="line">        entity.setSpuId(spuId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.saveBatch(entities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SPU-商品上架"><a href="#SPU-商品上架" class="headerlink" title="SPU 商品上架"></a>SPU 商品上架</h4><p>当点击上架时，上架状态改为 “上架” 状态，同时商品数据需要在 ES 中进行保存（ES 部分基本使用请看 <code>全文检索部分</code>），方便后续的搜索。</p>
<p>1、构建 ES 存储形式索引映射，并创建对应的索引（根据后面的需求回来修改 mapping）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;skuId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spuId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;skuTitle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;skuPrice&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;skuImg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;saleCount&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hasStock&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hotScore&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brandId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;catalogId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brandName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;brandImg&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;catalogName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;attrs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nested&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;attrId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attrName&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attrValue&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2、product 服务接受请求，实现商品上架功能：</p>
<p>1）SpuInfoController 接收请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoController</span></span><br><span class="line"><span class="comment"> * 上架指定 spuId 的商品</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/&#123;spuId&#125;/up&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">spuUp</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span>&#123;</span><br><span class="line">    spuInfoService.up(spuId);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）为了方便在 common 模块创建 <code>SkuEsModel</code> 类，用于传递数据。（实际应该在 product 和 search 各创建一份）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuEsModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> String skuTitle;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal skuPrice;</span><br><span class="line">    <span class="keyword">private</span> String skuImg;</span><br><span class="line">    <span class="keyword">private</span> Long saleCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> hasStock;</span><br><span class="line">    <span class="keyword">private</span> Long hotScore;</span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> Long catalogId;</span><br><span class="line">    <span class="keyword">private</span> String brandName;</span><br><span class="line">    <span class="keyword">private</span> String brandImg;</span><br><span class="line">    <span class="keyword">private</span> String catalogName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Attr&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Attr</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="keyword">private</span> String attrValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）SpuInfoServiceImpl 进行具体的业务逻辑实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpuInfoServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据 spuId 上架指定的商品，并存储到 ES 中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">up</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">    <span class="comment">//2.查询当前sku所有的可以用来被检索的规则属性（后续需要进行设置）</span></span><br><span class="line">    <span class="comment">//2.1 获取当前 spuId 所有的 attrValue 信息</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; attrValueEntityList = attrValueService.baseAttrListForSpu(spuId);</span><br><span class="line">    <span class="comment">//2.2 收集规则属性的id用来后续获取具体的 attr</span></span><br><span class="line">    List&lt;Long&gt; attrValueIds = attrValueEntityList.stream().map(attrValue -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attrValue.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//2.3 找出可被检索的id------ 标记1调用</span></span><br><span class="line">    List&lt;Long&gt; searchIds = attrService.selectSearchAttrValueIds(attrValueIds);</span><br><span class="line">    <span class="comment">//2.4 从所有属性id集合中过滤出只属于可被检索的id集合的内容</span></span><br><span class="line">    Set&lt;Long&gt; searchIdSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(searchIds);</span><br><span class="line">    List&lt;SkuEsModel.Attr&gt; attrs = attrValueEntityList.stream().filter(attrValue -&gt; &#123;</span><br><span class="line">        <span class="comment">//2.4.1 过滤掉不可检索的 baseAttr</span></span><br><span class="line">        <span class="keyword">return</span> searchIdSet.contains(attrValue.getAttrId());</span><br><span class="line">    &#125;).map( attrValue -&gt; &#123;</span><br><span class="line">        <span class="comment">//2.4.2 转化为可以放入 skuEsModel 的 attrs 属性对象</span></span><br><span class="line">        SkuEsModel.<span class="type">Attr</span> <span class="variable">attr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attr();</span><br><span class="line">        BeanUtils.copyProperties(attrValue, attr);</span><br><span class="line">        <span class="keyword">return</span> attr;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据 spuId 查询所有 sku 信息------------ 标记2调用</span></span><br><span class="line">    List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 远程调用 ware 服务，返回库存状态查询的批量结果</span></span><br><span class="line">    List&lt;Long&gt; skuIdList = skus.stream().map(SkuInfoEntity::getSkuId).collect(Collectors.toList());</span><br><span class="line">    Map&lt;Long, Boolean&gt; stockMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 远程调用 ware 仓储服务------------ 标记3调用</span></span><br><span class="line">        List&lt;SkuHasStockVo&gt; skusHasStock = wareFeignService.getSkusHasStock(skuIdList);</span><br><span class="line">        stockMap = skusHasStock.stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, item -&gt; item.isHasStock()));</span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">&quot;库存服务远程调用出现问题：&#123;&#125;&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.组装需要的数据</span></span><br><span class="line">    <span class="comment">//1.1 查询当前 supId 对应的所有sku信息和品牌分类等信息</span></span><br><span class="line">    Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">    List&lt;SkuEsModel&gt; upProducts = skus.stream().map(sku -&gt; &#123;</span><br><span class="line">        <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">        BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">        <span class="comment">//处理属性名不相同无法对拷的属性</span></span><br><span class="line">        skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">        skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">        <span class="comment">//需要远程调用库存系统，查询是否还有库存来设置 hasStock 属性(每次遍历到都调用不合适，因此得先请求获取再直接在此处插入)</span></span><br><span class="line">        <span class="keyword">if</span> (finalStockMap == <span class="literal">null</span>)&#123;</span><br><span class="line">            skuEsModel.setHasStock(<span class="literal">true</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            skuEsModel.setHasStock(finalStockMap.get(sku.getSkuId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span>热度评分此处默认设置为 0，但其实也可能刚上架就置顶设置热度</span></span><br><span class="line">        skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询品牌和分类信息并设置到 skuEsModel</span></span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">brand</span> <span class="operator">=</span> brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">        skuEsModel.setBrandName(brand.getName());</span><br><span class="line">        skuEsModel.setBrandImg(brand.getLogo());</span><br><span class="line">        skuEsModel.setCatalogName(categoryService.getById(skuEsModel.getCatalogId()).getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将对应的规则属性并设置到 attrs 属性中(每次遍历到都调用不合适，因此得先请求获取再直接在此处插入)</span></span><br><span class="line">        skuEsModel.setAttrs(attrs);</span><br><span class="line">        <span class="keyword">return</span> skuEsModel;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远程调用 search 服务，将数据发送到 es 进行保存------------ 标记4调用</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> searchFeignService.productStatusUp(upProducts);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//远程调用search上架成功，需要修改当前上架商品spu的状态------------ 标记5调用</span></span><br><span class="line">        <span class="built_in">this</span>.baseMapper.updateSpuStatus(spuId, ProductConstant.StatusEnum.SPU_UP.getCode());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//远程调用search上架失败</span></span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span>重复调用,也就是接口幂等性问题？ ====&gt; 重试机制 ？ ====&gt; 利用重试器的重试机制进行重试</span></span><br><span class="line">        log.error(<span class="string">&quot;searchFeignService 远程调用进行上架商品失败!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标记1调用：AttrServiceImpl</span></span><br><span class="line"><span class="comment"> * 在指定的所有属性集合里面找出可检索的属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrValueIds attrValue的id集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 可检索属性集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">selectSearchAttrValueIds</span><span class="params">(List&lt;Long&gt; attrValueIds)</span> &#123;</span><br><span class="line">    log.info(<span class="string">&quot;attrValueIds:&#123;&#125;&quot;</span>, attrValueIds);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.baseMapper.selectSearchAttrValueIds(attrValueIds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标记1调用 selectSearchAttrValueIds 具体执行的 sql 语句</span></span><br><span class="line">&lt;select id=<span class="string">&quot;selectSearchAttrValueIds&quot;</span> resultType=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span><br><span class="line">    select attr_id from pms_attr where attr_id in</span><br><span class="line">    	&lt;foreach collection=<span class="string">&quot;attrValueIds&quot;</span> item=<span class="string">&quot;id&quot;</span> separator=<span class="string">&quot;,&quot;</span> open=<span class="string">&quot;(&quot;</span> close=<span class="string">&quot;)&quot;</span>&gt;</span><br><span class="line">    		#&#123;id&#125;</span><br><span class="line">		&lt;/foreach&gt;</span><br><span class="line">    <span class="type">and</span> <span class="variable">search_type</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">&lt;/select&gt;</span><br><span class="line">            </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标记2调用：SkuInfoServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据 spuId 查询所有 sku 信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> spuId spuId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuInfoEntity&gt; <span class="title function_">getSkusBySpuId</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">   QueryWrapper&lt;SkuInfoEntity&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(<span class="string">&quot;spu_id&quot;</span>, spuId);</span><br><span class="line">   List&lt;SkuInfoEntity&gt; list = <span class="built_in">this</span>.list(queryWrapper);</span><br><span class="line">   <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//标记5调用处直接调用 baseMapper 执行sql语句</span></span><br><span class="line">&lt;update id=<span class="string">&quot;updateSpuStatus&quot;</span>&gt;</span><br><span class="line">    update pms_spu_info set publish_status=#&#123;code&#125;,update_time=NOW() <span class="type">where</span> <span class="variable">id</span> <span class="operator">=</span> #&#123;spuId&#125;</span><br><span class="line">&lt;/update&gt;</span><br></pre></td></tr></table></figure>

<p><code>[远程调用]</code> 远程调用 ware 仓储服务（标记3 处调用方法）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//product 本地存根</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/ware/waresku/hasStock&quot;)</span></span><br><span class="line">List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WareSkuController</span></span><br><span class="line"><span class="comment"> * 查询一些商品(sku)是否有库存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回商品库存状态信息</span></span><br><span class="line"><span class="comment"> * 注：此处将 R 加上泛型再来返回实际上更好 R&lt;T&gt; 更有利于数据统一返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/hasStock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> wareSkuService.getSkusHasStock(skuIds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WareSkuServiceImpl</span></span><br><span class="line"><span class="comment"> * 检查商品库存状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(List&lt;Long&gt; skuIds)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> skuIds.stream().map(skuId -&gt; &#123;</span><br><span class="line">        <span class="type">SkuHasStockVo</span> <span class="variable">skuHasStockVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuHasStockVo</span>();</span><br><span class="line">        <span class="comment">//查询当前 sku 的总库存量（多个仓库的库存之和）,单个仓库的库存还得减去锁定的库存量</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">sumStock</span> <span class="operator">=</span> <span class="built_in">this</span>.baseMapper.getSkuSumStock(skuId);</span><br><span class="line">        skuHasStockVo.setHasStock(sumStock == <span class="literal">null</span> ? <span class="literal">false</span> : (sumStock &gt; <span class="number">0</span>));</span><br><span class="line">        skuHasStockVo.setSkuId(skuId);</span><br><span class="line">        <span class="keyword">return</span> skuHasStockVo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//getSkuSumStock 方法的具体实现sql语句</span></span><br><span class="line">&lt;select id=<span class="string">&quot;getSkuSumStock&quot;</span> resultType=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span><br><span class="line">    select <span class="title function_">sum</span><span class="params">(stock - stock_locked)</span> from wms_ware_sku <span class="type">where</span> <span class="variable">sku_id</span> <span class="operator">=</span> #&#123;skuId&#125;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p><code>[远程调用]</code> 远程调用 search 检索服务（标记4 处调用方法）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//product 本地存根</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/search/save/product&quot;)</span></span><br><span class="line">R <span class="title function_">productStatusUp</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;SkuEsModel&gt; skuEsModels)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//search 服务新建商品索引 constant 常量工具类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsConstant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCT_INDEX</span> <span class="operator">=</span> <span class="string">&quot;product&quot;</span>;   <span class="comment">//SKU商品的索引</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新建 ElasticSaveController 类负责检索资源的存储实现</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/search/save&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSaveController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProductSaveService productSaveService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/product&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">productStatusUp</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;SkuEsModel&gt; skuEsModels)</span>&#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">upFlag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upFlag = productSaveService.productStatusUp(skuEsModels);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ElasticSaveController 商品上架错误：&#123;&#125;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCode.PRODUCT_UP_EXCEPTION.getCode(), BizCode.PRODUCT_UP_EXCEPTION.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.ok();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ProductSaveServiceImpl</span></span><br><span class="line"><span class="comment"> * 保存 ES 数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> skuEsModels 数据集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">productStatusUp</span><span class="params">(List&lt;SkuEsModel&gt; skuEsModels)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//1.给 es 建立索引，操作 kibana 建立好映射关系 mapping（前置操作）</span></span><br><span class="line">    <span class="comment">//2.批量保存数据</span></span><br><span class="line">    <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">    <span class="keyword">for</span> (SkuEsModel skuEsModel : skuEsModels) &#123;</span><br><span class="line">        <span class="comment">//构建一个一个的保存请求</span></span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(EsConstant.PRODUCT_INDEX);</span><br><span class="line">        <span class="comment">//指定每个商品的id</span></span><br><span class="line">        indexRequest.id(skuEsModel.getSkuId().toString());</span><br><span class="line">        <span class="comment">//每个商品的真正数据内容 Json 格式</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> JSON.toJSONString(skuEsModel);</span><br><span class="line">        indexRequest.source(s, XContentType.JSON);</span><br><span class="line">        <span class="comment">//把每一个保存请求都放在bulk请求中</span></span><br><span class="line">        bulkRequest.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">BulkResponse</span> <span class="variable">bulk</span> <span class="operator">=</span> esClient.bulk(bulkRequest, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span>如果批量插入时出现错误，还需要单独处理（直接不处理？重新上架？记录下来？）</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> bulk.hasFailures();</span><br><span class="line">    List&lt;String&gt; collect = Arrays.stream(bulk.getItems()).map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    log.info(<span class="string">&quot;商品上架成功:&#123;&#125;&quot;</span>, collect);</span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="商品管理模块"><a href="#商品管理模块" class="headerlink" title="商品管理模块"></a>商品管理模块</h3><h4 id="SKU-复杂检索"><a href="#SKU-复杂检索" class="headerlink" title="SKU 复杂检索"></a>SKU 复杂检索</h4><p><img src="https://pic1.imgdb.cn/item/634cfcd116f2c2beb1cf8a5a.png"></p>
<p>根据前端接口提供后端的逻辑实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SkuInfoController</span></span><br><span class="line"><span class="comment"> * 根据条件信息查询 sku 信息列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数和查询条件封装</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, Object&gt; params)</span>&#123;</span><br><span class="line">    <span class="type">PageUtils</span> <span class="variable">page</span> <span class="operator">=</span> skuInfoService.queryPageByCondition(params);</span><br><span class="line">    <span class="keyword">return</span> R.ok().put(<span class="string">&quot;page&quot;</span>, page);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SkuInfoServiceImpl</span></span><br><span class="line"><span class="comment"> * 根据条件信息查询 sku 信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> params 分页参数和条件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageUtils <span class="title function_">queryPageByCondition</span><span class="params">(Map&lt;String, Object&gt; params)</span> &#123;</span><br><span class="line">    QueryWrapper&lt;SkuInfoEntity&gt; wrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//封装请求条件信息</span></span><br><span class="line">    <span class="comment">//1.设置搜索关键字条件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">searchKey</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(searchKey))&#123;</span><br><span class="line">        wrapper.and((w) -&gt; &#123;</span><br><span class="line">            w.eq(<span class="string">&quot;sku_id&quot;</span>, searchKey).or().like(<span class="string">&quot;sku_name&quot;</span>, searchKey);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.设置分类id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catelogId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;catelogId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(catelogId) &amp;&amp; !(<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(catelogId)))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;catalog_id&quot;</span>, catelogId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.设置品牌id</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">brandId</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(brandId) &amp;&amp; !(<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(brandId)))&#123;</span><br><span class="line">        wrapper.eq(<span class="string">&quot;brand_id&quot;</span>, brandId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.设置筛选价格下限</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">min</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;min&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(min) &amp;&amp; !(<span class="string">&quot;0&quot;</span>.equalsIgnoreCase(min)))&#123;</span><br><span class="line">        wrapper.ge(<span class="string">&quot;price&quot;</span>, min);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.设置筛选价格上限</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">max</span> <span class="operator">=</span> (String) params.get(<span class="string">&quot;max&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(max))&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BigDecimal</span> <span class="variable">bigDecimal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(max);</span><br><span class="line">                <span class="keyword">if</span> (bigDecimal.compareTo(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>)) == <span class="number">1</span>)&#123;</span><br><span class="line">                    wrapper.le(<span class="string">&quot;price&quot;</span>, max);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//封装返回信息</span></span><br><span class="line">    IPage&lt;SkuInfoEntity&gt; page = <span class="built_in">this</span>.page(<span class="keyword">new</span> <span class="title class_">Query</span>&lt;SkuInfoEntity&gt;().getPage(params),wrapper);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageUtils</span>(page);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://localhost:4000">moon</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://localhost:4000/2022/10/08/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/">http://localhost:4000/2022/10/08/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://localhost:4000" target="_blank">月の子豚小屋</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringBoot/">SpringBoot</a><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/07/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%8A%80%E6%9C%AF%E5%9B%9E%E9%A1%BE/"><img class="prev-cover" src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">谷粒商城-前端开发技术</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/10/%E9%A1%B9%E7%9B%AE%E9%97%AE%E9%A2%98/SpringBoot%E9%99%8D%E4%BD%8E%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/"><img class="next-cover" src="https://w.wallhaven.cc/full/zy/wallhaven-zygeko.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">SpringBoot 降低版本问题</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/10/17/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E4%BB%93%E5%82%A8%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9D%97/" title="谷粒商城-仓储服务模块"><img class="cover" src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-17</div><div class="title">谷粒商城-仓储服务模块</div></div></a></div><div><a href="/2022/10/24/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E6%90%9C%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86/" title="谷粒商城-用户搜索业务处理"><img class="cover" src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-24</div><div class="title">谷粒商城-用户搜索业务处理</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic1.imgdb.cn/item/6337ca6e16f2c2beb17d8731.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">moon</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">46</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div><a id="card-info-btn"><i class="fab fa-github"></i><span>月の子豚小屋</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/xxx" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/1963885633@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/1963885633" target="_blank" title="QQ"><i class="fa-sharp fa-solid fa-ghost"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">月の子豚小屋</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%B1%BB%E7%BB%B4%E6%8A%A4%E6%A8%A1%E5%9D%97"><span class="toc-number">1.</span> <span class="toc-text">分类维护模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E6%98%BE%E7%A4%BA"><span class="toc-number">1.1.</span> <span class="toc-text">菜单显示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E5%88%A0%E9%99%A4"><span class="toc-number">1.2.</span> <span class="toc-text">菜单删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E6%B7%BB%E5%8A%A0"><span class="toc-number">1.3.</span> <span class="toc-text">菜单添加</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8F%9C%E5%8D%95%E4%BF%AE%E6%94%B9"><span class="toc-number">1.4.</span> <span class="toc-text">菜单修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%96%E6%8B%BD%E5%8A%9F%E8%83%BD"><span class="toc-number">1.5.</span> <span class="toc-text">拖拽功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="toc-number">1.6.</span> <span class="toc-text">批量删除</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">2.</span> <span class="toc-text">品牌管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">配置分页插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%8A%B6%E6%80%81%E4%BC%98%E5%8C%96"><span class="toc-number">2.2.</span> <span class="toc-text">显示状态优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%93%81%E7%89%8C%E5%88%97%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">查询品牌列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E5%88%86%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.</span> <span class="toc-text">关联分类实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87OSS"><span class="toc-number">2.5.</span> <span class="toc-text">上传图片OSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E8%A1%A8%E5%8D%95%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.6.</span> <span class="toc-text">前端表单校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.7.</span> <span class="toc-text">统一异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%B1%9E%E6%80%A7%E6%A8%A1%E5%9D%97"><span class="toc-number">3.</span> <span class="toc-text">平台属性模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84"><span class="toc-number">3.1.</span> <span class="toc-text">属性分组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.1.1.</span> <span class="toc-text">属性分组查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E6%96%B0%E5%A2%9E"><span class="toc-number">3.1.2.</span> <span class="toc-text">属性分组新增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E5%88%86%E7%BB%84%E4%BF%AE%E6%94%B9"><span class="toc-number">3.1.3.</span> <span class="toc-text">属性分组修改</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E5%B1%9E%E6%80%A7%E5%85%B3%E8%81%94"><span class="toc-number">3.1.4.</span> <span class="toc-text">分组属性关联</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E5%8F%82%E6%95%B0"><span class="toc-number">3.2.</span> <span class="toc-text">规则参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E5%8F%82%E6%95%B0%E6%96%B0%E5%A2%9E"><span class="toc-number">3.2.1.</span> <span class="toc-text">规则参数新增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E5%8F%82%E6%95%B0%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.2.</span> <span class="toc-text">规则参数查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E6%A0%BC%E5%8F%82%E6%95%B0%E6%9B%B4%E6%96%B0"><span class="toc-number">3.2.3.</span> <span class="toc-text">规格参数更新</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7"><span class="toc-number">3.3.</span> <span class="toc-text">销售属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.3.1.</span> <span class="toc-text">销售属性查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%80%E5%94%AE%E5%B1%9E%E6%80%A7%E6%96%B0%E5%A2%9E"><span class="toc-number">3.3.2.</span> <span class="toc-text">销售属性新增</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E7%BB%B4%E6%8A%A4%E6%A8%A1%E5%9D%97"><span class="toc-number">4.</span> <span class="toc-text">商品维护模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%95%86%E5%93%81%E6%A8%A1%E5%9D%97"><span class="toc-number">4.1.</span> <span class="toc-text">发布商品模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E5%BD%95%E5%85%A5"><span class="toc-number">4.1.1.</span> <span class="toc-text">基本信息录入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E5%8F%82%E6%95%B0%E5%BD%95%E5%85%A5"><span class="toc-number">4.1.2.</span> <span class="toc-text">规则参数录入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E6%8F%90%E4%BA%A4%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.3.</span> <span class="toc-text">发布提交实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SPU-%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.2.</span> <span class="toc-text">SPU 管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SPU-%E5%A4%8D%E6%9D%82%E6%A3%80%E7%B4%A2"><span class="toc-number">4.2.1.</span> <span class="toc-text">SPU 复杂检索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SPU-%E8%A7%84%E6%A0%BC%E7%BB%B4%E6%8A%A4"><span class="toc-number">4.2.2.</span> <span class="toc-text">SPU 规格维护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SPU-%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="toc-number">4.2.3.</span> <span class="toc-text">SPU 商品上架</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">4.3.</span> <span class="toc-text">商品管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SKU-%E5%A4%8D%E6%9D%82%E6%A3%80%E7%B4%A2"><span class="toc-number">4.3.1.</span> <span class="toc-text">SKU 复杂检索</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-订单服务实现"/></a><div class="content"><a class="title" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现">谷粒商城-订单服务实现</a><time datetime="2022-11-06T14:42:44.735Z" title="发表于 2022-11-06 22:42:44">2022-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-购物车逻辑实现"/></a><div class="content"><a class="title" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现">谷粒商城-购物车逻辑实现</a><time datetime="2022-11-03T07:19:16.711Z" title="发表于 2022-11-03 15:19:16">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户认证处理"/></a><div class="content"><a class="title" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理">谷粒商城-用户认证处理</a><time datetime="2022-10-30T02:15:21.954Z" title="发表于 2022-10-30 10:15:21">2022-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/28/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E5%A4%84%E7%90%86/" title="谷粒商城-用户商品详情处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户商品详情处理"/></a><div class="content"><a class="title" href="/2022/10/28/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85%E5%A4%84%E7%90%86/" title="谷粒商城-用户商品详情处理">谷粒商城-用户商品详情处理</a><time datetime="2022-10-28T08:39:51.722Z" title="发表于 2022-10-28 16:39:51">2022-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/24/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E6%90%9C%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86/" title="谷粒商城-用户搜索业务处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="谷粒商城-用户搜索业务处理"/></a><div class="content"><a class="title" href="/2022/10/24/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E6%90%9C%E7%B4%A2%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86/" title="谷粒商城-用户搜索业务处理">谷粒商城-用户搜索业务处理</a><time datetime="2022-10-24T14:24:27.926Z" title="发表于 2022-10-24 22:24:27">2022-10-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By moon</div><div class="footer_custom_text">Hi, welcome to <a href="">月の子豚小屋</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'W7dceLXrUuiCITXy8cfM3sQ5-gzGzoHsz',
      appKey: 'Cu1minmiIoZRLGrJNxHnhZgn',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-mini="true" data-fixed="true" data-autoplay="true"> </div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>