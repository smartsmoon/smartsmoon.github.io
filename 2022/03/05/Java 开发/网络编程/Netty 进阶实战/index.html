<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Netty 进阶实战 | 月の子豚小窝</title><meta name="keywords" content="Netty"><meta name="author" content="月の子豚小窝"><meta name="copyright" content="月の子豚小窝"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="单元测试使用[案例]  Netty 网络编程主要就是 handler 编程，那么如何对编写的 handler 进行测试呢？&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 单元测试 Embedded ​	Embedded 是特殊的 Channel 实现，主要针对 ChannelHandler 的单元测试。通过 writeInbound 和 readInbound 测试入站的消息">
<meta property="og:type" content="article">
<meta property="og:title" content="Netty 进阶实战">
<meta property="og:url" content="http://localhost:4000/2022/03/05/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="月の子豚小窝">
<meta property="og:description" content="单元测试使用[案例]  Netty 网络编程主要就是 handler 编程，那么如何对编写的 handler 进行测试呢？&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; 单元测试 Embedded ​	Embedded 是特殊的 Channel 实现，主要针对 ChannelHandler 的单元测试。通过 writeInbound 和 readInbound 测试入站的消息">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/x8/wallhaven-x8xo1d.jpg">
<meta property="article:published_time" content="2022-03-04T16:00:00.000Z">
<meta property="article:modified_time" content="2022-11-21T03:54:42.539Z">
<meta property="article:author" content="月の子豚小窝">
<meta property="article:tag" content="Netty">
<meta property="article:tag" content="网络编程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/x8/wallhaven-x8xo1d.jpg"><link rel="shortcut icon" href="https://pic.imgdb.cn/item/637afbc616f2c2beb1d6ef3b.png"><link rel="canonical" href="http://localhost:4000/2022/03/05/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98/"><link rel="preconnect" href="//fastly.jsdelivr.net"/><link rel="preconnect" href="//cdn.dusays.com"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"简","msgToSimplifiedChinese":"繁"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的內容可能已经发生变化，请留意"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 月の子豚小窝","link":"链接: ","source":"来源: 月の子豚小窝","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn1.tianli0.top/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn1.tianli0.top/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Netty 进阶实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-21 11:54:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="shenma-site-verification" content="df2d187adea46639af5b16a59246a655_1658299306"><meta name="bytedance-verification-code" content="Sgu9oIPNU2jM5Z2P4Dv7" /><link rel="stylesheet" href="/css/styles.css"><link id="css" rel="stylesheet" href="/css/stylessimple.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/LYXOfficial/LYXOfficial.github.io/css/iconfont.css"><style>#article-container h1:before, h2:before, h3:before, h4:before, h5:before, h6:before { -webkit-animation: avatar_turn_around 3s linear infinite; -moz-animation: avatar_turn_around 3s linear infinite; -o-animation: avatar_turn_around 3s linear infinite; -ms-animation: avatar_turn_around 3s linear infinite; animation: avatar_turn_around 3s linear infinite; }</style><style id="barragesColor"></style><style id="settingStyle"></style><style id="yjjs"></style><style id="themeColor"></style><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC"><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/swiper/swiper-bundle.min.css"><link rel="stylesheet" href="https://cdn1.tianli0.top/gh/Zfour/Butterfly-card-history/baiduhistory/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC"><link rel="stylesheet" type="text/css" href="https://cdn1.tianli0.top/npm/node-snackbar@latest/dist/snackbar.min.css" /><script src="/swReg.js"></script><span id="fps"></span><link rel="stylesheet" href="/css/fixed_comment.css"  media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/aplayer.css"><link rel="stylesheet" href="/css/player.css"><link rel="stylesheet" href="/css/essay.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper-anzhiyu@1.0.4/lib/swiper.min.css"><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="/css/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.css" /><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-newspaper"></i><span> 文章</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 隧道</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-chart-bar"></i><span> 博客</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-chart-area"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="/census/"><i class="fa-fw fas fa-chart-line"></i><span> 博客统计</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 空间</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/speaks/"><i class="fa-fw fa fa-comments"></i><span> 说说</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw fa fa-bell"></i><span> 哔哔</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fab fa-galactic-republic"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/barrage/"><i class="fa-fw fa fa-blackboard"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 娱乐</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/musiccentor/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/muyu/"><i class="fa-fw fa-fw fa-solid fa-fish"></i><span> 木鱼</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-address-card"></i><span> 我的</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw fa-fw fas fa-tools"></i><span> 宝藏网站</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-info-circle"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/license/"><i class="fa-fw fas fa-balance-scale"></i><span> 版权声明</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://w.wallhaven.cc/full/x8/wallhaven-x8xo1d.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">月の子豚小窝</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-newspaper"></i><span> 文章</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 隧道</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-chart-bar"></i><span> 博客</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/charts/"><i class="fa-fw fas fa-chart-area"></i><span> 文章统计</span></a></li><li><a class="site-page child" href="/census/"><i class="fa-fw fas fa-chart-line"></i><span> 博客统计</span></a></li><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 空间</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/speaks/"><i class="fa-fw fa fa-comments"></i><span> 说说</span></a></li><li><a class="site-page child" href="/essay/"><i class="fa-fw fa fa-bell"></i><span> 哔哔</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fab fa-galactic-republic"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/barrage/"><i class="fa-fw fa fa-blackboard"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-sitemap"></i><span> 娱乐</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/musiccentor/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/muyu/"><i class="fa-fw fa-fw fa-solid fa-fish"></i><span> 木鱼</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-fw fas fa-address-card"></i><span> 我的</span><!--i.fas.fa-chevron-down--></a><ul class="menus_item_child"><li><a class="site-page child" href="/tools/"><i class="fa-fw fa-fw fas fa-tools"></i><span> 宝藏网站</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fa fa-info-circle"></i><span> 关于我</span></a></li><li><a class="site-page child" href="/license/"><i class="fa-fw fas fa-balance-scale"></i><span> 版权声明</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:rmf.scrollToTop()">PAGE_NAME</a></center></div><div id="toggleButtons"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><!--span=' '+_p('search.title')--></a></div><div id="randoms"><a class="site-page social-icon" href="javascript:toRandomPost()"><i class="fa fa-paper-plane"></i></a></div><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Netty 进阶实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-04T16:00:00.000Z" title="发表于 2022-03-05 00:00:00">2022-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-21T03:54:42.539Z" title="更新于 2022-11-21 11:54:42">2022-11-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java-%E5%BC%80%E5%8F%91/">Java 开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">18.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>82分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title="Netty 进阶实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/03/05/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98/#post-comment"><span id="twikoo-count"></span></a></span><span class="post-meta-separator">|&nbsp <span class="post-meta-dianzan"><a class="dianzan" href="javascript:void(0)" onclick="dianzan()"><i class="fas fa-thumbs-up"></i></a><span class="post-meta-label"> 点赞:</span><span class="dianzan-count">0</span></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="单元测试使用"><a href="#单元测试使用" class="headerlink" title="单元测试使用"></a>单元测试使用</h2><p><code>[案例]</code>  Netty 网络编程主要就是 handler 编程，那么如何对编写的 handler 进行测试呢？&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&gt; <code>单元测试 Embedded</code></p>
<p>​	Embedded 是特殊的 Channel 实现，主要针对 ChannelHandler 的单元测试。通过 <code>writeInbound</code> 和 <code>readInbound</code> 测试入站的消息通信，通过 <code>readOutbound</code> 和 <code>writeOnbound</code> 方法来测试出站的消息通信，write 方法都会返回 boolean 值，表示使用 write 方法向入站&#x2F;出站处理器写入数据，read 方法能够读取到，那么就返回 true，否则返回 false。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6336e98a16f2c2beb1bae671.png" alt="单元测试"></p>
<p>1）测试消息切割的入站 Handler：将传入的数据按照 handler 里面设定的固定的长度进行切割，如果传入的字节数不够，writeInbound 返回 false，readInbound 读取不到数据。</p>
<p>需要测试的解码器 FixedLengthFrameDecoder，用于分割数据长度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ByteToMessageDecoder 是一个入站处理器，处理入站字节，并将它们解码为消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedLengthFrameDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> frameLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定要生成的帧的长度(切分的字节数)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FixedLengthFrameDecoder</span><span class="params">(<span class="type">int</span> frameLength)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (frameLength &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                <span class="string">&quot;frameLength must be a positive integer: &quot;</span> + frameLength);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.frameLength = frameLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分割传入的字节</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//检查是否有足够的字节可以被读取，以生成下一个帧</span></span><br><span class="line">        <span class="keyword">while</span> (in.readableBytes() &gt;= frameLength) &#123;</span><br><span class="line">            <span class="comment">//从 ByteBuf 中读取一个新帧</span></span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> in.readBytes(frameLength);</span><br><span class="line">            <span class="comment">//将该帧添加到已被解码的消息列表中</span></span><br><span class="line">            out.add(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行单元测试读取和写入的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testFramesDecoded</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        buf.writeByte(i);  <span class="comment">//往 buf 写入 9 个字节</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">input</span> <span class="operator">=</span> buf.duplicate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//限定切分的字节大小</span></span><br><span class="line">    <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">FixedLengthFrameDecoder</span>(<span class="number">3</span>));</span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">1</span>)));;   <span class="comment">//使用 writeInbound 测试写入数据写入 1 个 false</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">1</span>)));;   <span class="comment">//使用 writeInbound 测试写入数据写入 1 个 false</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">1</span>)));;   <span class="comment">//使用 writeInbound 测试写入数据写入 1 个 true</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">6</span>)));;   <span class="comment">//使用 writeInbound 测试写入数据写入 6 个 true</span></span><br><span class="line">    channel.finish();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">read</span> <span class="operator">=</span> channel.readInbound();   <span class="comment">//读取所生成的消息，并且验证是否有3帧，其中每帧 3 字节</span></span><br><span class="line">    ConstantUtils.printMessage(buf.readSlice(<span class="number">3</span>).equals(read));  <span class="comment">// 和源数据进行对比</span></span><br><span class="line">    read.release();</span><br><span class="line"></span><br><span class="line">    read = channel.readInbound();</span><br><span class="line">    ConstantUtils.printMessage(buf.readSlice(<span class="number">3</span>).equals(read));  <span class="comment">// 和源数据进行对比</span></span><br><span class="line">    read.release();</span><br><span class="line">    read = channel.readInbound();</span><br><span class="line">    ConstantUtils.printMessage(buf.readSlice(<span class="number">3</span>).equals(read));  <span class="comment">// 和源数据进行对比</span></span><br><span class="line">    read.release();</span><br><span class="line">    ConstantUtils.printMessage(channel.readInbound());  <span class="comment">//继续读取验证是否读完了</span></span><br><span class="line">    buf.release();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）测试出站编码处理器的功能：此处主要就是将数据进行绝对值处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扩展 MessageToMessageEncoder 以将一个消息编码为另外一种格式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbsIntegerEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;ByteBuf&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//检查是否有足够的字节用来编码,int为4个字节</span></span><br><span class="line">        <span class="keyword">while</span> (in.readableBytes() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="comment">//从输入的 ByteBuf 中读取下一个整数，并且计算其绝对值</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> Math.abs(in.readInt());</span><br><span class="line">            <span class="comment">//将该整数写入到编码消息的 List 中</span></span><br><span class="line">            out.add(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testFramesEncoded</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 ByteBuf，并且写入 9 个负整数</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        buf.writeInt(i * -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个 EmbeddedChannel，并安装一个要测试的 AbsIntegerEncoder</span></span><br><span class="line">    <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">AbsIntegerEncoder</span>());</span><br><span class="line">    <span class="comment">//写入 ByteBuf，判断 readOutbound() 方法将会产生数据</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeOutbound(buf));</span><br><span class="line">    <span class="comment">//将该 Channel 标记为已完成状态</span></span><br><span class="line">    channel.finish();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取所产生的消息，并判断编码效果</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        ConstantUtils.printMessage((channel.readOutbound()).equals(i));</span><br><span class="line">    &#125;</span><br><span class="line">    ConstantUtils.printMessage(channel.readOutbound()); <span class="comment">//判断是否还有数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）测试异常处理：只允许最大的帧的字节大小为设定的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//扩展 ByteToMessageDecoder以将入站字节解码为消息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FrameChunkDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> maxFrameSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定将要产生的帧的最大允许大小</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FrameChunkDecoder</span><span class="params">(<span class="type">int</span> maxFrameSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.maxFrameSize = maxFrameSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">readableBytes</span> <span class="operator">=</span> in.readableBytes();</span><br><span class="line">        <span class="keyword">if</span> (readableBytes &gt; maxFrameSize) &#123;</span><br><span class="line">            <span class="comment">//如果该帧超出允许的大小，则丢弃它并抛出一个 TooLongFrameException……</span></span><br><span class="line">            in.clear();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TooLongFrameException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//否则，从 ByteBuf 中读取一个新的帧</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> in.readBytes(readableBytes);</span><br><span class="line">        <span class="comment">//将该帧添加到解码 读取一个新的帧消息的 List 中</span></span><br><span class="line">        out.add(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFramesException</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//创建一个 ByteBuf，并向它写入 9 字节</span></span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">9</span>; i++) &#123;</span><br><span class="line">        buf.writeByte(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">ByteBuf</span> <span class="variable">input</span> <span class="operator">=</span> buf.duplicate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个 EmbeddedChannel，并向其安装允许一个帧最大为3字节的 FrameChunkDecoder</span></span><br><span class="line">    <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">FrameChunkDecoder</span>(<span class="number">3</span>));</span><br><span class="line">    <span class="comment">//向它写入 2 字节，判断是否会产生一个有效帧</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">2</span>)));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//写入一个 4 字节大小的帧，判断是否会产生一个有效帧，并捕获预期的 TooLongFrameException</span></span><br><span class="line">        channel.writeInbound(input.readBytes(<span class="number">4</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TooLongFrameException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写入剩余的2字节，判断是否会产生一个有效帧</span></span><br><span class="line">    ConstantUtils.printMessage(channel.writeInbound(input.readBytes(<span class="number">3</span>)));</span><br><span class="line">    <span class="comment">//将该 Channel 标记为已完成状态</span></span><br><span class="line">    channel.finish();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UDP-协议"><a href="#UDP-协议" class="headerlink" title="UDP 协议"></a>UDP 协议</h2><p><code>[理论]</code>  UDP 是面向<code>无连接</code>的通讯协议，通讯时不需要接收方确认，属于<code>不可靠</code>的传输，但是正因为不需要建立连接，所以<code>传输速度快</code>，但是容易丢失数据。</p>
<blockquote>
<p>DNS 就是使用 UDP 为主， TCP 为辅。</p>
</blockquote>
<p><code>[理论]</code>  UDP 的报文是由 <code>报文首部（8 byte）</code>+ 数据部分 组成，报文首部则是由：</p>
<p>1）源端口（2 byte）：在需要对方回信时选用，不需要时可用全 0。</p>
<p>2）目的端口（2 byte）：目的端口号，这在终点交付报文时必须要使用到。</p>
<p>3）长度（2 byte）：UDP 用户数据包的长度，其最小值是 8 byte（也就是仅有报文首部）。</p>
<p>4）校验和（2 byte）：用来检测 UDP 用户数据报在传输中是否有错，有错就丢弃。</p>
<p><code>[理论]</code>  UDP 在 Netty 也提供了相关的支持，UDP 支持<code>单播</code>（发送到某个ip 和 port 确定的主机），同样还支持<code>广播</code>（发送到某个子网里面的所有主机）。在 Netty 中对 Channel 抽象成为 <code>DatagramChannel</code>，同时发送的数据也需要包装成 <code>DatagramPacket</code> 再进行发送。</p>
<p>1）基于 UDP 的<code>单播模式</code>的实现：发送端和接收端。</p>
<p>​	发送端主要就是发送问题，同时处理接收端的响应信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UdpQuestionSide</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">QUESTION</span> <span class="operator">=</span> <span class="string">&quot;想不想骂老李狗?&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">UdpQuestionSide</span>().start(UdpAnswerSide.ANSWER_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">eventLoopGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(eventLoopGroup)</span><br><span class="line">                    .channel(NioDatagramChannel.class)      <span class="comment">//表示使用 UDP 通信模式</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">QuestionHandler</span>());</span><br><span class="line">            <span class="comment">// 获取 channel</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.bind(<span class="number">0</span>).sync().channel();</span><br><span class="line">            <span class="comment">// 由于不需要建立连接，则直接向对端写即可,写的是 UDP 的报文</span></span><br><span class="line">            channel.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(</span><br><span class="line">                    Unpooled.copiedBuffer(QUESTION, StandardCharsets.UTF_8),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, port)    <span class="comment">//单播模式下需要指定具体应答方的主机</span></span><br><span class="line">            )).sync();  <span class="comment">//确保一定写完</span></span><br><span class="line">            <span class="comment">//由于不知道接收端是否接收，需要等待 15s 再关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel.closeFuture().await(<span class="number">15000</span>))&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;等待超时，正在关闭通道 ......&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            eventLoopGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuestionHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;DatagramPacket&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//接收应答端的报文</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, DatagramPacket msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获得应答数据，DatagramPacket 提供了 content 方法取得报文里面读的数据部分</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> msg.content().toString(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">if</span> (response.startsWith(UdpAnswerSide.ANSWER))&#123;     <span class="comment">// 判断是不是那个响应</span></span><br><span class="line">            System.out.println(response);</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		接收端需要接收到发送端发送过来的报文数据，并作出响应信息 DatagramPacket 的封装。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UdpAnswerSide</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ANSWER_PORT</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ANSWER</span> <span class="operator">=</span> <span class="string">&quot;当然想骂了，你这不是废话吗？&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">UdpAnswerSide</span>().run(ANSWER_PORT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//由于 UDP 是无连接的，没有接收连接的说法，因此不使用 ServerBootstrap</span></span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(group).channel(NioDatagramChannel.class).handler(<span class="keyword">new</span> <span class="title class_">AnswerHandler</span>());</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.bind(port).sync();</span><br><span class="line">            System.out.println(<span class="string">&quot;应答端服务已启动......&quot;</span>);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnswerHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;DatagramPacket&gt; &#123;</span><br><span class="line">    <span class="comment">//对端传过来的是一个个的 UDP 报文，因此此处便是拆解报文</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, DatagramPacket packet)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> packet.content().toString(StandardCharsets.UTF_8);     <span class="comment">//获取数据部分</span></span><br><span class="line">        <span class="keyword">if</span> (UdpQuestionSide.QUESTION.equals(request))&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> UdpAnswerSide.ANSWER;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到请求，请求内容为：&quot;</span> + request);</span><br><span class="line">            <span class="comment">//重新拼凑一个 DatagramPacket 向对端响应</span></span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(</span><br><span class="line">                    Unpooled.copiedBuffer(answer, StandardCharsets.UTF_8),</span><br><span class="line">                    packet.sender()     <span class="comment">// 获取对端的地址信息:UDP的报文上携带了</span></span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		测试结果发现能够正常进行消息的通信，在 UDP 中不存在服务端和客户端的概念，是没有建立连接的，两端都可能需要发送消息，同时都是使用 UDP 的数据报文 DatagramPacket 来封装消息。</p>
<p>2）基于 UDP 的<code>广播模式</code>的实现：广播端和事件监视器，也就是同一个内容一次向多个主机发送，以日志举例。</p>
<p>​	日志的相关实体类：LogMessage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogMessage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">SEPARATOR</span> <span class="operator">=</span> (<span class="type">byte</span>) <span class="string">&#x27;:&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InetSocketAddress source; <span class="comment">//日志的源地址</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String msg;   <span class="comment">//日志内容</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> msgId;   <span class="comment">//日志id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> time;    <span class="comment">//日志消息的发送时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于传入消息的构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, msg,-<span class="number">1</span>,System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于传出消息的构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogMessage</span><span class="params">(InetSocketAddress source, <span class="type">long</span> msgId, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(source,msg,msgId,System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogMessage</span><span class="params">(InetSocketAddress source, String msg, <span class="type">long</span> msgId, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.source = source;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">        <span class="built_in">this</span>.msgId = msgId;</span><br><span class="line">        <span class="built_in">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// getter setter and toString methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	模拟日志生成的类：LogConstant。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogConstant</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MONITOR_SIDE_PORT</span> <span class="operator">=</span> <span class="number">9998</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] LOG_INFOS = &#123;</span><br><span class="line">            <span class="string">&quot;20180912:peter-machine:啦啦啦，德玛西亚&quot;</span>,</span><br><span class="line">            <span class="string">&quot;20180913:deer-machine:痛！太痛了！&quot;</span>,</span><br><span class="line">            <span class="string">&quot;20180914:king-machine:哈萨克&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    <span class="comment">//产生模拟日志</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getLogInfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LOG_INFOS[r.nextInt(LOG_INFOS.length - <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	广播端启动程序，发送到某端口进行广播，需要设置广播模式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//广播端：发送生成的模拟日志</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventBroadcaster</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//创建并启动一个新的广播端的实例，广播统一写成 255.255.255.255 表示广播地址</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LogEventBroadcaster</span>().start(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;255.255.255.255&quot;</span>, LogConstant.MONITOR_SIDE_PORT));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//远端地址通过传入方式:传入广播地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(InetSocketAddress remoteAddress)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            <span class="comment">//引导该 NioDatagramChannel（无连接的）</span></span><br><span class="line">            bootstrap.group(group).channel(NioDatagramChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BROADCAST,<span class="literal">true</span>)    <span class="comment">//设置通信选项为广播模式</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LogEventEncoder</span>(remoteAddress));</span><br><span class="line">            <span class="comment">//绑定 Channel</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> bootstrap.bind(<span class="number">0</span>).sync().channel();</span><br><span class="line">            System.out.println(<span class="string">&quot;广播端准备发送消息 ......&quot;</span>);</span><br><span class="line">            <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;   <span class="comment">//模拟不停的发送日志</span></span><br><span class="line">                <span class="type">LogMessage</span> <span class="variable">logMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogMessage</span>(<span class="literal">null</span>, ++count, LogConstant.getLogInfo());</span><br><span class="line">                ch.writeAndFlush(logMessage);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息:&quot;</span> + logMessage.toString());</span><br><span class="line">                TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		广播端消息发送的编码器，将信息编码为 DatagramPacket 报文。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编码器继承 ChannelOutboundHandlerAdapter：将实际的日志实体类 LogMessage 编码为 DatagramPacket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;LogMessage&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InetSocketAddress remoteAddress;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LogEventEncoder 创建了即将被发送到指定的 InetSocketAddress 的 DatagramPacket 消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LogEventEncoder</span><span class="params">(InetSocketAddress remoteAddress)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.remoteAddress = remoteAddress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext channelHandlerContext, LogMessage logMessage, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//网络通信中消息发送都需要基于字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] logs = logMessage.getMsg().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> channelHandlerContext.alloc().buffer(<span class="number">8</span>*<span class="number">2</span> + logs.length + <span class="number">1</span>);   <span class="comment">// 通过分配器拿到 ByteBuf，并规定容量</span></span><br><span class="line">        buf.writeLong(logMessage.getTime());    <span class="comment">//时间</span></span><br><span class="line">        buf.writeLong(logMessage.getMsgId());   <span class="comment">//日志时间</span></span><br><span class="line">        buf.writeByte(LogMessage.SEPARATOR);    <span class="comment">//分隔符</span></span><br><span class="line">        buf.writeBytes(logs);   <span class="comment">//日志的具体内容</span></span><br><span class="line">        out.add(<span class="keyword">new</span> <span class="title class_">DatagramPacket</span>(buf, remoteAddress));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	监听端（接收端）启动程序，监听该端口的消息接收，注意设置广播模式和端口重用（本地测试需要）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//日志接收端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventMonitor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">//注意这里不能指定 127.0.0.1，因为是广播端使用的是广播地址 255.255.255.255</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">LogEventMonitor</span>().start(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(LogConstant.MONITOR_SIDE_PORT));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">(InetSocketAddress address)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            bootstrap.group(group).channel(NioDatagramChannel.class)</span><br><span class="line">                    .localAddress(address)  <span class="comment">//指明本地监听端口</span></span><br><span class="line">                    .option(ChannelOption.SO_BROADCAST, <span class="literal">true</span>)   <span class="comment">//设置套接字 SO_BROADCAST 表示通信选项为广播模式</span></span><br><span class="line">                    .option(ChannelOption.SO_REUSEADDR, <span class="literal">true</span>)   <span class="comment">//设置在一台应用程序上启动多个服务监听同一个端口（端口重用机制）</span></span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> channel.pipeline();</span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LogEventDecoder</span>());    <span class="comment">//对接收到的消息进行解码为 LogMessage</span></span><br><span class="line">                            pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LogEventHandler</span>());    <span class="comment">//实际的业务处理,此处直接打印</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            <span class="comment">//绑定 Channel 监听，但需要注意 DatagramChannel 是无连接的</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> bootstrap.bind().syncUninterruptibly().channel();</span><br><span class="line">            System.out.println(<span class="string">&quot;日志监听端启动......&quot;</span>);</span><br><span class="line">            channel.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	接收端需要对收到的 UDP 报文进行解码成 LogMessage 格式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解码：将 DatagramPacket 解码为实际的日志实体类 LogMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventDecoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageDecoder</span>&lt;DatagramPacket&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext channelHandlerContext, DatagramPacket packet, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//编码时放入的是 ByteBuf，因此解码拿到的内容也是 ByteBuf，同时解码时需要按照编码对应顺序拆包</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">data</span> <span class="operator">=</span> packet.content();</span><br><span class="line">        <span class="type">long</span> <span class="variable">sendTime</span> <span class="operator">=</span> data.readLong();</span><br><span class="line">        <span class="type">long</span> <span class="variable">msgId</span> <span class="operator">=</span> data.readLong();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">sep</span> <span class="operator">=</span> data.readByte();</span><br><span class="line">        <span class="type">int</span> <span class="variable">readerIndex</span> <span class="operator">=</span> data.readerIndex();   <span class="comment">//获取读索引的当前位置,就是分隔符的索引+1,提取日志消息需要从读索引开始，到最后</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> data.slice(readerIndex , data.readableBytes()).toString(StandardCharsets.UTF_8);</span><br><span class="line">        System.out.println(<span class="string">&quot;收到消息的内容是：&quot;</span>);</span><br><span class="line">        System.out.println(sendTime + <span class="string">&quot; [&quot;</span> + msgId + <span class="string">&quot;] &quot;</span> + sep + message);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构建一个新的 LogMsg 对象，并且将它添加到已经解码的消息的列表中，用于后面的 handler 使用</span></span><br><span class="line">        <span class="type">LogMessage</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LogMessage</span>(packet.sender(), msgId, message);</span><br><span class="line">        <span class="comment">//作为本handler的处理结果，交给后面的handler进行处理</span></span><br><span class="line">        out.add(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	解码后的报文传递给后面的业务 handler 进行处理，此处业务就是打印。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogEventHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;LogMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, LogMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//创建 StringBuilder，并且构建输出的字符串</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        builder.append(msg.getTime());</span><br><span class="line">        builder.append(<span class="string">&quot; [&quot;</span>);</span><br><span class="line">        builder.append(msg.getSource().toString());</span><br><span class="line">        builder.append(<span class="string">&quot;] ：[&quot;</span>);</span><br><span class="line">        builder.append(msg.getMsgId());</span><br><span class="line">        builder.append(<span class="string">&quot;] ：&quot;</span>);</span><br><span class="line">        builder.append(msg.getMsg());</span><br><span class="line">        <span class="comment">//打印 LogMsg 的数据</span></span><br><span class="line">        System.out.println(<span class="string">&quot;LogEventHandler &quot;</span> + builder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		测试时启动两个日志监听端，再启动日志发送端，发现能够起到广播的作用。断开其中一个监听端，再重启，发现能够继续接收到消息，而断开期间的消息并没有顺利接收，也说明了 UDP 是无连接不可靠的。广播模式一般适用于局域网内部的消息通信。</p>
<p>​		实际上，当局域网内部的广播端发送 UDP 报文时，局域网内部的所有接收端都会收到报文，没有配置广播设置的主机会先拿到报文进行解析发现不是自己的报文时才会丢弃（解析完才丢弃，因此会影响主机性能），配置了对应 handler 的服务接收到成功解析后就不会丢弃。（<code>组播</code> 底层也是基于 UDP ，可以做到指定某些机器接收报文，其余机器直接就不用接收解析）</p>
<p><code>[问题]</code>  现在发现 UDP 是无连接的，接收端中断一下就会丢包，并不会像 TCP 一样重复发送，怎么解决 UDP 的丢包问题呢？</p>
<p>​		借鉴 TCP 的解决方案（三次握手、中断重传等等机制），使用 <code>基于 UDP 的数据传输协议： UDT</code> 来防止丢包问题，UDT 主要用于高速广域网上的<code>海量数据</code>传输。UDT 是基于 UDP 在应用层来实现拥塞控制、带宽估计等等控制算法，因此是一个<code>应用层协议</code>。（目前 Java 没有开源的基于 UDT 的实现架构）</p>
<h2 id="服务器推送"><a href="#服务器推送" class="headerlink" title="服务器推送"></a>服务器推送</h2><p>​		服务器推送的作用就是进行网络应用时不需要一遍遍的刷新。Htpp 协议是单向无状态的（只允许客户端向服务端发请求，每一个客户端请求都是独立的新的），这就带来了麻烦，引入扫码登陆技术时，服务端如何知道<code>手机已经扫码从而进行响应</code>呢？毕竟服务端是不能向客户端发送请求验证的。</p>
<p>​		服务器推送按照出现时间长短，分为 ajax 短轮询、Comet 技术 和 WebSocket 技术。</p>
<p>1、服务器推送技术之 <code>ajax 短轮询</code>。在前端 Js 部分设置定时器，每隔一段时间向服务器请求一次，进行轮询查询状态，但这种方式会给服务端一定的压力，同时由于每一次的请求服务端都需要应答会消耗带宽，造成资源的浪费，最重要的就是数据的同步并不及时会有一定延时。</p>
<p>客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language = <span class="string">&quot;java&quot;</span> contentType= <span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding= <span class="string">&quot;UTF-8&quot;</span> %&gt;</span><br><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html <span class="variable constant_">PUBLIC</span> <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>服务器时间<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>服务器时间<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>服务器当前时间为：<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;color:#F00&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;serverTime&quot;</span>&gt;</span>  <span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery-1.9.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">showTime</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">showTime</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        $.<span class="title function_">get</span>(<span class="string">&quot;showTime&quot;</span>,<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            $(<span class="string">&quot;#serverTime&quot;</span>).<span class="title function_">html</span>(data);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setInterval</span>(showTime, <span class="number">1000</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShowTimeController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ShowTimeController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/time&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">normal</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;showtime&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/showTime&quot;,produces = &quot;text/html;charset=UTF-8&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTime</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">formatter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> formatter.format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、服务端推送技术之 <code>Comet 技术</code>。Comet 技术是基于 HTTP 长连接、无须在浏览器端安装插件的 <code>服务器推</code> 技术，器分为两种方式：</p>
<p>​	1）<code>基于 ajax 的长轮询方式</code>。也就是客户端发起请求后，服务端并不是马上响应，而是等待服务器有新内容时才会返回响应告诉客户端数据来了，同时关闭这个连接，创建新的连接获取数据信息。其实现方式主要有：基于 Servlet3 里面的<code>异步任务</code>（麻烦，此处不实现）、Spring 封住好的 <code>DeferedResult</code> 实现。</p>
<p>​	长轮询方式响应过后会暂时断开连接，如果在此期间有数据要发送，那么就会有延时。</p>
<p>客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>新闻推送<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>每日头条<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>每日头条新闻实时看<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;color:#F00&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;realTimeNews&quot;</span>&gt;</span>  <span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery-1.9.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">longLoop</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">longLoop</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        $.<span class="title function_">get</span>(<span class="string">&quot;realTimeNews&quot;</span>,<span class="keyword">function</span> (<span class="params">data</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            $(<span class="string">&quot;#realTimeNews&quot;</span>).<span class="title function_">html</span>(data);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="title function_">longLoop</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>服务端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(produces=&quot;text/html;charset=UTF-8&quot;)</span></span><br><span class="line"><span class="comment">/*记得要在WebInitializer中增加servlet.setAsyncSupported(true);*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PushNewsController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/pushnews&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">news</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pushNews&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/realTimeNews&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="comment">// 在 WebInitializer 中要加上 servlet.setAsyncSupported(true);</span></span><br><span class="line">    <span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title function_">realtimeNews</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="keyword">final</span> DeferredResult&lt;String&gt; dr = <span class="keyword">new</span> <span class="title class_">DeferredResult</span>&lt;String&gt;();		<span class="comment">//避免线程安全问题，每次 new 一个新的 DeferredResult</span></span><br><span class="line">        executorService.submit(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;		<span class="comment">//使用线程池提交任务，异步实现</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(Const.NEWS.length);</span><br><span class="line">                dr.setResult(Const.NEWS[index]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> dr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Const</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] NEWS = &#123;</span><br><span class="line">            <span class="string">&quot;震惊！美国总统看到后都惊呆了！&quot;</span>,</span><br><span class="line">            <span class="string">&quot;整个X国X洲都慌了：X公司X亿收购了这家企业&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	2）<code>基于长连接的服务器推模型 SSE（Server-sent-events）</code>，也就是服务器推送事件。客户端发起请求后，服务端并不是马上响应，而是等待服务器有新内容时才会返回响应到客户端，同时还会在应答报文里面告诉客户端，服务端会马上推送很多数据给客户端，让客户端不要关闭连接（<code>接下来发送的是流信息</code> ，数据不断），因此这个连接就保持着，一定那服务端有新数据就会马上直接可以推送给客户端。SSE 是基于浏览器实现的，也是 H5 时代出现的，只支持文本。</p>
<p>​	SSE 的方式实际上类似服务端在向客户端不停的发起请求，一旦客户端发起请求，那么这个 SSE 的推送过程就会断掉，就是一个全新的通信过程。</p>
<p>客户端：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language = <span class="string">&quot;java&quot;</span> contentType= <span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding= <span class="string">&quot;UTF-8&quot;</span> %&gt;</span><br><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html <span class="variable constant_">PUBLIC</span> <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;</span><br><span class="line">&lt;title&gt;贵金属期货&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;贵金属期货&lt;/h1&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h2&gt;贵金属列表&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h2 id=&quot;hint&quot;&gt;&lt;/h2&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;div&gt;&lt;p&gt;黄金&lt;/p&gt;&lt;p id=&quot;c0&quot; style=&quot;color:#F00&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;p id=&quot;s0&quot;&gt;历史价格：&lt;/p&gt;&lt;/b&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&lt;p&gt;白银&lt;/p&gt;&lt;p id=&quot;c1&quot; style=&quot;color:#F00&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;p id=&quot;s1&quot;&gt;历史价格：&lt;/p&gt;&lt;/b&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&lt;p&gt;铂&lt;/p&gt;&lt;p id=&quot;c2&quot; style=&quot;color:#F00&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;p id=&quot;s2&quot;&gt;历史价格：&lt;/p&gt;&lt;/b&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;&lt;p&gt;铱&lt;/p&gt;&lt;p id=&quot;c3&quot; style=&quot;color:#F00&quot;&gt;&lt;/p&gt;&lt;b&gt;&lt;p id=&quot;s3&quot;&gt;历史价格：&lt;/p&gt;&lt;/b&gt;&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;assets/js/jquery-1.9.1.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line"></span><br><span class="line">    function showPrice(index,data)&#123;</span><br><span class="line">        $(&quot;#c&quot;+index).html(&quot;当前价格：&quot;+data);</span><br><span class="line">        var s = $(&quot;#s&quot;+index).html();</span><br><span class="line">        $(&quot;#s&quot;+index).html(s+data+&quot; &quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//通过 EventSource 拿到 SSE 的相关对象</span><br><span class="line">    if(!!window.EventSource)&#123;</span><br><span class="line">        var source = new EventSource(&#x27;needPrice&#x27;);</span><br><span class="line">        //收到消息时的处理事件</span><br><span class="line">        source.onmessage=function (e) &#123;</span><br><span class="line">            var dataObj=e.data;</span><br><span class="line">            var arr = dataObj.split(&#x27;,&#x27;);</span><br><span class="line">            $.each(arr, function (i, item) &#123;</span><br><span class="line">                showPrice(i,item);</span><br><span class="line">                &#125;);</span><br><span class="line">            $(&quot;#hint&quot;).html(&quot;&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line">		//打开连接时的处理事件</span><br><span class="line">        source.onopen=function (e) &#123;</span><br><span class="line">            console.log(&quot;Connecting server!&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line">		//出现错误时的处理事件</span><br><span class="line">        source.onerror=function () &#123;</span><br><span class="line">            console.log(&quot;error&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        $(&quot;#hint&quot;).html(&quot;您的浏览器不支持SSE！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>第一种服务端的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NobleMetalController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(NobleMetalController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/nobleMetal&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">stock</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nobleMetal&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注意需要告诉浏览器发送的是事件流 text/event-stream</span></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/needPrice&quot;,produces=&quot;text/event-stream;charset=UTF-8&quot; )</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">push</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> makeResp(r);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//业务方法，生成贵金属的实时价格</span></span><br><span class="line">	<span class="comment">//凡是通过 SSE 发送到客户端的数据必须遵循一定的格式：[field]:value</span></span><br><span class="line">	<span class="comment">//field 有四种类型：data(数据，最后面需要加\n)、id、event、retry(表示多久可以重试)</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">makeResp</span><span class="params">(Random r)</span>&#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">&quot;retry:2000\n&quot;</span>)</span><br><span class="line">                .append(<span class="string">&quot;data:&quot;</span>)</span><br><span class="line">                .append(r.nextInt(<span class="number">100</span>)+<span class="number">50</span>+<span class="string">&quot;,&quot;</span>)</span><br><span class="line">                .append(r.nextInt(<span class="number">40</span>)+<span class="number">35</span>)</span><br><span class="line">                .append(<span class="string">&quot;\n\n&quot;</span>);	<span class="comment">//表示数据发送完毕</span></span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		但是经过测试发现还是会产生很多请求，因为 <code>return makeResp(r)</code> 会将结果交给 Tomcat，但是 Tomcat 接收到 return 后主动关闭 Http 连接，但是 retry 又会让这个请求自动重连，因此就会看到浏览器在不断向服务器发送新的请求。</p>
<p>第二种服务端的实现：通过 response 拿到输出流，使用输出流直接将数据写回浏览器客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NobleMetalController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(NobleMetalController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/nobleMetalr&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">stockr</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nobleMetalAlso&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;needPricer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pushRight</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/event-stream&quot;</span>);	<span class="comment">//必须配置</span></span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">pw</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(i&lt;<span class="number">10</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(pw.checkError())&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;客户端断开连接&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                pw.write(makeResp(r));</span><br><span class="line">                pw.flush();</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;达到阈值，结束发送.......&quot;</span>);</span><br><span class="line">            pw.write(<span class="string">&quot;data:stop\n\n&quot;</span>);</span><br><span class="line">            pw.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、<code>WebSocket 技术</code>。是 H5 的协议，适合于对数据的<code>实时性</code>要求比较强的场景，如通信、直播、共享桌面，特别适合于客户与服务频繁交互的情况下，如实时共享、多人协作等平台。SSE 基于现有的通信协议 Http 就能实现（只支持文本的传输），而 WebSocket 属于全新的服务器推送协议（<code>支持消息文本或二进制数据</code>），但也说明其后端需要单独实现，不能使用原来的统一模板，同时也不是所有浏览器都支持。</p>
<table>
<thead>
<tr>
<th align="center">比较项</th>
<th align="center">短轮询</th>
<th align="center">长轮询</th>
<th align="center">SSE</th>
<th align="center">WebSocket</th>
</tr>
</thead>
<tbody><tr>
<td align="center">浏览器支持度</td>
<td align="center">最高</td>
<td align="center">很高</td>
<td align="center">中(IE和Edge均不支持)</td>
<td align="center">中(早期的浏览器不支持)</td>
</tr>
<tr>
<td align="center">实时性</td>
<td align="center">最低</td>
<td align="center">较高</td>
<td align="center">很高</td>
<td align="center">很高</td>
</tr>
<tr>
<td align="center">代码实现复杂度</td>
<td align="center">最容易</td>
<td align="center">较容易</td>
<td align="center">容易</td>
<td align="center">最复杂</td>
</tr>
<tr>
<td align="center">连接性质</td>
<td align="center">短连接</td>
<td align="center">长连接</td>
<td align="center">长连接</td>
<td align="center">长连接</td>
</tr>
<tr>
<td align="center">适用</td>
<td align="center">需要服务极大量或极小量的用户，实时性要求不高</td>
<td align="center">准实时性的应用，比较关注浏览器的兼容性</td>
<td align="center">实时，基本都是<code>文本交互</code>的应用</td>
<td align="center">实时，需要支持<code>多样化的用户数据类型</code>的应用或者是原生程序</td>
</tr>
</tbody></table>
<h2 id="WebSocket-概述"><a href="#WebSocket-概述" class="headerlink" title="WebSocket 概述"></a>WebSocket 概述</h2><p>​		WebSocket 本身是一个 TCP 连接，建立后的连接是 <code>全双工</code> 的，客户端和服务端都能向对端发送请求，需要先借助 Http 协议来完成一部分 <code>握手（应用层的握手）</code>，是为了确认客户端和服务端支持 WebSocket 的程度，然后才会升级成 WebSocket 协议。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6336e94a16f2c2beb1baa143.png"></p>
<p><code>[理论]</code> WebSocket 建立的握手过程。</p>
<p>​		当决定升级成 WebSocket 协议时，客户端发送给服务端的报文会包括：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Connection：Upgrade	# 表示现在决定升级，升级到什么则由 Upgrade 字段决定</span><br><span class="line">Upgrade：websocket</span><br><span class="line">Sec-WebSocket-Version：13		# 升级到 websocket 的哪个版本，常用 13 版本</span><br><span class="line">Sec-WebSocket-Key：xxxxxxxxx		# 加密运算的随机字符串 ssh 摘要</span><br><span class="line">Sec-WebSocket-Extensions：xxx	</span><br></pre></td></tr></table></figure>

<p>​		当服务端收到这个请求报文后，服务端也会在响应报文携带参数，然后将密文数据进行处理发送给客户端。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Connection：Upgrade</span><br><span class="line">Upgrade：websocket</span><br><span class="line">Sec-WebSocket-Accept：xxxxxxxxx</span><br><span class="line">Sec-WebSocket-Extensions：xxx</span><br></pre></td></tr></table></figure>

<p>​		此时客户端和服务端的握手就完成了，后面的客户端和服务端的通信就全部使用 websocket 协议来进行。</p>
<p><code>[理论]</code> WebSocket 是个规范，在实际的实现中有 HTML5 规范中的 <code>WebSocket API（原生）</code> 和 WebSocket 的子协议 <code>STOMP</code>。</p>
<p><code>[实现]</code>  STOMP 在 Spring 中的实现：基于 STOMP 协议在 SpringBoot 项目中实现网页版的聊天室。</p>
<p>​		STOMP：也就是简单（流）文本定向消息协议。STOMP 协议的前身是专为消息中间件设计的 <code>TTMP</code> 协议（一个简单的基于文本的协议），是属于消息队列的一种协议，和 AMQP 和 JMS 等平级。STOMP 的简单性恰巧可以用于定义 websocket 的消息体格式，STOMP 协议很多 MQ 都已支持，如 RabbitMq 等。类似于消息队列， STOMP 中也有生产者和消费者的概念。<code>STOMP 是基于帧的协议</code> </p>
<blockquote>
<p>如果需要使用 STOMP，那么浏览器前端页面需要引入 Js 文件：<code>sockjs.min.js</code>、<code>stomp.min.js</code> 和 <code>jquery.js</code>。</p>
</blockquote>
<p>​	实现思路：首先需要建立连接，服务端需要一个类似地址的地方（<code>EndPoint</code>）接受连接。进而浏览器订阅消息，单聊和群聊订阅不同消息。然后客户端向服务端发送请求，Spring 后端使用 <code>@MessageMapping</code> 注解来接受 WebSocket 请求，请求的处理结果再交给 <code>消息代理</code>，消息代理根据不同订阅发送给各个客户端。</p>
<p>0）Pom 文件引入 lombok、thymeleaf 和 websocket 依赖。</p>
<p>1）Html 页面，引入三个 Js 文件，绘制基本的页面样式。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;aplus-terminal&quot;</span> <span class="attr">content</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;apple-mobile-web-app-title&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;apple-mobile-web-app-capable&quot;</span> <span class="attr">content</span>=<span class="string">&quot;yes&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;apple-mobile-web-app-status-bar-style&quot;</span> <span class="attr">content</span>=<span class="string">&quot;black-translucent&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;format-detection&quot;</span> <span class="attr">content</span>=<span class="string">&quot;telephone=no, address=no&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>聊天<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* css 样式（省略）*/</span></span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:left;width:47%&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>请选择你是谁：</span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectName&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;stompQueue();&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Mark&quot;</span>&gt;</span>Mark<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;James&quot;</span>&gt;</span>James<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Lison&quot;</span>&gt;</span>Lison<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Peter&quot;</span>&gt;</span>Peter<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;King&quot;</span>&gt;</span>King<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chatWindow&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;color:darkgrey&quot;</span>&gt;</span>群聊：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;chatRecord1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;chatRecord&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mass_div&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mobile-page&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;sendWindow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;sendChatValue&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendChatValue&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sendChatValue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sendMessage&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendMassMessage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sendMessage&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;sendMassMessage()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发送&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:right; width:47%&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>请选择你要发给谁：</span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectName2&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Mark&quot;</span>&gt;</span>Mark<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;James&quot;</span>&gt;</span>James<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Lison&quot;</span>&gt;</span>Lison<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Peter&quot;</span>&gt;</span>Peter<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;King&quot;</span>&gt;</span>King<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chatWindow&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;color:darkgrey&quot;</span>&gt;</span>单聊：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;chatRecord2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;chatRecord&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;alone_div&quot;</span>  <span class="attr">class</span>=<span class="string">&quot;mobile-page&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;sendWindow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;sendChatValue2&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendChatValue2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sendChatValue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;sendMessage&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendAloneMessage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sendMessage&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;sendAloneMessage()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发送&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 独立JS --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;sockjs.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;stomp.min.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;jquery.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;wechat_room.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>​	其中引入的 wechat_room.js 内容为，用于实现前端逻辑。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> stompClient = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//加载完浏览器后调用 connect（），打开通道</span></span><br><span class="line">$(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">connect</span>();	<span class="comment">//打开双通道</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//强制关闭浏览器时调用 websocket.close（）,进行正常关闭</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onunload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(stompClient != <span class="literal">null</span>) &#123;</span><br><span class="line">        stompClient.<span class="title function_">disconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Disconnected ......&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开通道，建立连接</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">connect</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> socket = <span class="keyword">new</span> <span class="title class_">SockJS</span>(<span class="string">&#x27;/endpointMark&#x27;</span>); 		 <span class="comment">// 指明连接 SockJS 的 endpoint 名称为 &quot;endpointMark&quot;</span></span><br><span class="line">    stompClient = <span class="title class_">Stomp</span>.<span class="title function_">over</span>(socket);				<span class="comment">// 获取 STMOP 子协议的 WebSocket 客户端</span></span><br><span class="line">    stompClient.<span class="title function_">connect</span>(&#123;&#125;,<span class="keyword">function</span>(<span class="params">frame</span>)&#123;			<span class="comment">// 使用客户端连接 WebSocket 服务端</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Connected:&#x27;</span> + frame);</span><br><span class="line">        <span class="title function_">stompTopic</span>();		<span class="comment">//订阅接收广播信息</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//广播消息的订阅接收消息（一对多）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stompTopic</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//通过 stompClient.subscribe 订阅目标(destination)发送的消息（接收广播信息）</span></span><br><span class="line">    stompClient.<span class="title function_">subscribe</span>(<span class="string">&#x27;/mass/getResponse&#x27;</span>,<span class="keyword">function</span>(<span class="params">response</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> message=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">body</span>);</span><br><span class="line">        <span class="comment">// 展示广播的接收的内容接收：前端操作将文本显示到页面上</span></span><br><span class="line">        <span class="keyword">var</span> response = $(<span class="string">&quot;#mass_div&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> userName=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">        <span class="keyword">if</span>(userName==message.<span class="property">name</span>)&#123;</span><br><span class="line">            response.<span class="title function_">append</span>(<span class="string">&quot;&lt;div class=&#x27;user-group&#x27;&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;div class=&#x27;user-msg&#x27;&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;span class=&#x27;user-reply&#x27;&gt;&quot;</span>+message.<span class="property">chatValue</span>+<span class="string">&quot;&lt;/span&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &lt;i class=&#x27;triangle-user&#x27;&gt;&lt;/i&gt;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;          &lt;/div&gt;&quot;</span> +userName+</span><br><span class="line">                <span class="string">&quot;     &lt;/div&gt;&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            response.<span class="title function_">append</span>(<span class="string">&quot;     &lt;div class=&#x27;admin-group&#x27;&gt;&quot;</span>+</span><br><span class="line">                message.<span class="property">name</span>+</span><br><span class="line">                <span class="string">&quot;&lt;div class=&#x27;admin-msg&#x27;&gt;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;    &lt;i class=&#x27;triangle-admin&#x27;&gt;&lt;/i&gt;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;    &lt;span class=&#x27;admin-reply&#x27;&gt;&quot;</span>+message.<span class="property">chatValue</span>+<span class="string">&quot;&lt;/span&gt;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&lt;/div&gt;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&lt;/div&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//群发消息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendMassMessage</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> postValue=&#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> chatValue=$(<span class="string">&quot;#sendChatValue&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> userName=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    postValue.<span class="property">name</span>=userName;</span><br><span class="line">    postValue.<span class="property">chatValue</span>=chatValue.<span class="title function_">val</span>();</span><br><span class="line">    <span class="comment">//postValue.userId=&quot;0&quot;;</span></span><br><span class="line">    <span class="keyword">if</span>(userName==<span class="number">1</span>||userName==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择你是谁！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(chatValue==<span class="string">&quot;&quot;</span>||userName==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;不能发送空消息！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    stompClient.<span class="title function_">send</span>(<span class="string">&quot;/massRequest&quot;</span>,&#123;&#125;,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(postValue));</span><br><span class="line">    chatValue.<span class="title function_">val</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//单独发送消息</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sendAloneMessage</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> postValue=&#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> chatValue=$(<span class="string">&quot;#sendChatValue2&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> userName=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> sendToId=$(<span class="string">&quot;#selectName2&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> response = $(<span class="string">&quot;#alone_div&quot;</span>);</span><br><span class="line">    postValue.<span class="property">name</span>=userName;	<span class="comment">//发送者姓名</span></span><br><span class="line">    postValue.<span class="property">chatValue</span>=chatValue.<span class="title function_">val</span>();	<span class="comment">//聊天内容</span></span><br><span class="line">    postValue.<span class="property">userId</span>=sendToId;	<span class="comment">//发送给谁</span></span><br><span class="line">    <span class="keyword">if</span>(userName==<span class="number">1</span>||userName==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择你是谁！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(sendToId==<span class="number">1</span>||sendToId==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;请选择你要发给谁！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(chatValue==<span class="string">&quot;&quot;</span>||userName==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&quot;不能发送空消息！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//发送请求 aloneRequest</span></span><br><span class="line">    stompClient.<span class="title function_">send</span>(<span class="string">&quot;/aloneRequest&quot;</span>,&#123;&#125;,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(postValue));</span><br><span class="line">    response.<span class="title function_">append</span>(<span class="string">&quot;&lt;div class=&#x27;user-group&#x27;&gt;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;          &lt;div class=&#x27;user-msg&#x27;&gt;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;                &lt;span class=&#x27;user-reply&#x27;&gt;&quot;</span>+chatValue.<span class="title function_">val</span>()+<span class="string">&quot;&lt;/span&gt;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;                &lt;i class=&#x27;triangle-user&#x27;&gt;&lt;/i&gt;&quot;</span> +</span><br><span class="line">        <span class="string">&quot;          &lt;/div&gt;&quot;</span> +userName+</span><br><span class="line">        <span class="string">&quot;     &lt;/div&gt;&quot;</span>);</span><br><span class="line">    chatValue.<span class="title function_">val</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//单独消息的订阅（1对1）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stompQueue</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> userId=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="comment">// 通过 stompClient.subscribe 订阅目标(destination)发送的消息（队列接收信息）</span></span><br><span class="line">    stompClient.<span class="title function_">subscribe</span>(<span class="string">&#x27;/user/&#x27;</span> + userId + <span class="string">&#x27;/alone&#x27;</span>,</span><br><span class="line">        <span class="keyword">function</span>(<span class="params">response</span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> message=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">body</span>);</span><br><span class="line">        <span class="comment">// 展示一对一的接收的内容接收</span></span><br><span class="line">        <span class="keyword">var</span> response = $(<span class="string">&quot;#alone_div&quot;</span>);</span><br><span class="line">        response.<span class="title function_">append</span>(<span class="string">&quot;     &lt;div class=&#x27;admin-group&#x27;&gt;&quot;</span>+</span><br><span class="line">            message.<span class="property">name</span>+</span><br><span class="line">            <span class="string">&quot;&lt;div class=&#x27;admin-msg&#x27;&gt;&quot;</span>+</span><br><span class="line">            <span class="string">&quot;    &lt;i class=&#x27;triangle-admin&#x27;&gt;&lt;/i&gt;&quot;</span>+</span><br><span class="line">            <span class="string">&quot;    &lt;span class=&#x27;admin-reply&#x27;&gt;&quot;</span>+message.<span class="property">chatValue</span>+<span class="string">&quot;&lt;/span&gt;&quot;</span>+</span><br><span class="line">            <span class="string">&quot;&lt;/div&gt;&quot;</span>+</span><br><span class="line">            <span class="string">&quot;&lt;/div&gt;&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务端定义一个请求的实体类和一个响应的实体类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRoomRequest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;    <span class="comment">//发送者姓名</span></span><br><span class="line">    <span class="keyword">private</span> String chatValue;   <span class="comment">//发送内容</span></span><br><span class="line">    <span class="keyword">private</span> String userId;  <span class="comment">//发送者id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRoomResponse</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;    <span class="comment">//接收者姓名</span></span><br><span class="line">    <span class="keyword">private</span> String chatValue;   <span class="comment">//具体的内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>webmvc 配置信息：<code>WebMvcConfig</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//设置 Thymeleaf 视图跳转到 wechat_room.html 页面</span></span><br><span class="line">        registry.addViewController(<span class="string">&quot;/chatroom&quot;</span>).setViewName(<span class="string">&quot;/wechat_room&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebSocket 的配置类：<code>WebSocketConfig</code> 配置请求入口和跨域，注册消息代理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span>    <span class="comment">//开启WebSocket支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketMessageBrokerConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册一个 EndPoint 用于接收请求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//注册STOMP协议的节点(endpoint),并映射指定的url,添加一个访问端点 “/endpointMark”,客户端打开双通道时需要的url。</span></span><br><span class="line">        registry.addEndpoint(<span class="string">&quot;/endpointMark&quot;</span>)   <span class="comment">//添加访问节点</span></span><br><span class="line">                <span class="comment">//.setAllowedOrigins(&quot;*&quot;)</span></span><br><span class="line">                .setAllowedOriginPatterns(<span class="string">&quot;*&quot;</span>)     <span class="comment">//设置允许所有的域名跨域访问</span></span><br><span class="line">                .withSockJS();      <span class="comment">//指定使用 SockJS 协议</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册消息代理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//相当于代理哪些主题</span></span><br><span class="line">        registry.enableSimpleBroker(<span class="string">&quot;/mass&quot;</span>, <span class="string">&quot;/user&quot;</span>);</span><br><span class="line">        registry.setUserDestinationPrefix(<span class="string">&quot;/user/&quot;</span>);     <span class="comment">//配置单聊消息主题请求的前缀</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端服务器的接收请求并进行处理，分别对单聊和群聊的请求进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StompController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SimpMessagingTemplate template;     <span class="comment">// Spring实现的一个发送模板类</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息群发，接受发送至自 massRequest 的请求</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/massRequest&quot;)</span></span><br><span class="line">    <span class="meta">@SendTo(&quot;/mass/getResponse&quot;)</span>     <span class="comment">//表示群聊消息需要发送到订阅 /mass/getResponse 的位置</span></span><br><span class="line">    <span class="keyword">public</span> ChatRoomResponse <span class="title function_">mass</span><span class="params">(ChatRoomRequest chatRoomRequest)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;name = &quot;</span> + chatRoomRequest.getName());  <span class="comment">//发送给谁</span></span><br><span class="line">        System.out.println(<span class="string">&quot;chatValue = &quot;</span> + chatRoomRequest.getChatValue());    <span class="comment">//发送内容</span></span><br><span class="line">        <span class="type">ChatRoomResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatRoomResponse</span>();     <span class="comment">//封装一个响应给前端</span></span><br><span class="line">        response.setName(chatRoomRequest.getName());</span><br><span class="line">        response.setChatValue(chatRoomRequest.getChatValue());</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单独聊天，接受发送至自 aloneRequest 的请求</span></span><br><span class="line">    <span class="meta">@MessageMapping(&quot;/aloneRequest&quot;)</span></span><br><span class="line">    <span class="comment">// @SendToUser 往往需要和安全模式结合，此处不使用</span></span><br><span class="line">    <span class="keyword">public</span> ChatRoomResponse <span class="title function_">alone</span><span class="params">(ChatRoomRequest chatRoomRequest)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SendToUser = &quot;</span> + chatRoomRequest.getUserId()    <span class="comment">//发送给谁</span></span><br><span class="line">                +<span class="string">&quot; FromName = &quot;</span> + chatRoomRequest.getName()     <span class="comment">//从哪里发送过来</span></span><br><span class="line">                +<span class="string">&quot; ChatValue = &quot;</span> + chatRoomRequest.getChatValue());     <span class="comment">//发送内容</span></span><br><span class="line">        <span class="type">ChatRoomResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChatRoomResponse</span>();</span><br><span class="line">        response.setName(chatRoomRequest.getName());</span><br><span class="line">        response.setChatValue(chatRoomRequest.getChatValue());</span><br><span class="line">        <span class="comment">//使用 SimpMessagingTemplate 来发送消息：拼装出 /user/userId/alone</span></span><br><span class="line">        <span class="built_in">this</span>.template.convertAndSendToUser(chatRoomRequest.getUserId()+<span class="string">&quot;&quot;</span>, <span class="string">&quot;/alone&quot;</span>, response);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		启动 SpringBoot 的启动类，打开三个浏览器窗口，访问 <code>http://localhost:8080/chatroom</code> 进入聊天页面，此时进行聊天测试，测试过程中观察请求 <code>websocket</code> 的请求头和响应信息，寻找发现 Connection 字段确实是 <code>Upgrade</code>，版本号也是 13 表示升级，另外几个字段也能成功看到。</p>
<p><code>[实现]</code> 实现基于原生 WebSocket 的 API 的网页群聊聊天室应用。</p>
<p>1）使用原生的 WebSocket 前端页面只需要引入 <code>jquery.js</code> 简化 Js 操作即可，同时前端页面也需要进行修改。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;aplus-terminal&quot;</span> <span class="attr">content</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;apple-mobile-web-app-title&quot;</span> <span class="attr">content</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;apple-mobile-web-app-capable&quot;</span> <span class="attr">content</span>=<span class="string">&quot;yes&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;apple-mobile-web-app-status-bar-style&quot;</span> <span class="attr">content</span>=<span class="string">&quot;black-translucent&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">fromName</span>=<span class="string">&quot;format-detection&quot;</span> <span class="attr">content</span>=<span class="string">&quot;telephone=no, address=no&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket原生API实现微信聊天<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="comment">/* css 样式 */</span></span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;float:left;width:99%&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>请选择你是谁：</span><br><span class="line">        <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectName&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;changeUser();&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Mark&quot;</span>&gt;</span>Mark<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;James&quot;</span>&gt;</span>James<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Lison&quot;</span>&gt;</span>Lison<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;Peter&quot;</span>&gt;</span>Peter<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;King&quot;</span>&gt;</span>King<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;chatWindow&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;color:darkgrey&quot;</span>&gt;</span>群聊：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;chatRecord1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;chatRecord&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;mass_div&quot;</span> <span class="attr">class</span>=<span class="string">&quot;mobile-page&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;sendWindow&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">fromName</span>=<span class="string">&quot;sendChatValue&quot;</span> <span class="attr">id</span>=<span class="string">&quot;sendChatValue&quot;</span></span></span><br><span class="line"><span class="tag">                          <span class="attr">class</span>=<span class="string">&quot;sendChatValue&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">fromName</span>=<span class="string">&quot;sendMessage&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">id</span>=<span class="string">&quot;sendMassMessage&quot;</span> <span class="attr">class</span>=<span class="string">&quot;sendMessage&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">onclick</span>=<span class="string">&quot;sendMassMessage()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发送&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;jquery.js&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (<span class="keyword">typeof</span> (<span class="title class_">WebSocket</span>) == <span class="string">&quot;undefined&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;遗憾：您的浏览器不支持WebSocket&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;恭喜：您的浏览器支持WebSocket&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//群发消息</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">sendMassMessage</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> userName=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(userName==<span class="number">1</span>||userName==<span class="literal">null</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;请选择你是谁！&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> chatValue=$(<span class="string">&quot;#sendChatValue&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(chatValue==<span class="string">&quot;&quot;</span>||userName==<span class="literal">null</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;不能发送空消息！&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        socket.<span class="title function_">send</span>(chatValue.<span class="title function_">val</span>());</span></span><br><span class="line"><span class="language-javascript">        chatValue.<span class="title function_">val</span>(<span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">changeUser</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (socket!=<span class="literal">null</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> toUserId=$(<span class="string">&quot;#selectName&quot;</span>).<span class="title function_">val</span>();</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(toUserId==<span class="number">1</span>||toUserId==<span class="literal">null</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//指定要连接的服务器地址与端口建立连接</span></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//ws对应http、wss对应https。</span></span></span><br><span class="line"><span class="language-javascript">        socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080/ws/asset?toUserId=&quot;</span>+toUserId);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//连接打开事件</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Socket 已打开&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//收到消息事件</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">msg</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//展示广播的接收的内容接收</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> response = $(<span class="string">&quot;#mass_div&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> dataObj=msg.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> arr = dataObj.<span class="title function_">split</span>(<span class="string">&#x27;@^&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> sendUser;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> acceptMsg;</span></span><br><span class="line"><span class="language-javascript">            $.<span class="title function_">each</span>(arr, <span class="keyword">function</span> (<span class="params">i, item</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(i==<span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                    sendUser = item;</span></span><br><span class="line"><span class="language-javascript">                &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    acceptMsg = item;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(toUserId==sendUser)&#123;</span></span><br><span class="line"><span class="language-javascript">                response.<span class="title function_">append</span>(<span class="string">&quot;&lt;div class=&#x27;user-group&#x27;&gt;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;          &lt;div class=&#x27;user-msg&#x27;&gt;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;                &lt;span class=&#x27;user-reply&#x27;&gt;&quot;</span>+acceptMsg+<span class="string">&quot;&lt;/span&gt;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;                &lt;i class=&#x27;triangle-user&#x27;&gt;&lt;/i&gt;&quot;</span> +</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;          &lt;/div&gt;&quot;</span> +toUserId+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;     &lt;/div&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                response.<span class="title function_">append</span>(<span class="string">&quot;     &lt;div class=&#x27;admin-group&#x27;&gt;&quot;</span>+</span></span><br><span class="line"><span class="language-javascript">                    sendUser+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;&lt;div class=&#x27;admin-msg&#x27;&gt;&quot;</span>+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;    &lt;i class=&#x27;triangle-admin&#x27;&gt;&lt;/i&gt;&quot;</span>+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;    &lt;span class=&#x27;admin-reply&#x27;&gt;&quot;</span>+acceptMsg+<span class="string">&quot;&lt;/span&gt;&quot;</span>+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;&lt;/div&gt;&quot;</span>+</span></span><br><span class="line"><span class="language-javascript">                    <span class="string">&quot;&lt;/div&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//连接关闭事件</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Socket已关闭&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//发生了错误事件</span></span></span><br><span class="line"><span class="language-javascript">        socket.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;Socket发生了错误&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//窗口关闭时，关闭连接</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">unload</span>=<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            socket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）配置 webmvc 的视图跳转控制。</p>
<p>3）配置 WebSocket 的数据监视组件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line"><span class="meta">@ServerEndpoint(value = &quot;/ws/asset&quot;)</span>    <span class="comment">//将此类定义成一个 WebSocket 服务器端，同时设置访问地址</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(WebSocketServer.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">onlineCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);  <span class="comment">// 统计在线用户数</span></span><br><span class="line">    <span class="comment">// 线程安全Set，用来存放每个浏览器客户端对应的 Session 对象。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArraySet&lt;Session&gt; sessionSet = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;Session&gt;();</span><br><span class="line">    <span class="comment">// 线程安全Map，用来存放每个浏览器客户端 sessionId 和用户名的对应关系。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String,String&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span>     <span class="comment">//连接建立成功调用的方法,需要将用户信息放入本地缓存</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        <span class="comment">//将用户session，session和用户名对应关系放入本地缓存</span></span><br><span class="line">        sessionSet.add(session);</span><br><span class="line">        <span class="comment">//从 session 中获取请求信息</span></span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; pathParameters = session.getRequestParameterMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> pathParameters.get(<span class="string">&quot;toUserId&quot;</span>).get(<span class="number">0</span>);</span><br><span class="line">        sessionMap.put(session.getId(),userId);     <span class="comment">//sessionId 和用户名对应关系存储</span></span><br><span class="line">        log.info(<span class="string">&quot;有连接加入，当前连接数为：&#123;&#125;&quot;</span>, onlineCount.incrementAndGet());     <span class="comment">//在线用户数增加</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//群发：通知所有用户有新用户上线</span></span><br><span class="line">            broadCastInfo(<span class="string">&quot;系统消息@^用户[&quot;</span>+userId+<span class="string">&quot;]加入群聊。&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span>    <span class="comment">//连接关闭调用的方法,需要将用户信息从本地缓存移除</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        <span class="comment">//将用户session，session和用户名对应关系从本地缓存移除</span></span><br><span class="line">        sessionSet.remove(session);</span><br><span class="line">        Map&lt;String, List&lt;String&gt;&gt; pathParameters = session.getRequestParameterMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> sessionMap.get(session.getId());</span><br><span class="line">        sessionMap.remove(session.getId());</span><br><span class="line">        <span class="type">int</span> <span class="variable">cnt</span> <span class="operator">=</span> onlineCount.decrementAndGet();    <span class="comment">//在线用户数减少</span></span><br><span class="line">        log.info(<span class="string">&quot;有连接关闭，当前连接数为：&#123;&#125;&quot;</span>, cnt);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//群发：通知所有用户有用户下线</span></span><br><span class="line">            broadCastInfo(<span class="string">&quot;系统消息@^用户[&quot;</span>+userId+<span class="string">&quot;]退出群聊。&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span>      <span class="comment">//收到客户端消息后调用的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;来自客户端&#123;&#125;的消息：&#123;&#125;&quot;</span>, sessionMap.get(session.getId()),message);</span><br><span class="line">        <span class="keyword">if</span>(message.startsWith(<span class="string">&quot;ToUser:&quot;</span>))&#123;</span><br><span class="line">            <span class="comment">//这里可以实现一对一聊天 sendMessageAlone();</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//实现群聊</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msger</span> <span class="operator">=</span> sessionMap.get(session.getId());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                broadCastInfo(msger+<span class="string">&quot;@^&quot;</span>+message);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span>      <span class="comment">//出现错误时的处理</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        log.error(<span class="string">&quot;发生错误：&#123;&#125;，Session ID： &#123;&#125;&quot;</span>, error.getMessage(), session.getId());</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//发送消息的基础方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">basicSendMessage</span><span class="params">(Session session, String message)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            session.getBasicRemote().sendText(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;发送消息出错：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//群发消息:实际就是遍历所有用户都发送一遍</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">broadCastInfo</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">for</span> (Session session : sessionSet) &#123;</span><br><span class="line">            <span class="keyword">if</span>(session.isOpen())&#123;</span><br><span class="line">                basicSendMessage(session, message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定 Session 发送消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendMessageAlone</span><span class="params">(String sessionId, String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Session s : sessionSet) &#123;</span><br><span class="line">            <span class="keyword">if</span>(s.getId().equals(sessionId))&#123;</span><br><span class="line">                session = s;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(session!=<span class="literal">null</span>)&#123;</span><br><span class="line">            basicSendMessage(session, message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            log.warn(<span class="string">&quot;没有找到你指定ID的会话：&#123;&#125;&quot;</span>, sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		启动主启动类，发现一样实现群聊聊天室的功能。</p>
<p><code>[实现]</code>  Netty 官方提供的基于 Netty 实现的 WebSocket 范例服务端部分，客户端使用浏览器。</p>
<p>​		WebSocket 的定义实际上是比较复杂的，其定义了<code>数据帧</code>的概念，包括二进制数据帧、文本类型数据帧、关闭连接请求数据帧、心跳有关的ping 和 pong 帧、续传的帧这六种，Netty 对这六种数据帧都有对应的实现，并且提供了对应的 handler 实现。</p>
<p>1）服务端的启动类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="comment">//Netty 提供的所有和客户端通信的集合 DefaultChannelGroup，用来保存所有已经连接的 WebSocket Channel，群发和一对一功能可以用上</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">ChannelGroup</span> <span class="variable">channelGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelGroup</span>(ImmediateEventExecutor.INSTANCE);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">SSL</span> <span class="operator">=</span> <span class="literal">false</span>;   <span class="comment">//是否启用ssl</span></span><br><span class="line">    <span class="comment">// 通过ssl访问端口为 8443，否则为 8080</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> Integer.parseInt(System.getProperty(<span class="string">&quot;port&quot;</span>, SSL? <span class="string">&quot;8443&quot;</span> : <span class="string">&quot;8080&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// SSL 配置</span></span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line">        <span class="keyword">if</span> (SSL) &#123;</span><br><span class="line">            <span class="type">SelfSignedCertificate</span> <span class="variable">ssc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SelfSignedCertificate</span>();</span><br><span class="line">            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sslCtx = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    <span class="comment">//服务端的 handler 的实现：就应该处理 websocket 所有相关的报文</span></span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">WebSocketServerInitializer</span>(channelGroup, sslCtx));</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> b.bind(PORT).sync().channel();     <span class="comment">//服务端监听本地端口</span></span><br><span class="line">            System.out.println(<span class="string">&quot;打开浏览器访问： &quot;</span> + (SSL? <span class="string">&quot;https&quot;</span> : <span class="string">&quot;http&quot;</span>) + <span class="string">&quot;://127.0.0.1:&quot;</span> + PORT + <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">            ch.closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）服务端的 handler 的装配，需要注意 WebSocket 升级前需要利用 HTTP 进行握手。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义服务端需要用到的所有 handler，利用 http 建立连接，后面用来处理 websocket 所有相关报文</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServerInitializer</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WEBSOCKET_PATH</span> <span class="operator">=</span> <span class="string">&quot;/websocket&quot;</span>;  <span class="comment">//websocket 访问路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelGroup group;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSocketServerInitializer</span><span class="params">(ChannelGroup group, SslContext sslCtx)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.group = group;</span><br><span class="line">        <span class="built_in">this</span>.sslCtx = sslCtx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">        <span class="keyword">if</span> (sslCtx != <span class="literal">null</span>) &#123;</span><br><span class="line">            pipeline.addLast(sslCtx.newHandler(ch.alloc()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//利用 http 建立连接需要使用的 http 的 handler：编解码器和聚合器</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>());    <span class="comment">//对 http 请求报文作入站处理，对 http 响应报文作出站处理</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">65536</span>));  <span class="comment">//聚合器</span></span><br><span class="line">        <span class="comment">// 提供对 WebSocket 数据的压缩传输</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerCompressionHandler</span>());</span><br><span class="line">        <span class="comment">//对 WebSocket 的支持，当握手成功后会触发 pipeline 中用户自定义事件</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerProtocolHandler</span>(WEBSOCKET_PATH, <span class="literal">null</span>,<span class="literal">true</span>));</span><br><span class="line">        <span class="comment">//浏览器客户端访问的时候展示 index 页面:提供发送消息和接收消息的可视化显示(页面采用后端生成直接写往浏览器)</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ProcessWsIndexPageHandler</span>(WEBSOCKET_PATH));</span><br><span class="line">        <span class="comment">//对 WebSocket 的数据进行处理：群发的支持</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ProcessWsFrameHandler</span>(group));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）生成浏览器页面的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MakeIndexPage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NEWLINE</span> <span class="operator">=</span> <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ByteBuf <span class="title function_">getContent</span><span class="params">(String webSocketLocation)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Unpooled.copiedBuffer(</span><br><span class="line">                <span class="string">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Web Socket Test&lt;/title&gt;&lt;/head&gt;&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;body&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;var socket;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;if (!window.WebSocket) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  window.WebSocket = window.MozWebSocket;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&#x27;&#125;&#x27;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;if (window.WebSocket) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  socket = new WebSocket(\&quot;&quot;</span> + webSocketLocation + <span class="string">&quot;\&quot;);&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  socket.onmessage = function(event) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    var ta = document.getElementById(&#x27;responseText&#x27;);&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    ta.value = ta.value + &#x27;\\n&#x27; + event.data&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  &#125;;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  socket.onopen = function(event) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    var ta = document.getElementById(&#x27;responseText&#x27;);&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    ta.value = \&quot;Web Socket opened!\&quot;;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  &#125;;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  socket.onclose = function(event) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    var ta = document.getElementById(&#x27;responseText&#x27;);&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    ta.value = ta.value + \&quot;Web Socket closed\&quot;; &quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  &#125;;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&#125; else &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  alert(\&quot;Your browser does not support Web Socket.\&quot;);&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&#x27;&#125;&#x27;</span> + NEWLINE +</span><br><span class="line">                        NEWLINE +</span><br><span class="line">                        <span class="string">&quot;function send(message) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  if (!window.WebSocket) &#123; return; &#125;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  if (socket.readyState == WebSocket.OPEN) &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    socket.send(message);&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  &#125; else &#123;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;    alert(\&quot;The socket is not open.\&quot;);&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;  &#125;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&#x27;&#125;&#x27;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;/script&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;form onsubmit=\&quot;return false;\&quot;&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;input type=\&quot;text\&quot; name=\&quot;message\&quot; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;value=\&quot;Hello, World!\&quot;/&gt;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&lt;input type=\&quot;button\&quot; value=\&quot;Send Web Socket Data\&quot;&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;       onclick=\&quot;send(this.form.message.value)\&quot; /&gt;&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;h3&gt;Output&lt;/h3&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;textarea id=\&quot;responseText\&quot; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;style=\&quot;width:500px;height:300px;\&quot;&gt;&lt;/textarea&gt;&quot;</span></span><br><span class="line">                        + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;/form&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;/body&gt;&quot;</span> + NEWLINE +</span><br><span class="line">                        <span class="string">&quot;&lt;/html&gt;&quot;</span> + NEWLINE, CharsetUtil.US_ASCII);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）对 http 请求，将 index 的页面返回给前端的处理器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对http请求，将index的页面返回给前端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessWsIndexPageHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String websocketPath;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProcessWsIndexPageHandler</span><span class="params">(String websocketPath)</span> &#123; <span class="built_in">this</span>.websocketPath = websocketPath; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest req)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 处理错误或者无法解析的http请求</span></span><br><span class="line">        <span class="keyword">if</span> (!req.decoderResult().isSuccess()) &#123;</span><br><span class="line">            sendHttpResponse(ctx, req, <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, BAD_REQUEST));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只允许Get请求</span></span><br><span class="line">        <span class="keyword">if</span> (req.method() != GET) &#123;</span><br><span class="line">            sendHttpResponse(ctx, req, <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, FORBIDDEN));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送index页面的内容</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;/&quot;</span>.equals(req.uri()) || <span class="string">&quot;/index.html&quot;</span>.equals(req.uri())) &#123;</span><br><span class="line">            <span class="comment">//生成WebSocket的访问地址，写入index页面中</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">webSocketLocation</span> <span class="operator">=</span> getWebSocketLocation(ctx.pipeline(), req, websocketPath);</span><br><span class="line">            System.out.println(<span class="string">&quot;WebSocketLocation:[&quot;</span>+webSocketLocation+<span class="string">&quot;]&quot;</span>);</span><br><span class="line">            <span class="comment">//生成index页面的具体内容,并送往浏览器</span></span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> MakeIndexPage.getContent(webSocketLocation);</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">res</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, OK, content);</span><br><span class="line">            res.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            HttpUtil.setContentLength(res, content.readableBytes());</span><br><span class="line">            sendHttpResponse(ctx, req, res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendHttpResponse(ctx, req, <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HTTP_1_1, NOT_FOUND));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*发送应答*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sendHttpResponse</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest req, FullHttpResponse res)</span> &#123;</span><br><span class="line">        <span class="comment">// 错误的请求进行处理 （code&lt;&gt;200).</span></span><br><span class="line">        <span class="keyword">if</span> (res.status().code() != <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> Unpooled.copiedBuffer(res.status().toString(), StandardCharsets.UTF_8);</span><br><span class="line">            res.content().writeBytes(buf);</span><br><span class="line">            buf.release();</span><br><span class="line">            HttpUtil.setContentLength(res, res.content().readableBytes());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送应答.</span></span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> ctx.channel().writeAndFlush(res);</span><br><span class="line">        <span class="comment">//对于不是长连接或者错误的请求直接关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> (!HttpUtil.isKeepAlive(req) || res.status().code() != <span class="number">200</span>) &#123;</span><br><span class="line">            f.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*根据用户的访问，告诉用户的浏览器，WebSocket的访问地址*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getWebSocketLocation</span><span class="params">(ChannelPipeline cp, HttpRequest req, String path)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> <span class="string">&quot;ws&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (cp.get(SslHandler.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            protocol = <span class="string">&quot;wss&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> protocol + <span class="string">&quot;://&quot;</span> + req.headers().get(HttpHeaderNames.HOST)</span><br><span class="line">                + path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）WebSocket 的数据处理的核心 handler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//由于这是最后一个 handler，实现对数据的处理，继承 SimpleChannelInboundHandler 更方便</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessWsFrameHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;WebSocketFrame&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelGroup group;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ProcessWsFrameHandler</span><span class="params">(ChannelGroup group)</span> &#123; <span class="built_in">this</span>.group = group; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//还是以聊天室举例，因此发送的都是文本消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, WebSocketFrame message)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (message <span class="keyword">instanceof</span> TextWebSocketFrame)&#123;     <span class="comment">// TextWebSocketFrame 表示文本帧</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">request</span> <span class="operator">=</span> ((TextWebSocketFrame) message).text();</span><br><span class="line">            <span class="comment">//先往自己所在的客户端浏览器写一份原始的自己发的内容,并支持中文</span></span><br><span class="line">            ctx.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(request.toUpperCase(Locale.CHINA)));</span><br><span class="line">            <span class="comment">//群发的实现：通过 group，里面存放了所有连接的 channel,内容则是帧Frame里面的字符串(发送的那个用户就会被发两遍)</span></span><br><span class="line">            group.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(</span><br><span class="line">                    <span class="string">&quot;client[&quot;</span> + ctx.channel().id() + <span class="string">&quot;] say:&quot;</span> + request.toUpperCase(Locale.CHINA)</span><br><span class="line">            ));</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;不支持非文本类型......&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理用户自定义的事件：当握手成功后对 WebSocket 进行支持时会触发用户自定义事件</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object event)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//假如需要实现功能：当某人进来时提示xxx用户加入群聊(event 就是握手完成事件)</span></span><br><span class="line">        <span class="keyword">if</span> (event == WebSocketServerProtocolHandler.ServerHandshakeStateEvent.HANDSHAKE_COMPLETE)&#123;</span><br><span class="line">            <span class="comment">//群发通知xxx用户加入群聊</span></span><br><span class="line">            group.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(</span><br><span class="line">                    <span class="string">&quot;client[&quot;</span> + ctx.channel().id() + <span class="string">&quot;] is login......&quot;</span></span><br><span class="line">            ));</span><br><span class="line">            group.add(ctx.channel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[案例]</code>  上面的客户端是使用浏览器的页面，那么使用 Netty 搭建客户端呢？</p>
<p>1）客户端的启动类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketClient</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;ws://127.0.0.1:8080/websocket&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SURL</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;url&quot;</span>, <span class="string">&quot;wss://127.0.0.1:8443/websocket&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URI</span>(URL);</span><br><span class="line">        <span class="type">String</span> <span class="variable">scheme</span> <span class="operator">=</span> uri.getScheme() == <span class="literal">null</span>? <span class="string">&quot;ws&quot;</span> : uri.getScheme();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> uri.getHost() == <span class="literal">null</span>? <span class="string">&quot;127.0.0.1&quot;</span> : uri.getHost();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> uri.getPort();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;ws&quot;</span>.equalsIgnoreCase(scheme) &amp;&amp; !<span class="string">&quot;wss&quot;</span>.equalsIgnoreCase(scheme)) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Only WS(S) is supported.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ssl</span> <span class="operator">=</span> <span class="string">&quot;wss&quot;</span>.equalsIgnoreCase(scheme);</span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line">        <span class="keyword">if</span> (ssl) &#123;</span><br><span class="line">            sslCtx = SslContextBuilder.forClient().trustManager(InsecureTrustManagerFactory.INSTANCE).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sslCtx = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Connect with V13 (RFC 6455 aka HyBi-17). You can change it to V08 or V00.</span></span><br><span class="line">            <span class="comment">// If you change it to V00, ping is not supported and remember to change</span></span><br><span class="line">            <span class="comment">// HttpResponseDecoder to WebSocketHttpResponseDecoder in the pipeline.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">WebSocketClientHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketClientHandler</span>(</span><br><span class="line">                    WebSocketClientHandshakerFactory.newHandshaker(uri, WebSocketVersion.V13, <span class="literal">null</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultHttpHeaders</span>()));</span><br><span class="line"></span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            b.group(group).channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            <span class="keyword">if</span> (sslCtx != <span class="literal">null</span>) &#123;</span><br><span class="line">                                p.addLast(sslCtx.newHandler(ch.alloc(), host, port));</span><br><span class="line">                            &#125;</span><br><span class="line">                            p.addLast(<span class="keyword">new</span> <span class="title class_">HttpClientCodec</span>())    <span class="comment">//http协议为握手必须</span></span><br><span class="line">                                    .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">8192</span>))</span><br><span class="line">                                    .addLast(WebSocketClientCompressionHandler.INSTANCE)    <span class="comment">//支持WebSocket数据压缩</span></span><br><span class="line">                                    .addLast(handler);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//连接服务器</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> b.connect(uri.getHost(), port).sync().channel();</span><br><span class="line">            <span class="comment">//等待握手完成</span></span><br><span class="line">            handler.handshakeFuture().sync();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">console</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in));</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> console.readLine();</span><br><span class="line">                <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;bye&quot;</span>.equals(msg.toLowerCase())) &#123;</span><br><span class="line">                    ch.writeAndFlush(<span class="keyword">new</span> <span class="title class_">CloseWebSocketFrame</span>());</span><br><span class="line">                    ch.closeFuture().sync();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;ping&quot;</span>.equals(msg.toLowerCase())) &#123;</span><br><span class="line">                    <span class="type">WebSocketFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PingWebSocketFrame</span>(Unpooled.wrappedBuffer(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="number">8</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">1</span> &#125;));</span><br><span class="line">                    ch.writeAndFlush(frame);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">WebSocketFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(msg);</span><br><span class="line">                    ch.writeAndFlush(frame);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）客户端的处理器，进行 TCP 的握手，处理 WebSocket 的报文。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketClientHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;Object&gt; &#123;</span><br><span class="line">    <span class="comment">//负责和服务器进行握手</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebSocketClientHandshaker handshaker;</span><br><span class="line">    <span class="comment">//握手的结果</span></span><br><span class="line">    <span class="keyword">private</span> ChannelPromise handshakeFuture;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSocketClientHandler</span><span class="params">(WebSocketClientHandshaker handshaker)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.handshaker = handshaker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ChannelFuture <span class="title function_">handshakeFuture</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> handshakeFuture;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当前Handler被添加到ChannelPipeline时，new 出握手的结果的实例，以备将来使用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        handshakeFuture = ctx.newPromise();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通道建立，进行握手</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        handshaker.handshake(ctx.channel());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通道关闭</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket Client disconnected!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取数据</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">ch</span> <span class="operator">=</span> ctx.channel();</span><br><span class="line">        <span class="comment">//握手未完成，完成握手</span></span><br><span class="line">        <span class="keyword">if</span> (!handshaker.isHandshakeComplete()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                handshaker.finishHandshake(ch, (FullHttpResponse) msg);</span><br><span class="line">                System.out.println(<span class="string">&quot;WebSocket Client connected!&quot;</span>);</span><br><span class="line">                handshakeFuture.setSuccess();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (WebSocketHandshakeException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;WebSocket Client failed to connect&quot;</span>);</span><br><span class="line">                handshakeFuture.setFailure(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//握手已经完成，升级为了websocket，不应该再收到http报文</span></span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FullHttpResponse) &#123;</span><br><span class="line">            <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> (FullHttpResponse) msg;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                    <span class="string">&quot;Unexpected FullHttpResponse (getStatus=&quot;</span> + response.status() +</span><br><span class="line">                            <span class="string">&quot;, content=&quot;</span> + response.content().toString(StandardCharsets.UTF_8) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理 websocket 报文</span></span><br><span class="line">        <span class="type">WebSocketFrame</span> <span class="variable">frame</span> <span class="operator">=</span> (WebSocketFrame) msg;</span><br><span class="line">        <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> TextWebSocketFrame) &#123;</span><br><span class="line">            <span class="type">TextWebSocketFrame</span> <span class="variable">textFrame</span> <span class="operator">=</span> (TextWebSocketFrame) frame;</span><br><span class="line">            System.out.println(<span class="string">&quot;WebSocket Client received message: &quot;</span> + textFrame.text());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> PongWebSocketFrame) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;WebSocket Client received pong&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frame <span class="keyword">instanceof</span> CloseWebSocketFrame) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;WebSocket Client received closing&quot;</span>);</span><br><span class="line">            ch.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (!handshakeFuture.isDone()) &#123;</span><br><span class="line">            handshakeFuture.setFailure(cause);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="私有协议实现"><a href="#私有协议实现" class="headerlink" title="私有协议实现"></a>私有协议实现</h2><p>​	通信协议从广义上区分，可以<code>分为公有协议和私有协议</code>。由于私有协议的灵活性，它往往会在某个公司或者组织内部使用，按需定制，也因为如此，升级起来会非常方便，灵活性好。<code>绝大多数的私有协议一般都是应用层协议</code>，其传输层都基于TCP&#x2F;IP，所以利用 Netty 的 NIO TCP 协议栈可以非常方便地进行私有协议的定制和开发（使用 UDP 的话，那些存在的问题就需要在应用层另外实现）。私有协议本质上是厂商内部发展和采用的标准，除非授权，其他厂商一般无权使用该协议。私有协议也称非标准协议，就是未经国际或国家标准化组织采纳或批准，由某个企业自己制订，协议实现细节不愿公开，只在企业自己生产的设备之间使用的协议，私有协议具有封闭性、垄断性、排他性等特点。</p>
<p>​	自定义的私有网络协议的设计功能：使用基于 Netty 的 <code>NIO 通信</code>框架(基于原生的 NIO 操作过于复杂)，提供高性能的异步通信能力，同时需要提供消息的<code>编解码框架</code>(网络传递通常是 JavaBean)，可以在框架层面实现 JavaBean 的<code>序列化和反序列化</code>，而不需要业务代码考虑单独实现，同时提供基于 IP 地址的<code>白名单</code>接入认证机制，网络安全的基本实现(本地缓存)，链路的有效性校验机制（keep-alive <code>心跳保活机制</code>：检测对端连接和业务服务的正常），提供链路的<code>断连重连</code>机制。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.imgdb.cn/item/6336e96016f2c2beb1bab89e.png"></p>
<p><code>[注意项]</code>  此设计的网络协议并不会对所有的功能都进行实现，同时还有一些注意点：</p>
<p>1）链路建立问题：客户端和服务端三次握手成功后，发送握手请求报文，服务端这边会对 IP 地址校验，同时一个 IP 只允许使用一个连接。</p>
<p>2）可靠性问题：实现心跳机制，当心跳断开时，能实现重连，同时当旧连接断开时，需要将其从缓存中清除，允许重新登陆保护。</p>
<p><code>[实现]</code> 基本框架的搭建。</p>
<p>0）创建 pojo.network 包，此包表示网络的基本规定信息。</p>
<p>1）消息类型的实体类：枚举类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消息的类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">    SERVICE_REQ((<span class="type">byte</span>) <span class="number">0</span>),          <span class="comment">// 业务请求消息</span></span><br><span class="line">    SERVICE_RESP((<span class="type">byte</span>) <span class="number">1</span>),         <span class="comment">// 业务应答消息</span></span><br><span class="line">    ONE_WAY((<span class="type">byte</span>) <span class="number">2</span>),              <span class="comment">// 无需应答的业务请求消息</span></span><br><span class="line">    LOGIN_REQ((<span class="type">byte</span>) <span class="number">3</span>),            <span class="comment">// 登录请求消息</span></span><br><span class="line">    LOGIN_RESP((<span class="type">byte</span>) <span class="number">4</span>),           <span class="comment">// 登录响应消息</span></span><br><span class="line">    HEARTBEAT_REQ((<span class="type">byte</span>) <span class="number">5</span>),        <span class="comment">// 心跳请求消息</span></span><br><span class="line">    HEARTBEAT_RESP((<span class="type">byte</span>) <span class="number">6</span>);       <span class="comment">// 心跳应答消息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> value;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">MessageType</span><span class="params">(<span class="type">byte</span> value)</span> &#123; <span class="built_in">this</span>.value = value; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">value</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="built_in">this</span>.value; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）网络数据报<code>消息头</code>的实体类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MessageHeader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">crcCode</span> <span class="operator">=</span> <span class="number">0xabef0101</span>;   <span class="comment">// CRC 校验</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> length;                 <span class="comment">// 消息长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> sessionID;             <span class="comment">// 会话ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> type;                  <span class="comment">// 消息类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span> priority;              <span class="comment">// 消息优先级</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachment = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;(); <span class="comment">// 附件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）网络消息数据报的消息封装：包括消息头和消息体。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NetworkMessage</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> MessageHeader messageHeader;</span><br><span class="line">    <span class="keyword">private</span> Object messageBody;    <span class="comment">//消息体，考虑可能是各种格式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）常量工具类 NetworkConstants 以及打印工具类 ConstantUtils。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NetworkConstants</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REMOTE_IP</span> <span class="operator">=</span> <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REMOTE_PORT</span> <span class="operator">=</span> <span class="number">8989</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstantUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANSI_GREEN</span> <span class="operator">=</span> <span class="string">&quot;\u001B[32m&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANSI_WHITE</span> <span class="operator">=</span> <span class="string">&quot;\u001B[37m&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANSI_BLACK</span> <span class="operator">=</span> <span class="string">&quot;\u001B[30m&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ANSI_RESET</span> <span class="operator">=</span> <span class="string">&quot;\u001B[0m&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getTime</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">simpleDateFormat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">dataString</span> <span class="operator">=</span> simpleDateFormat.format(date);</span><br><span class="line">        <span class="keyword">return</span> dataString;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printMessage</span><span class="params">(Object message)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">printMessage</span> <span class="operator">=</span> getTime() + ANSI_GREEN + <span class="string">&quot; [&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;] &quot;</span> + ANSI_RESET + message;</span><br><span class="line">        System.out.println(printMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[实现]</code> 之前使用过 Protocol 和 messagePack 序列化机制，现在使用 <code>Kryo 序列化</code>（只支持 Java ）的相关机制的实现，使用更加方便。</p>
<p>1）创建 Kryo 的序列化工厂，注册相关 Class。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KryoFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Kryo <span class="title function_">createKryo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kryo</span>();</span><br><span class="line">        kryo.setRegistrationRequired(<span class="literal">false</span>);</span><br><span class="line">        kryo.register(Arrays.asList(<span class="string">&quot;&quot;</span>).getClass(), <span class="keyword">new</span> <span class="title class_">ArraysAsListSerializer</span>());</span><br><span class="line">        kryo.register(GregorianCalendar.class, <span class="keyword">new</span> <span class="title class_">GregorianCalendarSerializer</span>());</span><br><span class="line">        kryo.register(InvocationHandler.class, <span class="keyword">new</span> <span class="title class_">JdkProxySerializer</span>());</span><br><span class="line">        kryo.register(BigDecimal.class, <span class="keyword">new</span> <span class="title class_">DefaultSerializers</span>.BigDecimalSerializer());</span><br><span class="line">        kryo.register(BigInteger.class, <span class="keyword">new</span> <span class="title class_">DefaultSerializers</span>.BigIntegerSerializer());</span><br><span class="line">        kryo.register(Pattern.class, <span class="keyword">new</span> <span class="title class_">RegexSerializer</span>());</span><br><span class="line">        kryo.register(BitSet.class, <span class="keyword">new</span> <span class="title class_">BitSetSerializer</span>());</span><br><span class="line">        kryo.register(URI.class, <span class="keyword">new</span> <span class="title class_">URISerializer</span>());</span><br><span class="line">        kryo.register(UUID.class, <span class="keyword">new</span> <span class="title class_">UUIDSerializer</span>());</span><br><span class="line">        UnmodifiableCollectionsSerializer.registerSerializers(kryo);</span><br><span class="line">        SynchronizedCollectionsSerializer.registerSerializers(kryo);</span><br><span class="line">        kryo.register(HashMap.class);</span><br><span class="line">        kryo.register(ArrayList.class);</span><br><span class="line">        kryo.register(LinkedList.class);</span><br><span class="line">        kryo.register(HashSet.class);</span><br><span class="line">        kryo.register(TreeSet.class);</span><br><span class="line">        kryo.register(Hashtable.class);</span><br><span class="line">        kryo.register(Date.class);</span><br><span class="line">        kryo.register(Calendar.class);</span><br><span class="line">        kryo.register(ConcurrentHashMap.class);</span><br><span class="line">        kryo.register(SimpleDateFormat.class);</span><br><span class="line">        kryo.register(GregorianCalendar.class);</span><br><span class="line">        kryo.register(Vector.class);</span><br><span class="line">        kryo.register(BitSet.class);</span><br><span class="line">        kryo.register(StringBuffer.class);</span><br><span class="line">        kryo.register(StringBuilder.class);</span><br><span class="line">        kryo.register(Object.class);</span><br><span class="line">        kryo.register(Object[].class);</span><br><span class="line">        kryo.register(String[].class);</span><br><span class="line">        kryo.register(<span class="type">byte</span>[].class);</span><br><span class="line">        kryo.register(<span class="type">char</span>[].class);</span><br><span class="line">        kryo.register(<span class="type">int</span>[].class);</span><br><span class="line">        kryo.register(<span class="type">float</span>[].class);</span><br><span class="line">        kryo.register(<span class="type">double</span>[].class);</span><br><span class="line">        <span class="keyword">return</span> kryo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）创建序列化器，进行二进制码流的相关读写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KryoSerializer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Kryo</span> <span class="variable">kryo</span> <span class="operator">=</span> KryoFactory.createKryo();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object, ByteBuf out)</span> &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Output</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Output</span>(baos);</span><br><span class="line">        kryo.writeClassAndObject(output, object);</span><br><span class="line">        output.flush();</span><br><span class="line">        output.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] b = baos.toByteArray();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            baos.flush();</span><br><span class="line">            baos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        out.writeBytes(b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(ByteBuf out)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (out == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Input</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Input</span>(<span class="keyword">new</span> <span class="title class_">ByteBufInputStream</span>(out));</span><br><span class="line">        <span class="keyword">return</span> kryo.readClassAndObject(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）编码器调用序列化器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编码：将 JavaBean 转化为 byte 二进制数据流</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KryoEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToByteEncoder</span>&lt;NetworkMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, NetworkMessage message, ByteBuf out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        KryoSerializer.serialize(message, out);</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）解码器调用序列化器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解码：将 byte 二进制流转化为 Message</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KryoDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> KryoSerializer.deserialize(in);</span><br><span class="line">        out.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[实现]</code> 服务端的具体的响应消息方面的处理器实现。</p>
<p>1）服务端的启动类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">NettyServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//配置服务端的 NIO 线程组</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> <span class="title class_">ServerInit</span>());</span><br><span class="line">        <span class="comment">// 绑定端口，同步等待成功</span></span><br><span class="line">        b.bind(NetworkConstants.REMOTE_PORT).sync();</span><br><span class="line">        ConstantUtils.printMessage(<span class="string">&quot;Netty server start : &quot;</span> + (NetworkConstants.REMOTE_IP + <span class="string">&quot; : &quot;</span> + NetworkConstants.REMOTE_PORT));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 2）服务端的 handler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerInit</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">        <span class="comment">//pipeline.addLast(new LoggingHandler(LogLevel.INFO));</span></span><br><span class="line">        <span class="comment">//粘包半包问题解决有三种方式：1）长度固定；2）分隔符；3）消息头包含消息体长度,</span></span><br><span class="line">        <span class="comment">//此处并没有使用消息头的长度信息，而是在整个消息的前面加 2 byte表示长度信息</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">65535</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldPrepender</span>(<span class="number">2</span>));  <span class="comment">//响应回去的消息报文的消息头也需要加上 2byte 的长度信息</span></span><br><span class="line">        <span class="comment">//序列化处理的 handler:编码解码以及序列化和反序列化</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">KryoDecoder</span>());</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">KryoEncoder</span>());</span><br><span class="line">        <span class="comment">//检测链路是否空闲，处理心跳超时的检测，超过 15s 没有处理就会抛出异常，而这个异常就会被 LoginAuthRespHandler 里面的处理异常的 handler 所接收</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ReadTimeoutHandler</span>(<span class="number">15</span>));</span><br><span class="line">        <span class="comment">//额外实现功能需要的处理器handler</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LoginAuthRespHandler</span>());  <span class="comment">//登陆白名单检查的 handler</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HeartBeatRespHandler</span>());    <span class="comment">//心跳检查的 handler,但是需要注意心跳超时机制的处理:ReadTimeoutHandler</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ServiceHandler</span>());     <span class="comment">//业务处理的 handler</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）服务端的响应登陆握手认证处理器 handler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类说明：登录检查的 handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAuthRespHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">	<span class="comment">//用本地缓存以检查用户是否重复登录的缓存，使一个 ip 只能登陆一次，而这个 map 就是表示当前登录的 ip</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Boolean&gt; nodeCheck = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//用户登录的白名单，后续可以实现从数据库等地方读取</span></span><br><span class="line">    <span class="keyword">private</span> String[] whiteList = &#123; <span class="string">&quot;127.0.0.1&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//处理用户发过来的相关登录信息，实际客户端发过来的消息就是 NetworkMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NetworkMessage) msg;</span><br><span class="line">		ConstantUtils.printMessage(<span class="string">&quot;enter loginAuth channelRead method......&quot;</span>);</span><br><span class="line">		<span class="comment">//判定是不是握手认证请求，也就是判断请求的消息类型是不是登录认证请求类型，就应该做实际的校验</span></span><br><span class="line">		<span class="keyword">if</span>(message.getMessageHeader() != <span class="literal">null</span> &amp;&amp; message.getMessageHeader().getType() == MessageType.LOGIN_REQ.value())&#123;</span><br><span class="line">			ConstantUtils.printMessage(<span class="string">&quot;has accepted loginAuth request......&quot;</span>);</span><br><span class="line">			<span class="type">String</span> <span class="variable">nodeIndex</span> <span class="operator">=</span> ctx.channel().remoteAddress().toString();	<span class="comment">//对端的IP地址</span></span><br><span class="line">			<span class="type">NetworkMessage</span> <span class="variable">loginResp</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">			<span class="comment">//在本地的缓存中检查是重复登陆则直接拒绝</span></span><br><span class="line">			<span class="keyword">if</span> (nodeCheck.containsKey(nodeIndex)) &#123;</span><br><span class="line">				ConstantUtils.printMessage(<span class="string">&quot;repeating login，please refuse login......&quot;</span>);</span><br><span class="line">				loginResp = buildResponse((<span class="type">byte</span>) -<span class="number">1</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">//如果是第一次登陆，则检查用户是否在白名单中，在则允许登录，并写入缓存，不在则同样不处理</span></span><br><span class="line">				<span class="type">InetSocketAddress</span> <span class="variable">address</span> <span class="operator">=</span> (InetSocketAddress) ctx.channel().remoteAddress();</span><br><span class="line">				<span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> address.getAddress().getHostAddress();</span><br><span class="line">				<span class="type">boolean</span> <span class="variable">isOK</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">for</span> (String WIP : whiteList) &#123;</span><br><span class="line">					<span class="keyword">if</span> (WIP.equals(ip)) &#123;</span><br><span class="line">						isOK = <span class="literal">true</span>;	<span class="comment">//如果在白名单里面那么就修改 isOK = true</span></span><br><span class="line">						<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//判断是否存在，允许登录则 loginResp = (NetworkMessage)0</span></span><br><span class="line">				<span class="keyword">if</span> (isOK)&#123;</span><br><span class="line">					ConstantUtils.printMessage(<span class="string">&quot;白名单检验通过，允许登录......&quot;</span>);</span><br><span class="line">					loginResp = buildResponse((<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">					<span class="comment">//已经登陆的缓存中保存当前登录IP</span></span><br><span class="line">					nodeCheck.put(nodeIndex, <span class="literal">true</span>);</span><br><span class="line">				&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">					ConstantUtils.printMessage(<span class="string">&quot;白名单检验拒绝，拒绝登录......&quot;</span>);</span><br><span class="line">					loginResp = buildResponse((<span class="type">byte</span>) -<span class="number">1</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(<span class="string">&quot;The login response is : &quot;</span> + loginResp + <span class="string">&quot; body [&quot;</span> + loginResp.getMessageBody() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">			<span class="comment">//直接将报文响应回客户端，不会往后继续传递，则此处就需要释放 buf 等，避免内存泄露</span></span><br><span class="line">			ctx.writeAndFlush(loginResp);</span><br><span class="line">			ReferenceCountUtil.release(msg);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">//如果不是登录认证请求类型，则需要将请求往后传递，其他 handler 处理</span></span><br><span class="line">			ctx.fireChannelRead(msg);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构造一个响应的消息 NetworkMessage</span></span><br><span class="line">    <span class="keyword">private</span> NetworkMessage <span class="title function_">buildResponse</span><span class="params">(<span class="type">byte</span> result)</span> &#123;</span><br><span class="line">		<span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NetworkMessage</span>();</span><br><span class="line">		<span class="type">MessageHeader</span> <span class="variable">myHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageHeader</span>();</span><br><span class="line">		myHeader.setType(MessageType.LOGIN_RESP.value());</span><br><span class="line">		message.setMessageHeader(myHeader);</span><br><span class="line">		message.setMessageBody(result);</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		cause.printStackTrace();</span><br><span class="line">        <span class="comment">//如果出现异常，则需要删除当前登录的IP缓存，避免后面重连出错</span></span><br><span class="line">		nodeCheck.remove(ctx.channel().remoteAddress().toString());</span><br><span class="line">		ctx.close();</span><br><span class="line">		ctx.fireExceptionCaught(cause);		<span class="comment">//异常后面可能会接受处理，因此向后传递</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）服务端的心跳响应处理器 handler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//心跳处理 handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatRespHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NetworkMessage) msg;</span><br><span class="line">		<span class="comment">//判定是不是心跳请求 HEARTBEAT_REQ 消息</span></span><br><span class="line">		<span class="keyword">if</span>(message.getMessageHeader() != <span class="literal">null</span> &amp;&amp; message.getMessageHeader().getType() == MessageType.HEARTBEAT_REQ.value())&#123;</span><br><span class="line">			<span class="type">NetworkMessage</span> <span class="variable">heartBeatResp</span> <span class="operator">=</span> buildHeatBeat();</span><br><span class="line">			ctx.writeAndFlush(heartBeatResp);	<span class="comment">//给客户端应答，表示服务端还正常，同时写出消息，因此也需要释放资源</span></span><br><span class="line">			ReferenceCountUtil.release(msg);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			ctx.fireChannelRead(msg);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建请求响应的消息报文:心跳报文的响应没有消息体，只需要确认还是连接的报文即可</span></span><br><span class="line">    <span class="keyword">private</span> NetworkMessage <span class="title function_">buildHeatBeat</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NetworkMessage</span>();</span><br><span class="line">		<span class="type">MessageHeader</span> <span class="variable">myHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageHeader</span>();</span><br><span class="line">		myHeader.setType(MessageType.HEARTBEAT_RESP.value());</span><br><span class="line">		message.setMessageHeader(myHeader);</span><br><span class="line">		<span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）服务端的业务处理的 handler，当前只是做简单的打印。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//业务处理的具体 handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;NetworkMessage&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, NetworkMessage msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ConstantUtils.printMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ConstantUtils.printMessage(ctx.channel().remoteAddress()+<span class="string">&quot; 主动断开了连接!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>[实现]</code>  客户端的请求 handler 的具体实现。</p>
<p>1）服务端的启动类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实际的 client 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientStart</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">NettyClient</span> <span class="variable">nettyClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NettyClient</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(nettyClient).start();    <span class="comment">//客户端线程启动</span></span><br><span class="line">        <span class="keyword">while</span>(!nettyClient.isConnected())&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (nettyClient)&#123;</span><br><span class="line">                <span class="comment">//引入等待和通知相关的机制，此处没有连接上则会等待连接，连接好后会通知此处从而结束死循环</span></span><br><span class="line">                nettyClient.wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;network socket has prepared................&quot;</span>);</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">            <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;q&quot;</span>.equals(msg.toLowerCase())) &#123;</span><br><span class="line">                nettyClient.close();</span><br><span class="line">                <span class="keyword">while</span>(nettyClient.isConnected())&#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (nettyClient)&#123;</span><br><span class="line">                        nettyClient.wait();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                scanner.close();</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;user&quot;</span>.equals(msg.toLowerCase())) &#123;</span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                user.setUserName(<span class="string">&quot;蔡徐坤&quot;</span>);</span><br><span class="line">                user.setAge(<span class="number">20</span>);</span><br><span class="line">                user.setId(<span class="string">&quot;NO:IKUN1&quot;</span>);</span><br><span class="line">                user.setUserContact(<span class="keyword">new</span> <span class="title class_">UserContact</span>(<span class="string">&quot;蔡徐坤:唱跳 Rap 篮球&quot;</span>, <span class="string">&quot;133928343&quot;</span>));</span><br><span class="line">                nettyClient.send(user);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                nettyClient.send(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）客户端线程的任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//客户端的启动类:发送握手请求、定时发送心跳、发送业务数据（每一个单独的客户端都是一个线程的任务）</span></span><br><span class="line"><span class="comment">//真实的客户端实际上是 ClientStart ，而具体线程内的操作（任务）则是 NettyClient，是一个异步的操作</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NettyClient</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="comment">//负责重连的线程池:单独的线程进行重连,如果使用原先的线程进行连接可能会死循环不停连接</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">userClose</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//表示是否用户主动关闭连接的标志值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">connected</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//表示连接是否成功关闭的标志值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isConnected</span><span class="params">()</span> &#123; <span class="keyword">return</span> connected; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用ip和端口连接服务器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connectServer</span><span class="params">(String host, <span class="type">int</span> port)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();  <span class="comment">//启动必备</span></span><br><span class="line">            bootstrap.group(group).channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ClientInit</span>());   <span class="comment">//handler 装配</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> bootstrap.connect(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9999</span>)).sync();  <span class="comment">//发起连接</span></span><br><span class="line">            channel = future.sync().channel();  <span class="comment">//拿到 channel，因为后面用户主动关闭和断线重连需要使用</span></span><br><span class="line">            ConstantUtils.printMessage(<span class="string">&quot;client success connection server： host = [&quot;</span> + host + <span class="string">&quot;] port = &quot;</span> + port);</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>)&#123;</span><br><span class="line">                <span class="built_in">this</span>.connected = <span class="literal">true</span>;  <span class="comment">//连接成功后修改连接状态标志位</span></span><br><span class="line">                System.out.println(<span class="string">&quot;=============================&quot;</span>);</span><br><span class="line">                <span class="built_in">this</span>.notifyAll();   <span class="comment">//连接成功则唤醒之前ClientStart的main线程，使其进行业务代码的实现</span></span><br><span class="line">            &#125;</span><br><span class="line">            future.channel().closeFuture().sync();  <span class="comment">//关闭事件上阻塞</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 出现问题则需要换线程连接，但是当用户主动关闭时就不需要断线重连</span></span><br><span class="line">            <span class="keyword">if</span>(!userClose)&#123; <span class="comment">//非正常关闭，有可能发生了网络问题，需要进行重连</span></span><br><span class="line">                System.out.println(<span class="string">&quot;need waiting network repeat connection......&quot;</span>);</span><br><span class="line">                <span class="comment">//重连直接调用 connect 方法则会造成递归死循环，因此需要放到另一个线程去做</span></span><br><span class="line">                executor.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="comment">//操作系统对端口的释放是需要一定的时间的，给操作系统足够的时间，去释放相关的资源，避免重启时端口并没有释放</span></span><br><span class="line">                            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">                            connectServer(NetworkConstants.REMOTE_IP, NetworkConstants.REMOTE_PORT);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;  <span class="comment">//用户主动关闭，则清空连接缓存，关闭资源，修改标志位</span></span><br><span class="line">                channel = <span class="literal">null</span>;</span><br><span class="line">                group.shutdownGracefully().sync();</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>)&#123;</span><br><span class="line">                    <span class="built_in">this</span>.connected = <span class="literal">false</span>;</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();   <span class="comment">//关闭后也需要通知ClientStart的main线程，进行其下一轮判断</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connectServer(NetworkConstants.REMOTE_IP, NetworkConstants.REMOTE_PORT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//具体的业务的方法接口:发送的消息可能是实体类，也可能是字符串或是其他对象，此处将其封装消息报文</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(Object message)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(channel == <span class="literal">null</span> || !channel.isActive())&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;has not success connection,please wait a litter......&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">NetworkMessage</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NetworkMessage</span>();</span><br><span class="line">        <span class="type">MessageHeader</span> <span class="variable">myHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageHeader</span>();</span><br><span class="line">        myHeader.setType(MessageType.SERVICE_REQ.value());  <span class="comment">//设置消息类型为业务请求消息</span></span><br><span class="line">        msg.setMessageHeader(myHeader);</span><br><span class="line">        msg.setMessageBody(message);</span><br><span class="line">        channel.writeAndFlush(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        userClose = <span class="literal">true</span>;</span><br><span class="line">        channel.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）客户端的 handler 装载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientInit</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> socketChannel.pipeline();</span><br><span class="line">        <span class="comment">//粘包半包问题：使用消息头带消息长度的方式</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldBasedFrameDecoder</span>(<span class="number">65535</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>));</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LengthFieldPrepender</span>(<span class="number">2</span>));</span><br><span class="line">        <span class="comment">//序列化处理的 handler:编码解码以及序列化和反序列化</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">KryoDecoder</span>());</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">KryoEncoder</span>());</span><br><span class="line">        <span class="comment">//处理心跳超时的检测，超过 15s 没有处理就会抛出异常，而这个异常就会被 HeartBeatReqHandler 里面的处理异常的 handler 所接收</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">ReadTimeoutHandler</span>(<span class="number">15</span>));</span><br><span class="line">        <span class="comment">//额外需要的处理器单独实现,没有设置业务的 handler</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LoginAuthReqHandler</span>());  <span class="comment">//发送握手请求的 handler</span></span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HeartBeatReqHandler</span>());  <span class="comment">//心跳检查的 handler,但是需要注意心跳超时机制的处理:ReadTimeoutHandler</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）客户端的登录握手请求 handler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发出登录握手请求的handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginAuthReqHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//通道连接成功后发起握手认证请求</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ConstantUtils.printMessage(<span class="string">&quot;send loginAuth request......&quot;</span>);</span><br><span class="line">        <span class="type">NetworkMessage</span> <span class="variable">loginReqMessage</span> <span class="operator">=</span> buildLoginReq();</span><br><span class="line">        System.out.println(loginReqMessage);</span><br><span class="line">        ctx.writeAndFlush(loginReqMessage); <span class="comment">//发出认证请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NetworkMessage) msg;</span><br><span class="line">        <span class="comment">//需要对服务端对认证的响应信息进行处理,判断是认证应答报文时就需要解析响应，不是就直接传递到后面的 handler</span></span><br><span class="line">        <span class="keyword">if</span>(message.getMessageHeader() != <span class="literal">null</span> &amp;&amp; message.getMessageHeader().getType() == MessageType.LOGIN_RESP.value())&#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">loginResult</span> <span class="operator">=</span> (<span class="type">byte</span>) message.getMessageBody();</span><br><span class="line">            <span class="keyword">if</span> (loginResult != (<span class="type">byte</span>) <span class="number">0</span>)&#123;</span><br><span class="line">                ConstantUtils.printMessage(<span class="string">&quot;握手失败......&quot;</span>);</span><br><span class="line">                <span class="comment">//表示握手失败，则关闭连接</span></span><br><span class="line">                ctx.close();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                ConstantUtils.printMessage(<span class="string">&quot;Login is ok: &quot;</span> + message);</span><br><span class="line">                ctx.fireChannelRead(msg);   <span class="comment">//向后传递，不能直接调用 release 方法释放，因为心跳请求的发送前提是握手成功</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//如果不是登陆握手的响应报文，则向后传递，让其他 handler 处理</span></span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> NetworkMessage <span class="title function_">buildLoginReq</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NetworkMessage</span>();</span><br><span class="line">        <span class="type">MessageHeader</span> <span class="variable">myHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageHeader</span>();</span><br><span class="line">        myHeader.setType(MessageType.LOGIN_REQ.value());</span><br><span class="line">        message.setMessageHeader(myHeader);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5）客户端的心跳请求发送的 handler。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//心跳请求的 handler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeartBeatReqHandler</span> <span class="keyword">extends</span> <span class="title class_">ChannelInboundHandlerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; heartBeat;</span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//此时 channelRead 时需要判断是否通过握手认证，通过则发送心跳的消息</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> (NetworkMessage) msg;</span><br><span class="line">        <span class="comment">//判定握手的应答，如果握手成功才会发起心跳请求</span></span><br><span class="line">        <span class="keyword">if</span>(message.getMessageHeader() != <span class="literal">null</span> &amp;&amp; message.getMessageHeader().getType() == MessageType.LOGIN_RESP.value())&#123;</span><br><span class="line">            <span class="comment">//定时发出心跳请求:Netty 提供了定时机制,需要提供任务和定时频率（也可以用定时器）</span></span><br><span class="line">            heartBeat = ctx.executor().scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">HeartBeatReqHandler</span>.HeartBeatTask(ctx), <span class="number">0</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="comment">//此时处理完了认证握手报文，就可以将认证请求报文释放</span></span><br><span class="line">            ReferenceCountUtil.release(msg);</span><br><span class="line">            <span class="comment">//如果是心跳响应报文，那么就可以直接接收到向后传递</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(message.getMessageHeader() != <span class="literal">null</span> &amp;&amp; message.getMessageHeader().getType() == MessageType.HEARTBEAT_RESP.value())&#123;</span><br><span class="line">            <span class="comment">//如果服务端发过来的是心跳的应答消息，就应该释放报文，表示接收到</span></span><br><span class="line">            ConstantUtils.printMessage(<span class="string">&quot;收到来自服务器的心跳报文......&quot;</span>);</span><br><span class="line">            ReferenceCountUtil.release(msg);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123; <span class="comment">//其他报文（业务报文）则向后传递处理即可</span></span><br><span class="line">            ctx.fireChannelRead(msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//心跳任务</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">HeartBeatTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandlerContext ctx;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">HeartBeatTask</span><span class="params">(ChannelHandlerContext ctx)</span> &#123; <span class="built_in">this</span>.ctx = ctx; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">//拼凑出心跳的应答报文发送给对端表示当前连接正常即可</span></span><br><span class="line">            <span class="type">NetworkMessage</span> <span class="variable">heatBeatMessage</span> <span class="operator">=</span> buildHeatBeat();</span><br><span class="line">            ctx.writeAndFlush(heatBeatMessage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//生成心跳请求的报文 HEARTBEAT_REQ</span></span><br><span class="line">        <span class="keyword">private</span> NetworkMessage <span class="title function_">buildHeatBeat</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">NetworkMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NetworkMessage</span>();</span><br><span class="line">            <span class="type">MessageHeader</span> <span class="variable">myHeader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageHeader</span>();</span><br><span class="line">            myHeader.setType(MessageType.HEARTBEAT_REQ.value());</span><br><span class="line">            message.setMessageHeader(myHeader);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//发生异常（心跳超时）则需要将这个定时任务清除</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (heartBeat != <span class="literal">null</span>) &#123;</span><br><span class="line">            heartBeat.cancel(<span class="literal">true</span>);</span><br><span class="line">            heartBeat = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.fireExceptionCaught(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要检查报文的传递，可以通过 Netty 提供的 <code>LoggingHandler</code> 处理 handler 来打印详细的报文信息，只需要加到客户端个服务端的 initChannel 开头即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pipeline.addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO));</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Netty 进阶实战</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="http://localhost:4000/2022/03/05/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98/">http://localhost:4000/2022/03/05/Java 开发/网络编程/Netty 进阶实战/</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display: inline-block;width: 120px"><h>作者</h><div class="post-copyright-cc-info"><h>月の子豚小窝</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2022-03-05</h></div></div><div class="post-copyright-u" style="display: inline-block;width: 120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2022-11-21</h></div></div><div class="post-copyright-c" style="display: inline-block;width: 180px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Netty/">Netty</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">网络编程</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/x8/wallhaven-x8xo1d.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn1.tianli0.top/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">好想要糖糖呀</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/cur/wechat.png" target="_blank"><img class="post-qr-code-img" src="/cur/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/cur/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/cur/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://cdn.cbd.int/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/03/02/Java%20%E5%BC%80%E5%8F%91/Java%20%E6%A1%86%E6%9E%B6/MybatisPlus%20%E5%9F%BA%E7%A1%80/"><img class="prev-cover" src="https://w.wallhaven.cc/full/wq/wallhaven-wqplxr.jpg" onerror="onerror=null;src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Mybatis-Plus 简单使用</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/29/%E5%B7%A5%E5%85%B7%E6%8F%92%E4%BB%B6/ShardingSphere%20%E5%9F%BA%E7%A1%80/"><img class="next-cover" src="https://w.wallhaven.cc/full/p9/wallhaven-p938pp.jpg" onerror="onerror=null;src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">ShardingSphere 基本了解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/02/27/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/" title="Netty 基础应用"><img class="cover" src="https://w.wallhaven.cc/full/9d/wallhaven-9dx8md.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-27</div><div class="title">Netty 基础应用</div></div></a></div><div><a href="/2022/02/25/Java%20%E5%BC%80%E5%8F%91/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Netty%20%E5%9F%BA%E7%A1%80%E6%A6%82%E8%BF%B0/" title="Netty 基本概述"><img class="cover" src="https://w.wallhaven.cc/full/j3/wallhaven-j36yxq.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-25</div><div class="title">Netty 基本概述</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div><div class="comment-barrage"></div><link rel="stylesheet" href="/css/commentBarrage.css"/><script src="/js/commentBarrage.js"></script></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="fgx"><div class="avatar_img"><img style="border-radius:10px" src="https://pic.imgdb.cn/item/637b405e16f2c2beb1405fb3.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2021/10/13/096df1ddac262.gif'" alt="avatar"/></div><div class="author-info__description"></div><div class="rights"><div class="author-info__name">月の子豚小窝</div><div class="card-info-data site-data is-center"><a class="adiv" href="/archives/"><div class="headline">文章</div><div class="length-num">37</div></a><a class="adiv" href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a class="adiv" href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div></div></div><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/lyxofficial" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="https://blog.csdn.net/weixin_44101108" target="_blank" title="CSDN"><i class="iconfont icon-csdn"></i></a><a class="social-icon" href="https://www.cnblogs.com/LYXOfficial" target="_blank" title="博客园"><i class="iconfont icon-RSS"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="订阅RSS源"><i class="fa fa-rss"></i></a><a class="social-icon" href="https://www.zhihu.com/people/lyx-29-86-4" target="_blank" title="知乎"><i class="iconfont icon-zhihu"></i></a><a class="social-icon" href="https://space.bilibili.com/369280472" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><a href="http://localhost:4000">月の子豚小窝</a> 整改中......<br/>2022年的计划我完成了吗？</div><div class="bbTimeList container" id="bbTimeList"><div class="swiper-container swiper-no-swiping essay_bar_swiper_container" id="bbtalk" tabindex="-1"><div class="swiper-wrapper" id="bber-talk" onclick="window.open('/essay/','_self')"><div class="li-style swiper-slide">可以看看我的音乐哦, 耶✌️, 终于不会混乱🤪了</div><div class="li-style swiper-slide">遇见彩虹🌈吃定彩虹 [图片]</div><div class="li-style swiper-slide">ThreeJs API真多丫</div><div class="li-style swiper-slide"></div><div class="li-style swiper-slide">还是不开Pjax好啊😂</div></div></div></div></div><div class="card-widget card-history"><div class="card-content"><div class="item-headline"><i class="fas fa-clock fa-spin"></i><span>那年今日</span></div><div id="history-baidu" style="height: 100px;overflow: hidden;"><div class="history_swiper-container" id="history-container" style="width: 100%;height: 100%;"><div class="swiper-wrapper" id="history_container_wrapper" style="height:20px"></div></div></div></div></div><div class="card-widget card-calendar"><div class="card-content"><div class="item-headline"><i class="fas fa-calendar"></i><span>文章日历</span></div><div class="widget" id="calendar"></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">单元测试使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP-%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">UDP 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8E%A8%E9%80%81"><span class="toc-number">3.</span> <span class="toc-text">服务器推送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WebSocket-%E6%A6%82%E8%BF%B0"><span class="toc-number">4.</span> <span class="toc-text">WebSocket 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%81%E6%9C%89%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">私有协议实现</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/21/%E5%A5%87%E6%80%9D%E6%B7%AB%E5%B7%A7/Hexo%E9%AD%94%E6%94%B9%E8%AE%B0%E5%BD%95/" title="Hexo魔改日记"><img src="https://w.wallhaven.cc/full/x6/wallhaven-x6128o.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="Hexo魔改日记"/></a><div class="content"><a class="title" href="/2022/11/21/%E5%A5%87%E6%80%9D%E6%B7%AB%E5%B7%A7/Hexo%E9%AD%94%E6%94%B9%E8%AE%B0%E5%BD%95/" title="Hexo魔改日记">Hexo魔改日记</a><time datetime="2022-11-21T12:35:28.011Z" title="发表于 2022-11-21 20:35:28">2022-11-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/20/%E5%A5%87%E6%80%9D%E6%B7%AB%E5%B7%A7/SpringBoot%E9%99%8D%E4%BD%8E%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/" title="SpringBoot 降低版本问题"><img src="https://w.wallhaven.cc/full/zy/wallhaven-zygeko.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="SpringBoot 降低版本问题"/></a><div class="content"><a class="title" href="/2022/11/20/%E5%A5%87%E6%80%9D%E6%B7%AB%E5%B7%A7/SpringBoot%E9%99%8D%E4%BD%8E%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98/" title="SpringBoot 降低版本问题">SpringBoot 降低版本问题</a><time datetime="2022-11-20T12:20:00.095Z" title="发表于 2022-11-20 20:20:00">2022-11-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="谷粒商城-订单服务实现"/></a><div class="content"><a class="title" href="/2022/11/06/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1/" title="谷粒商城-订单服务实现">谷粒商城-订单服务实现</a><time datetime="2022-11-06T14:42:44.735Z" title="发表于 2022-11-06 22:42:44">2022-11-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="谷粒商城-购物车逻辑实现"/></a><div class="content"><a class="title" href="/2022/11/03/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E8%B4%AD%E7%89%A9%E8%BD%A6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" title="谷粒商城-购物车逻辑实现">谷粒商城-购物车逻辑实现</a><time datetime="2022-11-03T07:19:16.711Z" title="发表于 2022-11-03 15:19:16">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理"><img src="https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg" onerror="this.onerror=null;this.src='https://bu.dusays.com/2022/09/01/63103d8f14652.webp'" alt="谷粒商城-用户认证处理"/></a><div class="content"><a class="title" href="/2022/10/30/%E9%A1%B9%E7%9B%AE%E7%BB%83%E4%B9%A0/%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E/%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E5%A4%84%E7%90%86/" title="谷粒商城-用户认证处理">谷粒商城-用户认证处理</a><time datetime="2022-10-30T02:15:21.954Z" title="发表于 2022-10-30 10:15:21">2022-10-30</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="social-icons"></div><div class="copyright">&copy;2020 - 2022 By 月の子豚小窝</div><div class="framework-info"><span class="footer-separator"> </span><a target="_blank" rel="noopener" href="https://hexo.io"><img src="https://img.shields.io/badge/Frame-Hexo-blue"/></a><span class="footer-separator"> </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><img src="https://img.shields.io/badge/Theme-Butterfly-informational"/></a><span class="footer-separator"> </span><a target="_blank" rel="noopener" href="https://vercel.app"><img src="https://img.shields.io/badge/Hosted-Vercel-success"/></a><span class="footer-separator"></span><a target="_blank" rel="noopener" href="https://tianli-blog.club/jsd/"><img src="https://img.shields.io/badge/CDN-TianliCDN-fff4c5"/></a><span class="footer-separator"></span><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/CC-BY--NC--SA4.0-red"/></a><span class="footer-separator"></span><a target="_blank" rel="noopener" href="https://icp.gov.moe/?keyword=20222035"><img src="https://img.shields.io/badge/%E8%90%8CICP%E5%A4%87-20222035-ff69b4"/></a></div><div class="footer_custom_text" id="footer_custom_text">这个小破站已运行{y}年{d}天{s}时{min}分{sec}秒</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="translateLink" type="button" title="简繁转换">简</button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="to_comment" type="button" title="直达评论" onclick="FixedCommentBtn();"><i class="fas fa-comments"></i></button><a id="switch_commentBarrage" href="javascript:switchCommentBarrage();" title="开关弹幕"><i class="iconfont icon-danmu"></i></a><a id="opensettings" href="javascript:toggleWinbox();" title="博客设置"><i class="fa fa-cog"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="nav-music"><div id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()">播放音乐</div><meting-js id="1708664797" server="tencent" type="playlist" mutex="true" preload="none" theme="#ed709b" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:window.location.href = window.location.origin;"><i class="fa-solid fa-house"></i></a></div><div class="rightMenu-group rightMenu-line rightMenuOther" id="menu-base1"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制文本</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="iconfont icon-baidu"></i><span>百度搜索</span></a><a class="rightMenu-item" href="#post-comment" onclick="rmf.yinyong()"><i class="fa-solid fa-message"></i><span>引用文本评论</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴文本</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>窗口预览</span></a><a class="rightMenu-item" href="javascript:rmf.click()"><i class="fa fa-arrows-alt"></i><span>全屏显示</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-music"><a class="rightMenu-item" href="javascript:rmf.musicSkipBack()"><i class="fas fa-backward"></i><span>上一首~</span></a><a class="rightMenu-item" href="javascript:rmf.musicSkipForward()"><i class="fas fa-forward"></i><span>下一首~</span></a><a class="rightMenu-item" id="menu-music-toggle" href="javascript:rmf.musicToggle()"><i class="fa-solid fa-pause"></i><span>暂停音乐</span></a><a class="rightMenu-item" href="javascript:rmf.copyMusicName()"><i class="fas fa-copy"></i><span>复制歌名</span></a></div><div class="rightMenu-group rightMenu-line" id="menu-base2"><a class="rightMenu-item" href="javascript:toRandomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="javascript:rmf.translate();"><i class="iconfont icon-fanti"></i><span>繁简转换</span></a><div class="rightMenu-item" href="javascript:rmf.printPage();"><i class="fa-solid fa-print fa-fw"></i><span>打印页面</span></div><a class="rightMenu-item" href="javascript:window.location.href=&quot;/license/&quot;;"><i class="fa fa-info-circle"></i><span>版权声明</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>博客设置</span></a></div></div><div><script src="https://npm.elemecdn.com/vue@2.6.11"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn1.tianli0.top/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn1.tianli0.top/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn1.tianli0.top/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
    setTimeout(function(){document.getElementById('loading-box').classList.add("loadend")},700)
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'http://124.221.230.10:8888',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'http://124.221.230.10:8888',
      region: '',
      urls: [window.location.pathname],
      includeReply: true
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/gh/zhheo/twikoo@dev/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><script>var gitcalendar = new Vue({
  el: '#gitcalendar',
  data: {
    simplemode: false,
    user: 'LYXOfficial',
    fixed: 'fixed',
    px: 'px',
    x: '',
    y: '',
    span1: '',
    span2: '',
    month: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
    monthchange: [],
    oneyearbeforeday: '',
    thisday: '',
    amonthago: '',
    aweekago: '',
    weekdatacore: 0,
    datacore: 0,
    total: 0,
    datadate: '',
    data: [],
    positionplusdata: [],
    firstweek: [],
    lastweek: [],
    beforeweek: [],
    thisweekdatacore: 0,
    mounthbeforeday: 0,
    mounthfirstindex: 0,
    crispedges: 'crispedges',
    thisdayindex: 0,
    amonthagoindex: 0,
    amonthagoweek: [],
    firstdate: [],
    first2date: [],
    montharrbefore: [],
    monthindex: 0,
    color: ['#ebedf0', '#f1f8ff', '#dbedff', '#c8e1ff', '#79b8ff', '#2188ff', '#0366d6', '#005cc5', '#044289', '#032f62', '#05264c']
  },
  methods: {
    selectStyle(data, event) {
      document.querySelector('.angle-wrapper').style.display = 'block'
      this.span1 = data.date;
      this.span2 = data.count;
      this.x = event.clientX - 100;
      this.y = event.clientY - 60
    },
    outStyle() {
      document.querySelector('.angle-wrapper').style.display = 'none'
    },
    thiscolor(x) {
      if (x === 0) {
        let i = parseInt(x / 2);
        return this.color[0]
      } else if (x < 2) {
        return this.color[1]
      } else if (x < 20) {
        let i = parseInt(x / 2);
        return this.color[i]
      } else {
        return this.color[9]
      }
    },
  }
});
var apiurl = 'gcapi.yisous.xyz' ? 'https://gcapi.yisous.xyz/api?' : 'https://githubapi.ryanchristian.dev/user/'
var githubapiurl = apiurl + gitcalendar.user;
//canvas绘图
function responsiveChart() {
  let c = document.getElementById("gitcanvas");
  if (c) {
    let cmessage = document.getElementById("gitmessage");
    let ctx = c.getContext("2d");
    c.width = document.getElementById("gitcalendarcanvasbox").offsetWidth;
    let linemaxwitdh = 0.96 * c.width / gitcalendar.data.length;
    c.height = 9 * linemaxwitdh;
    let lineminwitdh = 0.8 * linemaxwitdh;
    let setposition = {
      x: 0.02 * c.width,
      y: 0.025 * c.width
    };
    for (let week in gitcalendar.data) {
      weekdata = gitcalendar.data[week];
      for (let day in weekdata) {
        let dataitem = {
          date: "",
          count: "",
          x: 0,
          y: 0
        };
        gitcalendar.positionplusdata.push(dataitem);
        ctx.fillStyle = gitcalendar.thiscolor(weekdata[day].count);
        setposition.y = Math.round(setposition.y * 100) / 100;
        dataitem.date = weekdata[day].date;
        dataitem.count = weekdata[day].count;
        dataitem.x = setposition.x;
        dataitem.y = setposition.y;
        ctx.fillRect(setposition.x, setposition.y, lineminwitdh, lineminwitdh);
        setposition.y = setposition.y + linemaxwitdh
      };
      setposition.y = 0.025 * c.width;
      setposition.x = setposition.x + linemaxwitdh
    };
    ctx.font = "600  Arial";
    ctx.fillStyle = '#aaa';
    ctx.fillText("日", 0, 1.9 * linemaxwitdh);
    ctx.fillText("二", 0, 3.9 * linemaxwitdh);
    ctx.fillText("四", 0, 5.9 * linemaxwitdh);
    ctx.fillText("六", 0, 7.9 * linemaxwitdh);
    let monthindexlist = c.width / 24;
    for (let index in gitcalendar.monthchange) {
      ctx.fillText(gitcalendar.monthchange[index], monthindexlist, 0.7 * linemaxwitdh);
      monthindexlist = monthindexlist + c.width / 12
    };
    cmessage.onmousemove = function(event) {
      document.querySelector('.angle-wrapper').style.display = 'none'
    };
    c.onmousemove = function(event) {
      document.querySelector('.angle-wrapper').style.display = 'none'
      getMousePos(c, event);
    };

    function getMousePos(canvas, event) {
      var rect = canvas.getBoundingClientRect();
      var x = event.clientX - rect.left * (canvas.width / rect.width);
      var y = event.clientY - rect.top * (canvas.height / rect.height);
      //console.log("x:"+x+",y:"+y);
      for (let item of gitcalendar.positionplusdata) {
        let lenthx = x - item.x;
        let lenthy = y - item.y;
        //console.log(lenthx,lenthy);
        if (0 < lenthx && lenthx < lineminwitdh) {
          if (0 < lenthy && lenthy < lineminwitdh) {
            //console.log(item.date,item.count)
            document.querySelector('.angle-wrapper').style.display = 'block'
            gitcalendar.span1 = item.date;
            gitcalendar.span2 = item.count;
            gitcalendar.x = event.clientX - 100;
            gitcalendar.y = event.clientY - 60
          }
        }
        //if(0< x - item.x <lineminwitdh&&0< y - item.y <lineminwitdh){
        //console.log(item.count,item.date);
        //}
      }
    }
  }
}
//数据统计算法
function addlastmonth() {
  if (gitcalendar.thisdayindex === 0) {
    thisweekcore(52);
    thisweekcore(51);
    thisweekcore(50);
    thisweekcore(49);
    thisweekcore(48);
    gitcalendar.thisweekdatacore += gitcalendar.firstdate[6].count;
    gitcalendar.amonthago = gitcalendar.firstdate[6].date
  } else {
    thisweekcore(52);
    thisweekcore(51);
    thisweekcore(50);
    thisweekcore(49);
    thisweek2core();
    gitcalendar.amonthago = gitcalendar.first2date[gitcalendar.thisdayindex - 1].date
  }
};

function thisweek2core() {
  for (let i = gitcalendar.thisdayindex - 1; i < gitcalendar.first2date.length; i++) {
    gitcalendar.thisweekdatacore += gitcalendar.first2date[i].count
  }
};

function thisweekcore(index) {
  for (let item of gitcalendar.data[index]) {
    gitcalendar.thisweekdatacore += item.count
  }
};

function addlastweek() {
  for (let item of gitcalendar.lastweek) {
    gitcalendar.weekdatacore += item.count
  }
};

function addbeforeweek() {
  for (let i = gitcalendar.thisdayindex; i < gitcalendar.beforeweek.length; i++) {
    gitcalendar.weekdatacore += gitcalendar.beforeweek[i].count
  }
};

function addweek(data) {
  if (gitcalendar.thisdayindex === 6) {
    gitcalendar.aweekago = gitcalendar.lastweek[0].date;
    addlastweek()
  } else {
    lastweek = data.contributions[51];
    gitcalendar.aweekago = lastweek[gitcalendar.thisdayindex + 1].date;
    addlastweek();
    addbeforeweek()
  }
}

fetch(githubapiurl)
  .then(data => data.json())
  .then(data => {
    gitcalendar.data = data.contributions;
    gitcalendar.total = data.total;
    gitcalendar.first2date = gitcalendar.data[48];
    gitcalendar.firstdate = gitcalendar.data[47];
    gitcalendar.firstweek = data.contributions[0];
    gitcalendar.lastweek = data.contributions[52];
    gitcalendar.beforeweek = data.contributions[51];
    gitcalendar.thisdayindex = gitcalendar.lastweek.length - 1;
    gitcalendar.thisday = gitcalendar.lastweek[gitcalendar.thisdayindex].date;
    gitcalendar.oneyearbeforeday = gitcalendar.firstweek[0].date;
    gitcalendar.monthindex = gitcalendar.thisday.substring(5, 7) * 1;
    gitcalendar.montharrbefore = gitcalendar.month.splice(gitcalendar.monthindex, 12 - gitcalendar.monthindex);
    gitcalendar.monthchange = gitcalendar.montharrbefore.concat(gitcalendar.month);
    addweek(data);
    addlastmonth();
    responsiveChart();
  })
  .catch(function(error) {
    console.log(error);
  });

//手机版更换为svg绘制
if (document.getElementById("gitcalendarcanvasbox").offsetWidth < 500) {
  gitcalendar.simplemode = false
}

//当改变窗口大小时重新绘制canvas
window.onresize = function() {
  if (gitcalendar.simplemode) responsiveChart()
}

//解决滚动滑轮时出现的标签显示
window.onscroll = function() {
  if (document.querySelector('.angle-wrapper')) {
    document.querySelector('.angle-wrapper').style.display = 'none'
  }
};</script></div><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/katex@0.10.1/dist/katex.min.css"><script defer src="https://cdn1.tianli0.top/npm/katex@0.10.1/dist/katex.min.js"></script><script type="text/javascript" src="/js/noie.js"></script><script src="https://cdn1.tianli0.top/npm/leancloud-storage@4.13.1/dist/av-min.js"></script><script src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script type="text/javascript" src="/js/rightmenu.js"></script><script type="text/javascript" src="/js/copy.js"></script><script type="text/javascript" src="/js/welcome.js"></script><script async defer src="/js/aplayer.js"></script><script type="text/javascript" src="https://cdn1.tianli0.top/npm/jquery@latest/dist/jquery.min.js"></script><script type="text/javascript" src="/js/resizeTop.js"></script><script type="text/javascript" src="/js/calendar.js"></script><script type="text/javascript" src="/js/languages.js"></script><script type="text/javascript" src="/js/browser.js"></script><script type="text/javascript" src="/js/smooth-scrolling.js"></script><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><script type="text/javascript" src="/js/sitetime.js"></script><script type="text/javascript" src="https://cdn1.tianli0.top/gh/LYXOfficial/LYXOfficial.github.io/js/seo.js"></script><script type="text/javascript" src="https://cdn1.tianli0.top/gh/LYXOfficial/LYXOfficial.github.io/js/heimu.js"></script><script src="/js/bbtalklunbo.js"></script><script src="/js/fps.js"></script><script async src="/js/diytitle.js"></script><script src="/js/settings.js"></script><script src="/js/owo.js"></script><script src="/js/welcomeconsole.js"></script><script src="https://f.zhheo.com/JS-Heo/bb/showbb_in_index.js" data-pjax="" defer=""></script><script data-pace-options='{ "restartOnRequestAfter":false,"eventLag":false}' src="https://cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><script src="https://cdn1.tianli0.top/npm/swiper/swiper-bundle.min.js"></script><script src="https://cdn1.tianli0.top/gh/LYXOfficial/LYXOfficial.github.io/js/baiduhistory.js"></script><script src="https://cdn.jsdelivr.net/gh/zhheo/twikoo@dev/dist/twikoo.all.min.js"></script><script src="/js/random.js"></script><script src="https://cdn1.tianli0.top/gh/LYXOfficial/LYXOfficial.github.io/js/lunar.js"></script><script src="/js/day.js"></script><script src="/js/nav.js"></script><script src="/js/cursor.js"></script><script src="/js/post_charts.js"></script><script type="text/javascript" src="/js/dianzan.js"></script><script type="text/javascript" src="/js/commentsCount.js"></script><script type="text/javascript" src="/js/latest.js"></script><script data-pjax defer src="/js/fixed_card_widget.js"></script><script type="text/javascript" src="https://cdn1.tianli0.top/npm/node-snackbar@latest/src/js/snackbar.min.js"></script><script data-pjax defer src="/js/fixed_comment.js"></script><script async type="text/javascript" src="/js/readPercent.js"></script><script src="/js/sun_moon.js" async></script><script src="/js/essay.js" async data-pjax></script><script data-pjax src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/js/swiper.min.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="/js/meting_js.js"></script><script async data-pjax src="https://cdn.dusays.com/bsz.js"></script><div id="fixedcard-dashboard"><button class="fixedcard-activebtn" type="button" title="我的信息" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-info&quot;,&quot;0&quot;)"><i class="fas fa-address-book"></i></button><button class="fixedcard-activebtn" type="button" title="公告" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-announcement&quot;,&quot;0&quot;)"><i class="fas fa-bullhorn"></i></button><button class="fixedcard-activebtn" type="button" title="电子钟" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-clock&quot;,&quot;0&quot;)"><i class="fa-solid fa-clock"></i></button><button class="fixedcard-activebtn" type="button" title="最新文章" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-recent-post&quot;,&quot;0&quot;)"><i class="fas fa-history"></i></button><button class="fixedcard-activebtn" type="button" title="最新评论" onclick="FixedCardWidget(&quot;id&quot;,&quot;card-newest-comments&quot;,&quot;0&quot;)"><i class="fas fa-comment-dots"></i></button><button class="fixedcard-activebtn" type="button" title="文章日历" onclick="FixedCardWidget(&quot;class&quot;,&quot;card-calendar&quot;,&quot;0&quot;)"><i class="fas fa-calendar"></i></button><div class="fixedcard-user-avatar fixedcard-activebtn" onclick="RemoveFixedCardWidget()"><img class="fixedcard-user-avatar-img" src="https://pic.imgdb.cn/item/637b405e16f2c2beb1405fb3.jpg" title="月の子豚小窝"></div></div></div><div class="comment-barrage"></div><link rel="stylesheet" href="/css/commentBarrage.css"><script src="/js/commentBarrage.js"></script><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('fl') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('fl');
    var child = '<div class="recent-post-item" style="width:100%;height: 100% !important;border-radius:12px"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/Java-开发/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📚 月のJava 源泉 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/数据库技术/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎮 月の数据库总结 (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/运维技术/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🐱‍👓 月のLinux遨游 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/工具插件/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 月の妙用小工具 (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/奇思淫巧/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📒 月の奇思淫巧 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="http://localhost:4000/categories/项目练习/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 月の个人项目 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="http://localhost:4000/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2 !important;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #dd8484 !important}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementsByClassName('swiper-div')[0];
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/06/20/数据库技术/MySQL 数据库/MySQL/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/k7/wallhaven-k7m65d.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-06-20</span><a class="blog-slider__title" href="2022/06/20/数据库技术/MySQL 数据库/MySQL/" alt="">MySQL 底层初探</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2022/06/20/数据库技术/MySQL 数据库/MySQL/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/11/21/奇思淫巧/Hexo魔改记录/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/x6/wallhaven-x6128o.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-11-21</span><a class="blog-slider__title" href="2022/11/21/奇思淫巧/Hexo魔改记录/" alt="">Hexo魔改日记</a><div class="blog-slider__text">本文是在 Acryple 主题的基础上进行魔改</div><a class="blog-slider__button" href="2022/11/21/奇思淫巧/Hexo魔改记录/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2021/05/26/数据库技术/InfluxDB 数据库/InfluxDB数据库集群方案/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/qz/wallhaven-qz93rr.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2021-05-26</span><a class="blog-slider__title" href="2021/05/26/数据库技术/InfluxDB 数据库/InfluxDB数据库集群方案/" alt="">Influxdb 数据库集群方案</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2021/05/26/数据库技术/InfluxDB 数据库/InfluxDB数据库集群方案/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/03/05/Java 开发/网络编程/Netty 进阶实战/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/x8/wallhaven-x8xo1d.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-03-05</span><a class="blog-slider__title" href="2022/03/05/Java 开发/网络编程/Netty 进阶实战/" alt="">Netty 进阶实战</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2022/03/05/Java 开发/网络编程/Netty 进阶实战/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/05/30/Java 开发/Java 多线程/多线程和JUC编程/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/zy/wallhaven-zyxvqy.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-05-30</span><a class="blog-slider__title" href="2022/05/30/Java 开发/Java 多线程/多线程和JUC编程/" alt="">多线程和 JUC 编程</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2022/05/30/Java 开发/Java 多线程/多线程和JUC编程/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/05/20/运维技术/Docker 基础/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/e7/wallhaven-e7dy9w.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-05-20</span><a class="blog-slider__title" href="2022/05/20/运维技术/Docker 基础/" alt="">Docker 的基本使用</a><div class="blog-slider__text">主要讲述 Docker、Docker0、Docker compose 的基本使用</div><a class="blog-slider__button" href="2022/05/20/运维技术/Docker 基础/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2022/05/21/运维技术/Linux 基础/" alt=""><img width="48" height="48" src="https://w.wallhaven.cc/full/k7/wallhaven-k7mww1.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-05-21</span><a class="blog-slider__title" href="2022/05/21/运维技术/Linux 基础/" alt="">Linux 的基本命令</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" href="2022/05/21/运维技术/Linux 基础/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://cdn1.tianli0.top/npm/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://cdn1.tianli0.top/npm/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '5cb4f63e85c148a3bd7f49f81456f48c';
  var gaud_map_key = '334aebc0599a80601395fd75921efc43';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu/lib/clock.min.js"></script><script data-pjax src="https://unpkg.zhimg.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementsByClassName('gc')[0];
      var item_html = '<container><style>#git_container{min-height: 140px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></container>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementsByClassName('gc')[0] && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("gcapi.yisous.xyz/api?LYXOfficial",['#ebedf0', '#f1f8ff', '#dbedff', '#c8e1ff', '#79b8ff', '#2188ff', '#0366d6', '#005cc5', '#044289', '#032f62', '#05264c'],'LYXOfficial')
    }
  </script><!-- hexo injector body_end end --></body></html>